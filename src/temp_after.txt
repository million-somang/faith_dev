
// ==================== ìœ í‹¸ë¦¬í‹° í˜ì´ì§€ ====================
app.get('/lifestyle', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìœ í‹¸ë¦¬í‹° - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50" id="html-root">
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
            <div class="mb-6 overflow-x-auto">
                <div class="flex gap-2 min-w-max">
                    <button onclick="filterCategory('all')" class="category-tab active px-4 py-2 rounded-full font-medium transition-all">
                        ì „ì²´
                    </button>
                    <button onclick="filterCategory('life')" class="category-tab px-4 py-2 rounded-full font-medium transition-all">
                        ìƒí™œ/ê¸ˆìœµ
                    </button>
                    <button onclick="filterCategory('work')" class="category-tab px-4 py-2 rounded-full font-medium transition-all">
                        í•™ìŠµ/ì—…ë¬´
                    </button>
                    <button onclick="filterCategory('dev')" class="category-tab px-4 py-2 rounded-full font-medium transition-all">
                        ê°œë°œ ë„êµ¬
                    </button>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ë‹¤ê¸°ëŠ¥ ê³„ì‚°ê¸° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="life">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-calculator text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ë‹¤ê¸°ëŠ¥ ê³„ì‚°ê¸°</h3>
                    <p class="text-gray-600 mb-4">ê¸°ë³¸ ê³„ì‚°ë¶€í„° ëŒ€ì¶œ, BMI, ë‚ ì§œê¹Œì§€ ë‹¤ì–‘í•œ ê³„ì‚°ê¸°</p>
                    <a href="/lifestyle/calculator" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- ê¸€ììˆ˜ ì„¸ê¸° & ë§ì¶¤ë²• ê²€ì‚¬ê¸° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="work">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-spell-check text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ê¸€ììˆ˜ & ë§ì¶¤ë²•</h3>
                    <p class="text-gray-600 mb-4">í•œêµ­ì–´ ê¸€ììˆ˜ ì„¸ê¸°ì™€ ë§ì¶¤ë²• ê²€ì‚¬ë¥¼ í•œë²ˆì—</p>
                    <a href="/lifestyle/text-checker" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- í‰ìˆ˜ ê³„ì‚°ê¸° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="life">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-home text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">í‰ìˆ˜ ê³„ì‚°ê¸°</h3>
                    <p class="text-gray-600 mb-4">í‰ â†” mÂ² ë³€í™˜ (34í‰ = 112.39mÂ²)</p>
                    <a href="/lifestyle/pyeong-calculator" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- í•œêµ­ ë‚˜ì´ ê³„ì‚°ê¸° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="life">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-birthday-cake text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">í•œêµ­ ë‚˜ì´ ê³„ì‚°ê¸°</h3>
                    <p class="text-gray-600 mb-4">ë§Œ ë‚˜ì´, í•œêµ­ ë‚˜ì´, ì—° ë‚˜ì´ë¥¼ í•œë²ˆì— ê³„ì‚°</p>
                    <a href="/lifestyle/age-calculator" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- D-Day ê³„ì‚°ê¸° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="life">
                    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-calendar-alt text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">D-Day ê³„ì‚°ê¸°</h3>
                    <p class="text-gray-600 mb-4">ì¤‘ìš”í•œ ë‚ ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ê²°í˜¼, ì‹œí—˜, ì…ëŒ€)</p>
                    <a href="/lifestyle/dday-calculator" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- JSON í¬ë§¤í„° -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="dev">
                    <div class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-900 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-code text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">JSON í¬ë§¤í„°</h3>
                    <p class="text-gray-600 mb-4">JSON ë°ì´í„° ì •ë¦¬, ê²€ì¦, ì••ì¶• (ê°œë°œì í•„ìˆ˜)</p>
                    <a href="/lifestyle/json-formatter" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- Base64 ì¸ì½”ë”/ë””ì½”ë” -->
                <div class="utility-card bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all cursor-pointer" data-category="dev">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-lock text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Base64 ë³€í™˜</h3>
                    <p class="text-gray-600 mb-4">Base64 ì¸ì½”ë”©/ë””ì½”ë”© (í…ìŠ¤íŠ¸, ì´ë¯¸ì§€)</p>
                    <a href="/lifestyle/base64-converter" class="text-cyan-600 hover:text-cyan-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <!-- ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ (íˆ¬í‘œ ê¸°ëŠ¥) -->
                <div class="utility-card bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl shadow-lg p-6 border-2 border-dashed border-gray-300" data-category="all">
                    <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-vote-yea text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ë‹¤ìŒ ì„œë¹„ìŠ¤ íˆ¬í‘œ</h3>
                    <p class="text-gray-600 mb-4 text-sm">ì–´ë–¤ ìœ í‹¸ë¦¬í‹°ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?</p>
                    <div class="space-y-2 mb-4">
                        <button onclick="voteUtility('lotto')" class="w-full text-left px-3 py-2 bg-white rounded-lg hover:bg-gray-50 transition-all text-sm">
                            ğŸ± ë¡œë˜ ë²ˆí˜¸ ìƒì„±ê¸° <span class="float-right text-cyan-600 font-bold" id="vote-lotto">0</span>
                        </button>
                        <button onclick="voteUtility('ladder')" class="w-full text-left px-3 py-2 bg-white rounded-lg hover:bg-gray-50 transition-all text-sm">
                            ğŸªœ ì‚¬ë‹¤ë¦¬ ê²Œì„ <span class="float-right text-cyan-600 font-bold" id="vote-ladder">0</span>
                        </button>
                        <button onclick="voteUtility('translator')" class="w-full text-left px-3 py-2 bg-white rounded-lg hover:bg-gray-50 transition-all text-sm">
                            ğŸŒ ë²ˆì—­ê¸° <span class="float-right text-cyan-600 font-bold" id="vote-translator">0</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">* íˆ¬í‘œëŠ” 1ì¼ 1íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </div>
            </div>
        </main>

        <style>
            .category-tab {
                background: white;
                color: #6b7280;
                border: 1px solid #e5e7eb;
            }
            .category-tab:hover {
                background: #f3f4f6;
            }
            .category-tab.active {
                background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
                color: white;
                border-color: transparent;
            }
            .utility-card {
                transition: all 0.3s ease;
            }
            .utility-card:hover {
                transform: translateY(-5px);
            }
        </style>

        <script>
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const token = localStorage.getItem('auth_token');
            const userEmail = localStorage.getItem('user_email');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');

            // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
            function filterCategory(category) {
                const cards = document.querySelectorAll('.utility-card');
                const tabs = document.querySelectorAll('.category-tab');
                
                // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
                tabs.forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                // ì¹´ë“œ í•„í„°ë§
                cards.forEach(card => {
                    const cardCategory = card.getAttribute('data-category');
                    if (category === 'all' || cardCategory === category || cardCategory === 'all') {
                        card.style.display = 'block';
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 10);
                    } else {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.display = 'none';
                        }, 300);
                    }
                });
            }

            // íˆ¬í‘œ ê¸°ëŠ¥
            function voteUtility(utilityName) {
                const lastVoteDate = localStorage.getItem('lastVoteDate');
                const today = new Date().toDateString();
                
                if (lastVoteDate === today) {
                    alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ íˆ¬í‘œí•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                // íˆ¬í‘œ ìˆ˜ ì¦ê°€
                const currentVotes = parseInt(localStorage.getItem(\`votes_\${utilityName}\`) || '0');
                localStorage.setItem(\`votes_\${utilityName}\`, currentVotes + 1);
                localStorage.setItem('lastVoteDate', today);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById(\`vote-\${utilityName}\`).textContent = currentVotes + 1;
                
                alert('íˆ¬í‘œí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰');
            }

            // íˆ¬í‘œ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
            window.addEventListener('DOMContentLoaded', () => {
                ['lotto', 'ladder', 'translator'].forEach(name => {
                    const votes = localStorage.getItem(\`votes_\${name}\`) || '0';
                    const elem = document.getElementById(\`vote-\${name}\`);
                    if (elem) elem.textContent = votes;
                });
            });
            
            if (token && userEmail) {
                const userMenu = document.getElementById('user-menu');
                userMenu.innerHTML = \`
                    <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-blue-900 transition-all p-2" title="ë©”ë‰´ ì—´ê¸°">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <a href="/mypage" class="text-xs sm:text-sm text-gray-700 hover:text-blue-900 font-medium transition-all px-2 sm:px-3">
                        <i class="fas fa-user mr-0 sm:mr-1"></i><span class="hidden sm:inline">ë§ˆì´í˜ì´ì§€</span>
                    </a>
                    \${userLevel >= 6 ? '<a href="/admin" class="text-xs sm:text-sm bg-yellow-500 text-gray-900 px-2 sm:px-3 py-1.5 rounded font-medium hover:bg-yellow-600 transition-all"><i class="fas fa-crown mr-1"></i><span class="hidden sm:inline">ê´€ë¦¬ì</span></a>' : ''}
                    <button onclick="logout()" class="text-gray-700 hover:text-red-600 transition-all p-2" title="ë¡œê·¸ì•„ì›ƒ">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                \`;
            }
            
            function logout() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_email');
                    localStorage.removeItem('user_level');
                    location.href = '/';
                }
            }
            
            function toggleMobileMenu() {
                let overlay = document.getElementById('mobile-menu-overlay');
                
                if (overlay) {
                    overlay.classList.add('opacity-0');
                    setTimeout(() => overlay?.remove(), 300);
                } else {
                    const userLevel = parseInt(localStorage.getItem('user_level') || '0');
                    
                    overlay = document.createElement('div');
                    overlay.id = 'mobile-menu-overlay';
                    overlay.className = 'fixed inset-0 z-50 bg-black bg-opacity-50 opacity-0 transition-opacity duration-300';
                    
                    overlay.innerHTML = \`
                        <div class="fixed top-0 right-0 h-full w-64 bg-white shadow-2xl transform translate-x-full transition-transform duration-300" id="mobile-menu-content">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-bold text-gray-900">ë©”ë‰´</h3>
                                    <button onclick="toggleMobileMenu()" class="text-gray-600 hover:text-gray-900">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    <a href="/" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-home mr-3"></i>í™ˆ
                                    </a>
                                    <a href="/news" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-newspaper mr-3"></i>ë‰´ìŠ¤
                                    </a>
                                    <a href="/lifestyle" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-home mr-3"></i>ìœ í‹¸ë¦¬í‹°
                                    </a>
                                    <a href="/game" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-gamepad mr-3"></i>ê²Œì„
                                    </a>
                                    <a href="/finance" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-chart-line mr-3"></i>ê¸ˆìœµ
                                    </a>
                                    <a href="/mypage" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-user mr-3"></i>ë§ˆì´í˜ì´ì§€
                                    </a>
                                    <a href="/bookmarks" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="fas fa-bookmark mr-3"></i>ë¶ë§ˆí¬
                                    </a>
                                    \${userLevel >= 6 ? '<a href="/admin" class="block px-4 py-3 bg-yellow-50 text-yellow-700 hover:bg-yellow-100 rounded-lg transition-colors"><i class="fas fa-crown mr-3"></i>ê´€ë¦¬ìí˜ì´ì§€</a>' : ''}
                                    <hr class="my-2">
                                    <button onclick="logout()" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        <i class="fas fa-sign-out-alt mr-3"></i>ë¡œê·¸ì•„ì›ƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                    \`;
                    
                    document.body.appendChild(overlay);
                    
                    setTimeout(() => {
                        overlay?.classList.remove('opacity-0');
                        document.getElementById('mobile-menu-content')?.classList.remove('translate-x-full');
                    }, 10);
                    
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) toggleMobileMenu();
                    });
                }
            }
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}

    </body>
    </html>
  `)
})

// ==================== ê¸ˆìœµ í˜ì´ì§€ ====================
app.get('/finance', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê¸ˆìœµ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50" id="html-root">
        ${getCommonHeader('Finance')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê¸ˆìœµ'}
        ])}

        ${getFinanceMenu('/finance')}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-won-sign text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">
                    <span class="bg-gradient-to-r from-green-500 to-emerald-600 bg-clip-text text-transparent">ê¸ˆìœµ</span> ì •ë³´
                </h1>
                <p class="text-gray-600 text-lg mb-8">
                    ì‹¤ì‹œê°„ ê¸ˆìœµ ì •ë³´ì™€ ë‹¤ì–‘í•œ ê¸ˆìœµ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤
                </p>
                <div class="flex justify-center gap-4">
                    <a href="/finance/stock" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                        <i class="fas fa-chart-line mr-2"></i>
                        ì£¼ì‹ ì •ë³´
                    </a>
                    <a href="/" class="inline-flex items-center px-6 py-3 bg-white text-gray-700 rounded-lg font-medium border border-gray-300 hover:border-green-500 hover:text-green-600 transition-all">
                        <i class="fas fa-home mr-2"></i>
                        ë©”ì¸ìœ¼ë¡œ
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-chart-line text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì£¼ì‹ ì •ë³´</h3>
                    <p class="text-gray-600 mb-4">ì‹¤ì‹œê°„ ì£¼ì‹ ì‹œì„¸ì™€ ì°¨íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                    <a href="/finance/stock" class="text-green-600 hover:text-green-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-exchange-alt text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">í™˜ìœ¨ ì •ë³´</h3>
                    <p class="text-gray-600 mb-4">ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ì™€ í™˜ì „ ê³„ì‚°ê¸°</p>
                    <a href="/finance/exchange" class="text-green-600 hover:text-green-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-university text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì€í–‰ ì •ë³´</h3>
                    <p class="text-gray-600 mb-4">ì˜ˆì ê¸ˆ ê¸ˆë¦¬ ë¹„êµ ë° ì€í–‰ ì„œë¹„ìŠ¤</p>
                    <a href="/finance/banking" class="text-green-600 hover:text-green-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>
            </div>
        </main>

        ${getCommonFooter()}
        ${getCommonAuthScript()}
    </body>
    </html>
  `)
})

// ==================== ì—”í„° í˜ì´ì§€ ====================
app.get('/entertainment', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì—”í„° - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-pink-50 via-rose-50 to-red-50" id="html-root">
        ${getCommonHeader('Entertainment')}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ì—”í„°'}
        ])}

        ${getEntertainmentMenu('/entertainment')}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gradient-to-br from-pink-500 to-rose-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-star text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">
                    <span class="bg-gradient-to-r from-pink-500 to-rose-600 bg-clip-text text-transparent">ì—”í„°í…Œì¸ë¨¼íŠ¸</span>
                </h1>
                <p class="text-gray-600 text-lg mb-8">
                    ìµœì‹  ì—°ì˜ˆ, ìŒì•…, ì˜í™” ì†Œì‹ì„ ë§Œë‚˜ë³´ì„¸ìš”
                </p>
                <div class="flex justify-center gap-4">
                    <a href="/entertainment/music" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                        <i class="fas fa-music mr-2"></i>
                        ìŒì•… ì°¨íŠ¸
                    </a>
                    <a href="/" class="inline-flex items-center px-6 py-3 bg-white text-gray-700 rounded-lg font-medium border border-gray-300 hover:border-pink-500 hover:text-pink-600 transition-all">
                        <i class="fas fa-home mr-2"></i>
                        ë©”ì¸ìœ¼ë¡œ
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-music text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ìŒì•… ì°¨íŠ¸</h3>
                    <p class="text-gray-600 mb-4">ì‹¤ì‹œê°„ ìŒì•… ìˆœìœ„ì™€ ìµœì‹  ìŒì•…</p>
                    <a href="/entertainment/music" class="text-pink-600 hover:text-pink-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-film text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì˜í™” ì •ë³´</h3>
                    <p class="text-gray-600 mb-4">ìµœì‹  ê°œë´‰ì‘ê³¼ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ ìˆœìœ„</p>
                    <a href="/entertainment/movie" class="text-pink-600 hover:text-pink-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-star text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì—°ì˜ˆì¸ ì†Œì‹</h3>
                    <p class="text-gray-600 mb-4">ì—°ì˜ˆì¸ ë‰´ìŠ¤ì™€ í™”ì œì˜ ìŠ¤íƒ€</p>
                    <a href="/entertainment/celebrity" class="text-pink-600 hover:text-pink-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>
            </div>
        </main>

        ${getCommonFooter()}
        ${getCommonAuthScript()}
    </body>
    </html>
  `)
})

// ==================== êµìœ¡ í˜ì´ì§€ ====================
app.get('/education', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>êµìœ¡ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50" id="html-root">
        ${getCommonHeader('Education')}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'êµìœ¡'}
        ])}

        ${getEducationMenu('/education')}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-graduation-cap text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">
                    <span class="bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent">êµìœ¡</span> ì •ë³´
                </h1>
                <p class="text-gray-600 text-lg mb-8">
                    ì˜¨ë¼ì¸ ê°•ì˜ë¶€í„° ìê²©ì¦ê¹Œì§€, ë‹¤ì–‘í•œ êµìœ¡ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤
                </p>
                <div class="flex justify-center gap-4">
                    <a href="/education/online" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                        <i class="fas fa-laptop mr-2"></i>
                        ì˜¨ë¼ì¸ ê°•ì˜
                    </a>
                    <a href="/" class="inline-flex items-center px-6 py-3 bg-white text-gray-700 rounded-lg font-medium border border-gray-300 hover:border-indigo-500 hover:text-indigo-600 transition-all">
                        <i class="fas fa-home mr-2"></i>
                        ë©”ì¸ìœ¼ë¡œ
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-laptop text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì˜¨ë¼ì¸ ê°•ì˜</h3>
                    <p class="text-gray-600 mb-4">ë‹¤ì–‘í•œ ë¶„ì•¼ì˜ ì˜¨ë¼ì¸ ê°•ì˜ ì •ë³´</p>
                    <a href="/education/online" class="text-indigo-600 hover:text-indigo-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-language text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ì–¸ì–´ í•™ìŠµ</h3>
                    <p class="text-gray-600 mb-4">ì˜ì–´, ì¤‘êµ­ì–´ ë“± ì™¸êµ­ì–´ í•™ìŠµ ì •ë³´</p>
                    <a href="/education/language" class="text-indigo-600 hover:text-indigo-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-certificate text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ìê²©ì¦</h3>
                    <p class="text-gray-600 mb-4">ìê²©ì¦ ì‹œí—˜ ì¼ì • ë° í•™ìŠµ ìë£Œ</p>
                    <a href="/education/certificate" class="text-indigo-600 hover:text-indigo-700 font-medium">
                        ì‹œì‘í•˜ê¸° â†’
                    </a>
                </div>
            </div>
        </main>

        ${getCommonFooter()}
        ${getCommonAuthScript()}
    </body>
    </html>
  `)
})

// ==================== ê³„ì‚°ê¸° í˜ì´ì§€ ====================
app.get('/lifestyle/calculator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë‹¤ê¸°ëŠ¥ ê³„ì‚°ê¸° - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
            
            /* ê³„ì‚°ê¸° ì „ì²´ ìŠ¤íƒ€ì¼ */
            .calculator-container {
                background: linear-gradient(145deg, #f0f0f0, #ffffff);
                border-radius: 20px;
                padding: 1.5rem;
            }
            
            /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .calculator-btn {
                @apply text-gray-800 font-bold transition-all;
                aspect-ratio: 1 / 1;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(145deg, #ffffff, #e8e8e8);
                border-radius: 15px;
                border: 2px solid #d1d1d1;
                cursor: pointer;
            }
            .calculator-btn:hover {
                background: linear-gradient(145deg, #f8f8f8, #e0e0e0);
                transform: translateY(-1px);
            }
            .calculator-btn:active {
                transform: translateY(0);
            }
            /* ë°˜ì‘í˜• ë²„íŠ¼ í¬ê¸° */
            @media (max-width: 640px) {
                .calculator-btn {
                    font-size: 1rem;
                    min-height: 50px;
                }
                .calculator-display {
                    font-size: 1.5rem !important;
                    padding: 0.75rem !important;
                    min-height: 50px !important;
                }
            }
            @media (min-width: 641px) and (max-width: 1024px) {
                .calculator-btn {
                    font-size: 1.1rem;
                    min-height: 55px;
                }
                .calculator-display {
                    font-size: 1.75rem !important;
                    padding: 1rem !important;
                    min-height: 60px !important;
                }
            }
            @media (min-width: 1025px) {
                .calculator-btn {
                    font-size: 1.25rem;
                    min-height: 60px;
                }
                .calculator-display {
                    font-size: 2rem !important;
                    padding: 1.25rem !important;
                    min-height: 70px !important;
                }
            }
            .calculator-btn-operator {
                background: linear-gradient(145deg, #60a5fa, #3b82f6) !important;
                color: white !important;
                border: 2px solid #2563eb !important;
            }
            .calculator-btn-operator:hover {
                background: linear-gradient(145deg, #3b82f6, #2563eb) !important;
                transform: translateY(-1px);
            }
            .calculator-btn-operator:active {
                transform: translateY(0);
            }
            .calculator-btn-equal {
                background: linear-gradient(145deg, #34d399, #10b981) !important;
                color: white !important;
                border: 2px solid #059669 !important;
            }
            .calculator-btn-equal:hover {
                background: linear-gradient(145deg, #10b981, #059669) !important;
                transform: translateY(-1px);
            }
            .calculator-btn-equal:active {
                transform: translateY(0);
            }
            .calculator-btn-clear {
                background: linear-gradient(145deg, #f87171, #ef4444) !important;
                color: white !important;
                border: 2px solid #dc2626 !important;
            }
            .calculator-btn-clear:hover {
                background: linear-gradient(145deg, #ef4444, #dc2626) !important;
                transform: translateY(-1px);
            }
            .calculator-btn-clear:active {
                transform: translateY(0);
            }
            .tab-active {
                @apply bg-blue-500 text-white;
            }
            .calculator-display {
                @apply text-right font-mono mb-8 break-all;
                background: linear-gradient(145deg, #1f2937, #374151);
                color: #10b981;
                border-radius: 12px;
                border: 2px solid #4b5563;
                font-weight: 600;
                letter-spacing: 0.05em;
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50" id="html-root">
        ${getCommonHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'ê³„ì‚°ê¸°'}
        ])}

        <!-- ì„œë¸Œ ë©”ë‰´ -->
        ${getLifestyleMenu('/lifestyle/calculator')}

        <!-- ê´‘ê³  ë°°ë„ˆ ì˜ì—­ -->
        <div class="bg-gradient-to-r from-yellow-400 via-red-400 to-pink-400 py-4">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p class="text-white font-bold text-lg">
                    <i class="fas fa-ad mr-2"></i>ê´‘ê³  ë°°ë„ˆ ì˜ì—­
                </p>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <main class="w-full">
                <div class="bg-white rounded-xl shadow-lg p-3 sm:p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-3 sm:mb-4">
                        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800">
                            <i class="fas fa-calculator mr-2 text-blue-500"></i>
                            <span class="hidden sm:inline">ë‹¤ê¸°ëŠ¥ </span>ê³„ì‚°ê¸°
                        </h1>
                    </div>

                    <!-- ê³„ì‚°ê¸° íƒ­ -->
                    <div class="flex flex-wrap gap-2 mb-4 border-b pb-3">
                        <button onclick="showCalculator('basic')" class="tab-btn tab-active px-4 py-2 rounded-lg font-medium transition" data-tab="basic">
                            <i class="fas fa-calculator mr-1"></i>ê¸°ë³¸
                        </button>
                        <button onclick="showCalculator('scientific')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="scientific">
                            <i class="fas fa-square-root-alt mr-1"></i>ê³µí•™
                        </button>
                        <button onclick="showCalculator('loan')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="loan">
                            <i class="fas fa-money-bill-wave mr-1"></i>ëŒ€ì¶œ
                        </button>
                        <button onclick="showCalculator('bmi')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="bmi">
                            <i class="fas fa-weight mr-1"></i>BMI
                        </button>
                        <button onclick="showCalculator('age')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="age">
                            <i class="fas fa-birthday-cake mr-1"></i>ë‚˜ì´
                        </button>
                        <button onclick="showCalculator('date')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="date">
                            <i class="fas fa-calendar mr-1"></i>ë‚ ì§œ
                        </button>
                        <button onclick="showCalculator('unit')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="unit">
                            <i class="fas fa-exchange-alt mr-1"></i>ë‹¨ìœ„
                        </button>
                        <button onclick="showCalculator('percentage')" class="tab-btn px-4 py-2 rounded-lg font-medium transition bg-gray-100 hover:bg-gray-200" data-tab="percentage">
                            <i class="fas fa-percent mr-1"></i>ë°±ë¶„ìœ¨
                        </button>
                    </div>

                    <!-- ê¸°ë³¸ ê³„ì‚°ê¸° -->
                    <div id="calc-basic" class="calculator-container">
                        <div class="max-w-sm sm:max-w-md mx-auto bg-gray-200 p-4 sm:p-6 rounded-2xl shadow-2xl" style="background: linear-gradient(145deg, #e5e7eb, #d1d5db);">
                            <div id="basic-display" class="calculator-display" style="margin-bottom: 2rem;">0</div>
                            <div class="grid grid-cols-4 gap-3">
                                <button onclick="clearBasic()" class="calculator-btn calculator-btn-clear">C</button>
                                <button onclick="backspaceBasic()" class="calculator-btn"><i class="fas fa-backspace"></i></button>
                                <button onclick="appendToBasic('%')" class="calculator-btn calculator-btn-operator">%</button>
                                <button onclick="appendToBasic('/')" class="calculator-btn calculator-btn-operator">Ã·</button>
                                
                                <button onclick="appendToBasic('7')" class="calculator-btn">7</button>
                                <button onclick="appendToBasic('8')" class="calculator-btn">8</button>
                                <button onclick="appendToBasic('9')" class="calculator-btn">9</button>
                                <button onclick="appendToBasic('*')" class="calculator-btn calculator-btn-operator">Ã—</button>
                                
                                <button onclick="appendToBasic('4')" class="calculator-btn">4</button>
                                <button onclick="appendToBasic('5')" class="calculator-btn">5</button>
                                <button onclick="appendToBasic('6')" class="calculator-btn">6</button>
                                <button onclick="appendToBasic('-')" class="calculator-btn calculator-btn-operator">-</button>
                                
                                <button onclick="appendToBasic('1')" class="calculator-btn">1</button>
                                <button onclick="appendToBasic('2')" class="calculator-btn">2</button>
                                <button onclick="appendToBasic('3')" class="calculator-btn">3</button>
                                <button onclick="appendToBasic('+')" class="calculator-btn calculator-btn-operator">+</button>
                                
                                <button onclick="appendToBasic('0')" class="calculator-btn">0</button>
                                <button onclick="appendToBasic('00')" class="calculator-btn">00</button>
                                <button onclick="appendToBasic('.')" class="calculator-btn">.</button>
                                <button onclick="calculateBasic()" class="calculator-btn calculator-btn-equal">=</button>
                            </div>
                        </div>
                    </div>

                    <!-- ê³µí•™ ê³„ì‚°ê¸° -->
                    <div id="calc-scientific" class="calculator-container hidden">
                        <div class="max-w-md sm:max-w-lg lg:max-w-xl mx-auto bg-gray-200 p-4 sm:p-6 rounded-2xl shadow-2xl" style="background: linear-gradient(145deg, #e5e7eb, #d1d5db);">
                            <div id="scientific-display" class="calculator-display" style="margin-bottom: 2rem;">0</div>
                            <div class="grid grid-cols-5 gap-3">
                                <button onclick="clearScientific()" class="calculator-btn calculator-btn-clear">C</button>
                                <button onclick="scientificOperation('sin')" class="calculator-btn">sin</button>
                                <button onclick="scientificOperation('cos')" class="calculator-btn">cos</button>
                                <button onclick="scientificOperation('tan')" class="calculator-btn">tan</button>
                                <button onclick="backspaceScientific()" class="calculator-btn"><i class="fas fa-backspace"></i></button>
                                
                                <button onclick="scientificOperation('sqrt')" class="calculator-btn">âˆš</button>
                                <button onclick="scientificOperation('pow2')" class="calculator-btn">xÂ²</button>
                                <button onclick="scientificOperation('pow')" class="calculator-btn">xÊ¸</button>
                                <button onclick="scientificOperation('log')" class="calculator-btn">log</button>
                                <button onclick="scientificOperation('ln')" class="calculator-btn">ln</button>
                                
                                <button onclick="appendToScientific('7')" class="calculator-btn">7</button>
                                <button onclick="appendToScientific('8')" class="calculator-btn">8</button>
                                <button onclick="appendToScientific('9')" class="calculator-btn">9</button>
                                <button onclick="appendToScientific('/')" class="calculator-btn calculator-btn-operator">Ã·</button>
                                <button onclick="appendToScientific('(')" class="calculator-btn">(</button>
                                
                                <button onclick="appendToScientific('4')" class="calculator-btn">4</button>
                                <button onclick="appendToScientific('5')" class="calculator-btn">5</button>
                                <button onclick="appendToScientific('6')" class="calculator-btn">6</button>
                                <button onclick="appendToScientific('*')" class="calculator-btn calculator-btn-operator">Ã—</button>
                                <button onclick="appendToScientific(')')" class="calculator-btn">)</button>
                                
                                <button onclick="appendToScientific('1')" class="calculator-btn">1</button>
                                <button onclick="appendToScientific('2')" class="calculator-btn">2</button>
                                <button onclick="appendToScientific('3')" class="calculator-btn">3</button>
                                <button onclick="appendToScientific('-')" class="calculator-btn calculator-btn-operator">-</button>
                                <button onclick="scientificConstant('pi')" class="calculator-btn">Ï€</button>
                                
                                <button onclick="appendToScientific('0')" class="calculator-btn">0</button>
                                <button onclick="appendToScientific('00')" class="calculator-btn">00</button>
                                <button onclick="appendToScientific('.')" class="calculator-btn">.</button>
                                <button onclick="appendToScientific('+')" class="calculator-btn calculator-btn-operator">+</button>
                                <button onclick="calculateScientific()" class="calculator-btn calculator-btn-equal">=</button>
                            </div>
                        </div>
                    </div>

                    <!-- ëŒ€ì¶œ ê³„ì‚°ê¸° -->
                    <div id="calc-loan" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ëŒ€ì¶œ ìƒí™˜ ê³„ì‚°ê¸°</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì¶œ ê¸ˆì•¡ (ì›)</label>
                                    <input type="number" id="loan-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: 100000000" value="100000000">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ì—° ì´ììœ¨ (%)</label>
                                    <input type="number" id="loan-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: 3.5" value="3.5" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì¶œ ê¸°ê°„ (ë…„)</label>
                                    <input type="number" id="loan-years" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: 20" value="20">
                                </div>
                                <button onclick="calculateLoan()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="loan-result" class="hidden">
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-3 text-gray-800">ê³„ì‚° ê²°ê³¼</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì›” ìƒí™˜ì•¡:</span>
                                                <span id="monthly-payment" class="font-bold text-blue-600"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì´ ìƒí™˜ì•¡:</span>
                                                <span id="total-payment" class="font-bold text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì´ ì´ì:</span>
                                                <span id="total-interest" class="font-bold text-red-600"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BMI ê³„ì‚°ê¸° -->
                    <div id="calc-bmi" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">BMI (ì²´ì§ˆëŸ‰ì§€ìˆ˜) ê³„ì‚°ê¸°</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">í‚¤ (cm)</label>
                                    <input type="number" id="bmi-height" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: 170" value="170">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ëª¸ë¬´ê²Œ (kg)</label>
                                    <input type="number" id="bmi-weight" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: 70" value="70" step="0.1">
                                </div>
                                <button onclick="calculateBMI()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="bmi-result" class="hidden">
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-3 text-gray-800">ê³„ì‚° ê²°ê³¼</h4>
                                        <div class="space-y-2">
                                            <div class="text-center">
                                                <div class="text-3xl font-bold text-blue-600" id="bmi-value"></div>
                                                <div class="text-lg font-medium mt-2" id="bmi-category"></div>
                                            </div>
                                            <div class="mt-4 text-sm text-gray-600">
                                                <p class="font-medium mb-2">BMI ê¸°ì¤€:</p>
                                                <ul class="space-y-1">
                                                    <li>â€¢ ì €ì²´ì¤‘: 18.5 ë¯¸ë§Œ</li>
                                                    <li>â€¢ ì •ìƒ: 18.5 ~ 22.9</li>
                                                    <li>â€¢ ê³¼ì²´ì¤‘: 23.0 ~ 24.9</li>
                                                    <li>â€¢ ë¹„ë§Œ: 25.0 ì´ìƒ</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚˜ì´ ê³„ì‚°ê¸° -->
                    <div id="calc-age" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ë‚˜ì´ ê³„ì‚°ê¸°</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒë…„ì›”ì¼</label>
                                    <input type="date" id="age-birthdate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="1990-01-01">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ì¤€ ë‚ ì§œ (ì„ íƒì‚¬í•­)</label>
                                    <input type="date" id="age-target-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <button onclick="calculateAge()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="age-result" class="hidden">
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-3 text-gray-800">ê³„ì‚° ê²°ê³¼</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ë§Œ ë‚˜ì´:</span>
                                                <span id="age-full" class="font-bold text-blue-600"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì´ ì¼ìˆ˜:</span>
                                                <span id="age-days" class="font-bold text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ë‹¤ìŒ ìƒì¼ê¹Œì§€:</span>
                                                <span id="next-birthday" class="font-bold text-green-600"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚ ì§œ ê³„ì‚°ê¸° -->
                    <div id="calc-date" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ë‚ ì§œ ê³„ì‚°ê¸°</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                                    <input type="date" id="date-start" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œ ë‚ ì§œ</label>
                                    <input type="date" id="date-end" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <button onclick="calculateDateDiff()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ë‚ ì§œ ì°¨ì´ ê³„ì‚°
                                </button>
                                <div id="date-result" class="hidden">
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-3 text-gray-800">ê³„ì‚° ê²°ê³¼</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì´ ì¼ìˆ˜:</span>
                                                <span id="date-days" class="font-bold text-blue-600"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì£¼ ë‹¨ìœ„:</span>
                                                <span id="date-weeks" class="font-bold text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ì›” ë‹¨ìœ„:</span>
                                                <span id="date-months" class="font-bold text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">ë…„ ë‹¨ìœ„:</span>
                                                <span id="date-years" class="font-bold text-gray-800"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="my-6">
                                
                                <h4 class="font-bold text-gray-800 mb-3">ë‚ ì§œ ë”í•˜ê¸°/ë¹¼ê¸°</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ì¤€ ë‚ ì§œ</label>
                                    <input type="date" id="date-base" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ìˆ˜</label>
                                        <input type="number" id="date-add-days" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ì‚°</label>
                                        <select id="date-operation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="add">ë”í•˜ê¸° (+)</option>
                                            <option value="subtract">ë¹¼ê¸° (-)</option>
                                        </select>
                                    </div>
                                </div>
                                <button onclick="calculateDateAdd()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ë‚ ì§œ ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="date-add-result" class="hidden">
                                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-2 text-gray-800">ê²°ê³¼ ë‚ ì§œ</h4>
                                        <div class="text-2xl font-bold text-green-600" id="date-result-value"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‹¨ìœ„ ë³€í™˜ ê³„ì‚°ê¸° -->
                    <div id="calc-unit" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ë‹¨ìœ„ ë³€í™˜ ê³„ì‚°ê¸°</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ë³€í™˜ ì¢…ë¥˜</label>
                                    <select id="unit-type" onchange="updateUnitOptions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="length">ê¸¸ì´</option>
                                        <option value="weight">ë¬´ê²Œ</option>
                                        <option value="temperature">ì˜¨ë„</option>
                                        <option value="area">ë„“ì´</option>
                                        <option value="volume">ë¶€í”¼</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ë³€í™˜í•  ê°’</label>
                                    <input type="number" id="unit-value" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ìˆ«ì ì…ë ¥" value="1" step="0.01">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ì›ë˜ ë‹¨ìœ„</label>
                                        <select id="unit-from" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ë³€í™˜í•  ë‹¨ìœ„</label>
                                        <select id="unit-to" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </select>
                                    </div>
                                </div>
                                <button onclick="calculateUnit()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fas fa-calculator mr-2"></i>ë³€í™˜í•˜ê¸°
                                </button>
                                <div id="unit-result" class="hidden">
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h4 class="font-bold text-lg mb-2 text-gray-800">ë³€í™˜ ê²°ê³¼</h4>
                                        <div class="text-2xl font-bold text-blue-600" id="unit-result-value"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë°±ë¶„ìœ¨ ê³„ì‚°ê¸° -->
                    <div id="calc-percentage" class="calculator-container hidden">
                        <div class="max-w-2xl mx-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ë°±ë¶„ìœ¨ ê³„ì‚°ê¸°</h3>
                            
                            <!-- ë°±ë¶„ìœ¨ êµ¬í•˜ê¸° -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="font-bold text-gray-800 mb-3">AëŠ” Bì˜ ëª‡ %?</h4>
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <input type="number" id="pct-value-a" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="A ê°’" value="25">
                                    <input type="number" id="pct-value-b" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="B ê°’" value="100">
                                </div>
                                <button onclick="calculatePercentage1()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition">
                                    ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="pct-result-1" class="mt-3 hidden">
                                    <div class="bg-blue-100 p-3 rounded text-center">
                                        <span class="text-2xl font-bold text-blue-600" id="pct-result-1-value"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Aì˜ B% êµ¬í•˜ê¸° -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="font-bold text-gray-800 mb-3">Aì˜ B%ëŠ”?</h4>
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <input type="number" id="pct-base" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="A ê°’" value="100">
                                    <input type="number" id="pct-percent" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="B %" value="25">
                                </div>
                                <button onclick="calculatePercentage2()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition">
                                    ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="pct-result-2" class="mt-3 hidden">
                                    <div class="bg-blue-100 p-3 rounded text-center">
                                        <span class="text-2xl font-bold text-blue-600" id="pct-result-2-value"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- ì¦ê°€/ê°ì†Œìœ¨ êµ¬í•˜ê¸° -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3">ì¦ê°€/ê°ì†Œìœ¨ êµ¬í•˜ê¸°</h4>
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">ì›ë˜ ê°’</label>
                                        <input type="number" id="pct-original" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ì›ë˜ ê°’" value="100">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">ë°”ë€ ê°’</label>
                                        <input type="number" id="pct-new" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ë°”ë€ ê°’" value="150">
                                    </div>
                                </div>
                                <button onclick="calculatePercentage3()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition">
                                    ê³„ì‚°í•˜ê¸°
                                </button>
                                <div id="pct-result-3" class="mt-3 hidden">
                                    <div class="bg-blue-100 p-3 rounded">
                                        <div class="text-center">
                                            <span class="text-2xl font-bold text-blue-600" id="pct-result-3-value"></span>
                                        </div>
                                        <div class="text-sm text-gray-600 text-center mt-2" id="pct-result-3-desc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>



        <script>
            // ê³„ì‚°ê¸° ì „í™˜
            function showCalculator(type) {
                // ëª¨ë“  ê³„ì‚°ê¸° ìˆ¨ê¸°ê¸°
                document.querySelectorAll('.calculator-container').forEach(el => el.classList.add('hidden'));
                // ì„ íƒëœ ê³„ì‚°ê¸° í‘œì‹œ
                document.getElementById('calc-' + type).classList.remove('hidden');
                
                // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('tab-active', 'bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                });
                const activeTab = document.querySelector('[data-tab="' + type + '"]');
                activeTab.classList.add('tab-active', 'bg-blue-500', 'text-white');
                activeTab.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            }

            // ========== ê¸°ë³¸ ê³„ì‚°ê¸° ==========
            let basicExpression = '';
            
            function updateBasicDisplay() {
                const display = document.getElementById('basic-display');
                display.textContent = basicExpression || '0';
            }
            
            function appendToBasic(value) {
                basicExpression += value;
                updateBasicDisplay();
            }
            
            function clearBasic() {
                basicExpression = '';
                updateBasicDisplay();
            }
            
            function backspaceBasic() {
                basicExpression = basicExpression.slice(0, -1);
                updateBasicDisplay();
            }
            
            function calculateBasic() {
                try {
                    const result = eval(basicExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/'));
                    basicExpression = result.toString();
                    updateBasicDisplay();
                } catch (error) {
                    alert('ì˜¬ë°”ë¥¸ ìˆ˜ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                }
            }

            // ========== ê³µí•™ ê³„ì‚°ê¸° ==========
            let scientificExpression = '';
            
            function updateScientificDisplay() {
                const display = document.getElementById('scientific-display');
                display.textContent = scientificExpression || '0';
            }
            
            function appendToScientific(value) {
                scientificExpression += value;
                updateScientificDisplay();
            }
            
            function clearScientific() {
                scientificExpression = '';
                updateScientificDisplay();
            }
            
            function backspaceScientific() {
                scientificExpression = scientificExpression.slice(0, -1);
                updateScientificDisplay();
            }
            
            function scientificOperation(op) {
                const current = parseFloat(scientificExpression) || 0;
                let result;
                
                switch(op) {
                    case 'sin': result = Math.sin(current * Math.PI / 180); break;
                    case 'cos': result = Math.cos(current * Math.PI / 180); break;
                    case 'tan': result = Math.tan(current * Math.PI / 180); break;
                    case 'sqrt': result = Math.sqrt(current); break;
                    case 'pow2': result = Math.pow(current, 2); break;
                    case 'log': result = Math.log10(current); break;
                    case 'ln': result = Math.log(current); break;
                    case 'pow': scientificExpression += '^'; updateScientificDisplay(); return;
                }
                
                scientificExpression = result.toString();
                updateScientificDisplay();
            }
            
            function scientificConstant(constant) {
                if (constant === 'pi') {
                    scientificExpression += Math.PI.toString();
                } else if (constant === 'e') {
                    scientificExpression += Math.E.toString();
                }
                updateScientificDisplay();
            }
            
            function calculateScientific() {
                try {
                    let expr = scientificExpression
                        .replace(/Ã—/g, '*')
                        .replace(/Ã·/g, '/')
                        .replace(/\^/g, '**');
                    const result = eval(expr);
                    scientificExpression = result.toString();
                    updateScientificDisplay();
                } catch (error) {
                    alert('ì˜¬ë°”ë¥¸ ìˆ˜ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                }
            }

            // ========== ëŒ€ì¶œ ê³„ì‚°ê¸° ==========
            function calculateLoan() {
                const amount = parseFloat(document.getElementById('loan-amount').value);
                const rate = parseFloat(document.getElementById('loan-rate').value) / 100 / 12;
                const years = parseFloat(document.getElementById('loan-years').value);
                const months = years * 12;
                
                if (!amount || !rate || !years) {
                    alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const monthlyPayment = amount * (rate * Math.pow(1 + rate, months)) / (Math.pow(1 + rate, months) - 1);
                const totalPayment = monthlyPayment * months;
                const totalInterest = totalPayment - amount;
                
                document.getElementById('monthly-payment').textContent = monthlyPayment.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('total-payment').textContent = totalPayment.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('total-interest').textContent = totalInterest.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('loan-result').classList.remove('hidden');
            }

            // ========== BMI ê³„ì‚°ê¸° ==========
            function calculateBMI() {
                const height = parseFloat(document.getElementById('bmi-height').value) / 100;
                const weight = parseFloat(document.getElementById('bmi-weight').value);
                
                if (!height || !weight) {
                    alert('í‚¤ì™€ ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const bmi = weight / (height * height);
                let category, color;
                
                if (bmi < 18.5) {
                    category = 'ì €ì²´ì¤‘';
                    color = 'text-blue-600';
                } else if (bmi < 23) {
                    category = 'ì •ìƒ';
                    color = 'text-green-600';
                } else if (bmi < 25) {
                    category = 'ê³¼ì²´ì¤‘';
                    color = 'text-yellow-600';
                } else {
                    category = 'ë¹„ë§Œ';
                    color = 'text-red-600';
                }
                
                document.getElementById('bmi-value').textContent = bmi.toFixed(1);
                const categoryEl = document.getElementById('bmi-category');
                categoryEl.textContent = category;
                categoryEl.className = 'text-lg font-medium mt-2 ' + color;
                document.getElementById('bmi-result').classList.remove('hidden');
            }

            // ========== ë‚˜ì´ ê³„ì‚°ê¸° ==========
            function calculateAge() {
                const birthdate = new Date(document.getElementById('age-birthdate').value);
                const targetInput = document.getElementById('age-target-date').value;
                const targetDate = targetInput ? new Date(targetInput) : new Date();
                
                if (!birthdate || isNaN(birthdate.getTime())) {
                    alert('ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                let years = targetDate.getFullYear() - birthdate.getFullYear();
                let months = targetDate.getMonth() - birthdate.getMonth();
                let days = targetDate.getDate() - birthdate.getDate();
                
                if (days < 0) {
                    months--;
                    days += new Date(targetDate.getFullYear(), targetDate.getMonth(), 0).getDate();
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                const totalDays = Math.floor((targetDate - birthdate) / (1000 * 60 * 60 * 24));
                
                // ë‹¤ìŒ ìƒì¼ ê³„ì‚°
                const nextBirthday = new Date(targetDate.getFullYear(), birthdate.getMonth(), birthdate.getDate());
                if (nextBirthday < targetDate) {
                    nextBirthday.setFullYear(nextBirthday.getFullYear() + 1);
                }
                const daysToNextBirthday = Math.ceil((nextBirthday - targetDate) / (1000 * 60 * 60 * 24));
                
                document.getElementById('age-full').textContent = years + 'ë…„ ' + months + 'ê°œì›” ' + days + 'ì¼';
                document.getElementById('age-days').textContent = totalDays.toLocaleString('ko-KR') + 'ì¼';
                document.getElementById('next-birthday').textContent = daysToNextBirthday + 'ì¼ í›„';
                document.getElementById('age-result').classList.remove('hidden');
            }

            // ========== ë‚ ì§œ ê³„ì‚°ê¸° ==========
            function calculateDateDiff() {
                const start = new Date(document.getElementById('date-start').value);
                const end = new Date(document.getElementById('date-end').value);
                
                if (!start || !end || isNaN(start.getTime()) || isNaN(end.getTime())) {
                    alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffWeeks = Math.floor(diffDays / 7);
                const diffMonths = Math.floor(diffDays / 30.44);
                const diffYears = Math.floor(diffDays / 365.25);
                
                document.getElementById('date-days').textContent = diffDays.toLocaleString('ko-KR') + 'ì¼';
                document.getElementById('date-weeks').textContent = diffWeeks.toLocaleString('ko-KR') + 'ì£¼';
                document.getElementById('date-months').textContent = diffMonths.toLocaleString('ko-KR') + 'ê°œì›”';
                document.getElementById('date-years').textContent = diffYears.toLocaleString('ko-KR') + 'ë…„';
                document.getElementById('date-result').classList.remove('hidden');
            }
            
            function calculateDateAdd() {
                const base = new Date(document.getElementById('date-base').value);
                const days = parseInt(document.getElementById('date-add-days').value) || 0;
                const operation = document.getElementById('date-operation').value;
                
                if (!base || isNaN(base.getTime())) {
                    alert('ê¸°ì¤€ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const result = new Date(base);
                if (operation === 'add') {
                    result.setDate(result.getDate() + days);
                } else {
                    result.setDate(result.getDate() - days);
                }
                
                const year = result.getFullYear();
                const month = String(result.getMonth() + 1).padStart(2, '0');
                const day = String(result.getDate()).padStart(2, '0');
                
                document.getElementById('date-result-value').textContent = year + 'ë…„ ' + month + 'ì›” ' + day + 'ì¼';
                document.getElementById('date-add-result').classList.remove('hidden');
            }

            // ========== ë‹¨ìœ„ ë³€í™˜ ê³„ì‚°ê¸° ==========
            const unitData = {
                length: {
                    'ë°€ë¦¬ë¯¸í„° (mm)': 1,
                    'ì„¼í‹°ë¯¸í„° (cm)': 10,
                    'ë¯¸í„° (m)': 1000,
                    'í‚¬ë¡œë¯¸í„° (km)': 1000000,
                    'ì¸ì¹˜ (in)': 25.4,
                    'í”¼íŠ¸ (ft)': 304.8,
                    'ì•¼ë“œ (yd)': 914.4,
                    'ë§ˆì¼ (mi)': 1609344
                },
                weight: {
                    'ë°€ë¦¬ê·¸ë¨ (mg)': 1,
                    'ê·¸ë¨ (g)': 1000,
                    'í‚¬ë¡œê·¸ë¨ (kg)': 1000000,
                    'í†¤ (t)': 1000000000,
                    'ì˜¨ìŠ¤ (oz)': 28349.5,
                    'íŒŒìš´ë“œ (lb)': 453592
                },
                temperature: {
                    'ì„­ì”¨ (Â°C)': 'celsius',
                    'í™”ì”¨ (Â°F)': 'fahrenheit',
                    'ì¼ˆë¹ˆ (K)': 'kelvin'
                },
                area: {
                    'ì œê³±ë°€ë¦¬ë¯¸í„° (mmÂ²)': 1,
                    'ì œê³±ì„¼í‹°ë¯¸í„° (cmÂ²)': 100,
                    'ì œê³±ë¯¸í„° (mÂ²)': 1000000,
                    'í—¥íƒ€ë¥´ (ha)': 10000000000,
                    'ì œê³±í‚¬ë¡œë¯¸í„° (kmÂ²)': 1000000000000,
                    'í‰': 3305785,
                    'ì—ì´ì»¤ (acre)': 4046856422.4
                },
                volume: {
                    'ë°€ë¦¬ë¦¬í„° (mL)': 1,
                    'ë¦¬í„° (L)': 1000,
                    'ì„¸ì œê³±ë¯¸í„° (mÂ³)': 1000000,
                    'ê°¤ëŸ° (gal)': 3785.41,
                    'ì˜¨ìŠ¤ (fl oz)': 29.5735
                }
            };
            
            function updateUnitOptions() {
                const type = document.getElementById('unit-type').value;
                const units = unitData[type];
                const fromSelect = document.getElementById('unit-from');
                const toSelect = document.getElementById('unit-to');
                
                fromSelect.innerHTML = '';
                toSelect.innerHTML = '';
                
                for (const unit in units) {
                    fromSelect.innerHTML += '<option value="' + unit + '">' + unit + '</option>';
                    toSelect.innerHTML += '<option value="' + unit + '">' + unit + '</option>';
                }
            }
            
            function calculateUnit() {
                const type = document.getElementById('unit-type').value;
                const value = parseFloat(document.getElementById('unit-value').value);
                const fromUnit = document.getElementById('unit-from').value;
                const toUnit = document.getElementById('unit-to').value;
                
                if (!value && value !== 0) {
                    alert('ë³€í™˜í•  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                let result;
                
                if (type === 'temperature') {
                    result = convertTemperature(value, unitData.temperature[fromUnit], unitData.temperature[toUnit]);
                } else {
                    const units = unitData[type];
                    const baseValue = value * units[fromUnit];
                    result = baseValue / units[toUnit];
                }
                
                document.getElementById('unit-result-value').textContent = 
                    result.toLocaleString('ko-KR', {maximumFractionDigits: 6}) + ' ' + toUnit;
                document.getElementById('unit-result').classList.remove('hidden');
            }
            
            function convertTemperature(value, from, to) {
                let celsius;
                
                if (from === 'celsius') celsius = value;
                else if (from === 'fahrenheit') celsius = (value - 32) * 5/9;
                else if (from === 'kelvin') celsius = value - 273.15;
                
                if (to === 'celsius') return celsius;
                else if (to === 'fahrenheit') return celsius * 9/5 + 32;
                else if (to === 'kelvin') return celsius + 273.15;
            }

            // ========== ë°±ë¶„ìœ¨ ê³„ì‚°ê¸° ==========
            function calculatePercentage1() {
                const a = parseFloat(document.getElementById('pct-value-a').value);
                const b = parseFloat(document.getElementById('pct-value-b').value);
                
                if (!a && a !== 0 || !b && b !== 0) {
                    alert('ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const result = (a / b) * 100;
                document.getElementById('pct-result-1-value').textContent = result.toFixed(2) + '%';
                document.getElementById('pct-result-1').classList.remove('hidden');
            }
            
            function calculatePercentage2() {
                const base = parseFloat(document.getElementById('pct-base').value);
                const percent = parseFloat(document.getElementById('pct-percent').value);
                
                if (!base && base !== 0 || !percent && percent !== 0) {
                    alert('ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const result = (base * percent) / 100;
                document.getElementById('pct-result-2-value').textContent = result.toLocaleString('ko-KR');
                document.getElementById('pct-result-2').classList.remove('hidden');
            }
            
            function calculatePercentage3() {
                const original = parseFloat(document.getElementById('pct-original').value);
                const newValue = parseFloat(document.getElementById('pct-new').value);
                
                if (!original && original !== 0 || !newValue && newValue !== 0) {
                    alert('ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                const change = ((newValue - original) / original) * 100;
                const isIncrease = change > 0;
                
                document.getElementById('pct-result-3-value').textContent = 
                    (isIncrease ? '+' : '') + change.toFixed(2) + '%';
                document.getElementById('pct-result-3-desc').textContent = 
                    Math.abs(change).toFixed(2) + '% ' + (isIncrease ? 'ì¦ê°€' : 'ê°ì†Œ');
                document.getElementById('pct-result-3').classList.remove('hidden');
            }

            // ========== í‚¤ë³´ë“œ ì…ë ¥ ì§€ì› ==========
            document.addEventListener('keydown', function(event) {
                // í˜„ì¬ í™œì„±í™”ëœ ê³„ì‚°ê¸° í™•ì¸
                const activeCalc = document.querySelector('.calculator-container:not(.hidden)');
                if (!activeCalc) return;
                
                const isBasic = activeCalc.id === 'calc-basic';
                const isScientific = activeCalc.id === 'calc-scientific';
                
                // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ í‚¤ë³´ë“œ ì…ë ¥ ë¬´ì‹œ
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }
                
                const key = event.key;
                
                // ìˆ«ì í‚¤ (0-9)
                if (/^[0-9]$/.test(key)) {
                    event.preventDefault();
                    if (isBasic) appendToBasic(key);
                    if (isScientific) appendToScientific(key);
                }
                // ì—°ì‚°ì
                else if (key === '+') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('+');
                    if (isScientific) appendToScientific('+');
                }
                else if (key === '-') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('-');
                    if (isScientific) appendToScientific('-');
                }
                else if (key === '*') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('*');
                    if (isScientific) appendToScientific('*');
                }
                else if (key === '/') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('/');
                    if (isScientific) appendToScientific('/');
                }
                else if (key === '%') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('%');
                }
                else if (key === '.') {
                    event.preventDefault();
                    if (isBasic) appendToBasic('.');
                    if (isScientific) appendToScientific('.');
                }
                // ê´„í˜¸ (ê³µí•™ ê³„ì‚°ê¸°)
                else if (key === '(') {
                    event.preventDefault();
                    if (isScientific) appendToScientific('(');
                }
                else if (key === ')') {
                    event.preventDefault();
                    if (isScientific) appendToScientific(')');
                }
                // Enter = ê³„ì‚° ì‹¤í–‰
                else if (key === 'Enter') {
                    event.preventDefault();
                    if (isBasic) calculateBasic();
                    if (isScientific) calculateScientific();
                }
                // Escape ë˜ëŠ” c = í´ë¦¬ì–´
                else if (key === 'Escape' || key === 'c' || key === 'C') {
                    event.preventDefault();
                    if (isBasic) clearBasic();
                    if (isScientific) clearScientific();
                }
                // Backspace = í•œ ê¸€ì ì‚­ì œ
                else if (key === 'Backspace') {
                    event.preventDefault();
                    if (isBasic) backspaceBasic();
                    if (isScientific) backspaceScientific();
                }
            });
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            document.addEventListener('DOMContentLoaded', function() {
                updateUnitOptions();
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date-start').value = today;
                document.getElementById('date-end').value = today;
                document.getElementById('date-base').value = today;
            });
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}

    </body>
    </html>
  `)
})

// ==================== ê¸€ììˆ˜ & ë§ì¶¤ë²• ê²€ì‚¬ê¸° ====================
app.get('/lifestyle/text-checker', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬´ë£Œ ê¸€ììˆ˜ ì„¸ê¸° ë° ë§ì¶¤ë²• ê²€ì‚¬ê¸° - Faith Portal</title>
        <meta name="description" content="ì‹¤ì‹œê°„ ê¸€ììˆ˜ ì„¸ê¸°, ê³µë°± í¬í•¨/ì œì™¸, ë°”ì´íŠ¸ ê³„ì‚°, ë§ì¶¤ë²• ê²€ì‚¬ë¥¼ í•œë²ˆì—! ìì†Œì„œ, ë ˆí¬íŠ¸ ì‘ì„±ì— í•„ìˆ˜.">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .editor-toolbar {
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }
            .stat-card {
                background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                border: 2px solid #bfdbfe;
            }
            .spell-error {
                background-color: #fee2e2;
                border-bottom: 2px solid #ef4444;
                padding: 0 2px;
                cursor: pointer;
            }
            .spell-suggestion {
                background-color: #d1fae5;
                padding: 0 2px;
            }
            .mobile-stats-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                color: white;
                padding: 12px 16px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                z-index: 50;
                display: none;
            }
            @media (max-width: 1024px) {
                .mobile-stats-bar {
                    display: flex;
                }
                .desktop-stats {
                    display: none;
                }
                .mobile-editor-height {
                    height: 300px !important;
                    min-height: 250px;
                }
                .mobile-stats-card {
                    display: block !important;
                    margin-bottom: 1rem;
                }
                main {
                    padding-bottom: 110px !important; /* ëª¨ë°”ì¼ í•˜ë‹¨ ë°” ê³µê°„ í™•ë³´ */
                }
            }
            @media (max-width: 640px) {
                .editor-toolbar {
                    padding: 0.5rem;
                }
                .editor-toolbar button {
                    font-size: 0.75rem;
                    padding: 0.5rem 0.75rem;
                }
                main {
                    padding-left: 0.75rem;
                    padding-right: 0.75rem;
                }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50">
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'ê¸€ììˆ˜ & ë§ì¶¤ë²•'}
        ])}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 pb-24 lg:pb-8">
            <!-- Header -->
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-spell-check text-green-600"></i>
                        ê¸€ììˆ˜ ì„¸ê¸° & ë§ì¶¤ë²• ê²€ì‚¬
                    </h1>
                    <p class="text-gray-600 mt-2 flex items-center gap-2">
                        <i class="fas fa-lock text-green-500"></i>
                        ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ì— ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- Main Layout: 2 Column Split View -->
            <div class="flex flex-col lg:flex-row gap-6">
                
                <!-- Zone A: Left Editor -->
                <div class="flex-1 bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden flex flex-col">
                    <!-- Toolbar -->
                    <div class="editor-toolbar p-3 border-b border-gray-300 flex flex-wrap gap-2">
                        <button onclick="copyText()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 rounded-md transition border border-gray-300">
                            <i class="fas fa-copy"></i> ë³µì‚¬
                        </button>
                        <button onclick="clearText()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white hover:bg-red-50 hover:text-red-600 rounded-md transition border border-gray-300">
                            <i class="fas fa-trash-alt"></i> ì „ì²´ ì‚­ì œ
                        </button>
                        <button onclick="removeSpecialChars()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 rounded-md transition border border-gray-300">
                            <i class="fas fa-eraser"></i> íŠ¹ìˆ˜ë¬¸ì ì œê±°
                        </button>
                        <button onclick="removeEmojis()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 rounded-md transition border border-gray-300 ml-auto">
                            <i class="fas fa-smile"></i> ì´ëª¨ì§€ ì œê±°
                        </button>
                    </div>
                    
                    <!-- Text Area -->
                    <textarea
                        id="mainTextarea"
                        placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...

ìì†Œì„œ, ë ˆí¬íŠ¸, ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ë“± ì–´ë–¤ ê¸€ì´ë“  ì…ë ¥í•´ë³´ì„¸ìš”.
ì‹¤ì‹œê°„ìœ¼ë¡œ ê¸€ì ìˆ˜ë¥¼ ì„¸ê³ , ë§ì¶¤ë²•ì„ ê²€ì‚¬í•´ë“œë¦½ë‹ˆë‹¤."
                        class="w-full h-[350px] sm:h-[450px] lg:h-[500px] p-4 sm:p-6 resize-none focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm sm:text-base lg:text-lg leading-relaxed text-gray-800"
                        oninput="updateStats()"
                    ></textarea>
                </div>

                <!-- Zone B: Right Dashboard -->
                <div class="lg:w-[380px] space-y-4 desktop-stats">
                    
                    <!-- Stat Card -->
                    <div class="stat-card rounded-xl p-6 sticky top-4 shadow-lg">
                        <h3 class="text-sm font-bold text-blue-900 uppercase tracking-wide mb-4 flex items-center gap-2">
                            <i class="fas fa-chart-bar"></i> ì‹¤ì‹œê°„ ë¶„ì„
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-end border-b-2 border-blue-300 pb-3">
                                <span class="text-gray-700 font-medium">ê³µë°± í¬í•¨</span>
                                <span class="text-4xl font-bold text-blue-900">
                                    <span id="charWithSpace">0</span>
                                    <span class="text-sm font-normal text-gray-600 ml-1">ì</span>
                                </span>
                            </div>
                            <div class="flex justify-between items-end pb-2">
                                <span class="text-gray-600 text-sm">ê³µë°± ì œì™¸</span>
                                <span class="text-2xl font-semibold text-gray-700">
                                    <span id="charWithoutSpace">0</span>
                                    <span class="text-sm font-normal text-gray-500 ml-1">ì</span>
                                </span>
                            </div>
                            <div class="flex justify-between items-end pb-2">
                                <span class="text-gray-600 text-sm">ìš©ëŸ‰ (UTF-8)</span>
                                <span class="text-lg font-medium text-gray-600">
                                    <span id="byteCount">0</span>
                                    <span class="text-sm font-normal text-gray-500 ml-1">bytes</span>
                                </span>
                            </div>
                            <div class="flex justify-between items-end">
                                <span class="text-gray-600 text-sm">ì¤„ ë°”ê¿ˆ</span>
                                <span class="text-lg font-medium text-gray-600">
                                    <span id="lineCount">1</span>
                                    <span class="text-sm font-normal text-gray-500 ml-1">ì¤„</span>
                                </span>
                            </div>
                        </div>

                        <!-- Platform Options -->
                        <div class="mt-6 bg-white p-1 rounded-lg flex text-xs font-medium border-2 border-blue-200">
                            <button onclick="setPlatform('naver')" id="btn-naver" class="flex-1 py-2 rounded bg-blue-600 text-white shadow-sm transition">
                                ë„¤ì´ë²„/ì‚¬ëŒì¸
                            </button>
                            <button onclick="setPlatform('jobkorea')" id="btn-jobkorea" class="flex-1 py-2 hover:bg-gray-100 rounded transition text-gray-600">
                                ì¡ì½”ë¦¬ì•„
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            <i class="fas fa-info-circle"></i> í”Œë«í¼ë³„ ì¤„ë°”ê¿ˆ ê³„ì‚° ë°©ì‹ ì ìš©
                        </p>
                    </div>

                    <!-- Spell Check Card -->
                    <div class="bg-white rounded-xl p-6 border-2 border-gray-200 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-spell-check text-green-600"></i>
                                ë§ì¶¤ë²• ê²€ì‚¬
                            </h3>
                            <span id="spellStatus" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-medium">
                                ëŒ€ê¸° ì¤‘
                            </span>
                        </div>
                        
                        <div id="spellResult" class="text-center py-8 text-gray-400 text-sm bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <i class="fas fa-keyboard text-4xl mb-3 text-gray-300"></i>
                            <p>ê¸€ì„ ì…ë ¥í•˜ê³ <br/>ê²€ì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                        </div>

                        <button onclick="checkSpelling()" class="w-full mt-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 rounded-lg font-bold transition flex justify-center items-center gap-2 shadow-lg">
                            <i class="fas fa-wand-magic-sparkles"></i> ë§ì¶¤ë²• ê²€ì‚¬ ì‹œì‘
                        </button>

                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>ì•ˆë‚´:</strong> ë§ì¶¤ë²• ê²€ì‚¬ëŠ” ì°¸ê³ ìš©ì´ë©° 100% ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Fixed Bottom Stats Bar -->
            <div class="mobile-stats-bar justify-between items-center">
                <div class="flex items-center gap-4">
                    <div>
                        <span class="text-xs opacity-80">ê³µë°± í¬í•¨</span>
                        <div class="text-2xl font-bold">
                            <span id="mobileCharCount">0</span>ì
                        </div>
                    </div>
                    <div class="border-l border-white opacity-50 h-10"></div>
                    <div>
                        <span class="text-xs opacity-80">ê³µë°± ì œì™¸</span>
                        <div class="text-lg font-semibold">
                            <span id="mobileCharNoSpace">0</span>ì
                        </div>
                    </div>
                </div>
                <button onclick="checkSpelling()" class="bg-white text-blue-900 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-lg">
                    <i class="fas fa-check"></i> ê²€ì‚¬
                </button>
            </div>
        </main>

        <script>
            let currentPlatform = 'naver'; // ê¸°ë³¸ê°’: ë„¤ì´ë²„ ê¸°ì¤€

            // í”Œë«í¼ ì„ íƒ
            function setPlatform(platform) {
                currentPlatform = platform;
                document.getElementById('btn-naver').className = platform === 'naver' 
                    ? 'flex-1 py-2 rounded bg-blue-600 text-white shadow-sm transition'
                    : 'flex-1 py-2 hover:bg-gray-100 rounded transition text-gray-600';
                document.getElementById('btn-jobkorea').className = platform === 'jobkorea'
                    ? 'flex-1 py-2 rounded bg-blue-600 text-white shadow-sm transition'
                    : 'flex-1 py-2 hover:bg-gray-100 rounded transition text-gray-600';
                updateStats();
            }

            // ì‹¤ì‹œê°„ í†µê³„ ì—…ë°ì´íŠ¸
            function updateStats() {
                const text = document.getElementById('mainTextarea').value;
                
                // ê³µë°± í¬í•¨
                const charWithSpace = text.length;
                
                // ê³µë°± ì œì™¸
                const charWithoutSpace = text.replace(/\\s/g, '').length;
                
                // Byte ê³„ì‚° (UTF-8)
                const byteCount = new Blob([text]).size;
                
                // ì¤„ ìˆ˜ (í”Œë«í¼ë³„ ë‹¤ë¥´ê²Œ ê³„ì‚°)
                let lineCount;
                if (currentPlatform === 'jobkorea') {
                    // ì¡ì½”ë¦¬ì•„: \\r\\nì„ 2ìë¡œ ê³„ì‚°
                    lineCount = (text.match(/\\n/g) || []).length + 1;
                } else {
                    // ë„¤ì´ë²„/ì‚¬ëŒì¸: \\nì„ 1ìë¡œ ê³„ì‚°
                    lineCount = (text.match(/\\n/g) || []).length + 1;
                }
                
                // ë°ìŠ¤í¬í†±
                document.getElementById('charWithSpace').textContent = charWithSpace.toLocaleString();
                document.getElementById('charWithoutSpace').textContent = charWithoutSpace.toLocaleString();
                document.getElementById('byteCount').textContent = byteCount.toLocaleString();
                document.getElementById('lineCount').textContent = lineCount;
                
                // ëª¨ë°”ì¼
                document.getElementById('mobileCharCount').textContent = charWithSpace.toLocaleString();
                document.getElementById('mobileCharNoSpace').textContent = charWithoutSpace.toLocaleString();

                // LocalStorageì— ìë™ ì €ì¥
                localStorage.setItem('textChecker_content', text);
            }

            // ë³µì‚¬
            function copyText() {
                const textarea = document.getElementById('mainTextarea');
                textarea.select();
                document.execCommand('copy');
                showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }

            // ì „ì²´ ì‚­ì œ
            function clearText() {
                if (confirm('ì •ë§ë¡œ ëª¨ë“  ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    document.getElementById('mainTextarea').value = '';
                    updateStats();
                    localStorage.removeItem('textChecker_content');
                    showToast('ë‚´ìš©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }

            // íŠ¹ìˆ˜ë¬¸ì ì œê±°
            function removeSpecialChars() {
                const textarea = document.getElementById('mainTextarea');
                // HTML íƒœê·¸ì™€ íŠ¹ìˆ˜ë¬¸ì ì œê±° (í•œê¸€, ì˜ë¬¸, ìˆ«ì, ê³µë°±, ê¸°ë³¸ ë¬¸ì¥ë¶€í˜¸ë§Œ ë‚¨ê¹€)
                const cleaned = textarea.value.replace(/<[^>]*>/g, '').replace(/[^ê°€-í£a-zA-Z0-9\\s.,!?;:\\-()]/g, '');
                textarea.value = cleaned;
                updateStats();
                showToast('íŠ¹ìˆ˜ë¬¸ìê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            // ì´ëª¨ì§€ ì œê±°
            function removeEmojis() {
                const textarea = document.getElementById('mainTextarea');
                // ì´ëª¨ì§€ ìœ ë‹ˆì½”ë“œ ë²”ìœ„ ì œê±°
                const cleaned = textarea.value.replace(/[\\u{1F600}-\\u{1F64F}\\u{1F300}-\\u{1F5FF}\\u{1F680}-\\u{1F6FF}\\u{1F1E0}-\\u{1F1FF}\\u{2600}-\\u{26FF}\\u{2700}-\\u{27BF}]/gu, '');
                textarea.value = cleaned;
                updateStats();
                showToast('ì´ëª¨ì§€ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            // ë§ì¶¤ë²• ê²€ì‚¬ (ê°„ë‹¨í•œ ë¡œì§)
            function checkSpelling() {
                const text = document.getElementById('mainTextarea').value.trim();
                
                if (text.length === 0) {
                    showToast('ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                document.getElementById('spellStatus').textContent = 'ê²€ì‚¬ ì¤‘...';
                document.getElementById('spellStatus').className = 'text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-medium animate-pulse';

                // ê°„ë‹¨í•œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê²€ì‚¬ (ì‹¤ì œë¡œëŠ” ì„œë²„ API í•„ìš”)
                setTimeout(() => {
                    const errors = findSimpleErrors(text);
                    displaySpellResults(errors);
                }, 1000);
            }

            // í•œêµ­ì–´ ë§ì¶¤ë²• ê²€ì‚¬ (ëŒ€í­ ê°•í™”ëœ ë²„ì „)
            function findSimpleErrors(text) {
                const errors = [];
                const foundErrors = new Set(); // ì¤‘ë³µ ë°©ì§€
                
                // ê°„ë‹¨í•œ íŒ¨í„´ ê¸°ë°˜ ë§ì¶¤ë²• ê²€ì‚¬ (ì •ê·œì‹ í™œìš©)
                const patterns = [
                    // === ë„ì–´ì“°ê¸° ì˜¤ë¥˜ ===
                    { regex: /([ê°€-í£])ìˆ˜(ìˆ|ì—†|ë„ìˆ|ë„ì—†)/g, replacement: '$1 ìˆ˜ $2', type: 'ë„ì–´ì“°ê¸°', example: 'í• ìˆ˜ìˆ â†’ í•  ìˆ˜ ìˆ' },
                    { regex: /(ëª»|ì•ˆ)í• ìˆ˜/g, replacement: '$1 í•  ìˆ˜', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /([ê°€-í£])ê²ƒ(ê°™|ì´|ì„|ë„)/g, replacement: '$1 ê²ƒ $2', type: 'ë„ì–´ì“°ê¸°', example: 'í•˜ëŠ”ê²ƒ â†’ í•˜ëŠ” ê²ƒ' },
                    { regex: /([ê°€-í£])ë§Œ(í•˜|í¼)/g, replacement: '$1 ë§Œ$2', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /(í•˜ì§€|ë˜ì§€|ì˜¤ì§€|ê°€ì§€)ì•Š/g, replacement: '$1 ì•Š', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /([ê°€-í£])ë¿(ì´|ë§Œ)/g, replacement: '$1 ë¿$2', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /(ì´|ê·¸|ì €)ëŸ°ê²Œ/g, replacement: '$1ëŸ° ê²Œ', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /(í•œ|í•˜ëŠ”|í• |ëœ|ë |ë˜ëŠ”)ê²Œ/g, replacement: '$1 ê²Œ', type: 'ë„ì–´ì“°ê¸°' },
                    { regex: /(ì´ëŸ´|ì €ëŸ´|ê·¸ëŸ´)ìˆ˜ê°€/g, replacement: '$1 ìˆ˜ê°€', type: 'ë„ì–´ì“°ê¸°' },
                    
                    // === ë§ì¶¤ë²• ì˜¤ë¥˜: ë˜/ë¼ ===
                    { regex: /\bë˜ìš”\b/g, replacement: 'ë¼ìš”', type: 'ë§ì¶¤ë²•', example: 'ë˜ìš” â†’ ë¼ìš”' },
                    { regex: /\bì•ˆë¼\b/g, replacement: 'ì•ˆ ë¼', type: 'ë„ì–´ì“°ê¸°+ë§ì¶¤ë²•' },
                    { regex: /\bì•ˆë˜\b/g, replacement: 'ì•ˆ ë¼', type: 'ë„ì–´ì“°ê¸°+ë§ì¶¤ë²•' },
                    { regex: /\bë¬([ì–´|ë‹¤|ìŠµë‹ˆë‹¤|ë„¤ìš”])/g, replacement: 'ë$1', type: 'ë§ì¶¤ë²•', example: 'ë¬ì–´ â†’ ëì–´' },
                    { regex: /\bë˜ì—¬\b/g, replacement: 'ë¼', type: 'ë§ì¶¤ë²•' },
                    
                    // === ë§ì¶¤ë²• ì˜¤ë¥˜: ì›¬/ì™  ===
                    { regex: /\bì›¬ì§€\b/g, replacement: 'ì™ ì§€', type: 'ë§ì¶¤ë²•', example: 'ì›¬ì§€ â†’ ì™ ì§€' },
                    { regex: /\bì™ ë§Œí•˜ë©´\b/g, replacement: 'ì›¬ë§Œí•˜ë©´', type: 'ë§ì¶¤ë²•', example: 'ì™ ë§Œí•˜ë©´ â†’ ì›¬ë§Œí•˜ë©´' },
                    { regex: /\bì™ ì¼\b/g, replacement: 'ì›¬ì¼', type: 'ë§ì¶¤ë²•' },
                    
                    // === ë§ì¶¤ë²• ì˜¤ë¥˜: ìì£¼ í‹€ë¦¬ëŠ” ë‹¨ì–´ ===
                    { regex: /\bì–´ë–»í•´\b/g, replacement: 'ì–´ë–¡í•´', type: 'ë§ì¶¤ë²•', example: 'ì–´ë–»í•´ â†’ ì–´ë–¡í•´' },
                    { regex: /\bì–´ë–»ì¼€\b/g, replacement: 'ì–´ë–»ê²Œ', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bëª‡ì¼\b/g, replacement: 'ë©°ì¹ ', type: 'ë§ì¶¤ë²•', example: 'ëª‡ì¼ â†’ ë©°ì¹ ' },
                    { regex: /\bê¸ˆìƒˆ\b/g, replacement: 'ê¸ˆì„¸', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bê³°ë°©\b/g, replacement: 'ê¸ˆë°©', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bìˆë”°ê°€\b/g, replacement: 'ì´ë”°ê°€', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bë„“ì´ë‹¤\b/g, replacement: 'ë„“íˆë‹¤', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bê¸‰ìê¸°\b/g, replacement: 'ê°‘ìê¸°', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bê°‘ì‘ê¸°\b/g, replacement: 'ê°‘ìê¸°', type: 'ë§ì¶¤ë²•' },
                    { regex: /\bì„¤ë ˆì„\b/g, replacement: 'ì„¤ë ˜', type: 'ë§ì¶¤ë²•', example: 'ì„¤ë ˆì„ â†’ ì„¤ë ˜' },
                    
                    // === ë§ì¶¤ë²• ì˜¤ë¥˜: ~ë“ ì§€/~ë˜ì§€ ===
                    { regex: /\b([ê°€-í£]+)ë˜ì§€\s+([ê°€-í£]+)ë˜ì§€\b/g, replacement: '$1ë“ ì§€ $2ë“ ì§€', type: 'ë§ì¶¤ë²•', example: 'ê°€ë˜ì§€ ì˜¤ë˜ì§€ â†’ ê°€ë“ ì§€ ì˜¤ë“ ì§€' },
                    
                    // === ë§ì¶¤ë²• ì˜¤ë¥˜: ë¡œì„œ/ë¡œì¨ ===
                    { regex: /(ìê²©|ì…ì¥|ì—­í• |ì‹ ë¶„)([ìœ¼]?)ë¡œì¨\b/g, replacement: '$1$2ë¡œì„œ', type: 'ë§ì¶¤ë²•', example: 'í•™ìƒìœ¼ë¡œì¨ â†’ í•™ìƒìœ¼ë¡œì„œ' },
                    { regex: /(ìˆ˜ë‹¨|ë„êµ¬|ë°©ë²•)([ìœ¼]?)ë¡œì„œ\b/g, replacement: '$1$2ë¡œì¨', type: 'ë§ì¶¤ë²•', example: 'ë„êµ¬ë¡œì„œ â†’ ë„êµ¬ë¡œì¨' },
                ];
                
                // íŒ¨í„´ ê¸°ë°˜ ê²€ì‚¬
                patterns.forEach(pattern => {
                    const regex = new RegExp(pattern.regex.source, pattern.regex.flags);
                    let match;
                    
                    while ((match = regex.exec(text)) !== null) {
                        const wrongText = match[0];
                        let correctText = pattern.replacement;
                        
                        // $1, $2 ë“± ê·¸ë£¹ ì¹˜í™˜
                        for (let i = 1; i < match.length; i++) {
                            correctText = correctText.replace(new RegExp('\\$' + i, 'g'), match[i]);
                        }
                        
                        // ì´ë¯¸ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¶”ê°€
                        const key = wrongText + '_' + correctText;
                        if (!foundErrors.has(key) && wrongText !== correctText) {
                            errors.push({
                                wrong: wrongText,
                                correct: correctText,
                                type: pattern.type,
                                desc: pattern.example || ''
                            });
                            foundErrors.add(key);
                        }
                    }
                });

                return errors;
            }

            // ë§ì¶¤ë²• ê²°ê³¼ í‘œì‹œ
            function displaySpellResults(errors) {
                const resultDiv = document.getElementById('spellResult');
                const statusSpan = document.getElementById('spellStatus');

                if (errors.length === 0) {
                    statusSpan.textContent = 'ì˜¤ë¥˜ ì—†ìŒ';
                    statusSpan.className = 'text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium';
                    resultDiv.innerHTML = \`
                        <div class="text-center py-6">
                            <i class="fas fa-check-circle text-5xl text-green-500 mb-3"></i>
                            <p class="text-green-700 font-semibold">ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
                            <p class="text-gray-500 text-sm mt-2">ë§ì¶¤ë²•ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤.</p>
                        </div>
                    \`;
                } else {
                    statusSpan.textContent = \`\${errors.length}ê°œ ë°œê²¬\`;
                    statusSpan.className = 'text-xs bg-red-100 text-red-700 px-3 py-1 rounded-full font-medium';
                    
                    let html = '<div class="space-y-2">';
                    errors.forEach((error, index) => {
                        html += \`
                            <div class="flex items-start gap-2 p-3 bg-red-50 rounded-lg border border-red-200">
                                <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">
                                        <span class="spell-error">\${error.wrong}</span>
                                        <i class="fas fa-arrow-right mx-2 text-gray-400"></i>
                                        <span class="spell-suggestion">\${error.correct}</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded">\${error.type}</span>
                                        \${error.desc ? '<span class="ml-2 text-gray-500">Â· ' + error.desc + '</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        \`;
                    });
                    html += '</div>';
                    html += \`
                        <button onclick="autoFixAll()" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium transition">
                            <i class="fas fa-magic"></i> ëª¨ë“  ì˜¤ë¥˜ í•œ ë²ˆì— ìˆ˜ì •
                        </button>
                    \`;
                    resultDiv.innerHTML = html;
                }
            }

            // ëª¨ë“  ì˜¤ë¥˜ ìë™ ìˆ˜ì •
            function autoFixAll() {
                showToast('ìë™ ìˆ˜ì • ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
            }

            // Toast ë©”ì‹œì§€
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-24 lg:bottom-8 right-8 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl z-50 animate-bounce';
                toast.innerHTML = \`<i class="fas fa-check-circle mr-2"></i>\${message}\`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë‚´ìš© ë³µì›
            document.addEventListener('DOMContentLoaded', () => {
                const saved = localStorage.getItem('textChecker_content');
                if (saved) {
                    document.getElementById('mainTextarea').value = saved;
                    updateStats();
                    showToast('ì´ì „ì— ì‘ì„±í•˜ë˜ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                }
            });
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}

    </body>
    </html>
  `)
})

// ==================== ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ ====================
app.get('/lifestyle/youtube-download', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50" id="html-root">
        ${getCommonHeader('Lifestyle')}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ'}
        ])}

        <!-- ì„œë¸Œ ë©”ë‰´ -->
        ${getLifestyleMenu('/lifestyle/youtube-download')}

        <!-- ê´‘ê³  ë°°ë„ˆ -->
        <div class="bg-gradient-to-r from-yellow-400 via-red-400 to-pink-400 py-4">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                <div class="flex items-center justify-center space-x-4">
                    <i class="fas fa-ad text-white text-2xl"></i>
                    <p class="text-white font-bold text-lg">ê´‘ê³  ë°°ë„ˆ ì˜ì—­ - ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                    <i class="fas fa-ad text-white text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            <main class="w-full">
                    <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8">
                        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
                        <div class="mb-8">
                            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fab fa-youtube text-2xl text-white"></i>
                                </div>
                                ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ
                            </h1>
                            <p class="text-gray-600">ìœ íŠœë¸Œ ì˜ìƒ URLì„ ì…ë ¥í•˜ê³  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                        </div>

                        <!-- ë‹¤ìš´ë¡œë“œ í¼ -->
                        <div class="space-y-6">
                            <!-- URL ì…ë ¥ë€ -->
                            <div>
                                <label for="youtube-url" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-link mr-1"></i>
                                    ìœ íŠœë¸Œ URL
                                </label>
                                <input 
                                    type="text" 
                                    id="youtube-url" 
                                    placeholder="ì˜ˆ: https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all"
                                />
                                <p class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ìœ íŠœë¸Œ ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: youtube.com/watch?v=...)
                                </p>
                            </div>

                            <!-- í’ˆì§ˆ ì„ íƒ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-sliders-h mr-1"></i>
                                    í’ˆì§ˆ ì„ íƒ
                                </label>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <label class="flex items-center justify-center px-4 py-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-cyan-500 transition-all">
                                        <input type="radio" name="quality" value="highest" checked class="mr-2">
                                        <span class="text-sm font-medium">ìµœê³  í’ˆì§ˆ</span>
                                    </label>
                                    <label class="flex items-center justify-center px-4 py-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-cyan-500 transition-all">
                                        <input type="radio" name="quality" value="1080p" class="mr-2">
                                        <span class="text-sm font-medium">1080p</span>
                                    </label>
                                    <label class="flex items-center justify-center px-4 py-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-cyan-500 transition-all">
                                        <input type="radio" name="quality" value="720p" class="mr-2">
                                        <span class="text-sm font-medium">720p</span>
                                    </label>
                                    <label class="flex items-center justify-center px-4 py-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-cyan-500 transition-all">
                                        <input type="radio" name="quality" value="480p" class="mr-2">
                                        <span class="text-sm font-medium">480p</span>
                                    </label>
                                </div>
                            </div>

                            <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                            <button 
                                onclick="downloadVideo()" 
                                class="w-full py-4 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                <i class="fas fa-download mr-2"></i>
                                ë‹¤ìš´ë¡œë“œ
                            </button>

                            <!-- ìƒíƒœ ë©”ì‹œì§€ -->
                            <div id="status-message" class="hidden p-4 rounded-lg"></div>

                            <!-- ì§„í–‰ ìƒí™© -->
                            <div id="progress-container" class="hidden">
                                <div class="mb-2 flex justify-between text-sm">
                                    <span class="text-gray-600">ë‹¤ìš´ë¡œë“œ ì§„í–‰ ì¤‘...</span>
                                    <span id="progress-text" class="text-cyan-600 font-medium">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div id="progress-bar" class="h-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ì•ˆë‚´ ì‚¬í•­ -->
                        <div class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                ì‚¬ìš© ì•ˆë‚´
                            </h3>
                            <ul class="space-y-2 text-sm text-blue-700">
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle mr-2 mt-0.5"></i>
                                    <span>ê°œì¸ì ì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle mr-2 mt-0.5"></i>
                                    <span>ì €ì‘ê¶Œì´ ìˆëŠ” ì½˜í…ì¸ ì˜ ë¬´ë‹¨ ë‹¤ìš´ë¡œë“œëŠ” ë²•ì  ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check-circle mr-2 mt-0.5"></i>
                                    <span>ë‹¤ìš´ë¡œë“œ ì†ë„ëŠ” ì˜ìƒ í¬ê¸°ì™€ ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </main>
            </div>
        </div>



        <script>
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const token = localStorage.getItem('auth_token');
            const userEmail = localStorage.getItem('user_email');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (token && userEmail) {
                const userMenu = document.getElementById('user-menu');
                userMenu.innerHTML = \`
                    <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-blue-900 transition-all p-2" title="ë©”ë‰´ ì—´ê¸°">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <a href="/mypage" class="text-xs sm:text-sm text-gray-700 hover:text-blue-900 font-medium transition-all px-2 sm:px-3">
                        <i class="fas fa-user mr-0 sm:mr-1"></i><span class="hidden sm:inline">ë§ˆì´í˜ì´ì§€</span>
                    </a>
                    \${userLevel >= 6 ? '<a href="/admin" class="text-xs sm:text-sm bg-yellow-500 text-gray-900 px-2 sm:px-3 py-1.5 rounded font-medium hover:bg-yellow-600 transition-all"><i class="fas fa-crown mr-1"></i><span class="hidden sm:inline">ê´€ë¦¬ì</span></a>' : ''}
                    <button onclick="logout()" class="text-gray-700 hover:text-red-600 transition-all p-2" title="ë¡œê·¸ì•„ì›ƒ">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                \`;
            }
            
            function logout() {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_level');
                location.href = '/';
            }

            // ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
            async function downloadVideo() {
                const urlInput = document.getElementById('youtube-url');
                const url = urlInput.value.trim();
                const statusMessage = document.getElementById('status-message');
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                // ì…ë ¥ ê²€ì¦
                if (!url) {
                    showMessage('error', 'ìœ íŠœë¸Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                    showMessage('error', 'ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                // í’ˆì§ˆ ì„ íƒ
                const quality = document.querySelector('input[name="quality"]:checked').value;
                
                // ì§„í–‰ ìƒíƒœ í‘œì‹œ
                statusMessage.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                updateProgress(0);
                
                try {
                    // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                    updateProgress(10);
                    
                    // API í˜¸ì¶œ
                    const response = await fetch('/api/youtube/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url, quality })
                    });
                    
                    updateProgress(30);
                    
                    const data = await response.json();
                    console.log('API ì‘ë‹µ:', data);
                    
                    if (data.success && data.downloadUrl) {
                        // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
                        updateProgress(50);
                        await sleep(300);
                        updateProgress(70);
                        
                        // ë¹„ë””ì˜¤ ì •ë³´ í‘œì‹œ
                        let successMessage = '<div class="space-y-2">';
                        successMessage += '<div class="font-bold text-lg">âœ… ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ!</div>';
                        if (data.videoInfo) {
                            successMessage += '<div class="text-sm mt-2">';
                            successMessage += '<div><strong>ì œëª©:</strong> ' + (data.videoInfo.title || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</div>';
                            successMessage += '<div><strong>ì±„ë„:</strong> ' + (data.videoInfo.author || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</div>';
                            successMessage += '<div><strong>í™”ì§ˆ:</strong> ' + (data.quality || 'ê¸°ë³¸') + '</div>';
                            successMessage += '</div>';
                            
                            if (data.videoInfo.thumbnail) {
                                successMessage += '<img src="' + data.videoInfo.thumbnail + '" class="w-full max-w-xs rounded-lg mt-2" alt="ì¸ë„¤ì¼">';
                            }
                        }
                        successMessage += '<div class="text-sm mt-3 text-blue-600">ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤...</div>';
                        successMessage += '</div>';
                        
                        progressContainer.classList.add('hidden');
                        showMessage('success', successMessage);
                        
                        // ì ì‹œ í›„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘
                        await sleep(1000);
                        updateProgress(90);
                        
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const link = document.createElement('a');
                        link.href = data.downloadUrl;
                        link.download = data.videoInfo?.title ? data.videoInfo.title.replace(/[^a-zA-Z0-9ê°€-í£\\s]/g, '_') + '.mp4' : 'video.mp4';
                        link.target = '_blank'; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        updateProgress(100);
                        
                        // ì„±ê³µ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                        await sleep(500);
                        successMessage = '<div class="space-y-2">';
                        successMessage += '<div class="font-bold text-lg">âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</div>';
                        successMessage += '<div class="text-sm">íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ë‹¤ìš´ë¡œë“œ í´ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                        successMessage += '</div>';
                        showMessage('success', successMessage);
                        
                        urlInput.value = '';
                    } else {
                        // ì—ëŸ¬ ì²˜ë¦¬
                        progressContainer.classList.add('hidden');
                        
                        let errorMessage = '';
                        
                        if (data.errorType === 'REDIRECT_REQUIRED') {
                            // ì™¸ë¶€ ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤ ì•ˆë‚´
                            errorMessage = '<div class="space-y-4">';
                            errorMessage += '<div class="font-bold text-lg text-blue-600">' + (data.error || 'ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤ ì•ˆë‚´') + '</div>';
                            
                            if (data.videoInfo) {
                                errorMessage += '<div class="bg-gray-50 p-3 rounded-lg">';
                                if (data.videoInfo.thumbnail) {
                                    errorMessage += '<img src="' + data.videoInfo.thumbnail + '" class="w-full rounded mb-2" alt="ì¸ë„¤ì¼">';
                                }
                                errorMessage += '<div class="text-sm"><strong>ì œëª©:</strong> ' + data.videoInfo.title + '</div>';
                                errorMessage += '<div class="text-sm"><strong>ì±„ë„:</strong> ' + data.videoInfo.author + '</div>';
                                errorMessage += '</div>';
                            }
                            
                            if (data.message) {
                                errorMessage += '<div class="text-sm text-gray-700">' + data.message + '</div>';
                            }
                            
                            if (data.downloadServices && data.downloadServices.length > 0) {
                                errorMessage += '<div class="mt-3">';
                                errorMessage += '<div class="font-semibold mb-2">ğŸ’¡ ì¶”ì²œ ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤:</div>';
                                errorMessage += '<div class="space-y-2">';
                                data.downloadServices.forEach(service => {
                                    errorMessage += '<a href="' + service.url + '" target="_blank" class="block p-3 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition">';
                                    errorMessage += '<div class="font-medium text-blue-700">ğŸ”— ' + service.name + '</div>';
                                    errorMessage += '<div class="text-xs text-gray-600">' + service.description + '</div>';
                                    errorMessage += '</a>';
                                });
                                errorMessage += '</div></div>';
                            }
                            
                            if (data.alternativeMethod) {
                                errorMessage += '<div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200">';
                                errorMessage += '<div class="font-semibold text-purple-700 mb-2">ğŸ”Œ ' + data.alternativeMethod.title + '</div>';
                                errorMessage += '<div class="text-xs text-gray-600 mb-2">' + data.alternativeMethod.description + '</div>';
                                errorMessage += '<div class="flex gap-2 text-xs">';
                                errorMessage += '<a href="' + data.alternativeMethod.chromeExtension + '" target="_blank" class="text-blue-600 hover:underline">Chrome í™•ì¥</a>';
                                errorMessage += '<span class="text-gray-400">|</span>';
                                errorMessage += '<a href="' + data.alternativeMethod.firefoxExtension + '" target="_blank" class="text-blue-600 hover:underline">Firefox í™•ì¥</a>';
                                errorMessage += '</div></div>';
                            }
                            
                            errorMessage += '</div>';
                        } else if (data.errorType === 'NOT_IMPLEMENTED') {
                            // êµ¬í˜„ë˜ì§€ ì•Šì€ ê¸°ëŠ¥
                            errorMessage = '<div class="space-y-3">';
                            errorMessage += '<div class="font-bold text-lg">' + (data.error || 'ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”') + '</div>';
                            
                            if (data.details) {
                                errorMessage += '<div class="text-sm"><strong>ìƒíƒœ:</strong> ' + data.details.title + '</div>';
                                errorMessage += '<div class="text-sm"><strong>ì›ì¸:</strong> ' + data.details.reason + '</div>';
                                
                                if (data.details.limitations && data.details.limitations.length > 0) {
                                    errorMessage += '<div class="mt-2"><strong>ì œì•½ ì‚¬í•­:</strong><ul class="list-disc list-inside mt-1">';
                                    data.details.limitations.forEach(limitation => {
                                        errorMessage += '<li>' + limitation + '</li>';
                                    });
                                    errorMessage += '</ul></div>';
                                }
                                
                                if (data.details.solutions && data.details.solutions.length > 0) {
                                    errorMessage += '<div class="mt-3"><strong>êµ¬í˜„ ë°©ë²•:</strong>';
                                    data.details.solutions.forEach(solution => {
                                        errorMessage += '<div class="mt-2 pl-4 border-l-2 border-blue-400">';
                                        errorMessage += '<div class="font-medium">' + solution.method + '</div>';
                                        errorMessage += '<div class="text-xs mt-1">' + solution.description + '</div>';
                                        errorMessage += '<div class="text-xs mt-1">âœ… ' + solution.pros + ' / âš ï¸ ' + solution.cons + '</div>';
                                        errorMessage += '</div>';
                                    });
                                    errorMessage += '</div>';
                                }
                            }
                            
                            if (data.recommendations && data.recommendations.length > 0) {
                                errorMessage += '<div class="mt-3"><strong>ê¶Œì¥ ì‚¬í•­:</strong><ul class="list-disc list-inside mt-1">';
                                data.recommendations.forEach(rec => {
                                    errorMessage += '<li class="text-xs">' + rec + '</li>';
                                });
                                errorMessage += '</ul></div>';
                            }
                            
                            errorMessage += '</div>';
                        } else {
                            // ì¼ë°˜ ì—ëŸ¬
                            errorMessage = '<div>';
                            errorMessage += '<div class="font-bold mb-2">' + (data.error || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨') + '</div>';
                            if (data.message) {
                                errorMessage += '<div class="text-sm whitespace-pre-line">' + data.message + '</div>';
                            }
                            if (data.details) {
                                errorMessage += '<div class="text-xs mt-2 text-gray-600">ìƒì„¸: ' + JSON.stringify(data.details, null, 2) + '</div>';
                            }
                            errorMessage += '</div>';
                        }
                        
                        showMessage('error', errorMessage);
                    }
                } catch (error) {
                    console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    progressContainer.classList.add('hidden');
                    
                    let errorMessage = '<div>';
                    errorMessage += '<div class="font-bold mb-2">ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>';
                    errorMessage += '<div class="text-sm">ì˜¤ë¥˜ ë©”ì‹œì§€: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>';
                    errorMessage += '<div class="text-xs mt-2 text-gray-600">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
                    errorMessage += '</div>';
                    
                    showMessage('error', errorMessage);
                }
            }
            
            function updateProgress(percent) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
            
            function showMessage(type, message) {
                const statusMessage = document.getElementById('status-message');
                statusMessage.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'border-green-200', 'bg-red-50', 'text-red-700', 'border-red-200');
                
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
                    statusMessage.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + message;
                } else {
                    statusMessage.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
                    statusMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + message;
                }
            }
            
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Enter í‚¤ë¡œ ë‹¤ìš´ë¡œë“œ
            document.getElementById('youtube-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    downloadVideo();
                }
            });
        </script>

        ${getCommonFooter()}

    </body>
    </html>
  `)
})

// ==================== ìŠ¤ë§ˆíŠ¸ ë¶€ë™ì‚° í‰ìˆ˜ ê³„ì‚°ê¸° ====================
app.get('/lifestyle/pyeong-calculator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìŠ¤ë§ˆíŠ¸ ë¶€ë™ì‚° í‰ìˆ˜ ê³„ì‚°ê¸° - Faith Portal</title>
        <script>
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return;
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
            .quick-chip {
                transition: all 0.2s;
            }
            .quick-chip:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            .visual-card {
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50" id="html-root">
        ${getCommonAuthScript()}
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'í‰ìˆ˜ ê³„ì‚°ê¸°'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-4xl mx-auto px-3 sm:px-4 lg:px-6 py-6 space-y-6">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl mb-4">
                    <i class="fas fa-home text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                    ìŠ¤ë§ˆíŠ¸ ë¶€ë™ì‚° í‰ìˆ˜ ê³„ì‚°ê¸°
                </h1>
                <p class="text-gray-600 text-sm md:text-base max-w-2xl mx-auto">
                    ë¶€ë™ì‚° ë©´ì ì„ í‰ê³¼ mÂ²ë¡œ ë³€í™˜í•˜ê³ , í‰ë‹¹ ê°€ê²©ì„ ê³„ì‚°í•˜ë©°, ì‹¤ì œ í¬ê¸°ë¥¼ ëŠê»´ë³´ì„¸ìš”
                </p>
            </div>

            <!-- 1. ë³€í™˜ ê³„ì‚°ê¸° ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-exchange-alt text-xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ë©´ì  ë³€í™˜</h2>
                </div>

                <!-- ì…ë ¥ í•„ë“œ -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- mÂ² ì…ë ¥ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì œê³±ë¯¸í„° (mÂ²)
                        </label>
                        <div class="relative">
                            <input 
                                type="number" 
                                id="m2Input" 
                                placeholder="84"
                                class="w-full px-4 py-4 text-2xl font-bold border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                            >
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">mÂ²</span>
                        </div>
                    </div>

                    <!-- í‰ ì…ë ¥ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            í‰ (åª)
                        </label>
                        <div class="relative">
                            <input 
                                type="number" 
                                id="pyeongInput" 
                                placeholder="25.4"
                                class="w-full px-4 py-4 text-2xl font-bold border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                            >
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">í‰</span>
                        </div>
                    </div>
                </div>

                <!-- ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ -->
                <div class="mb-6">
                    <p class="text-sm font-medium text-gray-600 mb-3">ì£¼ìš” ì•„íŒŒíŠ¸ í‰í˜•</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                        <button onclick="setQuickValue(59)" class="quick-chip px-4 py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold rounded-xl border-2 border-blue-200">
                            <div class="text-xs text-blue-600">25í‰</div>
                            <div class="text-sm">59mÂ²</div>
                        </button>
                        <button onclick="setQuickValue(84)" class="quick-chip px-4 py-3 bg-purple-50 hover:bg-purple-100 text-purple-700 font-semibold rounded-xl border-2 border-purple-200">
                            <div class="text-xs text-purple-600">34í‰</div>
                            <div class="text-sm">84mÂ²</div>
                        </button>
                        <button onclick="setQuickValue(102)" class="quick-chip px-4 py-3 bg-pink-50 hover:bg-pink-100 text-pink-700 font-semibold rounded-xl border-2 border-pink-200">
                            <div class="text-xs text-pink-600">40í‰</div>
                            <div class="text-sm">102mÂ²</div>
                        </button>
                        <button onclick="setQuickValue(115)" class="quick-chip px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-semibold rounded-xl border-2 border-indigo-200">
                            <div class="text-xs text-indigo-600">45í‰</div>
                            <div class="text-sm">115mÂ²</div>
                        </button>
                        <button onclick="setQuickValue(133)" class="quick-chip px-4 py-3 bg-cyan-50 hover:bg-cyan-100 text-cyan-700 font-semibold rounded-xl border-2 border-cyan-200">
                            <div class="text-xs text-cyan-600">50í‰</div>
                            <div class="text-sm">133mÂ²</div>
                        </button>
                    </div>
                </div>

                <!-- ë³€í™˜ ê²°ê³¼ -->
                <div id="conversionResult" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
                    <div class="text-center">
                        <div class="text-4xl md:text-5xl font-bold text-blue-600 mb-2" id="resultValue">-</div>
                        <div class="text-gray-600 font-medium" id="resultLabel">-</div>
                    </div>
                </div>
            </div>

            <!-- 2. ê°€ê²© ê³„ì‚°ê¸° ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-won-sign text-xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">í‰ë‹¹ ê°€ê²© ê³„ì‚°</h2>
                </div>

                <div class="space-y-6">
                    <!-- ì´ ê°€ê²© ì…ë ¥ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì´ ê°€ê²© (ë§¤ë§¤ê°€/ì „ì„¸ê°€)
                        </label>
                        <div class="relative">
                            <input 
                                type="number" 
                                id="totalPrice" 
                                placeholder="1050000000"
                                class="w-full px-4 py-4 text-xl font-semibold border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition"
                            >
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">ì›</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ì˜ˆ: 10ì–µ 5ì²œë§Œì› = 1050000000</p>
                    </div>

                    <!-- ë©´ì  ì…ë ¥ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ë©´ì  (í‰ ë˜ëŠ” mÂ²)
                        </label>
                        <div class="flex gap-3">
                            <div class="flex-1 relative">
                                <input 
                                    type="number" 
                                    id="priceArea" 
                                    placeholder="34"
                                    class="w-full px-4 py-4 text-xl font-semibold border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition"
                                >
                            </div>
                            <select 
                                id="areaUnit" 
                                class="px-6 py-4 border-2 border-gray-300 rounded-xl font-medium focus:border-green-500 focus:outline-none transition"
                            >
                                <option value="pyeong">í‰</option>
                                <option value="m2">mÂ²</option>
                            </select>
                        </div>
                    </div>

                    <!-- ê³„ì‚° ë²„íŠ¼ -->
                    <button 
                        onclick="calculatePricePerPyeong()"
                        class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-lg"
                    >
                        <i class="fas fa-calculator mr-2"></i>
                        í‰ë‹¹ ê°€ê²© ê³„ì‚°í•˜ê¸°
                    </button>

                    <!-- ê°€ê²© ê³„ì‚° ê²°ê³¼ -->
                    <div id="priceResult" class="hidden space-y-4">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
                            <div class="text-center mb-4">
                                <div class="text-gray-600 text-sm mb-1">í‰ë‹¹ ê°€ê²©</div>
                                <div class="text-4xl md:text-5xl font-bold text-green-600" id="pricePerPyeong">-</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-500 text-xs mb-1">ì´ ê°€ê²©</div>
                                    <div class="font-bold text-gray-800" id="displayTotalPrice">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-3">
                                    <div class="text-gray-500 text-xs mb-1">ë©´ì </div>
                                    <div class="font-bold text-gray-800" id="displayArea">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- ë¹„êµ ì •ë³´ -->
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                            <div class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>ì°¸ê³ :</strong> <span id="priceComparison">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ë©´ì  ê°€ì´ë“œ ì¹´ë“œ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-ruler-combined text-xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ë©´ì  ê°€ì´ë“œ</h2>
                </div>

                <div class="space-y-6">
                    <!-- ì „ìš©ë©´ì  vs ê³µê¸‰ë©´ì  -->
                    <div class="visual-card rounded-xl p-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">
                            <i class="fas fa-building text-blue-600 mr-2"></i>
                            ì „ìš©ë©´ì  vs ê³µê¸‰ë©´ì 
                        </h3>
                        <div class="space-y-3 text-sm text-gray-700">
                            <div class="flex items-start">
                                <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-3 mt-1.5"></span>
                                <div>
                                    <strong class="text-blue-700">ì „ìš©ë©´ì :</strong> ì‹¤ì œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìˆœìˆ˜ ê±°ì£¼ ê³µê°„ (ë°©, ê±°ì‹¤, ì£¼ë°© ë“±)
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="inline-block w-2 h-2 bg-purple-500 rounded-full mr-3 mt-1.5"></span>
                                <div>
                                    <strong class="text-purple-700">ê³µê¸‰ë©´ì :</strong> ì „ìš©ë©´ì  + ë²½ ë‘ê»˜ + ê³„ë‹¨, ë³µë„ ë“± ê³µìš© ë¶€ë¶„
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-white rounded-lg border-2 border-blue-200">
                                <div class="text-xs text-gray-600 mb-2">ì‹¤ì œ ì˜ˆì‹œ</div>
                                <div class="font-semibold text-gray-800">
                                    "34í‰ ì•„íŒŒíŠ¸" = ë³´í†µ 84mÂ² ì „ìš©ë©´ì ì„ ì˜ë¯¸
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    ê³µê¸‰ë©´ì ì€ ì•½ 112mÂ² (ì „ìš©ë¥  75% ê¸°ì¤€)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì‹œê°ì  í¬ê¸° ë¹„êµ -->
                    <div id="visualComparison" class="hidden">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">
                            <i class="fas fa-eye text-green-600 mr-2"></i>
                            ì´ í¬ê¸°ëŠ” ì–´ëŠ ì •ë„ì¼ê¹Œìš”?
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-gradient-to-br from-pink-50 to-rose-50 rounded-xl p-5 border-2 border-pink-200">
                                <div class="text-3xl mb-2">ğŸ›ï¸</div>
                                <div class="font-bold text-gray-800 mb-1" id="bedComparison">-</div>
                                <div class="text-xs text-gray-600">í‚¹ì‚¬ì´ì¦ˆ ì¹¨ëŒ€ ê¸°ì¤€</div>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-5 border-2 border-yellow-200">
                                <div class="text-3xl mb-2">ğŸ€</div>
                                <div class="font-bold text-gray-800 mb-1" id="courtComparison">-</div>
                                <div class="text-xs text-gray-600">ë†êµ¬ ì½”íŠ¸ ê¸°ì¤€</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border-2 border-green-200">
                                <div class="text-3xl mb-2">ğŸ“</div>
                                <div class="font-bold text-gray-800 mb-1" id="dimensionEstimate">-</div>
                                <div class="text-xs text-gray-600">ëŒ€ëµì ì¸ í¬ê¸°</div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-5 border-2 border-blue-200">
                                <div class="text-3xl mb-2">ğŸ </div>
                                <div class="font-bold text-gray-800 mb-1" id="roomEstimate">-</div>
                                <div class="text-xs text-gray-600">ë°© êµ¬ì„± ì˜ˆìƒ</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë²•ì • ë‹¨ìœ„ ì•ˆë‚´ -->
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                        <div class="flex items-start">
                            <i class="fas fa-gavel text-gray-600 mr-3 mt-1"></i>
                            <div class="text-sm text-gray-700">
                                <strong class="text-gray-800">ë²•ì  ë‹¨ìœ„:</strong> 
                                ëŒ€í•œë¯¼êµ­ì—ì„œëŠ” 2007ë…„ë¶€í„° <strong class="text-blue-600">ì œê³±ë¯¸í„°(mÂ²)</strong>ê°€ ê³µì‹ ë²•ì • ë‹¨ìœ„ì…ë‹ˆë‹¤. 
                                'í‰'ì€ ê´€ìŠµì ìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ë§Œ ê³µì‹ ë¬¸ì„œì—ëŠ” mÂ²ë¡œ í‘œê¸°ë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ í™•ì¥ ì œì•ˆ -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl shadow-lg p-6 md:p-8 border-2 border-purple-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    ì´ëŸ° ì •ë³´ë„ í•„ìš”í•˜ì‹ ê°€ìš”?
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-2xl mb-2">ğŸšš</div>
                        <div class="font-semibold text-gray-800 mb-1">ì´ì‚¬/ì²­ì†Œ ê²¬ì </div>
                        <div class="text-xs text-gray-600">í‰ìˆ˜ì— ë§ëŠ” ì´ì‚¬ ë¹„ìš© í™•ì¸</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-2xl mb-2">ğŸ¨</div>
                        <div class="font-semibold text-gray-800 mb-1">ì¸í…Œë¦¬ì–´ ìì¬ ê³„ì‚°</div>
                        <div class="text-xs text-gray-600">ë²½ì§€, ì¥íŒ í•„ìš”ëŸ‰ ê³„ì‚°</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-2xl mb-2">ğŸ“°</div>
                        <div class="font-semibold text-gray-800 mb-1">ë¶€ë™ì‚° ë‰´ìŠ¤</div>
                        <div class="text-xs text-gray-600">ìµœì‹  ë¶€ë™ì‚° ì‹œì¥ ì •ë³´</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-2xl mb-2">ğŸ’°</div>
                        <div class="font-semibold text-gray-800 mb-1">ëŒ€ì¶œ ê³„ì‚°ê¸°</div>
                        <div class="text-xs text-gray-600">ì£¼íƒë‹´ë³´ëŒ€ì¶œ ì´ì ê³„ì‚°</div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // ë³€í™˜ ìƒìˆ˜
            const M2_TO_PYEONG = 0.3025;
            const PYEONG_TO_M2 = 3.3058;
            const KING_BED_SIZE = 4.05; // í‚¹ì‚¬ì´ì¦ˆ ì¹¨ëŒ€ ì•½ 4.05mÂ²
            const BASKETBALL_COURT = 420; // ë†êµ¬ ì½”íŠ¸ ì•½ 420mÂ²

            // mÂ² ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('m2Input').addEventListener('input', function(e) {
                const m2 = parseFloat(e.target.value);
                if (!isNaN(m2) && m2 > 0) {
                    const pyeong = (m2 * M2_TO_PYEONG).toFixed(2);
                    document.getElementById('pyeongInput').value = pyeong;
                    showConversionResult(pyeong, 'í‰', m2 + 'mÂ²ë¥¼ ë³€í™˜í•œ ê²°ê³¼');
                    updateVisualComparison(m2);
                } else {
                    clearResults();
                }
            });

            // í‰ ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('pyeongInput').addEventListener('input', function(e) {
                const pyeong = parseFloat(e.target.value);
                if (!isNaN(pyeong) && pyeong > 0) {
                    const m2 = (pyeong * PYEONG_TO_M2).toFixed(2);
                    document.getElementById('m2Input').value = m2;
                    showConversionResult(m2, 'mÂ²', pyeong + 'í‰ì„ ë³€í™˜í•œ ê²°ê³¼');
                    updateVisualComparison(parseFloat(m2));
                } else {
                    clearResults();
                }
            });

            // ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼
            function setQuickValue(m2) {
                document.getElementById('m2Input').value = m2;
                const pyeong = (m2 * M2_TO_PYEONG).toFixed(2);
                document.getElementById('pyeongInput').value = pyeong;
                showConversionResult(pyeong, 'í‰', m2 + 'mÂ²ë¥¼ ë³€í™˜í•œ ê²°ê³¼');
                updateVisualComparison(m2);
            }

            // ë³€í™˜ ê²°ê³¼ í‘œì‹œ
            function showConversionResult(value, unit, label) {
                const resultDiv = document.getElementById('conversionResult');
                resultDiv.classList.remove('hidden');
                document.getElementById('resultValue').textContent = value + ' ' + unit;
                document.getElementById('resultLabel').textContent = label;
            }

            // ì‹œê°ì  ë¹„êµ ì—…ë°ì´íŠ¸
            function updateVisualComparison(m2) {
                const comparisonDiv = document.getElementById('visualComparison');
                comparisonDiv.classList.remove('hidden');

                // í‚¹ì‚¬ì´ì¦ˆ ì¹¨ëŒ€ ë¹„êµ
                const beds = Math.floor(m2 / KING_BED_SIZE);
                document.getElementById('bedComparison').textContent = 
                    'í‚¹ì‚¬ì´ì¦ˆ ì¹¨ëŒ€ ì•½ ' + beds + 'ê°œ';

                // ë†êµ¬ ì½”íŠ¸ ë¹„êµ
                const courtPercent = ((m2 / BASKETBALL_COURT) * 100).toFixed(1);
                document.getElementById('courtComparison').textContent = 
                    'ë†êµ¬ ì½”íŠ¸ì˜ ' + courtPercent + '%';

                // ëŒ€ëµì ì¸ í¬ê¸°
                const sideLength = Math.sqrt(m2).toFixed(1);
                document.getElementById('dimensionEstimate').textContent = 
                    'ì•½ ' + sideLength + 'm Ã— ' + sideLength + 'm';

                // ë°© êµ¬ì„± ì˜ˆìƒ
                let roomEstimate = '';
                if (m2 < 50) {
                    roomEstimate = 'ì›ë£¸ ~ íˆ¬ë£¸';
                } else if (m2 < 70) {
                    roomEstimate = 'íˆ¬ë£¸ ~ ë°© 2ê°œ';
                } else if (m2 < 90) {
                    roomEstimate = 'ë°© 3ê°œ (25í‰ëŒ€)';
                } else if (m2 < 110) {
                    roomEstimate = 'ë°© 3~4ê°œ (34í‰ëŒ€)';
                } else if (m2 < 140) {
                    roomEstimate = 'ë°© 4ê°œ (40í‰ëŒ€)';
                } else {
                    roomEstimate = 'ë°© 4ê°œ ì´ìƒ (ëŒ€í˜•)';
                }
                document.getElementById('roomEstimate').textContent = roomEstimate;
            }

            // í‰ë‹¹ ê°€ê²© ê³„ì‚°
            function calculatePricePerPyeong() {
                const totalPrice = parseFloat(document.getElementById('totalPrice').value);
                const area = parseFloat(document.getElementById('priceArea').value);
                const unit = document.getElementById('areaUnit').value;

                if (isNaN(totalPrice) || isNaN(area) || totalPrice <= 0 || area <= 0) {
                    alert('ì´ ê°€ê²©ê³¼ ë©´ì ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // í‰ìœ¼ë¡œ ë³€í™˜
                const pyeongArea = unit === 'm2' ? area * M2_TO_PYEONG : area;
                const pricePerPyeong = totalPrice / pyeongArea;

                // ê²°ê³¼ í‘œì‹œ
                const resultDiv = document.getElementById('priceResult');
                resultDiv.classList.remove('hidden');

                // í‰ë‹¹ ê°€ê²©
                document.getElementById('pricePerPyeong').textContent = 
                    formatPrice(pricePerPyeong) + 'ì›/í‰';

                // ì´ ê°€ê²©
                document.getElementById('displayTotalPrice').textContent = 
                    formatPrice(totalPrice) + 'ì›';

                // ë©´ì 
                const m2Area = unit === 'pyeong' ? area * PYEONG_TO_M2 : area;
                document.getElementById('displayArea').textContent = 
                    pyeongArea.toFixed(1) + 'í‰ (' + m2Area.toFixed(1) + 'mÂ²)';

                // ë¹„êµ ì •ë³´
                let comparison = '';
                if (pricePerPyeong < 20000000) {
                    comparison = 'ë¹„êµì  ì €ë ´í•œ ê°€ê²©ëŒ€ì…ë‹ˆë‹¤';
                } else if (pricePerPyeong < 30000000) {
                    comparison = 'ì ì •í•œ ê°€ê²©ëŒ€ì…ë‹ˆë‹¤';
                } else if (pricePerPyeong < 50000000) {
                    comparison = 'ë‹¤ì†Œ ë†’ì€ ê°€ê²©ëŒ€ì…ë‹ˆë‹¤';
                } else {
                    comparison = 'ë§¤ìš° ë†’ì€ ê°€ê²©ëŒ€ì…ë‹ˆë‹¤';
                }
                document.getElementById('priceComparison').textContent = comparison;
            }

            // ê°€ê²© í¬ë§·íŒ…
            function formatPrice(price) {
                const eok = Math.floor(price / 100000000);
                const man = Math.floor((price % 100000000) / 10000);

                let result = '';
                if (eok > 0) {
                    result += eok + 'ì–µ';
                    if (man > 0) {
                        result += ' ' + man + 'ë§Œ';
                    }
                } else if (man > 0) {
                    result += man + 'ë§Œ';
                } else {
                    result = price.toLocaleString();
                }
                return result;
            }

            // ê²°ê³¼ ì´ˆê¸°í™”
            function clearResults() {
                document.getElementById('conversionResult').classList.add('hidden');
                document.getElementById('visualComparison').classList.add('hidden');
            }
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}

    </body>
    </html>
  `)
})

// ==================== ë‰´ìŠ¤ í˜ì´ì§€ ====================
app.get('/news', async (c) => {
  const { DB } = c.env
  
  // DBì—ì„œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
  let newsFromDB: any[] = []
  try {
    const { results } = await DB.prepare('SELECT * FROM news ORDER BY created_at DESC LIMIT 20').all()
    newsFromDB = results || []
  } catch (error) {
    console.error('ë‰´ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜:', error)
  }
  
  // DBì— ë‰´ìŠ¤ê°€ ì—†ìœ¼ë©´ RSSì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
  if (newsFromDB.length === 0) {
    try {
      const categories = ['general', 'politics', 'economy', 'tech', 'sports', 'entertainment']
      for (let i = 0; i < categories.length; i++) {
        const category = categories[i]
        const newsItems = await parseGoogleNewsRSS(category)
        for (const item of newsItems.slice(0, 5)) { // ì¹´í…Œê³ ë¦¬ë‹¹ 5ê°œ
          try {
            await DB.prepare(`
              INSERT OR IGNORE INTO news (category, title, summary, link, image_url, publisher, pub_date)
              VALUES (?, ?, ?, ?, ?, ?, ?)
            `).bind(
              item.category,
              item.title,
              item.summary,
              item.link,
              item.image_url,
              item.publisher,
              item.pub_date
            ).run()
          } catch (err) {
            console.error('ë‰´ìŠ¤ ì €ì¥ ì˜¤ë¥˜:', err)
          }
        }
        
        // êµ¬ê¸€ Rate Limit íšŒí”¼: ì¹´í…Œê³ ë¦¬ ê°„ 2ì´ˆ ì§€ì—° (ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬ ì œì™¸)
        if (i < categories.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 2000))
        }
      }
      // ë‹¤ì‹œ ì¡°íšŒ
      const { results } = await DB.prepare('SELECT * FROM news ORDER BY created_at DESC LIMIT 20').all()
      newsFromDB = results || []
    } catch (error) {
      console.error('RSS ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error)
    }
  }

  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë‰´ìŠ¤ - Faith Portal</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg">
        <link rel="alternate icon" href="/favicon.ico">
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = { darkMode: 'class' }
        </script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
            .news-card {
                transition: all 0.3s ease;
            }
            .news-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0,0,0,0.15);
            }
            .category-badge {
                transition: all 0.3s ease;
            }
            .category-badge:hover {
                transform: scale(1.05);
            }
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .line-clamp-3 {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .leading-snug {
                line-height: 1.4;
            }
            .leading-relaxed {
                line-height: 1.7;
            }
            /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
            .dark {
                color-scheme: dark;
            }
            .dark body {
                background: linear-gradient(to bottom right, #1e293b, #0f172a, #020617);
            }
            .dark .bg-white {
                background-color: #1e293b !important;
            }
            .dark .text-gray-900 {
                color: #f1f5f9 !important;
            }
            .dark .text-gray-800 {
                color: #e2e8f0 !important;
            }
            .dark .text-gray-700 {
                color: #cbd5e1 !important;
            }
            .dark .text-gray-600 {
                color: #94a3b8 !important;
            }
            .dark .text-gray-500 {
                color: #64748b !important;
            }
            .dark .border-gray-200 {
                border-color: #334155 !important;
            }
            .dark .bg-gray-100 {
                background-color: #334155 !important;
            }
            .dark .news-card {
                background-color: #1e293b;
                border: 1px solid #334155;
            }
            .dark .news-card:hover {
                background-color: #334155;
            }
            /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
            .toast {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                z-index: 9999;
                animation: slideInRight 0.3s ease-out;
            }
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            .toast.hiding {
                animation: slideOutRight 0.3s ease-in forwards;
            }
            /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
            .spinner {
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                width: 24px;
                height: 24px;
                animation: spin 0.6s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            /* ë¶ë§ˆí¬ ë²„íŠ¼ */
            .bookmark-btn {
                transition: all 0.2s;
            }
            .bookmark-btn:hover {
                transform: scale(1.1);
            }
            .bookmark-btn.bookmarked {
                color: #eab308;
            }
            /* íˆ¬í‘œ ë²„íŠ¼ */
            .vote-btn {
                transition: all 0.2s;
            }
            .vote-btn:hover {
                transform: scale(1.1);
            }
            .vote-btn:active {
                transform: scale(0.95);
            }
            /* ì‚¬ì´ë“œë°” ìŠ¤í¬ë¡¤ */
            aside {
                max-height: calc(100vh - 120px);
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 transition-colors duration-300">
        ${getCommonHeader('News')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ë‰´ìŠ¤'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸ : 3ë‹¨ ë ˆì´ì•„ì›ƒ (PC) / 1ë‹¨ ë ˆì´ì•„ì›ƒ (ëª¨ë°”ì¼) -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6 sm:py-8">
            
            <!-- ê²€ìƒ‰ ë°” -->
            <div class="mb-6 sm:mb-8">
                <div class="relative">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="ë‰´ìŠ¤ ê²€ìƒ‰..." 
                        class="w-full px-5 py-3 pl-12 rounded-xl border-2 border-gray-300 focus:border-purple-500 focus:outline-none text-gray-900 bg-white transition-all shadow-sm"
                    />
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <button 
                        id="clear-search" 
                        class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
                        onclick="clearSearch()"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ íƒ­ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥) -->
            <div class="mb-6 sm:mb-8">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-filter mr-2"></i>ì¹´í…Œê³ ë¦¬ í•„í„°
                    </h3>
                    <button onclick="clearCategoryFilter()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                        <i class="fas fa-redo mr-1"></i>ì´ˆê¸°í™”
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <div class="flex space-x-2 sm:space-x-3 pb-2 min-w-max">
                        <button onclick="toggleCategory('all')" data-category="all" class="category-btn active px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-blue-600 text-white font-medium text-sm sm:text-base shadow hover:bg-blue-700 transition">
                            ì „ì²´
                        </button>
                        <button onclick="toggleCategory('general')" data-category="general" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            ì¼ë°˜
                        </button>
                        <button onclick="toggleCategory('politics')" data-category="politics" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            ì •ì¹˜
                        </button>
                        <button onclick="toggleCategory('economy')" data-category="economy" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            ê²½ì œ
                        </button>
                        <button onclick="toggleCategory('tech')" data-category="tech" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            IT/ê³¼í•™
                        </button>
                        <button onclick="toggleCategory('sports')" data-category="sports" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            ìŠ¤í¬ì¸ 
                        </button>
                        <button onclick="toggleCategory('entertainment')" data-category="entertainment" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300">
                            ì—”í„°í…Œì¸ë¨¼íŠ¸
                        </button>
                    </div>
                </div>
            </div>

            <!-- ========== ëª¨ë°”ì¼ ìœ„ì ¯ íƒ­ (ëª¨ë°”ì¼ë§Œ í‘œì‹œ) ========== -->
            <div class="lg:hidden mb-6">
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <!-- íƒ­ í—¤ë” -->
                    <div class="flex border-b border-gray-200">
                        <button 
                            id="tab-hot" 
                            onclick="switchMobileTab('hot')" 
                            class="flex-1 py-4 px-4 font-semibold text-center transition-colors border-b-2 border-red-500 text-red-600"
                        >
                            <i class="fas fa-fire mr-2"></i>
                            HOT ì´ìŠˆ
                        </button>
                        <button 
                            id="tab-keyword" 
                            onclick="switchMobileTab('keyword')" 
                            class="flex-1 py-4 px-4 font-semibold text-center transition-colors border-b-2 border-transparent text-gray-500"
                        >
                            <i class="fas fa-bookmark mr-2"></i>
                            í‚¤ì›Œë“œ êµ¬ë…
                        </button>
                    </div>
                    
                    <!-- íƒ­ ì»¨í…ì¸  -->
                    <div class="p-5">
                        <!-- HOT ë‰´ìŠ¤ íƒ­ -->
                        <div id="mobile-hot-content" class="">
                            <div id="mobile-hot-news-list" class="space-y-3">
                                <p class="text-sm text-gray-500 text-center py-4">
                                    ë¡œë”© ì¤‘...
                                </p>
                            </div>
                            <button onclick="loadMoreHotNews()" class="w-full mt-4 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
                                <i class="fas fa-chevron-down mr-1"></i>
                                ë”ë³´ê¸°
                            </button>
                        </div>
                        
                        <!-- í‚¤ì›Œë“œ êµ¬ë… íƒ­ -->
                        <div id="mobile-keyword-content" class="hidden">
                            <!-- í‚¤ì›Œë“œ ì¶”ê°€ ì…ë ¥ -->
                            <div class="mb-4">
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="mobile-keyword-input" 
                                        placeholder="í‚¤ì›Œë“œ ì…ë ¥..." 
                                        class="w-full px-3 py-2 pr-10 rounded-lg border border-gray-300 focus:border-purple-500 focus:outline-none text-sm"
                                    />
                                    <button 
                                        onclick="addKeyword('mobile')" 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-purple-600 hover:text-purple-700"
                                        title="ì¶”ê°€"
                                    >
                                        <i class="fas fa-plus-circle text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- í‚¤ì›Œë“œ ëª©ë¡ -->
                            <div id="mobile-keyword-list" class="space-y-2 max-h-80 overflow-y-auto">
                                <p class="text-sm text-gray-500 text-center py-4">
                                    ì•„ì§ êµ¬ë…í•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 3ë‹¨ ë ˆì´ì•„ì›ƒ (PCë§Œ í‘œì‹œ) ========== -->
            <div class="hidden lg:flex lg:flex-row gap-6">
                
                <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: í‚¤ì›Œë“œ êµ¬ë… -->
                <aside class="lg:w-64 flex-shrink-0">
                    <div class="bg-white rounded-xl shadow-md p-5 sticky top-20">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-bookmark text-purple-600 mr-2"></i>
                            í‚¤ì›Œë“œ êµ¬ë…
                        </h3>
                        
                        <!-- í‚¤ì›Œë“œ ì¶”ê°€ ì…ë ¥ -->
                        <div class="mb-4">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="keyword-input" 
                                    placeholder="í‚¤ì›Œë“œ ì…ë ¥..." 
                                    class="w-full px-3 py-2 pr-10 rounded-lg border border-gray-300 focus:border-purple-500 focus:outline-none text-sm"
                                />
                                <button 
                                    onclick="addKeyword()" 
                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-purple-600 hover:text-purple-700"
                                    title="ì¶”ê°€"
                                >
                                    <i class="fas fa-plus-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- í‚¤ì›Œë“œ ëª©ë¡ -->
                        <div id="keyword-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-sm text-gray-500 text-center py-4">
                                ì•„ì§ êµ¬ë…í•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤
                            </p>
                        </div>
                    </div>
                </aside>

                <!-- ì¤‘ì•™ ì˜ì—­: ë‰´ìŠ¤ í”¼ë“œ -->
                <div class="flex-1 min-w-0">
                    <div id="news-feed" class="space-y-4">
                        <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë‰´ìŠ¤ ë¡œë“œë¨ -->
                        <div class="text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                            <p class="text-gray-500 mt-4 text-lg">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”: ì‹¤ì‹œê°„ HOT ì´ìŠˆ -->
                <aside class="lg:w-80 flex-shrink-0">
                    <div class="bg-white rounded-xl shadow-md p-5 sticky top-20">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-fire text-red-500 mr-2"></i>
                            ì‹¤ì‹œê°„ HOT ì´ìŠˆ
                        </h3>
                        
                        <!-- HOT ë‰´ìŠ¤ ëª©ë¡ -->
                        <div id="hot-news-list" class="space-y-3">
                            <p class="text-sm text-gray-500 text-center py-4">
                                ë¡œë”© ì¤‘...
                            </p>
                        </div>
                        
                        <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
                        <button onclick="loadMoreHotNews()" class="w-full mt-4 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-chevron-down mr-1"></i>
                            ë”ë³´ê¸°
                        </button>
                    </div>
                </aside>

            </div>
            
            <!-- ========== ëª¨ë°”ì¼ ë‰´ìŠ¤ í”¼ë“œ ========== -->
            <div class="lg:hidden">
                <div id="mobile-news-feed" class="space-y-4">
                    <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë‰´ìŠ¤ ë¡œë“œë¨ -->
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                        <p class="text-gray-500 mt-4 text-lg">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
            <div class="mt-8 sm:mt-12 text-center">
                <button onclick="fetchNewsAndReload()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold hover:shadow-lg transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>
                    ìµœì‹  ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                </button>
            </div>
        </main>

        <!-- ê³µìœ  ëª¨ë‹¬ -->
        <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-share-alt text-blue-500 mr-2"></i>
                        ë‰´ìŠ¤ ê³µìœ 
                    </h3>
                    <button onclick="closeShareModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <button onclick="shareToKakao()" class="w-full flex items-center justify-center space-x-3 px-6 py-4 bg-yellow-400 hover:bg-yellow-500 rounded-xl font-semibold text-gray-900 transition-all">
                        <i class="fas fa-comment text-xl"></i>
                        <span>ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ </span>
                    </button>
                    <button onclick="shareToFacebook()" class="w-full flex items-center justify-center space-x-3 px-6 py-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-semibold text-white transition-all">
                        <i class="fab fa-facebook-f text-xl"></i>
                        <span>í˜ì´ìŠ¤ë¶ìœ¼ë¡œ ê³µìœ </span>
                    </button>
                    <button onclick="shareToTwitter()" class="w-full flex items-center justify-center space-x-3 px-6 py-4 bg-sky-400 hover:bg-sky-500 rounded-xl font-semibold text-white transition-all">
                        <i class="fab fa-twitter text-xl"></i>
                        <span>íŠ¸ìœ„í„°ë¡œ ê³µìœ </span>
                    </button>
                    <button onclick="copyLink()" class="w-full flex items-center justify-center space-x-3 px-6 py-4 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold text-gray-900 transition-all">
                        <i class="fas fa-link text-xl"></i>
                        <span>ë§í¬ ë³µì‚¬</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

        ${getCommonFooter()}

        <script>
            // ==================== ì „ì—­ ë³€ìˆ˜ ====================
            const userId = localStorage.getItem('user_id') || '1'; // ì„ì‹œ ì‚¬ìš©ì ID
            let currentCategories = ['all']; // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë“¤
            let shareNewsData = {}; // ê³µìœ í•  ë‰´ìŠ¤ ë°ì´í„°
            let searchTimeout = null;
            let currentPage = 0; // í˜„ì¬ í˜ì´ì§€ (ë¬´í•œ ìŠ¤í¬ë¡¤ìš©)
            let isLoading = false; // ë¡œë”© ì¤‘ í”Œë˜ê·¸
            let hasMore = true; // ë” ë¶ˆëŸ¬ì˜¬ ë‰´ìŠ¤ê°€ ìˆëŠ”ì§€
            const ITEMS_PER_PAGE = 12; // í˜ì´ì§€ë‹¹ ì•„ì´í…œ ìˆ˜
            
            // ==================== í† ìŠ¤íŠ¸ ì•Œë¦¼ ====================
            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast bg-white shadow-lg rounded-lg p-4 flex items-center space-x-3 min-w-[300px]';
                
                const icons = {
                    success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                    error: '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>',
                    info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>',
                    warning: '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>'
                };
                
                toast.innerHTML = icons[type] + '<span class="text-gray-900 font-medium">' + message + '</span>';
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            // ==================== ê²€ìƒ‰ ê¸°ëŠ¥ ====================
            function initSearchAndKeyword() {
                const searchInput = document.getElementById('search-input');
                const clearSearchBtn = document.getElementById('clear-search');
                
                // ë°ìŠ¤í¬í†± í‚¤ì›Œë“œ ì…ë ¥ Enter í‚¤ ì´ë²¤íŠ¸
                const keywordInput = document.getElementById('keyword-input');
                if (keywordInput) {
                    keywordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addKeyword();
                        }
                    });
                }
                
                // ëª¨ë°”ì¼ í‚¤ì›Œë“œ ì…ë ¥ Enter í‚¤ ì´ë²¤íŠ¸
                const mobileKeywordInput = document.getElementById('mobile-keyword-input');
                if (mobileKeywordInput) {
                    mobileKeywordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addKeyword('mobile');
                        }
                    });
                }
                
                // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
                if (searchInput && clearSearchBtn) {
                    searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                if (query.length > 0) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                }
                
                // ë””ë°”ìš´ìŠ¤ ì ìš©
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (query.length >= 2) {
                        searchNews(query);
                    } else if (query.length === 0) {
                        loadNews();
                    }
                }, 500);
                    });
                }
            }
            
            async function searchNews(query) {
                const newsFeed = document.getElementById('news-feed');
                newsFeed.innerHTML = '<div class="text-center py-12"><div class="spinner mx-auto"></div><p class="text-gray-500 mt-4">ê²€ìƒ‰ ì¤‘...</p></div>';
                
                try {
                    const categoryParam = currentCategories.includes('all') ? '' : '&category=' + currentCategories[0];
                    const response = await fetch('/api/news/search?q=' + encodeURIComponent(query) + categoryParam);
                    const data = await response.json();
                    
                    if (data.success && data.news.length > 0) {
                        renderNewsCards(data.news);
                        showToast(data.news.length + 'ê°œì˜ ë‰´ìŠ¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤', 'success');
                    } else {
                        newsFeed.innerHTML = '<div class="text-center py-12"><i class="fas fa-search text-gray-300 text-6xl mb-4"></i><p class="text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                    }
                } catch (error) {
                    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                    newsFeed.innerHTML = '<div class="text-center py-12"><p class="text-red-500">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p></div>';
                }
            }
            
            function clearSearch() {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                currentPage = 0;
                hasMore = true;
                loadNews(true);
            }
            
            // ==================== ì¹´í…Œê³ ë¦¬ í•„í„° (ë‹¤ì¤‘ ì„ íƒ) ====================
            function toggleCategory(category) {
                if (category === 'all') {
                    currentCategories = ['all'];
                } else {
                    // 'all' ì œê±°
                    currentCategories = currentCategories.filter(c => c !== 'all');
                    
                    // ì¹´í…Œê³ ë¦¬ í† ê¸€
                    const index = currentCategories.indexOf(category);
                    if (index > -1) {
                        currentCategories.splice(index, 1);
                    } else {
                        currentCategories.push(category);
                    }
                    
                    // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆë˜ë©´ 'all'ë¡œ
                    if (currentCategories.length === 0) {
                        currentCategories = ['all'];
                    }
                }
                
                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                updateCategoryButtons();
                
                // ë‰´ìŠ¤ ë¡œë“œ (ë¦¬ì…‹)
                currentPage = 0;
                hasMore = true;
                loadNews(true);
            }
            
            function clearCategoryFilter() {
                currentCategories = ['all'];
                updateCategoryButtons();
                currentPage = 0;
                hasMore = true;
                loadNews(true);
                showToast('í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            }
            
            function updateCategoryButtons() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    const category = btn.dataset.category;
                    if (currentCategories.includes(category)) {
                        btn.className = 'category-btn active px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-blue-600 text-white font-medium text-sm sm:text-base shadow hover:bg-blue-700 transition';
                    } else {
                        btn.className = 'category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow border border-gray-300';
                    }
                });
            }
            
            // ==================== íˆ¬í‘œ ì‹œìŠ¤í…œ ====================
            function attachVoteListeners() {
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.stopPropagation(); // ë‰´ìŠ¤ ì¹´ë“œ í´ë¦­ ë°©ì§€
                        const newsId = this.dataset.newsId;
                        const voteType = this.dataset.voteType;
                        await handleVote(newsId, voteType);
                    });
                });
            }
            
            async function handleVote(newsId, voteType) {
                if (!userId) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch('/api/news/vote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: userId,
                            newsId: parseInt(newsId),
                            voteType: voteType
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('[íˆ¬í‘œ ì„±ê³µ]', 'newsId:', newsId, 'voteType:', voteType, 'vote_up:', data.vote_up, 'vote_down:', data.vote_down);
                        
                        // PC ë° ëª¨ë°”ì¼ í”¼ë“œ ëª¨ë‘ì—ì„œ í•´ë‹¹ ë‰´ìŠ¤ ì¹´ë“œ ì°¾ê¸°
                        const voteUpBtns = document.querySelectorAll('.vote-up-btn[data-news-id="' + newsId + '"]');
                        const voteDownBtns = document.querySelectorAll('.vote-down-btn[data-news-id="' + newsId + '"]');
                        
                        // UP ë²„íŠ¼ì˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                        voteUpBtns.forEach(btn => {
                            const countSpan = btn.querySelector('.vote-up-count');
                            if (countSpan) {
                                countSpan.textContent = data.vote_up;
                                console.log('[íˆ¬í‘œ UP ì¹´ìš´í„° ì—…ë°ì´íŠ¸]', countSpan.textContent);
                            }
                        });
                        
                        // DOWN ë²„íŠ¼ì˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
                        voteDownBtns.forEach(btn => {
                            const countSpan = btn.querySelector('.vote-down-count');
                            if (countSpan) {
                                countSpan.textContent = data.vote_down;
                                console.log('[íˆ¬í‘œ DOWN ì¹´ìš´í„° ì—…ë°ì´íŠ¸]', countSpan.textContent);
                            }
                        });
                        
                        showToast(voteType === 'up' ? 'ğŸ‘ ì¢‹ì•„ìš”!' : 'ğŸ‘ ë³„ë¡œì˜ˆìš”', 'success');
                    } else {
                        showToast(data.error || 'íˆ¬í‘œ ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    console.error('íˆ¬í‘œ ì˜¤ë¥˜:', error);
                    showToast('íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // ==================== ì‹¤ì‹œê°„ HOT ë‰´ìŠ¤ ====================
            async function loadHotNews() {
                const hotNewsList = document.getElementById('hot-news-list');
                const mobileHotNewsList = document.getElementById('mobile-hot-news-list');
                
                if (hotNewsList) hotNewsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ë¡œë”© ì¤‘...</p>';
                if (mobileHotNewsList) mobileHotNewsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ë¡œë”© ì¤‘...</p>';
                
                try {
                    const response = await fetch('/api/news/hot?limit=10');
                    const data = await response.json();
                    
                    if (data.success && data.news.length > 0) {
                        // ìµœëŒ€ê°’ ê³„ì‚° (ë§‰ëŒ€ ê·¸ë˜í”„ìš©)
                        const maxVotes = Math.max(...data.news.map(n => (n.vote_up || 0)));
                        
                        const hotHTML = data.news.map((news, index) => {
                            const rankClass = index < 3 ? 'text-red-500 font-bold' : 'text-gray-600';
                            const rankBgClass = index < 3 ? 'bg-gradient-to-r from-red-500 to-orange-500 text-white' : 'bg-gray-100 text-gray-700';
                            const escapedLink = escapeHtml(news.link).replace(/'/g, '&apos;');
                            
                            // ë³€ë™ ì•„ì´ì½˜ (ëœë¤ ì‹œë®¬ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” ì´ì „ ìˆœìœ„ ë°ì´í„° í•„ìš”)
                            const trendIcons = ['ğŸ”º', 'â–', 'ğŸ†•'];
                            const trendIcon = index < 3 ? 'ğŸ”º' : (index < 7 ? 'â–' : 'ğŸ†•');
                            
                            // ë§‰ëŒ€ ê·¸ë˜í”„ ë„ˆë¹„ ê³„ì‚°
                            const barWidth = maxVotes > 0 ? ((news.vote_up || 0) / maxVotes * 100) : 0;
                            
                            return '<div class="relative p-3 hover:bg-gradient-to-r hover:from-gray-50 hover:to-blue-50 rounded-lg transition-all cursor-pointer hot-news-item border-b border-gray-100 last:border-0" ' +
                                'data-news-link="' + escapedLink + '">' +
                                // ë§‰ëŒ€ ê·¸ë˜í”„ ë°°ê²½
                                '<div class="absolute inset-0 opacity-10 rounded-lg overflow-hidden">' +
                                    '<div class="h-full bg-gradient-to-r from-blue-400 to-purple-400" style="width: ' + barWidth + '%"></div>' +
                                '</div>' +
                                // ì»¨í…ì¸ 
                                '<div class="relative flex items-start space-x-3">' +
                                    // ìˆœìœ„ ë±ƒì§€
                                    '<div class="flex flex-col items-center space-y-1">' +
                                        '<span class="w-7 h-7 flex items-center justify-center rounded-full ' + rankBgClass + ' text-xs font-bold shadow-sm">' + (index + 1) + '</span>' +
                                        '<span class="text-xs">' + trendIcon + '</span>' +
                                    '</div>' +
                                    // ë‰´ìŠ¤ ì •ë³´
                                    '<div class="flex-1 min-w-0">' +
                                        '<h4 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-2 leading-tight">' + escapeHtml(news.title) + '</h4>' +
                                        '<div class="flex items-center space-x-3 text-xs text-gray-500">' +
                                            '<span class="flex items-center space-x-1 font-semibold text-blue-600">' +
                                                '<i class="fas fa-thumbs-up"></i>' +
                                                '<span>' + (news.vote_up || 0) + '</span>' +
                                            '</span>' +
                                            '<span class="flex items-center space-x-1">' +
                                                '<i class="fas fa-eye"></i>' +
                                                '<span>' + (news.view_count || 0) + '</span>' +
                                            '</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                        }).join('');
                        
                        if (hotNewsList) hotNewsList.innerHTML = hotHTML;
                        if (mobileHotNewsList) mobileHotNewsList.innerHTML = hotHTML;
                        
                        // HOT ë‰´ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                        document.querySelectorAll('.hot-news-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const link = this.getAttribute('data-news-link').replace(/&apos;/g, "'");
                                openNewsInNewTab(link);
                            });
                        });
                    } else {
                        const emptyMsg = '<p class="text-sm text-gray-500 text-center py-4">HOT ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                        if (hotNewsList) hotNewsList.innerHTML = emptyMsg;
                        if (mobileHotNewsList) mobileHotNewsList.innerHTML = emptyMsg;
                    }
                } catch (error) {
                    console.error('HOT ë‰´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
                    const errorMsg = '<p class="text-sm text-red-500 text-center py-4">ë¡œë“œ ì‹¤íŒ¨</p>';
                    if (hotNewsList) hotNewsList.innerHTML = errorMsg;
                    if (mobileHotNewsList) mobileHotNewsList.innerHTML = errorMsg;
                }
            }
            
            function loadMoreHotNews() {
                showToast('ë” ë§ì€ HOT ë‰´ìŠ¤ ì¤€ë¹„ ì¤‘...', 'info');
            }
            
            // ==================== ëª¨ë°”ì¼ íƒ­ ì „í™˜ ====================
            function switchMobileTab(tab) {
                const hotTab = document.getElementById('tab-hot');
                const keywordTab = document.getElementById('tab-keyword');
                const hotContent = document.getElementById('mobile-hot-content');
                const keywordContent = document.getElementById('mobile-keyword-content');
                
                if (tab === 'hot') {
                    hotTab.classList.add('border-red-500', 'text-red-600');
                    hotTab.classList.remove('border-transparent', 'text-gray-500');
                    keywordTab.classList.remove('border-purple-500', 'text-purple-600');
                    keywordTab.classList.add('border-transparent', 'text-gray-500');
                    hotContent.classList.remove('hidden');
                    keywordContent.classList.add('hidden');
                } else {
                    keywordTab.classList.add('border-purple-500', 'text-purple-600');
                    keywordTab.classList.remove('border-transparent', 'text-gray-500');
                    hotTab.classList.remove('border-red-500', 'text-red-600');
                    hotTab.classList.add('border-transparent', 'text-gray-500');
                    keywordContent.classList.remove('hidden');
                    hotContent.classList.add('hidden');
                }
            }
            
            // ==================== í‚¤ì›Œë“œ êµ¬ë… ì‹œìŠ¤í…œ ====================
            async function addKeyword(device = 'desktop') {
                const inputId = device === 'mobile' ? 'mobile-keyword-input' : 'keyword-input';
                const input = document.getElementById(inputId);
                const keyword = input.value.trim();
                
                if (!keyword) {
                    showToast('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
                    return;
                }
                
                if (!userId) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch('/api/keywords/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: userId,
                            keyword: keyword
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        input.value = '';
                        showToast('í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        loadKeywords();
                    } else {
                        showToast(data.error || 'í‚¤ì›Œë“œ ì¶”ê°€ ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    console.error('í‚¤ì›Œë“œ ì¶”ê°€ ì˜¤ë¥˜:', error);
                    showToast('í‚¤ì›Œë“œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            async function loadKeywords() {
                if (!userId) return;
                
                const keywordList = document.getElementById('keyword-list');
                const mobileKeywordList = document.getElementById('mobile-keyword-list');
                
                try {
                    const response = await fetch('/api/keywords?userId=' + userId);
                    const data = await response.json();
                    
                    if (data.success && data.keywords.length > 0) {
                        const keywordsHTML = data.keywords.map(kw => {
                            return '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition">' +
                                '<span class="text-sm font-medium text-gray-700">' + escapeHtml(kw.keyword) + '</span>' +
                                '<button onclick="removeKeyword(' + kw.id + ')" class="text-red-500 hover:text-red-700 text-sm" title="ì‚­ì œ">' +
                                    '<i class="fas fa-times"></i>' +
                                '</button>' +
                            '</div>';
                        }).join('');
                        
                        if (keywordList) keywordList.innerHTML = keywordsHTML;
                        if (mobileKeywordList) mobileKeywordList.innerHTML = keywordsHTML;
                    } else {
                        const emptyMsg = '<p class="text-sm text-gray-500 text-center py-4">ì•„ì§ êµ¬ë…í•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                        if (keywordList) keywordList.innerHTML = emptyMsg;
                        if (mobileKeywordList) mobileKeywordList.innerHTML = emptyMsg;
                    }
                } catch (error) {
                    console.error('í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
            
            async function removeKeyword(keywordId) {
                if (!userId) return;
                
                try {
                    const response = await fetch('/api/keywords/' + keywordId, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showToast('í‚¤ì›Œë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                        loadKeywords();
                    } else {
                        showToast(data.error || 'í‚¤ì›Œë“œ ì‚­ì œ ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    console.error('í‚¤ì›Œë“œ ì‚­ì œ ì˜¤ë¥˜:', error);
                    showToast('í‚¤ì›Œë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // ==================== ë‰´ìŠ¤ ë¡œë“œ (ë¬´í•œ ìŠ¤í¬ë¡¤ ì§€ì›) ====================
            async function loadNews(reset = true) {
                console.log('[loadNews] ì‹œì‘ - reset:', reset);
                if (isLoading) {
                    console.log('[loadNews] ì´ë¯¸ ë¡œë”© ì¤‘');
                    return;
                }
                if (!reset && !hasMore) {
                    console.log('[loadNews] ë” ì´ìƒ ë‰´ìŠ¤ ì—†ìŒ');
                    return;
                }
                
                isLoading = true;
                const newsFeed = document.getElementById('news-feed');
                const mobileNewsFeed = document.getElementById('mobile-news-feed');
                console.log('[loadNews] newsFeed:', newsFeed ? 'ì°¾ìŒ' : 'ëª»ì°¾ìŒ');
                console.log('[loadNews] mobileNewsFeed:', mobileNewsFeed ? 'ì°¾ìŒ' : 'ëª»ì°¾ìŒ');
                
                if (reset) {
                    currentPage = 0;
                    hasMore = true;
                    const loadingHTML = '<div class="text-center py-12"><div class="spinner mx-auto"></div><p class="text-gray-500 mt-4">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
                    if (newsFeed) newsFeed.innerHTML = loadingHTML;
                    if (mobileNewsFeed) mobileNewsFeed.innerHTML = loadingHTML;
                } else {
                    // ë¡œë”© ì¸ë””ì¼€ì´í„° ì¶”ê°€
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'loading-more';
                    loadingDiv.className = 'text-center py-6';
                    loadingDiv.innerHTML = '<div class="spinner mx-auto"></div><p class="text-gray-500 mt-2">ë” ë§ì€ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                    if (newsFeed) newsFeed.appendChild(loadingDiv);
                    if (mobileNewsFeed) mobileNewsFeed.appendChild(loadingDiv.cloneNode(true));
                }
                
                try {
                    const offset = currentPage * ITEMS_PER_PAGE;
                    let url = '/api/news?limit=' + ITEMS_PER_PAGE + '&offset=' + offset;
                    if (!currentCategories.includes('all')) {
                        url += '&category=' + currentCategories[0];
                    }
                    
                    console.log('[loadNews] API í˜¸ì¶œ:', url);
                    const response = await fetch(url);
                    console.log('[loadNews] ì‘ë‹µ ë°›ìŒ:', response.status);
                    const data = await response.json();
                    console.log('[loadNews] ë°ì´í„° íŒŒì‹±:', data.success, 'ë‰´ìŠ¤ ìˆ˜:', data.news ? data.news.length : 0);
                    
                    if (data.success) {
                        if (data.news.length > 0) {
                            renderNewsCards(data.news, !reset);
                            currentPage++;
                            
                            // ë” ë¶ˆëŸ¬ì˜¬ ë‰´ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
                            if (data.news.length < ITEMS_PER_PAGE) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                            if (reset) {
                                newsFeed.innerHTML = '<div class="text-center py-12"><p class="text-gray-500">ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                            }
                        }
                    } else {
                        throw new Error('API ì‘ë‹µ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('ë‰´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (reset) {
                        const errorHTML = '<div class="text-center py-12">' +
                            '<i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-4"></i>' +
                            '<p class="text-gray-700 font-semibold mb-2">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>' +
                            '<p class="text-gray-500 text-sm mb-4">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</p>' +
                            '<button onclick="location.reload()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">' +
                            '<i class="fas fa-redo mr-2"></i>ìƒˆë¡œê³ ì¹¨' +
                            '</button>' +
                            '</div>';
                        if (newsFeed) newsFeed.innerHTML = errorHTML;
                        if (mobileNewsFeed) mobileNewsFeed.innerHTML = errorHTML;
                    } else {
                        showToast('ì¶”ê°€ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    }
                } finally {
                    isLoading = false;
                    const loadingMore = document.getElementById('loading-more');
                    if (loadingMore) loadingMore.remove();
                }
            }
            
            // ==================== ë‰´ìŠ¤ ì¹´ë“œ ë Œë”ë§ (ìƒˆë¡œìš´ í”¼ë“œ ìŠ¤íƒ€ì¼, append ëª¨ë“œ ì§€ì›) ====================
            function renderNewsCards(newsList, append = false) {
                console.log('[renderNewsCards] ì‹œì‘ - ë‰´ìŠ¤ ìˆ˜:', newsList.length, 'append:', append);
                const newsFeed = document.getElementById('news-feed');
                const mobileNewsFeed = document.getElementById('mobile-news-feed');
                
                // ì¹´í…Œê³ ë¦¬ í•œê¸€ ë§¤í•‘
                const categoryMap = {
                    'general': 'ì¼ë°˜',
                    'politics': 'ì •ì¹˜',
                    'economy': 'ê²½ì œ',
                    'tech': 'IT/ê³¼í•™',
                    'sports': 'ìŠ¤í¬ì¸ ',
                    'entertainment': 'ì—°ì˜ˆ',
                    'world': 'êµ­ì œ',
                    'culture': 'ë¬¸í™”'
                };
                
                // ìƒëŒ€ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
                function getRelativeTime(dateStr) {
                    const now = new Date();
                    const date = new Date(dateStr);
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
                    if (diffMins < 60) return diffMins + 'ë¶„ ì „';
                    if (diffHours < 24) return diffHours + 'ì‹œê°„ ì „';
                    if (diffDays === 1) return 'ì–´ì œ';
                    if (diffDays < 7) return diffDays + 'ì¼ ì „';
                    return date.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' });
                }
                
                const newsHTML = newsList.map(news => {
                    // ì œëª©ì—ì„œ ì–¸ë¡ ì‚¬ ë¶„ë¦¬
                    let cleanTitle = news.title;
                    let extractedPublisher = 'êµ¬ê¸€ ë‰´ìŠ¤';  // ê¸°ë³¸ê°’
                    const publisherMatch = news.title.match(/\\s*-\\s*([ê°€-í£a-zA-Z0-9\\s]+)$/);
                    if (publisherMatch) {
                        cleanTitle = news.title.replace(/\\s*-\\s*[ê°€-í£a-zA-Z0-9\\s]+$/, '').trim();
                        extractedPublisher = publisherMatch[1].trim();
                    }
                    
                    // HTML í‘œì‹œìš© (ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
                    const titleDisplay = escapeHtml(cleanTitle);
                    const categoryKr = categoryMap[news.category] || escapeHtml(news.category);
                    const publisherDisplay = escapeHtml(extractedPublisher);
                    const summaryDisplay = escapeHtml(news.summary || 'ìš”ì•½ ì—†ìŒ');
                    const aiSummaryDisplay = news.ai_summary ? escapeHtml(news.ai_summary) : null;
                    const sentiment = news.sentiment || 'neutral';
                    const sentimentIcon = sentiment === 'positive' ? 'ğŸ˜Š' : sentiment === 'negative' ? 'ğŸ˜' : 'ğŸ˜';
                    const sentimentText = sentiment === 'positive' ? 'ê¸ì •' : sentiment === 'negative' ? 'ë¶€ì •' : 'ì¤‘ë¦½';
                    const sentimentColor = sentiment === 'positive' ? 'text-green-600' : sentiment === 'negative' ? 'text-red-600' : 'text-gray-600';
                    const voteUp = news.vote_up || 0;
                    const voteDown = news.vote_down || 0;
                    const viewCount = news.view_count || 0;
                    const relativeTime = getRelativeTime(news.created_at);
                    
                    return '<article class="news-card bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl relative p-5" data-news-id="' + news.id + '">' +
                        // ì¹´í…Œê³ ë¦¬ & ë‚ ì§œ & AI ë±ƒì§€
                        '<div class="flex items-center justify-between mb-3">' +
                            '<div class="flex items-center space-x-2">' +
                                '<span class="px-3 py-1 bg-blue-50 text-blue-700 text-xs font-semibold rounded-md border border-blue-200">' + categoryKr + '</span>' +
                                (aiSummaryDisplay ? '<span class="px-2 py-1 bg-gradient-to-r from-purple-500 to-blue-500 text-white text-xs font-bold rounded-md">âœ¨ AI</span>' : '') +
                            '</div>' +
                            '<span class="text-xs text-gray-500 font-medium">' + relativeTime + '</span>' +
                        '</div>' +
                        
                        // ì œëª© (í´ë¦­ ê°€ëŠ¥)
                        '<div class="cursor-pointer news-clickable-area mb-3" data-news-url="' + escapeHtml(news.link) + '" data-news-id="' + news.id + '">' +
                            '<h3 class="font-bold text-lg text-gray-900 mb-2 hover:text-purple-600 transition">' + titleDisplay + '</h3>' +
                        '</div>' +
                        
                        // AI ìš”ì•½ (ìˆëŠ” ê²½ìš°) - ê°œì„ ëœ ë””ìì¸
                        (aiSummaryDisplay ? 
                            '<div class="mb-4 p-4 bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 border-l-4 border-purple-500 rounded-lg shadow-sm">' +
                                '<div class="flex items-center justify-between mb-2">' +
                                    '<div class="flex items-center">' +
                                        '<i class="fas fa-robot text-purple-600 mr-2 text-lg"></i>' +
                                        '<span class="text-xs font-bold text-purple-700">ğŸ¤– AI 3ì¤„ ë¸Œë¦¬í•‘</span>' +
                                    '</div>' +
                                    '<div class="flex items-center space-x-1">' +
                                        '<span class="text-lg">' + sentimentIcon + '</span>' +
                                        '<span class="text-xs font-semibold ' + sentimentColor + '">' + sentimentText + '</span>' +
                                    '</div>' +
                                '</div>' +
                                '<p class="text-sm text-gray-800 leading-relaxed font-medium">' + aiSummaryDisplay + '</p>' +
                            '</div>' 
                            : 
                            '<div class="mb-3 p-3 bg-gray-50 rounded-lg">' +
                                '<p class="text-sm text-gray-600 leading-relaxed line-clamp-3">' + summaryDisplay + '</p>' +
                            '</div>'
                        ) +
                        
                        // í•˜ë‹¨ ì•¡ì…˜ ë°” (íˆ¬í‘œ + ì¡°íšŒìˆ˜ + ë¶ë§ˆí¬ + ê³µìœ )
                        '<div class="flex items-center justify-between pt-4 border-t border-gray-200">' +
                            // ì™¼ìª½: íˆ¬í‘œ + ì¡°íšŒìˆ˜ (ê°•ì¡°ëœ ë””ìì¸)
                            '<div class="flex items-center space-x-3">' +
                                // íˆ¬í‘œ UP (í¬ê¸° í™•ëŒ€ + íŒŒë€ìƒ‰)
                                '<button class="vote-btn vote-up-btn flex items-center space-x-2 px-3 py-2 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700 transition-all transform hover:scale-105" ' +
                                    'data-news-id="' + news.id + '" data-vote-type="up" title="ì¢‹ì•„ìš”">' +
                                    '<i class="fas fa-thumbs-up text-lg"></i>' +
                                    '<span class="text-base font-bold vote-up-count">' + voteUp + '</span>' +
                                '</button>' +
                                // íˆ¬í‘œ DOWN (í¬ê¸° í™•ëŒ€ + ë¹¨ê°„ìƒ‰)
                                '<button class="vote-btn vote-down-btn flex items-center space-x-2 px-3 py-2 rounded-lg bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 transition-all transform hover:scale-105" ' +
                                    'data-news-id="' + news.id + '" data-vote-type="down" title="ì‹«ì–´ìš”">' +
                                    '<i class="fas fa-thumbs-down text-lg"></i>' +
                                    '<span class="text-base font-bold vote-down-count">' + voteDown + '</span>' +
                                '</button>' +
                                // ì¡°íšŒìˆ˜
                                '<span class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-50 text-gray-600">' +
                                    '<i class="fas fa-eye text-base"></i>' +
                                    '<span class="text-sm font-semibold view-count-display">' + viewCount + '</span>' +
                                '</span>' +
                            '</div>' +
                            
                            // ì˜¤ë¥¸ìª½: ë¶ë§ˆí¬ + ê³µìœ  + ì¶œì²˜
                            '<div class="flex items-center space-x-3 text-sm">' +
                                '<span class="text-gray-500 hidden sm:flex items-center">' +
                                    '<i class="fas fa-newspaper mr-1"></i>' + publisherDisplay +
                                '</span>' +
                                '<button class="bookmark-btn text-gray-400 hover:text-yellow-500" ' +
                                    'data-news-id="' + news.id + '" ' +
                                    'data-news-title="' + escapeHtml(news.title) + '" ' +
                                    'data-news-link="' + escapeHtml(news.link) + '" ' +
                                    'data-news-category="' + escapeHtml(news.category) + '" ' +
                                    'data-news-publisher="' + publisherDisplay + '" ' +
                                    'data-news-pubdate="' + escapeHtml(news.pub_date || news.created_at) + '">' +
                                    '<i class="fas fa-bookmark"></i>' +
                                '</button>' +
                                '<button class="share-btn text-gray-400 hover:text-blue-500" ' +
                                    'data-news-id="' + news.id + '" ' +
                                    'data-news-title="' + escapeHtml(news.title) + '" ' +
                                    'data-news-link="' + escapeHtml(news.link) + '">' +
                                    '<i class="fas fa-share-alt"></i>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</article>';
                }).join('');
                
                if (append) {
                    if (newsFeed) newsFeed.insertAdjacentHTML('beforeend', newsHTML);
                    if (mobileNewsFeed) mobileNewsFeed.insertAdjacentHTML('beforeend', newsHTML);
                } else {
                    if (newsFeed) newsFeed.innerHTML = newsHTML;
                    if (mobileNewsFeed) mobileNewsFeed.innerHTML = newsHTML;
                }
                
                // ë‰´ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                attachNewsClickListeners();
                
                // ë¶ë§ˆí¬/ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                attachBookmarkAndShareListeners();
                
                // íˆ¬í‘œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                attachVoteListeners();
                
                // ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸
                checkBookmarkStatus();
            }
            
            // ==================== ë‰´ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ====================
            function attachNewsClickListeners() {
                document.querySelectorAll('.news-clickable-area').forEach(element => {
                    element.addEventListener('click', function(e) {
                        const url = this.getAttribute('data-news-url');
                        const newsId = this.getAttribute('data-news-id');
                        if (url) {
                            console.log('[ë‰´ìŠ¤ í´ë¦­] URL:', url, 'newsId:', newsId);
                            
                            // ì¡°íšŒìˆ˜ ì¦ê°€
                            if (newsId) {
                                incrementViewCount(newsId);
                            }
                            
                            openNewsInNewTab(url);
                        }
                    });
                });
            }
            
            // ==================== ì¡°íšŒìˆ˜ ì¦ê°€ ====================
            async function incrementViewCount(newsId) {
                try {
                    const response = await fetch('/api/news/' + newsId + '/view', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('[ì¡°íšŒìˆ˜ ì¦ê°€] newsId:', newsId, 'view_count:', data.view_count);
                        
                        // UI ì—…ë°ì´íŠ¸ - PC ë° ëª¨ë°”ì¼ í”¼ë“œ ëª¨ë‘
                        const viewCountElements = document.querySelectorAll('.news-card[data-news-id="' + newsId + '"] .view-count-display');
                        viewCountElements.forEach(element => {
                            element.textContent = data.view_count;
                        });
                    }
                } catch (error) {
                    console.error('ì¡°íšŒìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error);
                }
            }
            
            // ==================== ë¶ë§ˆí¬/ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ====================
            function attachBookmarkAndShareListeners() {
                // ë¶ë§ˆí¬ ë²„íŠ¼ ì´ë²¤íŠ¸
                document.querySelectorAll('.bookmark-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // ë‰´ìŠ¤ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                        const newsId = this.getAttribute('data-news-id');
                        const title = this.getAttribute('data-news-title');
                        const link = this.getAttribute('data-news-link');
                        const category = this.getAttribute('data-news-category');
                        const publisher = this.getAttribute('data-news-publisher');
                        const pubDate = this.getAttribute('data-news-pubdate');
                        toggleBookmark(newsId, title, link, category, publisher, pubDate);
                    });
                });
                
                // ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸
                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // ë‰´ìŠ¤ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                        const newsId = this.getAttribute('data-news-id');
                        const title = this.getAttribute('data-news-title');
                        const link = this.getAttribute('data-news-link');
                        shareNews(title, link, newsId);
                    });
                });
            }
            
            // ==================== ë‰´ìŠ¤ ë§í¬ ì—´ê¸° (ì„œë²„ í”„ë¡ì‹œ ì‚¬ìš©) ====================
            function openNewsInNewTab(url) {
                // ì„œë²„ì‚¬ì´ë“œ í”„ë¡ì‹œë¥¼ í†µí•´ Google News ë¦¬ë‹¤ì´ë ‰íŠ¸ ìš°íšŒ
                console.log('[openNewsInNewTab] ì‹¤í–‰ - ì›ë³¸ URL:', url);
                const proxyUrl = '/news/redirect?url=' + encodeURIComponent(url);
                console.log('[openNewsInNewTab] í”„ë¡ì‹œ URL:', proxyUrl);
                window.open(proxyUrl, '_blank', 'noopener,noreferrer');
            }
            
            // ==================== ë¶ë§ˆí¬ ê¸°ëŠ¥ ====================
            async function checkBookmarkStatus() {
                if (!userId) return;
                
                const newsIds = Array.from(document.querySelectorAll('.bookmark-btn')).map(btn => btn.dataset.newsId);
                
                for (const newsId of newsIds) {
                    try {
                        const response = await fetch('/api/bookmarks/check?userId=' + userId + '&link=' + encodeURIComponent(newsId));
                        const data = await response.json();
                        
                        if (data.success && data.bookmarked) {
                            const btn = document.querySelector('.bookmark-btn[data-news-id="' + newsId + '"]');
                            if (btn) {
                                btn.classList.add('bookmarked');
                            }
                        }
                    } catch (error) {
                        console.error('ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                    }
                }
            }
            
            async function toggleBookmark(newsId, title, link, category, source, pubDate) {
                if (!userId) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                    return;
                }
                
                const btn = document.querySelector('.bookmark-btn[data-news-id="' + newsId + '"]');
                const isBookmarked = btn.classList.contains('bookmarked');
                
                try {
                    if (isBookmarked) {
                        // ë¶ë§ˆí¬ ì œê±°
                        const response = await fetch('/api/bookmarks/' + newsId + '?userId=' + userId, {
                            method: 'DELETE'
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            btn.classList.remove('bookmarked');
                            showToast('ë¶ë§ˆí¬ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                        }
                    } else {
                        // ë¶ë§ˆí¬ ì¶”ê°€
                        const response = await fetch('/api/bookmarks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: userId,
                                title: title,
                                link: link,
                                category: category,
                                source: source,
                                pubDate: pubDate
                            })
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            btn.classList.add('bookmarked');
                            showToast('ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        } else if (data.error.includes('ì´ë¯¸')) {
                            btn.classList.add('bookmarked');
                            showToast('ì´ë¯¸ ë¶ë§ˆí¬ì— ì¶”ê°€ëœ ë‰´ìŠ¤ì…ë‹ˆë‹¤', 'info');
                        }
                    }
                } catch (error) {
                    console.error('ë¶ë§ˆí¬ ì˜¤ë¥˜:', error);
                    showToast('ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // ==================== ê³µìœ  ê¸°ëŠ¥ ====================
            function shareNews(title, link, newsId) {
                shareNewsData = { title, link, newsId };
                document.getElementById('share-modal').classList.remove('hidden');
            }
            
            function closeShareModal() {
                document.getElementById('share-modal').classList.add('hidden');
            }
            
            function shareToKakao() {
                // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (ì‹¤ì œë¡œëŠ” ì¹´ì¹´ì˜¤ SDK í•„ìš”)
                const url = 'https://story.kakao.com/share?url=' + encodeURIComponent(shareNewsData.link);
                window.open(url, '_blank', 'width=600,height=400');
                closeShareModal();
                showToast('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤', 'success');
            }
            
            function shareToFacebook() {
                const url = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareNewsData.link);
                window.open(url, '_blank', 'width=600,height=400');
                closeShareModal();
                showToast('í˜ì´ìŠ¤ë¶ ê³µìœ  ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤', 'success');
            }
            
            function shareToTwitter() {
                const url = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareNewsData.title) + '&url=' + encodeURIComponent(shareNewsData.link);
                window.open(url, '_blank', 'width=600,height=400');
                closeShareModal();
                showToast('íŠ¸ìœ„í„° ê³µìœ  ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤', 'success');
            }
            
            function copyLink() {
                navigator.clipboard.writeText(shareNewsData.link).then(() => {
                    closeShareModal();
                    showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }).catch(() => {
                    showToast('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                });
            }
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.getElementById('share-modal').addEventListener('click', function(e) {
                if (e.target.id === 'share-modal') {
                    closeShareModal();
                }
            });
            
            // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
            function openNewsLink(url) {
                const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
                if (newWindow) {
                    newWindow.opener = null;
                }
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            async function fetchNewsAndReload() {
                showToast('ìµœì‹  ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'info');
                const categories = ['general', 'politics', 'economy', 'tech', 'sports', 'entertainment'];
                let totalFetched = 0;
                let totalErrors = 0;
                
                for (const category of categories) {
                    try {
                        const response = await fetch('/api/news/fetch?category=' + category);
                        const data = await response.json();
                        
                        if (data.success) {
                            totalFetched += data.saved || 0;
                        } else if (data.fallback) {
                            console.log('ìºì‹œëœ ë‰´ìŠ¤ ì‚¬ìš©:', category);
                        } else {
                            totalErrors++;
                        }
                    } catch (error) {
                        console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', category, error);
                        totalErrors++;
                    }
                }
                
                if (totalFetched > 0) {
                    showToast(totalFetched + 'ê°œì˜ ìƒˆ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else if (totalErrors === categories.length) {
                    showToast('ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showToast('ì¼ë¶€ ì¹´í…Œê³ ë¦¬ì˜ ë‰´ìŠ¤ë§Œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'warning');
                    setTimeout(() => location.reload(), 1000);
                }
            }
            
            // ==================== ë¬´í•œ ìŠ¤í¬ë¡¤ ====================
            let scrollTimeout = null;
            window.addEventListener('scroll', function() {
                // ë””ë°”ìš´ì‹±: ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ê°€ ë„ˆë¬´ ìì£¼ ë°œìƒí•˜ì§€ ì•Šë„ë¡
                if (scrollTimeout) return;
                
                scrollTimeout = setTimeout(() => {
                    scrollTimeout = null;
                    
                    // í˜ì´ì§€ í•˜ë‹¨ì— ë„ë‹¬í–ˆëŠ”ì§€ í™•ì¸
                    const scrollHeight = document.documentElement.scrollHeight;
                    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                    const clientHeight = document.documentElement.clientHeight;
                    
                    // í•˜ë‹¨ì—ì„œ 200px ì´ë‚´ì— ë„ë‹¬í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
                    if (scrollHeight - scrollTop - clientHeight < 200) {
                        if (!isLoading && hasMore) {
                            loadNews(false); // append ëª¨ë“œë¡œ ë¡œë“œ
                        }
                    }
                }, 200);
            });
            
            // ==================== ì´ˆê¸°í™” ====================
            window.addEventListener('DOMContentLoaded', function() {
                initSearchAndKeyword(); // ê²€ìƒ‰ ë° í‚¤ì›Œë“œ ì…ë ¥ ì´ˆê¸°í™”
                loadNews(true); // ì´ˆê¸° ë¡œë“œ
                loadHotNews(); // HOT ë‰´ìŠ¤ ë¡œë“œ
                loadKeywords(); // í‚¤ì›Œë“œ ë¡œë“œ
                initScrollToTop(); // ë§¨ ìœ„ë¡œ ë²„íŠ¼ ì´ˆê¸°í™”
            });
            
            // ==================== ë§¨ ìœ„ë¡œ ë²„íŠ¼ ====================
            function initScrollToTop() {
                const scrollBtn = document.getElementById('scroll-to-top');
                
                // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                window.addEventListener('scroll', function() {
                    if (window.scrollY > 300) {
                        scrollBtn.classList.remove('opacity-0', 'pointer-events-none');
                        scrollBtn.classList.add('opacity-100');
                    } else {
                        scrollBtn.classList.add('opacity-0', 'pointer-events-none');
                        scrollBtn.classList.remove('opacity-100');
                    }
                });
                
                // í´ë¦­ ì´ë²¤íŠ¸
                scrollBtn.addEventListener('click', function() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
        </script>

        ${getCommonAuthScript()}
        
        <!-- ë§¨ ìœ„ë¡œ ë²„íŠ¼ -->
        <button id="scroll-to-top" class="fixed bottom-8 right-8 w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 opacity-0 pointer-events-none z-50 flex items-center justify-center group">
            <i class="fas fa-arrow-up text-lg group-hover:translate-y-[-2px] transition-transform"></i>
        </button>

    </body>
    </html>
  `)
})

// ==================== ë¶ë§ˆí¬ í˜ì´ì§€ ====================
app.get('/bookmarks', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¶ë§ˆí¬ - Faith Portal</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg">
        <link rel="alternate icon" href="/favicon.ico">
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = { darkMode: 'class' }
        </script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
            .bookmark-card {
                transition: all 0.3s ease;
            }
            .bookmark-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            }
            /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
            .dark {
                color-scheme: dark;
            }
            .dark body {
                background: linear-gradient(to bottom right, #1e293b, #0f172a, #020617);
            }
            .dark .bg-white {
                background-color: #1e293b !important;
            }
            .dark .text-gray-900 {
                color: #f1f5f9 !important;
            }
            .dark .text-gray-800 {
                color: #e2e8f0 !important;
            }
            .dark .text-gray-700 {
                color: #cbd5e1 !important;
            }
            .dark .text-gray-600 {
                color: #94a3b8 !important;
            }
            .dark .text-gray-500 {
                color: #64748b !important;
            }
            .dark .border-gray-200 {
                border-color: #334155 !important;
            }
            .dark .bg-gray-50 {
                background-color: #0f172a !important;
            }
            .dark .bookmark-card {
                background-color: #1e293b;
                border: 1px solid #334155;
            }
            .dark .bookmark-card:hover {
                background-color: #334155;
            }
            .spinner {
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                width: 24px;
                height: 24px;
                animation: spin 0.6s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50 transition-colors duration-300" id="html-root">
        ${getCommonHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ë¶ë§ˆí¬'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6 sm:py-8">
            <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
            <div class="mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-bookmark text-yellow-500 mr-3"></i>
                    ë‚´ ë¶ë§ˆí¬
                </h1>
                <p class="text-sm sm:text-base text-gray-600">ì €ì¥í•œ ë‰´ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <div class="mb-6 sm:mb-8 overflow-x-auto">
                <div class="flex space-x-2 sm:space-x-3 pb-2 min-w-max">
                    <button onclick="filterBookmarks('all')" data-category="all" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-medium text-sm sm:text-base shadow-lg">
                        ì „ì²´
                    </button>
                    <button onclick="filterBookmarks('general')" data-category="general" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        ì¼ë°˜
                    </button>
                    <button onclick="filterBookmarks('politics')" data-category="politics" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        ì •ì¹˜
                    </button>
                    <button onclick="filterBookmarks('economy')" data-category="economy" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        ê²½ì œ
                    </button>
                    <button onclick="filterBookmarks('tech')" data-category="tech" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        IT/ê³¼í•™
                    </button>
                    <button onclick="filterBookmarks('sports')" data-category="sports" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        ìŠ¤í¬ì¸ 
                    </button>
                    <button onclick="filterBookmarks('entertainment')" data-category="entertainment" class="category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow">
                        ì—”í„°í…Œì¸ë¨¼íŠ¸
                    </button>
                </div>
            </div>

            <!-- ë¶ë§ˆí¬ ê·¸ë¦¬ë“œ -->
            <div id="bookmarks-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
                <div class="col-span-full text-center py-12">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-500 text-lg">ë¶ë§ˆí¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
        </main>

        ${getCommonFooter()}

        <script>
            // ==================== ë‰´ìŠ¤ ë§í¬ ì—´ê¸° (Referrer ì—†ì´) ====================
            function openNewsLink(url) {
                console.log('[openNewsLink] ì‹¤í–‰ - ì›ë³¸ URL:', url);
                const proxyUrl = '/news/redirect?url=' + encodeURIComponent(url);
                window.open(proxyUrl, '_blank', 'noopener,noreferrer');
            }
            
            // ==================== ì „ì—­ ë³€ìˆ˜ ====================
            const userId = localStorage.getItem('user_id') || '1';
            let currentCategory = 'all';
            
            // ==================== ë¶ë§ˆí¬ ë¡œë“œ ====================
            async function loadBookmarks(category = 'all') {
                const grid = document.getElementById('bookmarks-grid');
                grid.innerHTML = '<div class="col-span-full text-center py-12"><div class="spinner mx-auto mb-4"></div><p class="text-gray-500">ë¶ë§ˆí¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
                
                try {
                    const categoryParam = category === 'all' ? '' : '&category=' + category;
                    const response = await fetch('/api/bookmarks?userId=' + userId + categoryParam);
                    const data = await response.json();
                    
                    if (data.success && data.bookmarks.length > 0) {
                        renderBookmarks(data.bookmarks);
                    } else {
                        grid.innerHTML = '<div class="col-span-full text-center py-12"><i class="fas fa-bookmark text-gray-300 text-6xl mb-4"></i><p class="text-gray-500 text-lg">ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p><a href="/news" class="inline-block mt-4 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold hover:shadow-lg transition-all"><i class="fas fa-newspaper mr-2"></i>ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>';
                    }
                } catch (error) {
                    console.error('ë¶ë§ˆí¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                    grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-500">ë¶ë§ˆí¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p></div>';
                }
            }
            
            function renderBookmarks(bookmarks) {
                const grid = document.getElementById('bookmarks-grid');
                grid.innerHTML = bookmarks.map(bookmark => {
                    return '<article class="bookmark-card bg-white rounded-xl shadow-md overflow-hidden">' +
                        '<div class="p-6 sm:p-7">' +
                            '<div class="flex items-center justify-between mb-5">' +
                                '<span class="px-3 py-1 bg-blue-50 text-blue-700 text-sm font-semibold rounded-md border border-blue-200">' + escapeHtml(bookmark.news_category) + '</span>' +
                                '<span class="text-sm text-gray-500 font-medium">' + new Date(bookmark.created_at).toLocaleDateString('ko-KR') + '</span>' +
                            '</div>' +
                            '<h3 class="font-bold text-sm text-gray-900 mb-3 line-clamp-2 leading-snug hover:text-purple-600 transition cursor-pointer" onclick="openNewsLink(\'' + escapeHtml(bookmark.news_link) + '\')">' + escapeHtml(bookmark.news_title) + '</h3>' +
                            '<div class="flex items-center justify-between text-sm text-gray-600 pt-5 border-t border-gray-200">' +
                                '<span class="font-semibold flex items-center"><i class="fas fa-newspaper text-gray-400 mr-2"></i>' + escapeHtml(bookmark.news_source || 'êµ¬ê¸€ ë‰´ìŠ¤') + '</span>' +
                                '<button onclick="deleteBookmark(' + bookmark.id + ')" class="text-red-500 hover:text-red-700 transition" title="ì‚­ì œ">' +
                                    '<i class="fas fa-trash"></i>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</article>';
                }).join('');
            }
            
            // ==================== ì¹´í…Œê³ ë¦¬ í•„í„° ====================
            function filterBookmarks(category) {
                currentCategory = category;
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.dataset.category === category) {
                        btn.className = 'category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-medium text-sm sm:text-base shadow-lg';
                    } else {
                        btn.className = 'category-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full bg-white text-gray-700 font-medium hover:bg-gray-100 text-sm sm:text-base shadow';
                    }
                });
                
                loadBookmarks(category);
            }
            
            // ==================== ë¶ë§ˆí¬ ì‚­ì œ ====================
            async function deleteBookmark(bookmarkId) {
                if (!confirm('ì´ ë¶ë§ˆí¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/bookmarks/' + bookmarkId + '?userId=' + userId, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        loadBookmarks(currentCategory);
                    } else {
                        alert('ë¶ë§ˆí¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }
                } catch (error) {
                    console.error('ë¶ë§ˆí¬ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ë¶ë§ˆí¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            }
            
            // ==================== ìœ í‹¸ë¦¬í‹° ====================
            function openNewsLink(url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // ==================== ì´ˆê¸°í™” ====================
            window.addEventListener('DOMContentLoaded', function() {
                if (!userId) {
                    document.getElementById('bookmarks-grid').innerHTML = '<div class="col-span-full text-center py-12"><i class="fas fa-lock text-gray-300 text-6xl mb-4"></i><p class="text-gray-500 text-lg mb-4">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p><a href="/login" class="inline-block px-6 py-3 bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg transition-all"><i class="fas fa-sign-in-alt mr-2"></i>ë¡œê·¸ì¸í•˜ê¸°</a></div>';
                } else {
                    loadBookmarks();
                    initScrollToTop(); // ë§¨ ìœ„ë¡œ ë²„íŠ¼ ì´ˆê¸°í™”
                }
            });
            
            // ==================== ë§¨ ìœ„ë¡œ ë²„íŠ¼ ====================
            function initScrollToTop() {
                const scrollBtn = document.getElementById('scroll-to-top');
                
                // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                window.addEventListener('scroll', function() {
                    if (window.scrollY > 300) {
                        scrollBtn.classList.remove('opacity-0', 'pointer-events-none');
                        scrollBtn.classList.add('opacity-100');
                    } else {
                        scrollBtn.classList.add('opacity-0', 'pointer-events-none');
                        scrollBtn.classList.remove('opacity-100');
                    }
                });
                
                // í´ë¦­ ì´ë²¤íŠ¸
                scrollBtn.addEventListener('click', function() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
        </script>

        ${getCommonAuthScript()}
        
        <!-- ë§¨ ìœ„ë¡œ ë²„íŠ¼ -->
        <button id="scroll-to-top" class="fixed bottom-8 right-8 w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 opacity-0 pointer-events-none z-50 flex items-center justify-center group">
            <i class="fas fa-arrow-up text-lg group-hover:translate-y-[-2px] transition-transform"></i>
        </button>

    </body>
    </html>
  `)
})

// ==================== ë¡œê·¸ì¸ í˜ì´ì§€ ====================
app.get('/login', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Faith Portal ë¡œê·¸ì¸</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50">
        <div class="min-h-screen flex items-center justify-center px-4">
            <div class="max-w-md w-full">
                <!-- ë¡œê³  -->
                <div class="text-center mb-8">
                    <a href="/">
                        <h1 class="text-5xl font-bold faith-blue text-white inline-block px-8 py-3 rounded-lg">Faith Portal</h1>
                    </a>
                </div>

                <!-- ë¡œê·¸ì¸ í¼ -->
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ë¡œê·¸ì¸</h2>
                    
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
                            <input 
                                type="email" 
                                id="email"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                            <input 
                                type="password" 
                                id="password"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            />
                        </div>

                        <div id="error-message" class="hidden text-red-500 text-sm"></div>

                        <button 
                            type="submit"
                            class="w-full faith-blue text-white py-3 rounded-lg font-medium faith-blue-hover transition"
                        >
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            ë¡œê·¸ì¸
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”?
                            <a href="/signup" class="text-blue-600 hover:text-blue-700 font-medium">íšŒì›ê°€ì…</a>
                        </p>
                    </div>

                    <!-- í…ŒìŠ¤íŠ¸ ê³„ì • ì•ˆë‚´ -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-800 font-medium mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            í…ŒìŠ¤íŠ¸ ê³„ì •
                        </p>
                        <p class="text-xs text-blue-700">
                            ì´ë©”ì¼: test@example.com<br>
                            ë¹„ë°€ë²ˆí˜¸: test1234
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('error-message');
                
                try {
                    const response = await axios.post('/api/login', {
                        email: email,
                        password: password
                    });
                    
                    if (response.data.success) {
                        // ë¡œê·¸ì¸ ì„±ê³µ
                        localStorage.setItem('auth_token', response.data.token);
                        localStorage.setItem('user_id', response.data.user.id);
                        localStorage.setItem('user_email', response.data.user.email);
                        localStorage.setItem('user_level', response.data.user.level);
                        
                        alert('ë¡œê·¸ì¸ ì„±ê³µ!');
                        
                        // ê´€ë¦¬ìëŠ” ê´€ë¦¬ì í˜ì´ì§€ë¡œ
                        if (response.data.user.level >= 6) {
                            window.location.href = '/admin';
                        } else {
                            window.location.href = '/';
                        }
                    }
                } catch (error) {
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = error.response?.data?.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            });
        </script>
    </body>
    </html>
  `)
})

// ==================== íšŒì›ê°€ì… í˜ì´ì§€ ====================
app.get('/signup', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Faith Portal íšŒì›ê°€ì…</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-blue-50">
        <div class="min-h-screen flex items-center justify-center px-4 py-12">
            <div class="max-w-md w-full">
                <!-- ë¡œê³  -->
                <div class="text-center mb-8">
                    <a href="/">
                        <h1 class="text-5xl font-bold faith-blue text-white inline-block px-8 py-3 rounded-lg">Faith Portal</h1>
                    </a>
                </div>

                <!-- íšŒì›ê°€ì… í¼ -->
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">íšŒì›ê°€ì…</h2>
                    
                    <form id="signup-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ì´ë©”ì¼ <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="email" 
                                id="email"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="example@email.com"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="password" 
                                id="password"
                                required
                                minlength="6"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="password" 
                                id="password-confirm"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ì´ë¦„ <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="name"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="í™ê¸¸ë™"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                íœ´ëŒ€ì „í™”
                            </label>
                            <input 
                                type="tel" 
                                id="phone"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="010-1234-5678"
                            />
                        </div>

                        <div id="error-message" class="hidden text-red-500 text-sm"></div>
                        <div id="success-message" class="hidden text-blue-500 text-sm"></div>

                        <button 
                            type="submit"
                            class="w-full faith-blue text-white py-3 rounded-lg font-medium faith-blue-hover transition"
                        >
                            <i class="fas fa-user-plus mr-2"></i>
                            íšŒì›ê°€ì…
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            ì´ë¯¸ íšŒì›ì´ì‹ ê°€ìš”?
                            <a href="/login" class="text-blue-600 hover:text-blue-700 font-medium">ë¡œê·¸ì¸</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            document.getElementById('signup-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const passwordConfirm = document.getElementById('password-confirm').value;
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if (password !== passwordConfirm) {
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    return;
                }
                
                try {
                    const response = await axios.post('/api/signup', {
                        email: email,
                        password: password,
                        name: name,
                        phone: phone
                    });
                    
                    if (response.data.success) {
                        successDiv.classList.remove('hidden');
                        successDiv.textContent = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
                        
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    }
                } catch (error) {
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = error.response?.data?.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            });
        </script>
    </body>
    </html>
  `)
})

// ==================== API: í…ŒíŠ¸ë¦¬ìŠ¤ ìµœê³  ì ìˆ˜ ì €ì¥ ====================
app.post('/api/tetris/score', async (c) => {
  try {
    const { user_id, score } = await c.req.json()
    
    if (!user_id || score === undefined) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì…ë‹ˆë‹¤.' }, 400)
    }
    
    // ì ìˆ˜ ì €ì¥
    await c.env.DB.prepare(
      'INSERT INTO tetris_scores (user_id, score) VALUES (?, ?)'
    ).bind(user_id, score).run()
    
    return c.json({ success: true, message: 'ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('í…ŒíŠ¸ë¦¬ìŠ¤ ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ì ìˆ˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: í…ŒíŠ¸ë¦¬ìŠ¤ ìµœê³  ì ìˆ˜ ì¡°íšŒ ====================
app.get('/api/tetris/highscore/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    const highScore = await c.env.DB.prepare(
      'SELECT MAX(score) as high_score FROM tetris_scores WHERE user_id = ?'
    ).bind(userId).first()
    
    return c.json({ 
      success: true, 
      highScore: highScore?.high_score || 0 
    })
  } catch (error) {
    console.error('í…ŒíŠ¸ë¦¬ìŠ¤ ìµœê³  ì ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ìµœê³  ì ìˆ˜ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: í…ŒíŠ¸ë¦¬ìŠ¤ ìµœê³  ì ìˆ˜ ë¦¬ìŠ¤íŠ¸ ====================
app.get('/api/tetris/leaderboard', async (c) => {
  try {
    const { results } = await c.env.DB.prepare(`
      SELECT 
        t.id,
        t.score,
        t.created_at,
        u.email
      FROM tetris_scores t
      JOIN users u ON t.user_id = u.id
      ORDER BY t.score DESC
      LIMIT 10
    `).all()
    
    return c.json({ 
      success: true, 
      leaderboard: results || [] 
    })
  } catch (error) {
    console.error('í…ŒíŠ¸ë¦¬ìŠ¤ ë¦¬ë”ë³´ë“œ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ë¦¬ë”ë³´ë“œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ìŠ¤ë„ì¿  ê¸°ë¡ ì €ì¥ ====================
app.post('/api/sudoku/score', async (c) => {
  try {
    const { user_id, time, difficulty } = await c.req.json()
    
    if (!user_id || time === undefined || !difficulty) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì…ë‹ˆë‹¤.' }, 400)
    }
    
    await c.env.DB.prepare(
      'INSERT INTO sudoku_scores (user_id, time, difficulty) VALUES (?, ?, ?)'
    ).bind(user_id, time, difficulty).run()
    
    return c.json({ success: true, message: 'ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('ìŠ¤ë„ì¿  ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ìŠ¤ë„ì¿  ìµœê³  ê¸°ë¡ ì¡°íšŒ ====================
app.get('/api/sudoku/besttime/:userId/:difficulty', async (c) => {
  try {
    const userId = c.req.param('userId')
    const difficulty = c.req.param('difficulty')
    
    const bestTime = await c.env.DB.prepare(
      'SELECT MIN(time) as best_time FROM sudoku_scores WHERE user_id = ? AND difficulty = ?'
    ).bind(userId, difficulty).first()
    
    return c.json({ 
      success: true, 
      bestTime: bestTime?.best_time || 0 
    })
  } catch (error) {
    console.error('ìŠ¤ë„ì¿  ìµœê³  ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ìµœê³  ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ìŠ¤ë„ì¿  ë¦¬ë”ë³´ë“œ ====================
app.get('/api/sudoku/leaderboard/:difficulty', async (c) => {
  try {
    const difficulty = c.req.param('difficulty')
    
    const { results } = await c.env.DB.prepare(`
      SELECT 
        s.id,
        s.time,
        s.created_at,
        u.email
      FROM sudoku_scores s
      JOIN users u ON s.user_id = u.id
      WHERE s.difficulty = ?
      ORDER BY s.time ASC
      LIMIT 10
    `).bind(difficulty).all()
    
    return c.json({ 
      success: true, 
      leaderboard: results || [] 
    })
  } catch (error) {
    console.error('ìŠ¤ë„ì¿  ë¦¬ë”ë³´ë“œ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, message: 'ë¦¬ë”ë³´ë“œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì›ê°€ì… ====================
app.post('/api/signup', async (c) => {
  try {
    const { email, password, name, phone } = await c.req.json()
    
    // ì…ë ¥ ê²€ì¦
    if (!email || !password || !name) {
      return c.json({ success: false, message: 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
    const existingUser = await c.env.DB.prepare(
      'SELECT id FROM users WHERE email = ?'
    ).bind(email).first()
    
    if (existingUser) {
      return c.json({ success: false, message: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' }, 400)
    }
    
    // íšŒì› ì •ë³´ ì €ì¥ (ì‹¤ì œë¡œëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí™”í•´ì•¼ í•¨)
    const result = await c.env.DB.prepare(
      'INSERT INTO users (email, password, name, phone, level, status) VALUES (?, ?, ?, ?, 1, "active")'
    ).bind(email, password, name, phone || null).run()
    
    const newUserId = result.meta.last_row_id
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(newUserId, 'signup', `ì‹ ê·œ íšŒì› ê°€ì…: ${email}`).run()
    
    // ê´€ë¦¬ì ì•Œë¦¼ ìƒì„±
    await c.env.DB.prepare(
      'INSERT INTO notifications (type, title, message, priority) VALUES (?, ?, ?, ?)'
    ).bind('new_signup', 'ì‹ ê·œ íšŒì› ê°€ì…', `${name}(${email})ë‹˜ì´ ê°€ì…í–ˆìŠµë‹ˆë‹¤.`, 'normal').run()
    
    return c.json({
      success: true,
      message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      userId: newUserId
    })
  } catch (error) {
    console.error('Signup error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ë¡œê·¸ì¸ ====================
app.post('/api/login', async (c) => {
  try {
    const { email, password } = await c.req.json()
    
    if (!email || !password) {
      return c.json({ success: false, message: 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // ì‚¬ìš©ì ì¡°íšŒ (level, status í¬í•¨)
    const user = await c.env.DB.prepare(
      'SELECT id, email, name, phone, level, status FROM users WHERE email = ? AND password = ?'
    ).bind(email, password).first()
    
    if (!user) {
      return c.json({ success: false, message: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' }, 401)
    }
    
    // ê³„ì • ì •ì§€ ì²´í¬
    if (user.status === 'suspended') {
      return c.json({ success: false, message: 'ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' }, 403)
    }
    
    if (user.status === 'deleted') {
      return c.json({ success: false, message: 'ì‚­ì œëœ ê³„ì •ì…ë‹ˆë‹¤.' }, 403)
    }
    
    // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(
      'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?'
    ).bind(user.id).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(user.id, 'login', `ë¡œê·¸ì¸: ${user.email}`).run()
    
    // ë¡œê·¸ì¸ ê¸°ë¡ ì €ì¥
    const ipAddress = c.req.header('cf-connecting-ip') || c.req.header('x-forwarded-for') || 'unknown'
    const userAgent = c.req.header('user-agent') || 'unknown'
    await c.env.DB.prepare(
      'INSERT INTO login_history (user_id, ip_address, user_agent) VALUES (?, ?, ?)'
    ).bind(user.id, ipAddress, userAgent).run()
    
    // ê°„ë‹¨í•œ í† í° ìƒì„± (ì‹¤ì œë¡œëŠ” JWT ë“±ì„ ì‚¬ìš©í•´ì•¼ í•¨)
    const token = Buffer.from(`${user.id}:${Date.now()}`).toString('base64')
    
    return c.json({
      success: true,
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      token: token,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        phone: user.phone,
        level: user.level,
        status: user.status
      }
    })
  } catch (error) {
    console.error('Login error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ====================
app.get('/api/user', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    // ê°„ë‹¨í•œ í† í° ê²€ì¦ (ì‹¤ì œë¡œëŠ” JWT ê²€ì¦ í•„ìš”)
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const user = await c.env.DB.prepare(
      'SELECT id, email, name, phone, created_at, last_login FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    return c.json({
      success: true,
      user: user
    })
  } catch (error) {
    console.error('User info error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ í•¨ìˆ˜ ====================
async function checkAdminAuth(c: any) {
  const token = c.req.header('Cookie')?.match(/auth_token=([^;]+)/)?.[1]
  
  if (!token) {
    return null
  }
  
  try {
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const user = await c.env.DB.prepare(
      'SELECT id, email, name, level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    // ê´€ë¦¬ì ë“±ê¸‰ ì²´í¬ (6 ì´ìƒ)
    if (user && user.level >= 6 && user.status === 'active') {
      return user
    }
  } catch (error) {
    console.error('Admin auth error:', error)
  }
  
  return null
}

// ==================== ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ====================
app.get('/admin', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <a href="/" class="text-lg sm:text-xl lg:text-2xl font-bold">Faith Portal</a>
                        <span class="text-xs sm:text-sm bg-yellow-500 text-gray-900 px-2 sm:px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-0 sm:mr-1"></i>
                            <span class="hidden xs:inline">ê´€ë¦¬ì</span>
                        </span>
                    </div>
                    <div id="admin-info" class="flex items-center space-x-2 sm:space-x-4">
                        <span id="admin-name" class="text-xs sm:text-sm truncate max-w-[120px] sm:max-w-none"></span>
                        <a href="/" class="text-xs sm:text-sm hover:text-blue-200 whitespace-nowrap">
                            <i class="fas fa-home mr-0 sm:mr-1"></i>
                            <span class="hidden sm:inline">ë©”ì¸ìœ¼ë¡œ</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-gray-500 text-xs sm:text-sm">ì „ì²´ íšŒì›</p>
                            <p id="total-users" class="text-2xl sm:text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-blue-100 text-blue-600 rounded-full p-3 sm:p-4">
                            <i class="fas fa-users text-xl sm:text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-gray-500 text-xs sm:text-sm">í™œì„± íšŒì›</p>
                            <p id="active-users" class="text-2xl sm:text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 text-green-600 rounded-full p-3 sm:p-4">
                            <i class="fas fa-user-check text-xl sm:text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-gray-500 text-xs sm:text-sm">ì •ì§€ íšŒì›</p>
                            <p id="suspended-users" class="text-2xl sm:text-3xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="bg-orange-100 text-orange-600 rounded-full p-3 sm:p-4">
                            <i class="fas fa-user-lock text-xl sm:text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-gray-500 text-xs sm:text-sm">ì˜¤ëŠ˜ ê°€ì…</p>
                            <p id="today-signups" class="text-2xl sm:text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="bg-purple-100 text-purple-600 rounded-full p-3 sm:p-4">
                            <i class="fas fa-user-plus text-xl sm:text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë“±ê¸‰ë³„ íšŒì› ë¶„í¬ -->
            <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-6 sm:mb-8">
                <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    íšŒì› ë“±ê¸‰ë³„ ë¶„í¬
                </h3>
                <div class="w-full overflow-hidden">
                    <canvas id="levelChart" class="w-full" style="max-height: 250px; height: 250px;"></canvas>
                </div>
            </div>

            <!-- ìµœê·¼ ê°€ì… íšŒì› -->
            <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-clock text-blue-600 mr-2"></i>
                    ìµœê·¼ ê°€ì… íšŒì› (10ëª…)
                </h3>
                <div class="overflow-x-auto -mx-4 sm:mx-0">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë©”ì¼</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë“±ê¸‰</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê°€ì…ì¼</th>
                            </tr>
                        </thead>
                        <tbody id="recent-users" class="bg-white divide-y divide-gray-200">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            // ì¸ì¦ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }

            // ê´€ë¦¬ì ì •ë³´ í‘œì‹œ
            document.getElementById('admin-name').textContent = localStorage.getItem('user_email') || '';

            // ë“±ê¸‰ëª… ë°˜í™˜ í•¨ìˆ˜
            function getLevelName(level) {
                const levels = {
                    1: 'ì¼ë°˜ íšŒì›', 2: 'ì •íšŒì›', 3: 'ìš°ìˆ˜íšŒì›', 4: 'VIP', 5: 'VVIP',
                    6: 'ì‹¤ë²„ ê´€ë¦¬ì', 7: 'ê³¨ë“œ ê´€ë¦¬ì', 8: 'í”Œë˜í‹°ë„˜ ê´€ë¦¬ì',
                    9: 'ë§ˆìŠ¤í„° ê´€ë¦¬ì', 10: 'ìŠˆí¼ë°”ì´ì €'
                };
                return levels[level] || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }

            // í†µê³„ ë°ì´í„° ë¡œë“œ
            async function loadStats() {
                try {
                    const response = await axios.get('/api/admin/stats', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    const data = response.data;
                    document.getElementById('total-users').textContent = data.totalUsers;
                    document.getElementById('active-users').textContent = data.activeUsers;
                    document.getElementById('suspended-users').textContent = data.suspendedUsers;
                    document.getElementById('today-signups').textContent = data.todaySignups;
                    
                    // ë“±ê¸‰ë³„ ì°¨íŠ¸
                    createLevelChart(data.levelDistribution);
                    
                    // ìµœê·¼ ê°€ì… íšŒì›
                    displayRecentUsers(data.recentUsers);
                } catch (error) {
                    console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // ë“±ê¸‰ë³„ ì°¨íŠ¸ ìƒì„±
            function createLevelChart(distribution) {
                const ctx = document.getElementById('levelChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: distribution.map(d => getLevelName(d.level)),
                        datasets: [{
                            label: 'íšŒì› ìˆ˜',
                            data: distribution.map(d => d.count),
                            backgroundColor: 'rgba(30, 64, 175, 0.7)',
                            borderColor: 'rgba(30, 64, 175, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // ìµœê·¼ ê°€ì… íšŒì› í‘œì‹œ
            function displayRecentUsers(users) {
                const tbody = document.getElementById('recent-users');
                tbody.innerHTML = users.map(user => \`
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                \${getLevelName(user.level)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            \${new Date(user.created_at).toLocaleDateString('ko-KR')}
                        </td>
                    </tr>
                \`).join('');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ë¡œë“œ
            loadStats();
        </script>
    </body>
    </html>
  `)
})

// ==================== íšŒì› ê´€ë¦¬ í˜ì´ì§€ ====================
app.get('/admin/users', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>íšŒì› ê´€ë¦¬ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
            .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
            .modal.active { display: flex; align-items: center; justify-content: center; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-2xl font-bold">Faith Portal</a>
                        <span class="text-sm bg-yellow-500 text-gray-900 px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-1"></i>
                            ê´€ë¦¬ì
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-sm"></span>
                        <a href="/" class="text-sm hover:text-blue-200">
                            <i class="fas fa-home mr-1"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin/users')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì', href: '/admin'},
          {label: 'íšŒì› ê´€ë¦¬'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <select id="level-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ë“±ê¸‰</option>
                        <option value="1">ì¼ë°˜ íšŒì›</option>
                        <option value="2">ì •íšŒì›</option>
                        <option value="3">ìš°ìˆ˜íšŒì›</option>
                        <option value="4">VIP</option>
                        <option value="5">VVIP</option>
                        <option value="6">ì‹¤ë²„ ê´€ë¦¬ì</option>
                        <option value="7">ê³¨ë“œ ê´€ë¦¬ì</option>
                        <option value="8">í”Œë˜í‹°ë„˜ ê´€ë¦¬ì</option>
                        <option value="9">ë§ˆìŠ¤í„° ê´€ë¦¬ì</option>
                        <option value="10">ìŠˆí¼ë°”ì´ì €</option>
                    </select>
                    <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="active">í™œì„±</option>
                        <option value="suspended">ì •ì§€</option>
                        <option value="deleted">ì‚­ì œ</option>
                    </select>
                    <button onclick="searchUsers()" class="faith-blue text-white px-6 py-2 rounded-lg faith-blue-hover">
                        <i class="fas fa-search mr-2"></i>
                        ê²€ìƒ‰
                    </button>
                </div>
            </div>

            <!-- íšŒì› ëª©ë¡ ë·° -->
            <div id="list-view">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-list text-blue-600 mr-2"></i>
                                íšŒì› ëª©ë¡
                            </h3>
                            <div class="text-sm text-gray-600">
                                <span id="selected-count">0</span>ëª… ì„ íƒë¨
                            </div>
                        </div>
                    </div>

                    <!-- ë°°ì¹˜ ì‘ì—… íˆ´ë°” -->
                    <div class="px-6 py-3 bg-gray-50 border-b flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">ì „ì²´ ì„ íƒ</span>
                        </label>
                        
                        <div class="flex-1"></div>
                        
                        <select id="batch-action" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="executeBatchAction()">
                            <option value="">ì¼ê´„ ì‘ì—… ì„ íƒ...</option>
                            <option value="change-level">ë“±ê¸‰ ë³€ê²½</option>
                            <option value="change-status">ìƒíƒœ ë³€ê²½</option>
                            <option value="delete">ì‚­ì œ</option>
                        </select>
                        
                        <button onclick="exportToCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-file-csv mr-2"></i>
                            CSV ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase w-12">
                                        <input type="checkbox" id="header-checkbox" onchange="toggleSelectAll()" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë©”ì¼</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">íœ´ëŒ€ì „í™”</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë“±ê¸‰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê°€ì…ì¼</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- íšŒì› ìƒì„¸ë³´ê¸° ë·° -->
            <div id="detail-view" class="hidden">
                <div class="bg-white rounded-lg shadow">
                    <!-- ìƒì„¸ë³´ê¸° í—¤ë” -->
                    <div class="px-6 py-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-user text-blue-600 mr-2"></i>
                            íšŒì› ìƒì„¸ ì •ë³´
                        </h3>
                        <button onclick="backToList()" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-arrow-left mr-2"></i>
                            ëª©ë¡ìœ¼ë¡œ
                        </button>
                    </div>

                    <!-- ìƒì„¸ë³´ê¸° ë‚´ìš© -->
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ê¸°ë³¸ ì •ë³´ -->
                            <div class="space-y-4">
                                <h4 class="text-md font-bold text-gray-700 mb-3">ê¸°ë³¸ ì •ë³´</h4>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">íšŒì› ID</label>
                                    <p id="detail-id" class="text-lg font-semibold text-gray-900">-</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">ì´ë©”ì¼</label>
                                    <p id="detail-email" class="text-lg text-gray-900">-</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">ì´ë¦„</label>
                                    <input type="text" id="detail-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">íœ´ëŒ€ì „í™”</label>
                                    <input type="tel" id="detail-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <!-- ë“±ê¸‰ ë° ìƒíƒœ -->
                            <div class="space-y-4">
                                <h4 class="text-md font-bold text-gray-700 mb-3">ë“±ê¸‰ ë° ìƒíƒœ</h4>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">íšŒì› ë“±ê¸‰</label>
                                    <select id="detail-level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="1">Lv.1 ì¼ë°˜ íšŒì›</option>
                                        <option value="2">Lv.2 ì •íšŒì›</option>
                                        <option value="3">Lv.3 ìš°ìˆ˜íšŒì›</option>
                                        <option value="4">Lv.4 VIP</option>
                                        <option value="5">Lv.5 VVIP</option>
                                        <option value="6">Lv.6 ì‹¤ë²„ ê´€ë¦¬ì</option>
                                        <option value="7">Lv.7 ê³¨ë“œ ê´€ë¦¬ì</option>
                                        <option value="8">Lv.8 í”Œë˜í‹°ë„˜ ê´€ë¦¬ì</option>
                                        <option value="9">Lv.9 ë§ˆìŠ¤í„° ê´€ë¦¬ì</option>
                                        <option value="10">Lv.10 ìŠˆí¼ë°”ì´ì €</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">ê³„ì • ìƒíƒœ</label>
                                    <div id="detail-status" class="text-lg">-</div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">ê°€ì…ì¼</label>
                                    <p id="detail-created" class="text-gray-900">-</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-500 mb-1">ìµœê·¼ ë¡œê·¸ì¸</label>
                                    <p id="detail-last-login" class="text-gray-900">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="mt-8 pt-6 border-t flex space-x-3">
                            <button onclick="saveUserChanges()" class="flex-1 faith-blue text-white px-6 py-3 rounded-lg faith-blue-hover">
                                <i class="fas fa-save mr-2"></i>
                                ë³€ê²½ì‚¬í•­ ì €ì¥
                            </button>
                            <button id="toggle-status-btn" onclick="toggleUserStatus()" class="flex-1 bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600">
                                <i class="fas fa-ban mr-2"></i>
                                <span id="toggle-status-text">ì •ì§€</span>
                            </button>
                            <button onclick="deleteUserDetail()" class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash mr-2"></i>
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            // ì¸ì¦ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }

            document.getElementById('admin-name').textContent = localStorage.getItem('user_email') || '';

            // ë“±ê¸‰ëª… ë°˜í™˜
            function getLevelName(level) {
                const levels = {
                    1: 'ì¼ë°˜ íšŒì›', 2: 'ì •íšŒì›', 3: 'ìš°ìˆ˜íšŒì›', 4: 'VIP', 5: 'VVIP',
                    6: 'ì‹¤ë²„ ê´€ë¦¬ì', 7: 'ê³¨ë“œ ê´€ë¦¬ì', 8: 'í”Œë˜í‹°ë„˜ ê´€ë¦¬ì',
                    9: 'ë§ˆìŠ¤í„° ê´€ë¦¬ì', 10: 'ìŠˆí¼ë°”ì´ì €'
                };
                return levels[level] || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }

            // ìƒíƒœ ë°°ì§€ ìƒ‰ìƒ
            function getStatusBadge(status) {
                const badges = {
                    active: 'bg-green-100 text-green-800',
                    suspended: 'bg-orange-100 text-orange-800',
                    deleted: 'bg-red-100 text-red-800'
                };
                const names = {
                    active: 'í™œì„±',
                    suspended: 'ì •ì§€',
                    deleted: 'ì‚­ì œ'
                };
                return \`<span class="px-2 py-1 text-xs rounded-full \${badges[status] || ''}">\${names[status] || status}</span>\`;
            }

            // íšŒì› ëª©ë¡ ë¡œë“œ
            async function loadUsers(search = '', level = '', status = '') {
                try {
                    let url = '/api/admin/users?';
                    if (search) url += \`search=\${encodeURIComponent(search)}&\`;
                    if (level) url += \`level=\${level}&\`;
                    if (status) url += \`status=\${status}&\`;
                    
                    const response = await axios.get(url, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    displayUsers(response.data.users);
                } catch (error) {
                    console.error('íšŒì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì„ íƒëœ ì‚¬ìš©ì ID ì €ì¥
            let selectedUserIds = new Set();

            // íšŒì› ëª©ë¡ í‘œì‹œ
            function displayUsers(users) {
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = users.map(user => \`
                    <tr class="hover:bg-blue-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <input type="checkbox" 
                                   class="user-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                   value="\${user.id}" 
                                   onchange="updateSelection()"
                                   onclick="event.stopPropagation()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer" onclick="showUserDetail(\${user.id})">\${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer" onclick="showUserDetail(\${user.id})">\${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 cursor-pointer" onclick="showUserDetail(\${user.id})">\${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="showUserDetail(\${user.id})">\${user.phone || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm cursor-pointer" onclick="showUserDetail(\${user.id})">
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                Lv.\${user.level} \${getLevelName(user.level)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm cursor-pointer" onclick="showUserDetail(\${user.id})">
                            \${getStatusBadge(user.status)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="showUserDetail(\${user.id})">
                            \${new Date(user.created_at).toLocaleDateString('ko-KR')}
                        </td>
                    </tr>
                \`).join('');
                
                // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                selectedUserIds.clear();
                updateSelectionUI();
            }

            // ì „ì²´ ì„ íƒ/í•´ì œ
            function toggleSelectAll() {
                const checkboxes = document.querySelectorAll('.user-checkbox');
                const selectAllCheckbox = document.getElementById('select-all-checkbox') || document.getElementById('header-checkbox');
                const isChecked = selectAllCheckbox.checked;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                
                // ë‘ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
                const otherCheckbox = selectAllCheckbox.id === 'select-all-checkbox' 
                    ? document.getElementById('header-checkbox') 
                    : document.getElementById('select-all-checkbox');
                if (otherCheckbox) otherCheckbox.checked = isChecked;
                
                updateSelection();
            }

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            function updateSelection() {
                const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                selectedUserIds.clear();
                checkboxes.forEach(cb => selectedUserIds.add(parseInt(cb.value)));
                updateSelectionUI();
            }

            // ì„ íƒ UI ì—…ë°ì´íŠ¸
            function updateSelectionUI() {
                const count = selectedUserIds.size;
                document.getElementById('selected-count').textContent = count;
                
                // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
                const allCheckboxes = document.querySelectorAll('.user-checkbox');
                const checkedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                const headerCheckbox = document.getElementById('header-checkbox');
                
                if (allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length) {
                    if (selectAllCheckbox) selectAllCheckbox.checked = true;
                    if (headerCheckbox) headerCheckbox.checked = true;
                } else {
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;
                    if (headerCheckbox) headerCheckbox.checked = false;
                }
            }

            // ê²€ìƒ‰
            function searchUsers() {
                const search = document.getElementById('search-input').value;
                const level = document.getElementById('level-filter').value;
                const status = document.getElementById('status-filter').value;
                loadUsers(search, level, status);
            }

            // í˜„ì¬ ì„ íƒëœ ì‚¬ìš©ì ID ì €ì¥
            let currentUserId = null;

            // íšŒì› ìƒì„¸ë³´ê¸° í‘œì‹œ
            async function showUserDetail(userId) {
                try {
                    const response = await axios.get(\`/api/admin/users/\${userId}\`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    const user = response.data.user;
                    currentUserId = user.id;
                    
                    // ìƒì„¸ ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('detail-id').textContent = user.id;
                    document.getElementById('detail-email').textContent = user.email;
                    document.getElementById('detail-name').value = user.name;
                    document.getElementById('detail-phone').value = user.phone || '';
                    document.getElementById('detail-level').value = user.level;
                    document.getElementById('detail-status').innerHTML = getStatusBadge(user.status);
                    document.getElementById('detail-created').textContent = new Date(user.created_at).toLocaleString('ko-KR');
                    document.getElementById('detail-last-login').textContent = user.last_login ? new Date(user.last_login).toLocaleString('ko-KR') : 'ì—†ìŒ';
                    
                    // ì •ì§€/í•´ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                    const statusBtn = document.getElementById('toggle-status-text');
                    if (user.status === 'suspended') {
                        statusBtn.textContent = 'í•´ì œ';
                        document.getElementById('toggle-status-btn').className = 'flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600';
                    } else {
                        statusBtn.textContent = 'ì •ì§€';
                        document.getElementById('toggle-status-btn').className = 'flex-1 bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600';
                    }
                    
                    // ë·° ì „í™˜
                    document.getElementById('list-view').classList.add('hidden');
                    document.getElementById('detail-view').classList.remove('hidden');
                } catch (error) {
                    alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            function backToList() {
                document.getElementById('detail-view').classList.add('hidden');
                document.getElementById('list-view').classList.remove('hidden');
                currentUserId = null;
                searchUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }

            // ë°°ì¹˜ ì‘ì—… ì‹¤í–‰
            async function executeBatchAction() {
                const action = document.getElementById('batch-action').value;
                
                if (!action) return;
                
                if (selectedUserIds.size === 0) {
                    alert('ì„ íƒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('batch-action').value = '';
                    return;
                }
                
                const userIds = Array.from(selectedUserIds);
                
                try {
                    if (action === 'change-level') {
                        const level = prompt('ë³€ê²½í•  ë“±ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš” (1-10):');
                        if (!level || level < 1 || level > 10) {
                            alert('ì˜¬ë°”ë¥¸ ë“±ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
                            document.getElementById('batch-action').value = '';
                            return;
                        }
                        
                        if (!confirm(\`ì„ íƒí•œ \${userIds.length}ëª…ì˜ íšŒì› ë“±ê¸‰ì„ Lv.\${level}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                            document.getElementById('batch-action').value = '';
                            return;
                        }
                        
                        await axios.post('/api/admin/users/batch', 
                            { userIds, action: 'level', value: parseInt(level) },
                            { headers: { 'Authorization': 'Bearer ' + token } }
                        );
                        
                        alert('ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } 
                    else if (action === 'change-status') {
                        const status = prompt('ë³€ê²½í•  ìƒíƒœë¥¼ ì…ë ¥í•˜ì„¸ìš” (active/suspended/deleted):');
                        if (!['active', 'suspended', 'deleted'].includes(status)) {
                            alert('ì˜¬ë°”ë¥¸ ìƒíƒœë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                            document.getElementById('batch-action').value = '';
                            return;
                        }
                        
                        const statusName = { active: 'í™œì„±', suspended: 'ì •ì§€', deleted: 'ì‚­ì œ' }[status];
                        if (!confirm(\`ì„ íƒí•œ \${userIds.length}ëª…ì˜ íšŒì› ìƒíƒœë¥¼ '\${statusName}'ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                            document.getElementById('batch-action').value = '';
                            return;
                        }
                        
                        await axios.post('/api/admin/users/batch', 
                            { userIds, action: 'status', value: status },
                            { headers: { 'Authorization': 'Bearer ' + token } }
                        );
                        
                        alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } 
                    else if (action === 'delete') {
                        if (!confirm(\`ì •ë§ ì„ íƒí•œ \${userIds.length}ëª…ì˜ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\`)) {
                            document.getElementById('batch-action').value = '';
                            return;
                        }
                        
                        await axios.post('/api/admin/users/batch', 
                            { userIds, action: 'delete' },
                            { headers: { 'Authorization': 'Bearer ' + token } }
                        );
                        
                        alert('íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // ì‘ì—… ì™„ë£Œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    document.getElementById('batch-action').value = '';
                    searchUsers();
                } catch (error) {
                    console.error('Batch operation error:', error);
                    alert('ì¼ê´„ ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('batch-action').value = '';
                }
            }

            // CSV ë‚´ë³´ë‚´ê¸°
            async function exportToCSV() {
                try {
                    const response = await axios.get('/api/admin/users/export', {
                        headers: { 'Authorization': 'Bearer ' + token },
                        responseType: 'blob'
                    });
                    
                    // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const url = window.URL.createObjectURL(new Blob([response.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', \`users_\${new Date().toISOString().slice(0, 10)}.csv\`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    
                    alert('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('CSV export error:', error);
                    alert('CSV ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ë³€ê²½ì‚¬í•­ ì €ì¥
            async function saveUserChanges() {
                if (!currentUserId) return;
                
                const name = document.getElementById('detail-name').value;
                const phone = document.getElementById('detail-phone').value;
                const level = parseInt(document.getElementById('detail-level').value);
                
                if (!confirm('íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    await axios.put(\`/api/admin/users/\${currentUserId}\`, 
                        { name, phone, level },
                        { headers: { 'Authorization': 'Bearer ' + token } }
                    );
                    
                    alert('íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    showUserDetail(currentUserId); // ìƒì„¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    alert('íšŒì› ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // íšŒì› ìƒíƒœ ë³€ê²½ (ì •ì§€/í•´ì œ)
            async function toggleUserStatus() {
                if (!currentUserId) return;
                
                try {
                    // í˜„ì¬ ìƒíƒœ í™•ì¸
                    const response = await axios.get(\`/api/admin/users/\${currentUserId}\`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    const currentStatus = response.data.user.status;
                    const newStatus = currentStatus === 'suspended' ? 'active' : 'suspended';
                    const message = newStatus === 'suspended' ? 'ì •ì§€' : 'í™œì„±í™”';
                    
                    if (!confirm(\`ì •ë§ ì´ íšŒì›ì„ \${message}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                    
                    await axios.patch(\`/api/admin/users/\${currentUserId}/status\`, 
                        { status: newStatus },
                        { headers: { 'Authorization': 'Bearer ' + token } }
                    );
                    
                    alert(\`íšŒì›ì´ \${message}ë˜ì—ˆìŠµë‹ˆë‹¤.\`);
                    showUserDetail(currentUserId); // ìƒì„¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    alert('íšŒì› ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // íšŒì› ì‚­ì œ
            async function deleteUserDetail() {
                if (!currentUserId) return;
                
                if (!confirm('ì •ë§ ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
                
                try {
                    await axios.delete(\`/api/admin/users/\${currentUserId}\`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    alert('íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    backToList();
                } catch (error) {
                    alert('íšŒì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì´ˆê¸° ë¡œë“œ
            loadUsers();
        </script>
    </body>
    </html>
  `)
})

// ==================== API: ê´€ë¦¬ì í†µê³„ ====================
app.get('/api/admin/stats', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    // ì „ì²´ íšŒì› ìˆ˜
    const totalUsers = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM users WHERE status != "deleted"'
    ).first()
    
    // í™œì„± íšŒì› ìˆ˜
    const activeUsers = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM users WHERE status = "active"'
    ).first()
    
    // ì •ì§€ íšŒì› ìˆ˜
    const suspendedUsers = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM users WHERE status = "suspended"'
    ).first()
    
    // ì˜¤ëŠ˜ ê°€ì… íšŒì›
    const todaySignups = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM users WHERE DATE(created_at) = DATE("now")'
    ).first()
    
    // ë“±ê¸‰ë³„ ë¶„í¬
    const levelDistribution = await c.env.DB.prepare(
      'SELECT level, COUNT(*) as count FROM users WHERE status != "deleted" GROUP BY level ORDER BY level'
    ).all()
    
    // ìµœê·¼ ê°€ì… íšŒì› 10ëª…
    const recentUsers = await c.env.DB.prepare(
      'SELECT id, email, name, level, created_at FROM users WHERE status != "deleted" ORDER BY created_at DESC LIMIT 10'
    ).all()
    
    return c.json({
      success: true,
      totalUsers: totalUsers.count,
      activeUsers: activeUsers.count,
      suspendedUsers: suspendedUsers.count,
      todaySignups: todaySignups.count,
      levelDistribution: levelDistribution.results,
      recentUsers: recentUsers.results
    })
  } catch (error) {
    console.error('Admin stats error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ëª©ë¡ ì¡°íšŒ ====================
app.get('/api/admin/users', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    // ê²€ìƒ‰ íŒŒë¼ë¯¸í„°
    const search = c.req.query('search') || ''
    const level = c.req.query('level') || ''
    const status = c.req.query('status') || ''
    
    let query = 'SELECT id, email, name, phone, level, status, created_at FROM users WHERE 1=1'
    const bindings = []
    
    if (search) {
      query += ' AND (email LIKE ? OR name LIKE ?)'
      bindings.push(`%${search}%`, `%${search}%`)
    }
    
    if (level) {
      query += ' AND level = ?'
      bindings.push(parseInt(level))
    }
    
    if (status) {
      query += ' AND status = ?'
      bindings.push(status)
    } else {
      query += ' AND status != "deleted"'
    }
    
    query += ' ORDER BY created_at DESC LIMIT 100'
    
    const users = await c.env.DB.prepare(query).bind(...bindings).all()
    
    return c.json({
      success: true,
      users: users.results
    })
  } catch (error) {
    console.error('Admin users list error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ìƒì„¸ ì¡°íšŒ ====================
app.get('/api/admin/users/:id', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const targetUserId = c.req.param('id')
    const user = await c.env.DB.prepare(
      'SELECT id, email, name, phone, level, status, created_at, last_login FROM users WHERE id = ?'
    ).bind(targetUserId).first()
    
    if (!user) {
      return c.json({ success: false, message: 'íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    return c.json({
      success: true,
      user: user
    })
  } catch (error) {
    console.error('Admin user detail error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ì •ë³´ ìˆ˜ì • ====================
app.put('/api/admin/users/:id', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const targetUserId = c.req.param('id')
    const { name, phone, level } = await c.req.json()
    
    // ëŒ€ìƒ íšŒì› ì •ë³´ ì¡°íšŒ
    const targetUser = await c.env.DB.prepare(
      'SELECT email, name FROM users WHERE id = ?'
    ).bind(targetUserId).first()
    
    await c.env.DB.prepare(
      'UPDATE users SET name = ?, phone = ?, level = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?'
    ).bind(name, phone, level, targetUserId).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(userId, 'admin_action', `íšŒì› ì •ë³´ ìˆ˜ì •: ${targetUser?.email}`).run()
    
    return c.json({
      success: true,
      message: 'íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Admin user update error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ìƒíƒœ ë³€ê²½ (ì •ì§€/í•´ì œ) ====================
app.patch('/api/admin/users/:id/status', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const targetUserId = c.req.param('id')
    const { status } = await c.req.json()
    
    if (!['active', 'suspended'].includes(status)) {
      return c.json({ success: false, message: 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤.' }, 400)
    }
    
    // ëŒ€ìƒ íšŒì› ì •ë³´ ì¡°íšŒ
    const targetUser = await c.env.DB.prepare(
      'SELECT email, name FROM users WHERE id = ?'
    ).bind(targetUserId).first()
    
    await c.env.DB.prepare(
      'UPDATE users SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?'
    ).bind(status, targetUserId).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(userId, 'admin_action', `íšŒì› ìƒíƒœ ë³€ê²½: ${targetUser?.email} â†’ ${status}`).run()
    
    // ì •ì§€ ì•Œë¦¼ ìƒì„±
    if (status === 'suspended') {
      await c.env.DB.prepare(
        'INSERT INTO notifications (type, title, message, priority) VALUES (?, ?, ?, ?)'
      ).bind('user_suspended', 'íšŒì› ì •ì§€', `${targetUser?.name}(${targetUser?.email})ë‹˜ì˜ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high').run()
    }
    
    return c.json({
      success: true,
      message: 'íšŒì› ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Admin user status error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ì‚­ì œ ====================
app.delete('/api/admin/users/:id', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const targetUserId = c.req.param('id')
    
    // ëŒ€ìƒ íšŒì› ì •ë³´ ì¡°íšŒ
    const targetUser = await c.env.DB.prepare(
      'SELECT email, name FROM users WHERE id = ?'
    ).bind(targetUserId).first()
    
    // ì†Œí”„íŠ¸ ì‚­ì œ
    await c.env.DB.prepare(
      'UPDATE users SET status = "deleted", updated_at = CURRENT_TIMESTAMP WHERE id = ?'
    ).bind(targetUserId).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(userId, 'admin_action', `íšŒì› ì‚­ì œ: ${targetUser?.email}`).run()
    
    // ì‚­ì œ ì•Œë¦¼ ìƒì„±
    await c.env.DB.prepare(
      'INSERT INTO notifications (type, title, message, priority) VALUES (?, ?, ?, ?)'
    ).bind('user_deleted', 'íšŒì› ì‚­ì œ', `${targetUser?.name}(${targetUser?.email})ë‹˜ì˜ ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'high').run()
    
    return c.json({
      success: true,
      message: 'íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Admin user delete error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ê³ ê¸‰ í†µê³„ (ì¼ë³„/ì›”ë³„ ì¶”ì„¸) ====================
app.get('/api/admin/stats/trends', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    // ìµœê·¼ 30ì¼ ì¼ë³„ ê°€ì…ì ìˆ˜
    const dailySignups = await c.env.DB.prepare(`
      SELECT DATE(created_at) as date, COUNT(*) as count 
      FROM users 
      WHERE created_at >= DATE('now', '-30 days')
      GROUP BY DATE(created_at)
      ORDER BY date
    `).all()
    
    // ìµœê·¼ 12ê°œì›” ì›”ë³„ ê°€ì…ì ìˆ˜
    const monthlySignups = await c.env.DB.prepare(`
      SELECT strftime('%Y-%m', created_at) as month, COUNT(*) as count 
      FROM users 
      WHERE created_at >= DATE('now', '-12 months')
      GROUP BY strftime('%Y-%m', created_at)
      ORDER BY month
    `).all()
    
    // ìµœê·¼ 30ì¼ ì¼ë³„ ë¡œê·¸ì¸ í™œë™
    const dailyLogins = await c.env.DB.prepare(`
      SELECT DATE(created_at) as date, COUNT(*) as count 
      FROM activity_logs 
      WHERE action = 'login' AND created_at >= DATE('now', '-30 days')
      GROUP BY DATE(created_at)
      ORDER BY date
    `).all()
    
    // ë“±ê¸‰ë³„ í™œë™ í†µê³„ (ìµœê·¼ 30ì¼)
    const levelActivity = await c.env.DB.prepare(`
      SELECT u.level, COUNT(al.id) as activity_count
      FROM users u
      LEFT JOIN activity_logs al ON u.id = al.user_id AND al.created_at >= DATE('now', '-30 days')
      WHERE u.status = 'active'
      GROUP BY u.level
      ORDER BY u.level
    `).all()
    
    return c.json({
      success: true,
      dailySignups: dailySignups.results,
      monthlySignups: monthlySignups.results,
      dailyLogins: dailyLogins.results,
      levelActivity: levelActivity.results
    })
  } catch (error) {
    console.error('Admin trends error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: í™œë™ ë¡œê·¸ ì¡°íšŒ ====================
app.get('/api/admin/activity-logs', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const limit = parseInt(c.req.query('limit') || '50')
    const action = c.req.query('action') || ''
    
    let query = `
      SELECT al.*, u.email, u.name 
      FROM activity_logs al
      LEFT JOIN users u ON al.user_id = u.id
      WHERE 1=1
    `
    const bindings = []
    
    if (action) {
      query += ' AND al.action = ?'
      bindings.push(action)
    }
    
    query += ' ORDER BY al.created_at DESC LIMIT ?'
    bindings.push(limit)
    
    const logs = await c.env.DB.prepare(query).bind(...bindings).all()
    
    return c.json({
      success: true,
      logs: logs.results
    })
  } catch (error) {
    console.error('Admin activity logs error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ ====================
app.get('/api/admin/notifications', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    // ê´€ë¦¬ììš© ì•Œë¦¼ (target_user_idê°€ NULLì´ê±°ë‚˜ í˜„ì¬ ê´€ë¦¬ì)
    const notifications = await c.env.DB.prepare(`
      SELECT * FROM notifications
      WHERE (target_user_id IS NULL OR target_user_id = ?)
      ORDER BY created_at DESC
      LIMIT 50
    `).bind(userId).all()
    
    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜
    const unreadCount = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM notifications
      WHERE (target_user_id IS NULL OR target_user_id = ?) AND is_read = 0
    `).bind(userId).first()
    
    return c.json({
      success: true,
      notifications: notifications.results,
      unreadCount: unreadCount.count
    })
  } catch (error) {
    console.error('Admin notifications error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ====================
app.patch('/api/admin/notifications/:id/read', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const notificationId = c.req.param('id')
    
    await c.env.DB.prepare(
      'UPDATE notifications SET is_read = 1 WHERE id = ?'
    ).bind(notificationId).run()
    
    return c.json({
      success: true,
      message: 'ì•Œë¦¼ì´ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Admin notification read error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: íšŒì› ì¼ê´„ ì²˜ë¦¬ ====================
app.post('/api/admin/users/batch', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    // ì¼ê´„ ì²˜ë¦¬ëŠ” ë ˆë²¨ 8 ì´ìƒë§Œ ê°€ëŠ¥
    if (!admin || admin.level < 8 || admin.status !== 'active') {
      return c.json({ success: false, message: 'í”Œë˜í‹°ë„˜ ê´€ë¦¬ì ì´ìƒì˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const { action, userIds, value } = await c.req.json()
    
    if (!action || !userIds || !Array.isArray(userIds)) {
      return c.json({ success: false, message: 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ ìš”ì²­ì…ë‹ˆë‹¤.' }, 400)
    }
    
    let query = ''
    let bindings = []
    
    switch (action) {
      case 'change_level':
        query = `UPDATE users SET level = ?, updated_at = CURRENT_TIMESTAMP WHERE id IN (${userIds.map(() => '?').join(',')})`
        bindings = [value, ...userIds]
        break
      case 'change_status':
        query = `UPDATE users SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id IN (${userIds.map(() => '?').join(',')})`
        bindings = [value, ...userIds]
        break
      case 'delete':
        query = `UPDATE users SET status = 'deleted', updated_at = CURRENT_TIMESTAMP WHERE id IN (${userIds.map(() => '?').join(',')})`
        bindings = userIds
        break
      default:
        return c.json({ success: false, message: 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì‘ì—…ì…ë‹ˆë‹¤.' }, 400)
    }
    
    await c.env.DB.prepare(query).bind(...bindings).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await c.env.DB.prepare(
      'INSERT INTO activity_logs (user_id, action, description) VALUES (?, ?, ?)'
    ).bind(userId, 'admin_action', `ì¼ê´„ ì²˜ë¦¬: ${action} (${userIds.length}ëª…)`).run()
    
    return c.json({
      success: true,
      message: `${userIds.length}ëª…ì˜ íšŒì›ì´ ì¼ê´„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
    })
  } catch (error) {
    console.error('Admin batch action error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== API: CSV ë‚´ë³´ë‚´ê¸° ====================
app.get('/api/admin/users/export', async (c) => {
  try {
    const authHeader = c.req.header('Authorization')
    if (!authHeader) {
      return c.json({ success: false, message: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    const token = authHeader.replace('Bearer ', '')
    const decoded = Buffer.from(token, 'base64').toString()
    const userId = decoded.split(':')[0]
    
    const admin = await c.env.DB.prepare(
      'SELECT level, status FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!admin || admin.level < 6 || admin.status !== 'active') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }
    
    const users = await c.env.DB.prepare(`
      SELECT id, email, name, phone, level, status, created_at, last_login
      FROM users
      WHERE status != 'deleted'
      ORDER BY created_at DESC
    `).all()
    
    // CSV ìƒì„±
    let csv = 'ID,ì´ë©”ì¼,ì´ë¦„,íœ´ëŒ€ì „í™”,ë“±ê¸‰,ìƒíƒœ,ê°€ì…ì¼,ìµœê·¼ë¡œê·¸ì¸\n'
    for (const user of users.results) {
      csv += `${user.id},"${user.email}","${user.name}","${user.phone || ''}",${user.level},"${user.status}","${user.created_at}","${user.last_login || ''}"\n`
    }
    
    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv; charset=utf-8',
        'Content-Disposition': `attachment; filename="users_${new Date().toISOString().split('T')[0]}.csv"`
      }
    })
  } catch (error) {
    console.error('Admin export error:', error)
    return c.json({ success: false, message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ==================== í™œë™ ë¡œê·¸ ê¸°ë¡ í—¬í¼ í•¨ìˆ˜ ====================
async function logActivity(db: any, userId: number | null, action: string, description: string, ip?: string) {
  try {
    await db.prepare(
      'INSERT INTO activity_logs (user_id, action, description, ip_address) VALUES (?, ?, ?, ?)'
    ).bind(userId, action, description, ip || null).run()
  } catch (error) {
    console.error('Log activity error:', error)
  }
}

// ==================== ì•Œë¦¼ ìƒì„± í—¬í¼ í•¨ìˆ˜ ====================
async function createNotification(db: any, type: string, title: string, message: string, targetUserId?: number, priority: string = 'normal') {
  try {
    await db.prepare(
      'INSERT INTO notifications (type, title, message, target_user_id, priority) VALUES (?, ?, ?, ?, ?)'
    ).bind(type, title, message, targetUserId || null, priority).run()
  } catch (error) {
    console.error('Create notification error:', error)
  }
}

// ==================== í†µê³„ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ (ê³ ê¸‰) ====================
app.get('/admin/stats', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê³ ê¸‰ í†µê³„ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-2xl font-bold">Faith Portal</a>
                        <span class="text-sm bg-yellow-500 text-gray-900 px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-1"></i>
                            ê´€ë¦¬ì
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-sm"></span>
                        <a href="/" class="text-sm hover:text-blue-200">
                            <i class="fas fa-home mr-1"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin/stats')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì', href: '/admin'},
          {label: 'í†µê³„'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                ê³ ê¸‰ í†µê³„ ë¶„ì„
            </h2>

            <!-- ì¼ë³„ ê°€ì…ì ì¶”ì„¸ -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-area text-blue-600 mr-2"></i>
                    ìµœê·¼ 30ì¼ ì¼ë³„ ê°€ì…ì ì¶”ì„¸
                </h3>
                <canvas id="dailySignupsChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- ì›”ë³„ ê°€ì…ì ì¶”ì„¸ -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                    ìµœê·¼ 12ê°œì›” ì›”ë³„ ê°€ì…ì ì¶”ì„¸
                </h3>
                <canvas id="monthlySignupsChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- ë¡œê·¸ì¸ í™œë™ ì¶”ì„¸ -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-sign-in-alt text-blue-600 mr-2"></i>
                    ìµœê·¼ 30ì¼ ì¼ë³„ ë¡œê·¸ì¸ í™œë™
                </h3>
                <canvas id="dailyLoginsChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- ë“±ê¸‰ë³„ í™œë™ í†µê³„ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-users-cog text-blue-600 mr-2"></i>
                    ë“±ê¸‰ë³„ í™œë™ í†µê³„ (ìµœê·¼ 30ì¼)
                </h3>
                <canvas id="levelActivityChart" style="max-height: 300px;"></canvas>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            // ì¸ì¦ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }

            document.getElementById('admin-name').textContent = localStorage.getItem('user_email') || '';

            // ë“±ê¸‰ëª… ë°˜í™˜
            function getLevelName(level) {
                const levels = {
                    1: 'ì¼ë°˜ íšŒì›', 2: 'ì •íšŒì›', 3: 'ìš°ìˆ˜íšŒì›', 4: 'VIP', 5: 'VVIP',
                    6: 'ì‹¤ë²„ ê´€ë¦¬ì', 7: 'ê³¨ë“œ ê´€ë¦¬ì', 8: 'í”Œë˜í‹°ë„˜ ê´€ë¦¬ì',
                    9: 'ë§ˆìŠ¤í„° ê´€ë¦¬ì', 10: 'ìŠˆí¼ë°”ì´ì €'
                };
                return levels[level] || 'ì•Œ ìˆ˜ ì—†ìŒ';
            }

            // í†µê³„ ë°ì´í„° ë¡œë“œ
            async function loadTrends() {
                try {
                    const response = await axios.get('/api/admin/stats/trends', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    const data = response.data;
                    
                    // ì¼ë³„ ê°€ì…ì ì°¨íŠ¸
                    createDailySignupsChart(data.dailySignups);
                    
                    // ì›”ë³„ ê°€ì…ì ì°¨íŠ¸
                    createMonthlySignupsChart(data.monthlySignups);
                    
                    // ì¼ë³„ ë¡œê·¸ì¸ ì°¨íŠ¸
                    createDailyLoginsChart(data.dailyLogins);
                    
                    // ë“±ê¸‰ë³„ í™œë™ ì°¨íŠ¸
                    createLevelActivityChart(data.levelActivity);
                } catch (error) {
                    console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì¼ë³„ ê°€ì…ì ì°¨íŠ¸
            function createDailySignupsChart(data) {
                const ctx = document.getElementById('dailySignupsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'ê°€ì…ì ìˆ˜',
                            data: data.map(d => d.count),
                            borderColor: 'rgba(30, 64, 175, 1)',
                            backgroundColor: 'rgba(30, 64, 175, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // ì›”ë³„ ê°€ì…ì ì°¨íŠ¸
            function createMonthlySignupsChart(data) {
                const ctx = document.getElementById('monthlySignupsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.month),
                        datasets: [{
                            label: 'ì›”ë³„ ê°€ì…ì',
                            data: data.map(d => d.count),
                            backgroundColor: 'rgba(30, 64, 175, 0.7)',
                            borderColor: 'rgba(30, 64, 175, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // ì¼ë³„ ë¡œê·¸ì¸ ì°¨íŠ¸
            function createDailyLoginsChart(data) {
                const ctx = document.getElementById('dailyLoginsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'ë¡œê·¸ì¸ ìˆ˜',
                            data: data.map(d => d.count),
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // ë“±ê¸‰ë³„ í™œë™ ì°¨íŠ¸
            function createLevelActivityChart(data) {
                const ctx = document.getElementById('levelActivityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => 'Lv.' + d.level + ' ' + getLevelName(d.level)),
                        datasets: [{
                            label: 'í™œë™ ìˆ˜',
                            data: data.map(d => d.activity_count),
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ë¡œë“œ
            loadTrends();
        </script>
    </body>
    </html>
  `)
})

// ==================== í™œë™ ë¡œê·¸ í˜ì´ì§€ ====================
app.get('/admin/logs', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í™œë™ ë¡œê·¸ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-2xl font-bold">Faith Portal</a>
                        <span class="text-sm bg-yellow-500 text-gray-900 px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-1"></i>
                            ê´€ë¦¬ì
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-sm"></span>
                        <a href="/" class="text-sm hover:text-blue-200">
                            <i class="fas fa-home mr-1"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin/logs')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì', href: '/admin'},
          {label: 'í™œë™ ë¡œê·¸'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-history text-blue-600 mr-2"></i>
                í™œë™ ë¡œê·¸
            </h2>

            <!-- í•„í„° -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="action-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ íƒ€ì…</option>
                        <option value="login">ë¡œê·¸ì¸</option>
                        <option value="signup">íšŒì›ê°€ì…</option>
                        <option value="admin_action">ê´€ë¦¬ì ì‘ì—…</option>
                    </select>
                    <select id="limit-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="50">50ê°œ</option>
                        <option value="100">100ê°œ</option>
                        <option value="200">200ê°œ</option>
                    </select>
                    <button onclick="loadLogs()" class="faith-blue text-white px-6 py-2 rounded-lg faith-blue-hover">
                        <i class="fas fa-sync mr-2"></i>
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button onclick="toggleAutoRefresh()" id="auto-refresh-btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        <i class="fas fa-play mr-2"></i>
                        ìë™ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ë¡œê·¸ ëª©ë¡ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-list text-blue-600 mr-2"></i>
                        ë¡œê·¸ ëª©ë¡
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">íƒ€ì…</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‚¬ìš©ì</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì„¤ëª…</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP ì£¼ì†Œ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table" class="bg-white divide-y divide-gray-200">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            // ì¸ì¦ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }

            document.getElementById('admin-name').textContent = localStorage.getItem('user_email') || '';

            let autoRefreshInterval = null;

            // ë¡œê·¸ íƒ€ì… ë°°ì§€
            function getActionBadge(action) {
                const badges = {
                    login: 'bg-green-100 text-green-800',
                    signup: 'bg-blue-100 text-blue-800',
                    admin_action: 'bg-purple-100 text-purple-800'
                };
                const names = {
                    login: 'ë¡œê·¸ì¸',
                    signup: 'íšŒì›ê°€ì…',
                    admin_action: 'ê´€ë¦¬ì'
                };
                return \`<span class="px-2 py-1 text-xs rounded-full \${badges[action] || 'bg-gray-100 text-gray-800'}">\${names[action] || action}</span>\`;
            }

            // ë¡œê·¸ ë¡œë“œ
            async function loadLogs() {
                try {
                    const action = document.getElementById('action-filter').value;
                    const limit = document.getElementById('limit-filter').value;
                    
                    let url = \`/api/admin/activity-logs?limit=\${limit}\`;
                    if (action) url += \`&action=\${action}\`;
                    
                    const response = await axios.get(url, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    displayLogs(response.data.logs);
                } catch (error) {
                    console.error('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // ë¡œê·¸ í‘œì‹œ
            function displayLogs(logs) {
                const tbody = document.getElementById('logs-table');
                tbody.innerHTML = logs.map(log => \`
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${log.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            \${getActionBadge(log.action)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            \${log.email || 'ì‹œìŠ¤í…œ'}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">\${log.description || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\${log.ip_address || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            \${new Date(log.created_at).toLocaleString('ko-KR')}
                        </td>
                    </tr>
                \`).join('');
            }

            // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
            function toggleAutoRefresh() {
                const btn = document.getElementById('auto-refresh-btn');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i>ìë™ ìƒˆë¡œê³ ì¹¨';
                    btn.className = 'bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600';
                } else {
                    autoRefreshInterval = setInterval(loadLogs, 5000); // 5ì´ˆë§ˆë‹¤
                    btn.innerHTML = '<i class="fas fa-pause mr-2"></i>ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘';
                    btn.className = 'bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600';
                }
            }

            // ì´ˆê¸° ë¡œë“œ
            loadLogs();
        </script>
    </body>
    </html>
  `)
})

// ==================== ì•Œë¦¼ ì„¼í„° í˜ì´ì§€ ====================
app.get('/admin/notifications', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì•Œë¦¼ ì„¼í„° - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-2xl font-bold">Faith Portal</a>
                        <span class="text-sm bg-yellow-500 text-gray-900 px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-1"></i>
                            ê´€ë¦¬ì
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-sm"></span>
                        <a href="/" class="text-sm hover:text-blue-200">
                            <i class="fas fa-home mr-1"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin/notifications')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì', href: '/admin'},
          {label: 'ì•Œë¦¼ ì„¼í„°'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-bell text-blue-600 mr-2"></i>
                    ì•Œë¦¼ ì„¼í„°
                </h2>
                <div class="space-x-2">
                    <button onclick="filterNotifications('all')" id="filter-all" class="px-4 py-2 rounded-lg bg-blue-600 text-white">
                        ì „ì²´
                    </button>
                    <button onclick="filterNotifications('unread')" id="filter-unread" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        ì½ì§€ ì•ŠìŒ
                    </button>
                    <button onclick="filterNotifications('read')" id="filter-read" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700">
                        ì½ìŒ
                    </button>
                    <button onclick="loadNotifications()" class="px-4 py-2 rounded-lg bg-green-500 text-white">
                        <i class="fas fa-sync mr-2"></i>
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ì•Œë¦¼ ëª©ë¡ -->
            <div id="notifications-list" class="space-y-4">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="empty-state" class="hidden bg-white rounded-lg shadow p-12 text-center">
                <i class="fas fa-bell-slash text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
            // ì¸ì¦ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }

            document.getElementById('admin-name').textContent = localStorage.getItem('user_email') || '';

            let allNotifications = [];
            let currentFilter = 'all';

            // ì•Œë¦¼ ë¡œë“œ
            async function loadNotifications() {
                try {
                    const response = await axios.get('/api/admin/notifications', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    allNotifications = response.data.notifications;
                    
                    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ í‘œì‹œ
                    const unreadCount = response.data.unreadCount;
                    const badge = document.getElementById('unread-badge');
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                    
                    displayNotifications();
                } catch (error) {
                    console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // ì•Œë¦¼ í•„í„°ë§
            function filterNotifications(filter) {
                currentFilter = filter;
                
                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
                document.getElementById('filter-all').className = 'px-4 py-2 rounded-lg ' + (filter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700');
                document.getElementById('filter-unread').className = 'px-4 py-2 rounded-lg ' + (filter === 'unread' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700');
                document.getElementById('filter-read').className = 'px-4 py-2 rounded-lg ' + (filter === 'read' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700');
                
                displayNotifications();
            }

            // ì•Œë¦¼ í‘œì‹œ
            function displayNotifications() {
                let filtered = allNotifications;
                
                if (currentFilter === 'unread') {
                    filtered = allNotifications.filter(n => n.is_read === 0);
                } else if (currentFilter === 'read') {
                    filtered = allNotifications.filter(n => n.is_read === 1);
                }
                
                const container = document.getElementById('notifications-list');
                const emptyState = document.getElementById('empty-state');
                
                if (filtered.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                container.innerHTML = filtered.map(notif => \`
                    <div class="bg-white rounded-lg shadow p-6 \${notif.is_read === 0 ? 'border-l-4 border-blue-600' : ''}" onclick="markAsRead(\${notif.id})">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <span class="px-2 py-1 text-xs rounded-full \${notif.priority === 'high' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                        \${notif.priority === 'high' ? 'ë†’ìŒ' : 'ì¼ë°˜'}
                                    </span>
                                    <span class="ml-2 text-xs text-gray-500">
                                        \${new Date(notif.created_at).toLocaleString('ko-KR')}
                                    </span>
                                    \${notif.is_read === 0 ? '<span class="ml-2 px-2 py-1 text-xs rounded-full bg-blue-500 text-white">ìƒˆ ì•Œë¦¼</span>' : ''}
                                </div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">\${notif.title}</h4>
                                <p class="text-gray-600">\${notif.message}</p>
                            </div>
                            \${notif.is_read === 0 ? '<i class="fas fa-circle text-blue-600 ml-4"></i>' : ''}
                        </div>
                    </div>
                \`).join('');
            }

            // ì½ìŒ ì²˜ë¦¬
            async function markAsRead(notificationId) {
                try {
                    await axios.patch(\`/api/admin/notifications/\${notificationId}/read\`, {}, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    // ì•Œë¦¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadNotifications();
                } catch (error) {
                    console.error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                }
            }

            // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            setInterval(loadNotifications, 5000);

            // ì´ˆê¸° ë¡œë“œ
            loadNotifications();
        </script>
    </body>
    </html>
  `)
})

// ==================== RSS í”¼ë“œ íŒŒì‹± ìœ í‹¸ë¦¬í‹° ====================
async function parseGoogleNewsRSS(category: string = 'general'): Promise<any[]> {
  const rssUrls: Record<string, string> = {
    'general': 'https://news.google.com/rss?hl=ko&gl=KR&ceid=KR:ko',
    'politics': 'https://news.google.com/rss/topics/CAAqIQgKIhtDQkFTRGdvSUwyMHZNRFZ4ZERBU0FtdHZLQUFQAQ?hl=ko&gl=KR&ceid=KR:ko',
    'economy': 'https://news.google.com/rss/topics/CAAqIggKIhxDQkFTRHdvSkwyMHZNR2RtY0hNekVnSnJieWdBUAE?hl=ko&gl=KR&ceid=KR:ko',
    'tech': 'https://news.google.com/rss/topics/CAAqIQgKIhtDQkFTRGdvSUwyMHZNRGRqTVhZU0FtdHZLQUFQAQ?hl=ko&gl=KR&ceid=KR:ko',
    'sports': 'https://news.google.com/rss/topics/CAAqIQgKIhtDQkFTRGdvSUwyMHZNRFp1ZEdvU0FtdHZLQUFQAQ?hl=ko&gl=KR&ceid=KR:ko',
    'entertainment': 'https://news.google.com/rss/topics/CAAqIQgKIhtDQkFTRGdvSUwyMHZNREpxYW5RU0FtdHZLQUFQAQ?hl=ko&gl=KR&ceid=KR:ko',
  }

  const url = rssUrls[category] || rssUrls['general']
  
  // HTML ì—”í‹°í‹° ë””ì½”ë”© í•¨ìˆ˜
  function decodeHtmlEntities(text: string): string {
    const entities: Record<string, string> = {
      '&lt;': '<',
      '&gt;': '>',
      '&amp;': '&',
      '&quot;': '"',
      '&#39;': "'",
      '&apos;': "'",
      '&nbsp;': ' ',
      '&copy;': 'Â©',
      '&reg;': 'Â®',
      '&trade;': 'â„¢',
      '&hellip;': '...',
      '&mdash;': 'â€”',
      '&ndash;': 'â€“',
      '&bull;': 'â€¢',
      '&middot;': 'Â·',
      '&lsquo;': '\u2018',
      '&rsquo;': '\u2019',
      '&ldquo;': '\u201C',
      '&rdquo;': '\u201D',
    }
    return text.replace(/&[#\w]+;/g, (entity) => entities[entity] || '')
  }
  
  try {
    // êµ¬ê¸€ ì°¨ë‹¨ ë°©ì§€: User-Agent, Referer í—¤ë” ì¶”ê°€
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'application/rss+xml, application/xml, text/xml, */*',
        'Accept-Language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
        'Referer': 'https://news.google.com/',
        'Cache-Control': 'no-cache',
      },
    })
    
    if (!response.ok) {
      console.error(`RSS fetch failed: ${response.status} ${response.statusText}`)
      return []
    }
    
    const text = await response.text()
    
    // XML íŒŒì‹± (ê°„ë‹¨í•œ ì •ê·œì‹ ê¸°ë°˜)
    const items: any[] = []
    const itemRegex = /<item>([\s\S]*?)<\/item>/g
    let match
    
    while ((match = itemRegex.exec(text)) !== null) {
      const itemContent = match[1]
      
      const title = itemContent.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)?.[1] || 
                    itemContent.match(/<title>(.*?)<\/title>/)?.[1] || ''
      let link = itemContent.match(/<link>(.*?)<\/link>/)?.[1] || ''
      const pubDate = itemContent.match(/<pubDate>(.*?)<\/pubDate>/)?.[1] || ''
      let description = itemContent.match(/<description><!\[CDATA\[(.*?)\]\]><\/description>/)?.[1] ||
                        itemContent.match(/<description>(.*?)<\/description>/)?.[1] || ''
      
      // Google News RSSì˜ linkëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì´ì§€ë§Œ ì‹¤ì œ ê¸°ì‚¬ë¡œ ìë™ ë¦¬ë””ë ‰ì…˜ë¨
      // source íƒœê·¸ì˜ url ì†ì„±ì—ëŠ” ë„ë©”ì¸ë§Œ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      // linkë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (Google News ë¦¬ë‹¤ì´ë ‰íŠ¸ â†’ ì‹¤ì œ ê¸°ì‚¬)
      
      // HTML ì—”í‹°í‹° ë””ì½”ë”©
      description = decodeHtmlEntities(description)
      
      // ì´ë¯¸ì§€ URL ì¶”ì¶œ (ì—¬ëŸ¬ íŒ¨í„´ ì‹œë„)
      const categoryImages: Record<string, string> = {
        'general': 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=400&h=300&fit=crop',
        'politics': 'https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?w=400&h=300&fit=crop',
        'economy': 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=400&h=300&fit=crop',
        'tech': 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=400&h=300&fit=crop',
        'sports': 'https://images.unsplash.com/photo-1461896836934-ffe607ba8211?w=400&h=300&fit=crop',
        'entertainment': 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=400&h=300&fit=crop',
      }
      
      let imageUrl = categoryImages[category] || categoryImages['general']
      
      // íŒ¨í„´ 1: <img src="...">
      let imgMatch = description.match(/<img[^>]+src=["']([^"']+)["']/)
      if (imgMatch && imgMatch[1]) {
        imageUrl = imgMatch[1]
      } else {
        // íŒ¨í„´ 2: url(...) in style
        imgMatch = description.match(/url\(["']?([^"')]+)["']?\)/)
        if (imgMatch && imgMatch[1]) {
          imageUrl = imgMatch[1]
        }
      }
      
      // HTML íƒœê·¸ ì™„ì „ ì œê±°í•˜ì—¬ ìš”ì•½ë¬¸ ìƒì„±
      let summary = description
        .replace(/<[^>]*>/g, '')  // HTML íƒœê·¸ ì œê±°
        .replace(/&nbsp;/g, ' ')  // &nbsp; ì œê±°
        .replace(/&[#\w]+;/g, '') // ë‚¨ì€ HTML ì—”í‹°í‹° ì œê±°
        .replace(/\s+/g, ' ')      // ê³µë°± ì •ë¦¬
        .trim()
        .substring(0, 150)
      
      // ìš”ì•½ë¬¸ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì œëª© ì‚¬ìš©
      if (summary.length < 20) {
        summary = title.substring(0, 150)
      }
      
      if (summary.length > 0 && summary.length < 150) {
        summary += '...'
      }
      
      items.push({
        category,
        title: title.trim(),
        summary: summary || 'ë‰´ìŠ¤ ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.',
        link: link.trim(),
        image_url: imageUrl,
        publisher: 'êµ¬ê¸€ ë‰´ìŠ¤',
        pub_date: pubDate,
      })
      
      if (items.length >= 20) break // ìµœëŒ€ 20ê°œ
    }
    
    return items
  } catch (error) {
    console.error('RSS íŒŒì‹± ì˜¤ë¥˜:', error)
    return []
  }
}

// ==================== Gemini AI ìš”ì•½ ë° ê°ì • ë¶„ì„ í•¨ìˆ˜ ====================
async function summarizeWithGemini(title: string, summary: string): Promise<{ aiSummary: string, sentiment: string }> {
  try {
    // Gemini API í‚¤ í™•ì¸
    const GEMINI_API_KEY = 'AIzaSyBKN3R7vG_L7RpQhxO8uZUTL-vfZGx0234' // ì‹¤ì œ API í‚¤ë¡œ êµì²´ í•„ìš”
    
    const prompt = `ë‹¤ìŒ ë‰´ìŠ¤ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•˜ê³  ê°ì •ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì œëª©: ${title}
ë‚´ìš©: ${summary}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
ìš”ì•½: [3ì¤„ ìš”ì•½]
ê°ì •: [positive/negative/neutral ì¤‘ í•˜ë‚˜]`

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }]
      })
    })

    if (!response.ok) {
      console.error('Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', response.status, response.statusText)
      return {
        aiSummary: summary.substring(0, 150) + '...',
        sentiment: 'neutral'
      }
    }

    const data = await response.json()
    const text = data.candidates[0]?.content?.parts[0]?.text || ''
    
    // ì‘ë‹µ íŒŒì‹±
    const summaryMatch = text.match(/ìš”ì•½:\s*(.+?)(?=\nê°ì •:|$)/s)
    const sentimentMatch = text.match(/ê°ì •:\s*(positive|negative|neutral)/i)
    
    const aiSummary = summaryMatch ? summaryMatch[1].trim() : summary.substring(0, 150) + '...'
    const sentiment = sentimentMatch ? sentimentMatch[1].toLowerCase() : 'neutral'
    
    return { aiSummary, sentiment }
  } catch (error) {
    console.error('Gemini AI ì˜¤ë¥˜:', error)
    return {
      aiSummary: summary.substring(0, 150) + '...',
      sentiment: 'neutral'
    }
  }
}

// ==================== ë‰´ìŠ¤ AI ìš”ì•½ API ====================
app.post('/api/news/:id/summarize', async (c) => {
  try {
    const { id } = c.req.param()
    const { env } = c
    
    // ë‰´ìŠ¤ ì¡°íšŒ
    const news = await env.DB.prepare('SELECT * FROM news WHERE id = ?').bind(id).first()
    
    if (!news) {
      return c.json({ success: false, error: 'ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // ì´ë¯¸ AI ì²˜ë¦¬ëœ ê²½ìš°
    if (news.ai_processed) {
      return c.json({ 
        success: true, 
        ai_summary: news.ai_summary,
        sentiment: news.sentiment
      })
    }
    
    // Gemini AIë¡œ ìš”ì•½ ë° ê°ì • ë¶„ì„
    const { aiSummary, sentiment } = await summarizeWithGemini(news.title, news.summary || '')
    
    // DB ì—…ë°ì´íŠ¸
    await env.DB.prepare(`
      UPDATE news 
      SET ai_summary = ?, sentiment = ?, ai_processed = 1 
      WHERE id = ?
    `).bind(aiSummary, sentiment, id).run()
    
    return c.json({ 
      success: true, 
      ai_summary: aiSummary,
      sentiment: sentiment
    })
  } catch (error) {
    console.error('ë‰´ìŠ¤ ìš”ì•½ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ìš”ì•½ ìƒì„± ì‹¤íŒ¨' }, 500)
  }
})

// ==================== íˆ¬í‘œ ì‹œìŠ¤í…œ API ====================
app.post('/api/news/:id/vote', async (c) => {
  try {
    const { id } = c.req.param()
    const { type } = await c.req.json() // 'up' or 'down'
    const { env } = c
    
    // íˆ¬í‘œ íƒ€ì… ê²€ì¦
    if (type !== 'up' && type !== 'down') {
      return c.json({ success: false, error: 'ì˜ëª»ëœ íˆ¬í‘œ íƒ€ì…ì…ë‹ˆë‹¤' }, 400)
    }
    
    // ì‚¬ìš©ì IP ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ìš©)
    const userIp = c.req.header('cf-connecting-ip') || c.req.header('x-forwarded-for') || 'unknown'
    
    // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (ë¡œê·¸ì¸í•œ ê²½ìš°)
    const authToken = c.req.header('Authorization')?.replace('Bearer ', '')
    let userId = null
    
    if (authToken) {
      try {
        const payload = await c.env.JWT_SECRET ? 
          c.get('jwtPayload') : null
        userId = payload?.userId || null
      } catch (e) {
        // í† í° ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë¹„ë¡œê·¸ì¸ìœ¼ë¡œ ì²˜ë¦¬
      }
    }
    
    // ì¤‘ë³µ íˆ¬í‘œ ì²´í¬
    let existingVote
    if (userId) {
      existingVote = await env.DB.prepare(
        'SELECT * FROM news_votes WHERE news_id = ? AND user_id = ?'
      ).bind(id, userId).first()
    } else {
      existingVote = await env.DB.prepare(
        'SELECT * FROM news_votes WHERE news_id = ? AND user_ip = ?'
      ).bind(id, userIp).first()
    }
    
    // ì´ë¯¸ íˆ¬í‘œí•œ ê²½ìš°
    if (existingVote) {
      // ê°™ì€ íƒ€ì…ì´ë©´ ì·¨ì†Œ
      if (existingVote.vote_type === type) {
        await env.DB.prepare('DELETE FROM news_votes WHERE id = ?').bind(existingVote.id).run()
        
        // ì¹´ìš´íŠ¸ ê°ì†Œ
        const field = type === 'up' ? 'vote_up' : 'vote_down'
        await env.DB.prepare(`UPDATE news SET ${field} = ${field} - 1 WHERE id = ?`).bind(id).run()
        
        return c.json({ success: true, action: 'cancelled', type })
      } else {
        // ë‹¤ë¥¸ íƒ€ì…ì´ë©´ ë³€ê²½
        await env.DB.prepare(
          'UPDATE news_votes SET vote_type = ? WHERE id = ?'
        ).bind(type, existingVote.id).run()
        
        // ê¸°ì¡´ íƒ€ì… ê°ì†Œ, ìƒˆ íƒ€ì… ì¦ê°€
        const oldField = existingVote.vote_type === 'up' ? 'vote_up' : 'vote_down'
        const newField = type === 'up' ? 'vote_up' : 'vote_down'
        await env.DB.prepare(`
          UPDATE news 
          SET ${oldField} = ${oldField} - 1, ${newField} = ${newField} + 1 
          WHERE id = ?
        `).bind(id).run()
        
        return c.json({ success: true, action: 'changed', type })
      }
    }
    
    // ìƒˆ íˆ¬í‘œ ì¶”ê°€
    await env.DB.prepare(`
      INSERT INTO news_votes (news_id, user_id, user_ip, vote_type)
      VALUES (?, ?, ?, ?)
    `).bind(id, userId, userIp, type).run()
    
    // ì¹´ìš´íŠ¸ ì¦ê°€
    const field = type === 'up' ? 'vote_up' : 'vote_down'
    await env.DB.prepare(`UPDATE news SET ${field} = ${field} + 1 WHERE id = ?`).bind(id).run()
    
    // ì¸ê¸°ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸ (upì€ +2, downì€ -1)
    const scoreChange = type === 'up' ? 2 : -1
    await env.DB.prepare(`
      UPDATE news 
      SET popularity_score = popularity_score + ? 
      WHERE id = ?
    `).bind(scoreChange, id).run()
    
    return c.json({ success: true, action: 'voted', type })
  } catch (error) {
    console.error('íˆ¬í‘œ ì²˜ë¦¬ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'íˆ¬í‘œ ì²˜ë¦¬ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ë‰´ìŠ¤ íˆ¬í‘œ í˜„í™© ì¡°íšŒ API ====================
app.get('/api/news/:id/votes', async (c) => {
  try {
    const { id } = c.req.param()
    const { env } = c
    
    const news = await env.DB.prepare(`
      SELECT vote_up, vote_down, popularity_score 
      FROM news 
      WHERE id = ?
    `).bind(id).first()
    
    if (!news) {
      return c.json({ success: false, error: 'ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    return c.json({
      success: true,
      vote_up: news.vote_up || 0,
      vote_down: news.vote_down || 0,
      popularity_score: news.popularity_score || 0
    })
  } catch (error) {
    console.error('íˆ¬í‘œ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'íˆ¬í‘œ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== í‚¤ì›Œë“œ êµ¬ë… ì‹œìŠ¤í…œ API ====================
app.post('/api/keywords/subscribe', async (c) => {
  try {
    const { keyword, userId } = await c.req.json()
    const { env } = c
    
    // userId ê²€ì¦
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // í‚¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
    if (!keyword || keyword.trim().length === 0) {
      return c.json({ success: false, error: 'í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    if (keyword.length > 50) {
      return c.json({ success: false, error: 'í‚¤ì›Œë“œëŠ” 50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    try {
      // í‚¤ì›Œë“œ êµ¬ë… ì¶”ê°€ (ì¤‘ë³µ ì‹œ ë¬´ì‹œ)
      await env.DB.prepare(`
        INSERT INTO user_keywords (user_id, keyword)
        VALUES (?, ?)
      `).bind(parseInt(userId), keyword.trim()).run()
      
      return c.json({ success: true, keyword: keyword.trim() })
    } catch (err: any) {
      if (err.message?.includes('UNIQUE constraint failed')) {
        return c.json({ success: false, error: 'ì´ë¯¸ êµ¬ë… ì¤‘ì¸ í‚¤ì›Œë“œì…ë‹ˆë‹¤' }, 400)
      }
      throw err
    }
  } catch (error) {
    console.error('í‚¤ì›Œë“œ êµ¬ë… ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'í‚¤ì›Œë“œ êµ¬ë… ì‹¤íŒ¨' }, 500)
  }
})

// ==================== í‚¤ì›Œë“œ êµ¬ë… ì·¨ì†Œ API ====================
app.delete('/api/keywords/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const { userId } = await c.req.json()
    const { env } = c
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    await env.DB.prepare(`
      DELETE FROM user_keywords 
      WHERE id = ? AND user_id = ?
    `).bind(parseInt(id), parseInt(userId)).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('í‚¤ì›Œë“œ êµ¬ë… ì·¨ì†Œ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'êµ¬ë… ì·¨ì†Œ ì‹¤íŒ¨' }, 500)
  }
})

// DELETE by keyword (legacy)
app.delete('/api/keywords/:keyword', async (c) => {
  try {
    const keyword = decodeURIComponent(c.req.param('keyword'))
    const { env } = c
    
    const authToken = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!authToken) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
    }
    
    const userId = 1 // TODO: JWTì—ì„œ ì‹¤ì œ user_id ì¶”ì¶œ
    
    await env.DB.prepare(`
      DELETE FROM user_keywords 
      WHERE user_id = ? AND keyword = ?
    `).bind(userId, keyword).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('í‚¤ì›Œë“œ êµ¬ë… ì·¨ì†Œ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'êµ¬ë… ì·¨ì†Œ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ë‚´ í‚¤ì›Œë“œ ëª©ë¡ ì¡°íšŒ API ====================
app.get('/api/keywords/my', async (c) => {
  try {
    const { env } = c
    
    const authToken = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!authToken) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
    }
    
    const userId = 1 // TODO: JWTì—ì„œ ì‹¤ì œ user_id ì¶”ì¶œ
    
    const { results } = await env.DB.prepare(`
      SELECT keyword, created_at 
      FROM user_keywords 
      WHERE user_id = ? 
      ORDER BY created_at DESC
    `).bind(userId).all()
    
    return c.json({ success: true, keywords: results || [] })
  } catch (error) {
    console.error('í‚¤ì›Œë“œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== í‚¤ì›Œë“œ ëª©ë¡ ì¡°íšŒ API (userId íŒŒë¼ë¯¸í„°) ====================
app.get('/api/keywords', async (c) => {
  try {
    const userId = c.req.query('userId')
    const { env } = c
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    const { results } = await env.DB.prepare(`
      SELECT id, keyword, created_at 
      FROM user_keywords 
      WHERE user_id = ? 
      ORDER BY created_at DESC
    `).bind(parseInt(userId)).all()
    
    return c.json({ success: true, keywords: results || [] })
  } catch (error) {
    console.error('í‚¤ì›Œë“œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== í‚¤ì›Œë“œë³„ ë‰´ìŠ¤ ì¡°íšŒ API ====================
app.get('/api/news/keyword/:keyword', async (c) => {
  try {
    const keyword = decodeURIComponent(c.req.param('keyword'))
    const { env } = c
    
    const { results } = await env.DB.prepare(`
      SELECT * FROM news 
      WHERE title LIKE ? OR summary LIKE ?
      ORDER BY created_at DESC 
      LIMIT 50
    `).bind(`%${keyword}%`, `%${keyword}%`).all()
    
    return c.json({ success: true, news: results || [], keyword })
  } catch (error) {
    console.error('í‚¤ì›Œë“œ ë‰´ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== íˆ¬í‘œ API ====================
// ì¡°íšŒìˆ˜ ì¦ê°€ API
app.post('/api/news/:id/view', async (c) => {
  try {
    const newsId = c.req.param('id')
    const { env } = c
    
    // ì¡°íšŒìˆ˜ ì¦ê°€
    await env.DB.prepare(`
      UPDATE news 
      SET view_count = view_count + 1
      WHERE id = ?
    `).bind(newsId).run()
    
    // ì—…ë°ì´íŠ¸ëœ ì¡°íšŒìˆ˜ ì¡°íšŒ
    const newsData = await env.DB.prepare(
      'SELECT view_count FROM news WHERE id = ?'
    ).bind(newsId).first()
    
    return c.json({
      success: true,
      view_count: newsData?.view_count || 0
    })
  } catch (error) {
    console.error('ì¡°íšŒìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤íŒ¨' }, 500)
  }
})

app.post('/api/news/vote', async (c) => {
  try {
    const { userId, newsId, voteType } = await c.req.json()
    const { env } = c
    
    // ì…ë ¥ ê²€ì¦
    if (!userId || !newsId || !voteType) {
      return c.json({ success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
    }
    
    if (voteType !== 'up' && voteType !== 'down') {
      return c.json({ success: false, error: 'ì˜ëª»ëœ íˆ¬í‘œ íƒ€ì…ì…ë‹ˆë‹¤' }, 400)
    }
    
    // ê¸°ì¡´ íˆ¬í‘œ í™•ì¸
    const existingVote = await env.DB.prepare(
      'SELECT * FROM news_votes WHERE user_id = ? AND news_id = ?'
    ).bind(userId, newsId).first()
    
    // ê¸°ì¡´ íˆ¬í‘œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì‚½ì…
    if (existingVote) {
      // ê°™ì€ íƒ€ì…ì´ë©´ ì·¨ì†Œ
      if (existingVote.vote_type === voteType) {
        // íˆ¬í‘œ ì‚­ì œ
        await env.DB.prepare('DELETE FROM news_votes WHERE id = ?').bind(existingVote.id).run()
        
        // ì¹´ìš´íŠ¸ ê°ì†Œ
        const field = voteType === 'up' ? 'vote_up' : 'vote_down'
        await env.DB.prepare(`
          UPDATE news 
          SET ${field} = ${field} - 1,
              popularity_score = vote_up - vote_down
          WHERE id = ?
        `).bind(newsId).run()
      } else {
        // ë‹¤ë¥¸ íƒ€ì…ì´ë©´ ë³€ê²½
        await env.DB.prepare(
          'UPDATE news_votes SET vote_type = ? WHERE id = ?'
        ).bind(voteType, existingVote.id).run()
        
        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        const oldField = existingVote.vote_type === 'up' ? 'vote_up' : 'vote_down'
        const newField = voteType === 'up' ? 'vote_up' : 'vote_down'
        await env.DB.prepare(`
          UPDATE news 
          SET ${oldField} = ${oldField} - 1,
              ${newField} = ${newField} + 1,
              popularity_score = vote_up - vote_down
          WHERE id = ?
        `).bind(newsId).run()
      }
    } else {
      // ìƒˆ íˆ¬í‘œ ì¶”ê°€
      await env.DB.prepare(
        'INSERT INTO news_votes (user_id, news_id, vote_type) VALUES (?, ?, ?)'
      ).bind(userId, newsId, voteType).run()
      
      // ì¹´ìš´íŠ¸ ì¦ê°€
      const field = voteType === 'up' ? 'vote_up' : 'vote_down'
      await env.DB.prepare(`
        UPDATE news 
        SET ${field} = ${field} + 1,
            popularity_score = vote_up - vote_down
        WHERE id = ?
      `).bind(newsId).run()
    }
    
    // ì—…ë°ì´íŠ¸ëœ íˆ¬í‘œ ìˆ˜ ì¡°íšŒ
    const newsData = await env.DB.prepare(
      'SELECT vote_up, vote_down, popularity_score FROM news WHERE id = ?'
    ).bind(newsId).first()
    
    return c.json({
      success: true,
      vote_up: newsData.vote_up,
      vote_down: newsData.vote_down,
      popularity_score: newsData.popularity_score
    })
  } catch (error) {
    console.error('íˆ¬í‘œ ì²˜ë¦¬ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'íˆ¬í‘œ ì²˜ë¦¬ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ì‹¤ì‹œê°„ HOT ë‰´ìŠ¤ API ====================
app.get('/api/news/hot', async (c) => {
  try {
    const { env } = c
    const limit = parseInt(c.req.query('limit') || '10')
    
    const { results } = await env.DB.prepare(`
      SELECT 
        id, title, summary, link, image_url, category,
        vote_up, vote_down, view_count, popularity_score,
        ai_summary, sentiment
      FROM news 
      ORDER BY popularity_score DESC, vote_up DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json({ success: true, news: results || [] })
  } catch (error) {
    console.error('HOT ë‰´ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'HOT ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ API ====================
app.post('/api/youtube/download', async (c) => {
  try {
    const body = await c.req.json()
    const { url, quality } = body
    
    // URL ê²€ì¦
    if (!url || (!url.includes('youtube.com') && !url.includes('youtu.be'))) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // ë¹„ë””ì˜¤ ID ì¶”ì¶œ
    let videoId = ''
    if (url.includes('youtube.com/watch?v=')) {
      videoId = url.split('v=')[1]?.split('&')[0]
    } else if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1]?.split('?')[0]
    }
    
    if (!videoId) {
      return c.json({ success: false, error: 'ë¹„ë””ì˜¤ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // 1ë‹¨ê³„: YouTube oEmbed APIë¡œ ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let videoInfo: any = null
    try {
      const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`
      const oembedResponse = await fetch(oembedUrl)
      
      if (oembedResponse.ok) {
        videoInfo = await oembedResponse.json()
      }
    } catch (error) {
      console.error('ë¹„ë””ì˜¤ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error)
    }
    
    // 2ë‹¨ê³„: ì—¬ëŸ¬ ë‹¤ìš´ë¡œë“œ API ì‹œë„
    // ë°©ë²• 1: YouTube ë‚´ë¶€ APIë¡œ ìŠ¤íŠ¸ë¦¼ ì •ë³´ ì¶”ì¶œ
    try {
      // YouTubeì˜ ë‚´ë¶€ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const ytApiUrl = `https://www.youtube.com/youtubei/v1/player?key=AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8`
      const ytApiResponse = await fetch(ytApiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        },
        body: JSON.stringify({
          context: {
            client: {
              clientName: 'WEB',
              clientVersion: '2.20240101.00.00'
            }
          },
          videoId: videoId
        })
      })
      
      if (ytApiResponse.ok) {
        const ytData = await ytApiResponse.json()
        
        // ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° ì¶”ì¶œ
        const streamingData = ytData?.streamingData
        if (streamingData && streamingData.formats) {
          // ìš”ì²­ëœ í™”ì§ˆì— ë§ëŠ” í¬ë§· ì°¾ê¸°
          const qualityMap: Record<string, number> = {
            '4K': 2160,
            '1440p': 1440,
            '1080p': 1080,
            '720p': 720,
            '480p': 480,
            '360p': 360
          }
          
          const targetHeight = qualityMap[quality] || 720
          
          // ê°€ì¥ ê°€ê¹Œìš´ í™”ì§ˆì˜ í¬ë§· ì°¾ê¸°
          let bestFormat = streamingData.formats[0]
          let minDiff = Math.abs((bestFormat.height || 0) - targetHeight)
          
          for (const format of streamingData.formats) {
            if (format.mimeType?.includes('video/mp4') && format.url) {
              const diff = Math.abs((format.height || 0) - targetHeight)
              if (diff < minDiff) {
                minDiff = diff
                bestFormat = format
              }
            }
          }
          
          if (bestFormat && bestFormat.url) {
            // ì„±ê³µ ì‘ë‹µ
            return c.json({
              success: true,
              downloadUrl: bestFormat.url,
              videoInfo: {
                title: videoInfo?.title || ytData?.videoDetails?.title || 'ì œëª© ì—†ìŒ',
                author: videoInfo?.author_name || ytData?.videoDetails?.author || 'ì•Œ ìˆ˜ ì—†ìŒ',
                thumbnail: videoInfo?.thumbnail_url || ytData?.videoDetails?.thumbnail?.thumbnails?.[0]?.url || '',
                videoId: videoId,
                duration: ytData?.videoDetails?.lengthSeconds || '0'
              },
              quality: bestFormat.qualityLabel || quality,
              actualHeight: bestFormat.height,
              message: 'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ'
            })
          }
        }
      }
      
      // ë°©ë²• 2: ì‹¤íŒ¨ ì‹œ ì™¸ë¶€ ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      // ì—¬ëŸ¬ ë¬´ë£Œ ë‹¤ìš´ë¡œë“œ ì„œë¹„ìŠ¤ ì œê³µ
      const downloadServices = [
        {
          name: 'Y2Mate',
          url: `https://www.y2mate.com/youtube/${videoId}`,
          description: 'ì¸ê¸° ìˆëŠ” YouTube ë‹¤ìš´ë¡œë”'
        },
        {
          name: 'SaveFrom.net',
          url: `https://en.savefrom.net/#url=${encodeURIComponent(url)}`,
          description: 'ë¹ ë¥´ê³  ê°„ë‹¨í•œ ë‹¤ìš´ë¡œë“œ'
        },
        {
          name: '9Convert',
          url: `https://9convert.com/en60/youtube-downloader?url=${encodeURIComponent(url)}`,
          description: 'HD í’ˆì§ˆ ë‹¤ìš´ë¡œë“œ ì§€ì›'
        },
        {
          name: 'YTmp3',
          url: `https://ytmp3.nu/youtube-to-mp4/?url=${encodeURIComponent(url)}`,
          description: 'MP4/MP3 ë³€í™˜ ì§€ì›'
        }
      ]
      
      return c.json({
        success: false,
        errorType: 'REDIRECT_REQUIRED',
        error: 'ì§ì ‘ ë‹¤ìš´ë¡œë“œê°€ í˜„ì¬ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤',
        message: 'ì•„ë˜ ì„œë¹„ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•´ì£¼ì„¸ìš”',
        videoInfo: {
          title: videoInfo?.title || 'ì œëª© ì—†ìŒ',
          author: videoInfo?.author_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
          thumbnail: videoInfo?.thumbnail_url || '',
          videoId: videoId
        },
        downloadServices: downloadServices,
        alternativeMethod: {
          title: 'ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì‚¬ìš©',
          description: 'Video DownloadHelper, SaveFrom.net Helper ë“±ì˜ ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•˜ë©´ ë” í¸ë¦¬í•˜ê²Œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
          chromeExtension: 'https://chrome.google.com/webstore/search/youtube%20downloader',
          firefoxExtension: 'https://addons.mozilla.org/ko/firefox/search/?q=youtube+downloader'
        }
      })
      
    } catch (error) {
      console.error('ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', error)
      
      return c.json({
        success: false,
        error: 'ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        message: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
        videoInfo: videoInfo
      }, 500)
    }
    
  } catch (error) {
    console.error('YouTube ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error)
    return c.json({ 
      success: false, 
      error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      message: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
    }, 500)
  }
})

// ==================== ë‰´ìŠ¤ API ====================

// ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ë° DB ì €ì¥
app.get('/api/news/fetch', async (c) => {
  const { DB } = c.env
  const category = c.req.query('category') || 'general'
  
  try {
    // RSSì—ì„œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„)
    let newsItems: any[] = []
    let retryCount = 0
    const maxRetries = 3
    
    while (retryCount < maxRetries && newsItems.length === 0) {
      try {
        newsItems = await parseGoogleNewsRSS(category)
        if (newsItems.length > 0) break
      } catch (err) {
        console.error(`ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹œë„ ${retryCount + 1}/${maxRetries} ì‹¤íŒ¨:`, err)
      }
      retryCount++
      if (retryCount < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)) // ì¬ì‹œë„ ëŒ€ê¸°
      }
    }
    
    if (newsItems.length === 0) {
      // DBì—ì„œ ê¸°ì¡´ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (fallback)
      const { results } = await DB.prepare(`
        SELECT * FROM news 
        WHERE category = ? 
        ORDER BY created_at DESC 
        LIMIT 20
      `).bind(category).all()
      
      if (results && results.length > 0) {
        return c.json({ 
          success: true, 
          fetched: 0,
          saved: 0,
          cached: results.length,
          message: 'ìµœì‹  ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ìºì‹œëœ ë‰´ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.',
          fallback: true
        })
      }
      
      return c.json({ 
        error: 'ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        fallback: false
      }, 503)
    }
    
    // DBì— ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
    let savedCount = 0
    for (const item of newsItems) {
      try {
        await DB.prepare(`
          INSERT OR IGNORE INTO news (category, title, summary, link, image_url, publisher, pub_date)
          VALUES (?, ?, ?, ?, ?, ?, ?)
        `).bind(
          item.category,
          item.title,
          item.summary,
          item.link,
          item.image_url,
          item.publisher,
          item.pub_date
        ).run()
        savedCount++
      } catch (err) {
        console.error('ë‰´ìŠ¤ ì €ì¥ ì˜¤ë¥˜:', err)
      }
    }
    
    return c.json({ 
      success: true, 
      fetched: newsItems.length,
      saved: savedCount,
      message: `${savedCount}ê°œì˜ ìƒˆ ë‰´ìŠ¤ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`,
      fallback: false
    })
  } catch (error) {
    console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error)
    
    // DBì—ì„œ ê¸°ì¡´ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (fallback)
    try {
      const { results } = await DB.prepare(`
        SELECT * FROM news 
        WHERE category = ? 
        ORDER BY created_at DESC 
        LIMIT 20
      `).bind(category).all()
      
      if (results && results.length > 0) {
        return c.json({ 
          success: true, 
          fetched: 0,
          saved: 0,
          cached: results.length,
          message: 'ìµœì‹  ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ìºì‹œëœ ë‰´ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.',
          fallback: true
        })
      }
    } catch (dbErr) {
      console.error('DB fallback ì˜¤ë¥˜:', dbErr)
    }
    
    return c.json({ 
      error: 'ë‰´ìŠ¤ ì„œë¹„ìŠ¤ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
      fallback: false
    }, 503)
  }
})

// ì €ì¥ëœ ë‰´ìŠ¤ ëª©ë¡ ì¡°íšŒ
// API: ë‰´ìŠ¤ ë¦¬ë‹¤ì´ë ‰íŠ¸ í”„ë¡ì‹œ (Google News ì°¨ë‹¨ ìš°íšŒ)
app.get('/news/redirect', async (c) => {
  const url = c.req.query('url')
  
  if (!url) {
    return c.text('URLì´ í•„ìš”í•©ë‹ˆë‹¤', 400)
  }
  
  try {
    // Google News URLì„ fetchí•˜ì—¬ ìµœì¢… redirect URLì„ ì–»ìŒ
    const response = await fetch(url, {
      redirect: 'follow',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    })
    
    // ìµœì¢… URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return c.redirect(response.url, 302)
  } catch (error) {
    console.error('ë‰´ìŠ¤ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì˜¤ë¥˜:', error)
    return c.text('ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 500)
  }
})

app.get('/api/news', async (c) => {
  const { DB } = c.env
  const category = c.req.query('category')
  const limit = parseInt(c.req.query('limit') || '20')
  const offset = parseInt(c.req.query('offset') || '0')
  
  try {
    let query = 'SELECT * FROM news'
    const params: any[] = []
    
    if (category && category !== 'all') {
      query += ' WHERE category = ?'
      params.push(category)
    }
    
    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?'
    params.push(limit, offset)
    
    const { results } = await DB.prepare(query).bind(...params).all()
    
    return c.json({ 
      success: true, 
      news: results,
      count: results.length 
    })
  } catch (error) {
    console.error('ë‰´ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ error: 'ë‰´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ë‰´ìŠ¤ ì‚­ì œ (ê´€ë¦¬ììš©)
app.delete('/api/news/:id', async (c) => {
  const { DB } = c.env
  const id = c.req.param('id')
  
  try {
    await DB.prepare('DELETE FROM news WHERE id = ?').bind(id).run()
    return c.json({ success: true, message: 'ë‰´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('ë‰´ìŠ¤ ì‚­ì œ ì˜¤ë¥˜:', error)
    return c.json({ error: 'ë‰´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ë‰´ìŠ¤ ìŠ¤ì¼€ì¤„ ì„¤ì • API ====================
// ìŠ¤ì¼€ì¤„ ì„¤ì • ì¡°íšŒ
app.get('/api/news/schedule', async (c) => {
  const { DB } = c.env
  
  try {
    const { results } = await DB.prepare('SELECT * FROM news_schedule WHERE id = 1').all()
    const schedule = results?.[0] || {
      enabled: 1,
      schedule_type: 'hourly',
      schedule_time: null,
      interval_hours: 1,
      last_run: null,
      next_run: null
    }
    
    return c.json({ 
      success: true, 
      schedule 
    })
  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ error: 'ìŠ¤ì¼€ì¤„ ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ìŠ¤ì¼€ì¤„ ì„¤ì • ì—…ë°ì´íŠ¸
app.post('/api/news/schedule', async (c) => {
  const { DB } = c.env
  
  try {
    const body = await c.req.json()
    const { enabled, schedule_type, schedule_time, interval_hours } = body
    
    // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
    let next_run = null
    const now = new Date()
    
    if (enabled) {
      if (schedule_type === 'hourly') {
        const hours = interval_hours || 1
        next_run = new Date(now.getTime() + hours * 60 * 60 * 1000).toISOString()
      } else if (schedule_type === 'daily' && schedule_time) {
        // schedule_time í˜•ì‹: "HH:mm" (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
        const [hours, minutes] = schedule_time.split(':').map(Number)
        
        // í˜„ì¬ í•œêµ­ ì‹œê°„ êµ¬í•˜ê¸° (UTC+9)
        const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000))
        
        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì§€ì •ëœ ì‹œê°„ (í•œêµ­ ì‹œê°„)
        const nextRun = new Date(koreaTime)
        nextRun.setHours(hours, minutes, 0, 0)
        
        // ì˜¤ëŠ˜ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë‚´ì¼ë¡œ ì„¤ì •
        if (nextRun <= koreaTime) {
          nextRun.setDate(nextRun.getDate() + 1)
        }
        
        // UTC ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥ (í•œêµ­ ì‹œê°„ - 9ì‹œê°„)
        next_run = new Date(nextRun.getTime() - (9 * 60 * 60 * 1000)).toISOString()
      }
    }
    
    await DB.prepare(`
      UPDATE news_schedule 
      SET enabled = ?, 
          schedule_type = ?, 
          schedule_time = ?, 
          interval_hours = ?,
          next_run = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = 1
    `).bind(
      enabled ? 1 : 0,
      schedule_type,
      schedule_time,
      interval_hours,
      next_run
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'ìŠ¤ì¼€ì¤„ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      next_run 
    })
  } catch (error) {
    console.error('ìŠ¤ì¼€ì¤„ ì„¤ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error)
    return c.json({ error: 'ìŠ¤ì¼€ì¤„ ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨' }, 500)
  }
})

// ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ê¸°ë¡ ì—…ë°ì´íŠ¸ (ìë™ ì‹¤í–‰ ì‹œ í˜¸ì¶œ)
app.post('/api/news/schedule/update-run', async (c) => {
  const { DB } = c.env
  
  try {
    const now = new Date().toISOString()
    
    // last_run ì—…ë°ì´íŠ¸
    await DB.prepare(`
      UPDATE news_schedule 
      SET last_run = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = 1
    `).bind(now).run()
    
    // í˜„ì¬ ì„¤ì • ê°€ì ¸ì™€ì„œ next_run ì¬ê³„ì‚°
    const { results } = await DB.prepare('SELECT * FROM news_schedule WHERE id = 1').all()
    const schedule = results?.[0]
    
    if (schedule && schedule.enabled) {
      let next_run = null
      const currentTime = new Date()
      
      if (schedule.schedule_type === 'hourly') {
        const hours = schedule.interval_hours || 1
        next_run = new Date(currentTime.getTime() + hours * 60 * 60 * 1000).toISOString()
      } else if (schedule.schedule_type === 'daily' && schedule.schedule_time) {
        const [hours, minutes] = schedule.schedule_time.split(':').map(Number)
        
        // í˜„ì¬ í•œêµ­ ì‹œê°„ êµ¬í•˜ê¸° (UTC+9)
        const koreaTime = new Date(currentTime.getTime() + (9 * 60 * 60 * 1000))
        
        // ë‹¤ìŒë‚  ì§€ì •ëœ ì‹œê°„ (í•œêµ­ ì‹œê°„)
        const nextRun = new Date(koreaTime)
        nextRun.setDate(nextRun.getDate() + 1) // ë‹¤ìŒ ë‚ 
        nextRun.setHours(hours, minutes, 0, 0)
        
        // UTC ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥ (í•œêµ­ ì‹œê°„ - 9ì‹œê°„)
        next_run = new Date(nextRun.getTime() - (9 * 60 * 60 * 1000)).toISOString()
      }
      
      if (next_run) {
        await DB.prepare(`
          UPDATE news_schedule 
          SET next_run = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = 1
        `).bind(next_run).run()
      }
    }
    
    return c.json({ 
      success: true, 
      message: 'ì‹¤í–‰ ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (error) {
    console.error('ì‹¤í–‰ ê¸°ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error)
    return c.json({ error: 'ì‹¤í–‰ ê¸°ë¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ê´€ë¦¬ì ë‰´ìŠ¤ê´€ë¦¬ í˜ì´ì§€ ====================
app.get('/admin/news', async (c) => {
  const { DB } = c.env
  
  // DBì—ì„œ ë‰´ìŠ¤ í†µê³„ë§Œ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ ê°œìˆ˜)
  let newsFromDB: any[] = []
  let totalCount = 0
  try {
    // ì „ì²´ ê°œìˆ˜ ì¡°íšŒ
    const countResult = await DB.prepare('SELECT COUNT(*) as total FROM news').first()
    totalCount = countResult?.total || 0
    
    // ì´ˆê¸° 50ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
    const { results } = await DB.prepare('SELECT * FROM news ORDER BY created_at DESC LIMIT 50').all()
    newsFromDB = results || []
  } catch (error) {
    console.error('ë‰´ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜:', error)
  }
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë‰´ìŠ¤ê´€ë¦¬ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background-color: #1E40AF; }
            .faith-blue-hover:hover { background-color: #1E3A8A; }
        </style>
    </head>
    <body class="bg-gray-100">
        <!-- ê´€ë¦¬ì í—¤ë” -->
        <header class="faith-blue text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-2xl font-bold">Faith Portal</a>
                        <span class="text-sm bg-yellow-500 text-gray-900 px-3 py-1 rounded-full font-medium">
                            <i class="fas fa-crown mr-1"></i>
                            ê´€ë¦¬ì
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-name" class="text-sm"></span>
                        <a href="/" class="text-sm hover:text-blue-200">
                            <i class="fas fa-home mr-1"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
                ${getAdminNavigation('/admin/news')}
            </div>
        </nav>
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ê´€ë¦¬ì', href: '/admin'},
          {label: 'ë‰´ìŠ¤ ê´€ë¦¬'}
        ])}

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8">
            <!-- í˜ì´ì§€ íƒ€ì´í‹€ ë° ì•¡ì…˜ -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-newspaper text-blue-600 mr-2"></i>
                        ë‰´ìŠ¤ê´€ë¦¬
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">ì €ì¥ëœ ë‰´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  ìƒˆ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <button onclick="fetchAllNews()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>
                    ì „ì²´ ì¹´í…Œê³ ë¦¬ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                </button>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ì „ì²´ ë‰´ìŠ¤</p>
                            <p class="text-2xl font-bold text-gray-800" id="total-count">${totalCount}</p>
                        </div>
                        <i class="fas fa-newspaper text-3xl text-blue-500"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">í‘œì‹œëœ ë‰´ìŠ¤</p>
                            <p class="text-2xl font-bold text-purple-600" id="loaded-count">${newsFromDB.length}</p>
                        </div>
                        <i class="fas fa-list text-3xl text-purple-500"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">í˜„ì¬ í•„í„°</p>
                            <p class="text-2xl font-bold text-green-600" id="filter-status">ì „ì²´</p>
                        </div>
                        <i class="fas fa-filter text-3xl text-green-500"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ë¡œë”© ìƒíƒœ</p>
                            <p class="text-2xl font-bold text-indigo-600" id="loading-status">ëŒ€ê¸°</p>
                        </div>
                        <i class="fas fa-spinner text-3xl text-indigo-500" id="loading-icon"></i>
                    </div>
                </div>
            </div>

            <!-- ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ìŠ¤ì¼€ì¤„ ì„¤ì • -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-clock text-blue-600 mr-2"></i>
                        ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì„¤ì •
                    </h3>
                    <div class="flex items-center space-x-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="schedule-enabled" class="sr-only peer" onchange="toggleSchedule()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700">í™œì„±í™”</span>
                        </label>
                    </div>
                </div>

                <div id="schedule-settings" class="space-y-4">
                    <!-- ìŠ¤ì¼€ì¤„ íƒ€ì… ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            ìŠ¤ì¼€ì¤„ íƒ€ì…
                        </label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="schedule-type" value="hourly" checked onchange="updateScheduleType()" class="mr-2">
                                <span class="text-sm text-gray-700">ì‹œê°„ ê°„ê²©</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="schedule-type" value="daily" onchange="updateScheduleType()" class="mr-2">
                                <span class="text-sm text-gray-700">ë§¤ì¼ ì§€ì • ì‹œê°„</span>
                            </label>
                        </div>
                    </div>

                    <!-- ì‹œê°„ ê°„ê²© ì„¤ì • (hourly) -->
                    <div id="hourly-settings">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-hourglass-half mr-1"></i>
                            ê°€ì ¸ì˜¤ê¸° ê°„ê²© (ì‹œê°„)
                        </label>
                        <select id="interval-hours" class="px-4 py-2 border border-gray-300 rounded-lg w-full md:w-64">
                            <option value="1">1ì‹œê°„ë§ˆë‹¤</option>
                            <option value="2">2ì‹œê°„ë§ˆë‹¤</option>
                            <option value="3">3ì‹œê°„ë§ˆë‹¤</option>
                            <option value="6">6ì‹œê°„ë§ˆë‹¤</option>
                            <option value="12">12ì‹œê°„ë§ˆë‹¤</option>
                            <option value="24">24ì‹œê°„ë§ˆë‹¤</option>
                        </select>
                    </div>

                    <!-- ì§€ì • ì‹œê°„ ì„¤ì • (daily) -->
                    <div id="daily-settings" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>
                            ë§¤ì¼ ê°€ì ¸ì˜¬ ì‹œê°„
                        </label>
                        <input type="time" id="schedule-time" class="px-4 py-2 border border-gray-300 rounded-lg w-full md:w-64" value="09:00">
                    </div>

                    <!-- ì‹¤í–‰ ì •ë³´ -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">ë§ˆì§€ë§‰ ì‹¤í–‰:</span>
                            <span id="last-run" class="text-sm font-medium text-gray-800">-</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">ë‹¤ìŒ ì‹¤í–‰ ì˜ˆì •:</span>
                            <span id="next-run" class="text-sm font-medium text-blue-600">-</span>
                        </div>
                    </div>

                    <!-- ì €ì¥ ë²„íŠ¼ -->
                    <div class="flex justify-end">
                        <button onclick="saveSchedule()" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                            <i class="fas fa-save mr-2"></i>
                            ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë‰´ìŠ¤ ëª©ë¡ í…Œì´ë¸” -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800">ë‰´ìŠ¤ ëª©ë¡ (ë¬´í•œ ìŠ¤í¬ë¡¤)</h3>
                        <div class="flex items-center space-x-2">
                            <select id="category-filter" onchange="filterNews()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                                <option value="general">ì¼ë°˜</option>
                                <option value="politics">ì •ì¹˜</option>
                                <option value="economy">ê²½ì œ</option>
                                <option value="tech">ê¸°ìˆ </option>
                                <option value="sports">ìŠ¤í¬ì¸ </option>
                                <option value="entertainment">ì—°ì˜ˆ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto" id="news-container" style="max-height: 600px; overflow-y: auto;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì¹´í…Œê³ ë¦¬</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œëª©</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë°œí–‰ì‚¬</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë°œí–‰ì¼</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="news-table" class="bg-white divide-y divide-gray-200">
                            ${newsFromDB.map(news => `
                                <tr data-category="${news.category}" class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${news.id}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                            ${news.category}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900 max-w-md truncate">
                                        <span onclick="openNewsLink('${news.link}')" class="hover:text-blue-600 cursor-pointer">
                                            ${news.title}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${news.publisher || 'êµ¬ê¸€ ë‰´ìŠ¤'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(news.created_at).toLocaleDateString('ko-KR')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="openNewsLink('${news.link}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            ë³´ê¸°
                                        </a>
                                        <button onclick="deleteNews(${news.id})" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash mr-1"></i>
                                            ì‚­ì œ
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${newsFromDB.length === 0 ? `
                    <div class="text-center py-12">
                        <i class="fas fa-newspaper text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">ì €ì¥ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button onclick="fetchAllNews()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                        </button>
                    </div>
                    ` : ''}
                    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                    <div id="loading-indicator" class="hidden text-center py-4">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                        <p class="text-sm text-gray-600 mt-2">ë” ë§ì€ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // ë‰´ìŠ¤ ë§í¬ ì—´ê¸° (Referrer ì—†ì´)
            function openNewsLink(url) {
                console.log('[openNewsLink] ì‹¤í–‰ - ì›ë³¸ URL:', url);
                const proxyUrl = '/news/redirect?url=' + encodeURIComponent(url);
                window.open(proxyUrl, '_blank', 'noopener,noreferrer');
            }
            
            // ë¡œê·¸ì¸ í™•ì¸ ë° ê¶Œí•œ ê²€ì¦
            const token = localStorage.getItem('auth_token');
            const userEmail = localStorage.getItem('user_email');
            const userLevel = parseInt(localStorage.getItem('user_level') || '0');
            
            if (!token || userLevel < 6) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/';
            }
            
            if (userEmail) {
                document.getElementById('admin-name').textContent = userEmail + ' (ë ˆë²¨ ' + userLevel + ')';
            }
            
            // ==================== ë¬´í•œ ìŠ¤í¬ë¡¤ ê´€ë ¨ ë³€ìˆ˜ ====================
            let currentOffset = 50; // ì´ë¯¸ 50ê°œ ë¡œë“œë¨
            let isLoading = false;
            let hasMore = true;
            let currentCategory = 'all';
            const loadLimit = 50; // í•œ ë²ˆì— 50ê°œì”© ë¡œë“œ
            
            // ë¬´í•œ ìŠ¤í¬ë¡¤ ì„¤ì •
            const newsContainer = document.getElementById('news-container');
            if (newsContainer) {
                console.log('ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
                newsContainer.addEventListener('scroll', function() {
                    const scrollHeight = newsContainer.scrollHeight;
                    const scrollTop = newsContainer.scrollTop;
                    const clientHeight = newsContainer.clientHeight;
                    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
                    
                    console.log('ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸:', {
                        scrollHeight,
                        scrollTop,
                        clientHeight,
                        distanceFromBottom,
                        isLoading,
                        hasMore
                    });
                    
                    if (isLoading || !hasMore) {
                        console.log('ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ì—†ìŒ');
                        return;
                    }
                    
                    // ìŠ¤í¬ë¡¤ì´ ëì—ì„œ 200px ì´ë‚´ë¡œ ê°€ê¹Œì›Œì§€ë©´ ë¡œë“œ
                    if (distanceFromBottom <= 200) {
                        console.log('ì¶”ê°€ ë¡œë“œ ì‹œì‘!');
                        loadMoreNews();
                    }
                });
            } else {
                console.error('news-containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // ë” ë§ì€ ë‰´ìŠ¤ ë¡œë“œ
            async function loadMoreNews() {
                if (isLoading || !hasMore) {
                    console.log('loadMoreNews ì¤‘ë‹¨:', { isLoading, hasMore });
                    return;
                }
                
                console.log('loadMoreNews ì‹œì‘:', { currentOffset, currentCategory });
                isLoading = true;
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('loading-status').textContent = 'ë¡œë”©ì¤‘';
                
                try {
                    const url = '/api/news?category=' + currentCategory + '&limit=' + loadLimit + '&offset=' + currentOffset;
                    console.log('API ìš”ì²­:', url);
                    const response = await fetch(url);
                    const data = await response.json();
                    console.log('API ì‘ë‹µ:', data);
                    
                    if (data.success && data.news && data.news.length > 0) {
                        const newsTable = document.getElementById('news-table');
                        
                        data.news.forEach(news => {
                            const row = document.createElement('tr');
                            row.setAttribute('data-category', news.category);
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + news.id + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap">' +
                                    '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">' +
                                        news.category +
                                    '</span>' +
                                '</td>' +
                                '<td class="px-6 py-4 text-sm text-gray-900 max-w-md truncate">' +
                                    '<span onclick="openNewsLink(\'' + news.link + '\')" class="hover:text-blue-600 cursor-pointer">' +
                                        news.title +
                                    '</span>' +
                                '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + (news.publisher || 'êµ¬ê¸€ ë‰´ìŠ¤') + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + new Date(news.created_at).toLocaleDateString('ko-KR') + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">' +
                                    '<button onclick="openNewsLink(\'' + news.link + '\')" class="text-blue-600 hover:text-blue-900 mr-3">' +
                                        '<i class="fas fa-external-link-alt mr-1"></i>' +
                                        'ë³´ê¸°' +
                                    '</button>' +
                                    '<button onclick="deleteNews(' + news.id + ')" class="text-red-600 hover:text-red-900">' +
                                        '<i class="fas fa-trash mr-1"></i>' +
                                        'ì‚­ì œ' +
                                    '</button>' +
                                '</td>';
                            newsTable.appendChild(row);
                        });
                        
                        currentOffset += data.news.length;
                        document.getElementById('loaded-count').textContent = document.querySelectorAll('#news-table tr').length;
                        
                        // 50ê°œë³´ë‹¤ ì ê²Œ ë¡œë“œë˜ë©´ ë” ì´ìƒ ì—†ìŒ
                        if (data.news.length < loadLimit) {
                            hasMore = false;
                            document.getElementById('loading-status').textContent = 'ì™„ë£Œ';
                        } else {
                            document.getElementById('loading-status').textContent = 'ëŒ€ê¸°';
                        }
                    } else {
                        hasMore = false;
                        document.getElementById('loading-status').textContent = 'ì™„ë£Œ';
                    }
                } catch (error) {
                    console.error('ë‰´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
                    document.getElementById('loading-status').textContent = 'ì˜¤ë¥˜';
                } finally {
                    isLoading = false;
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            }
            
            // ì „ì²´ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
            async function fetchAllNews() {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                
                const categories = ['general', 'politics', 'economy', 'tech', 'sports', 'entertainment'];
                let totalFetched = 0;
                
                for (const category of categories) {
                    try {
                        const response = await fetch('/api/news/fetch?category=' + category);
                        const data = await response.json();
                        if (data.success) {
                            totalFetched += data.saved;
                        }
                    } catch (error) {
                        console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    }
                }
                
                alert(totalFetched + 'ê°œì˜ ìƒˆ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                location.reload();
            }
            
            // ë‰´ìŠ¤ ì‚­ì œ
            async function deleteNews(id) {
                if (!confirm('ì´ ë‰´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/news/' + id, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ë‰´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('ë‰´ìŠ¤ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ì¹´í…Œê³ ë¦¬ í•„í„° (ë¬´í•œ ìŠ¤í¬ë¡¤ ì¬ì„¤ì •)
            async function filterNews() {
                const category = document.getElementById('category-filter').value;
                currentCategory = category;
                currentOffset = 0;
                hasMore = true;
                
                // í…Œì´ë¸” ì´ˆê¸°í™”
                document.getElementById('news-table').innerHTML = '';
                document.getElementById('loaded-count').textContent = '0';
                document.getElementById('filter-status').textContent = category === 'all' ? 'ì „ì²´' : category;
                
                // ì²« 50ê°œ ë¡œë“œ
                await loadMoreNews();
            }
            
            // ==================== ìŠ¤ì¼€ì¤„ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ ====================
            let autoFetchInterval = null;
            
            // ìŠ¤ì¼€ì¤„ ì„¤ì • ë¡œë“œ
            async function loadSchedule() {
                try {
                    const response = await fetch('/api/news/schedule');
                    const data = await response.json();
                    
                    if (data.success && data.schedule) {
                        const schedule = data.schedule;
                        
                        // í™œì„±í™” ìƒíƒœ
                        document.getElementById('schedule-enabled').checked = schedule.enabled === 1;
                        
                        // ìŠ¤ì¼€ì¤„ íƒ€ì…
                        const scheduleType = schedule.schedule_type || 'hourly';
                        document.querySelector('input[name="schedule-type"][value="' + scheduleType + '"]').checked = true;
                        
                        // ê°„ê²© (hourly)
                        if (schedule.interval_hours) {
                            document.getElementById('interval-hours').value = schedule.interval_hours;
                        }
                        
                        // ì‹œê°„ (daily)
                        if (schedule.schedule_time) {
                            document.getElementById('schedule-time').value = schedule.schedule_time;
                        }
                        
                        // ì‹¤í–‰ ì •ë³´
                        if (schedule.last_run) {
                            document.getElementById('last-run').textContent = new Date(schedule.last_run).toLocaleString('ko-KR');
                        }
                        if (schedule.next_run) {
                            document.getElementById('next-run').textContent = new Date(schedule.next_run).toLocaleString('ko-KR');
                        }
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateScheduleType();
                        
                        // ìë™ ì‹¤í–‰ ì‹œì‘
                        if (schedule.enabled === 1) {
                            startAutoFetch();
                        }
                    }
                } catch (error) {
                    console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
            
            // ìŠ¤ì¼€ì¤„ í™œì„±í™”/ë¹„í™œì„±í™”
            function toggleSchedule() {
                const enabled = document.getElementById('schedule-enabled').checked;
                const settings = document.getElementById('schedule-settings');
                
                if (enabled) {
                    settings.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    settings.classList.add('opacity-50', 'pointer-events-none');
                    stopAutoFetch();
                }
            }
            
            // ìŠ¤ì¼€ì¤„ íƒ€ì… ë³€ê²½
            function updateScheduleType() {
                const scheduleType = document.querySelector('input[name="schedule-type"]:checked').value;
                const hourlySettings = document.getElementById('hourly-settings');
                const dailySettings = document.getElementById('daily-settings');
                
                if (scheduleType === 'hourly') {
                    hourlySettings.classList.remove('hidden');
                    dailySettings.classList.add('hidden');
                } else {
                    hourlySettings.classList.add('hidden');
                    dailySettings.classList.remove('hidden');
                }
            }
            
            // ìŠ¤ì¼€ì¤„ ì €ì¥
            async function saveSchedule() {
                const enabled = document.getElementById('schedule-enabled').checked;
                const scheduleType = document.querySelector('input[name="schedule-type"]:checked').value;
                const intervalHours = parseInt(document.getElementById('interval-hours').value);
                const scheduleTime = document.getElementById('schedule-time').value;
                
                const data = {
                    enabled: enabled ? 1 : 0,
                    schedule_type: scheduleType,
                    interval_hours: intervalHours,
                    schedule_time: scheduleTime
                };
                
                try {
                    const response = await fetch('/api/news/schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ìŠ¤ì¼€ì¤„ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ í‘œì‹œ
                        if (result.next_run) {
                            document.getElementById('next-run').textContent = new Date(result.next_run).toLocaleString('ko-KR');
                        }
                        
                        // ìë™ ì‹¤í–‰ ì¬ì‹œì‘
                        stopAutoFetch();
                        if (enabled) {
                            startAutoFetch();
                        }
                    } else {
                        alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('ìŠ¤ì¼€ì¤„ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
            function startAutoFetch() {
                // ê¸°ì¡´ interval ì •ë¦¬
                stopAutoFetch();
                
                // 1ë¶„ë§ˆë‹¤ ìŠ¤ì¼€ì¤„ ì²´í¬
                autoFetchInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/news/schedule');
                        const data = await response.json();
                        
                        if (data.success && data.schedule && data.schedule.enabled === 1) {
                            const schedule = data.schedule;
                            const now = new Date();
                            const nextRun = schedule.next_run ? new Date(schedule.next_run) : null;
                            
                            // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ì´ ë˜ì—ˆëŠ”ì§€ í™•ì¸
                            if (nextRun && now >= nextRun) {
                                console.log('ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰...');
                                
                                // ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                                const categories = ['general', 'politics', 'economy', 'tech', 'sports', 'entertainment'];
                                let totalFetched = 0;
                                
                                for (const category of categories) {
                                    try {
                                        const fetchResponse = await fetch('/api/news/fetch?category=' + category);
                                        const fetchData = await fetchResponse.json();
                                        if (fetchData.success) {
                                            totalFetched += fetchData.saved || 0;
                                        }
                                    } catch (error) {
                                        console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                                    }
                                }
                                
                                console.log('ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ:', totalFetched + 'ê°œ');
                                
                                // ì‹¤í–‰ ê¸°ë¡ ì—…ë°ì´íŠ¸
                                await fetch('/api/news/schedule/update-run', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                // UI ìƒˆë¡œê³ ì¹¨
                                location.reload();
                            }
                        }
                    } catch (error) {
                        console.error('ìë™ ì‹¤í–‰ ì²´í¬ ì˜¤ë¥˜:', error);
                    }
                }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
                
                console.log('ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            // ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì¤‘ì§€
            function stopAutoFetch() {
                if (autoFetchInterval) {
                    clearInterval(autoFetchInterval);
                    autoFetchInterval = null;
                    console.log('ìë™ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤ì¼€ì¤„ ì„¤ì • ë¡œë“œ
            loadSchedule();
        </script>
    </body>
    </html>
  `)
})

// ==================== ë¶ë§ˆí¬ API ====================
// ë¶ë§ˆí¬ ì¶”ê°€
app.post('/api/bookmarks', async (c) => {
  const { DB } = c.env
  try {
    const body = await c.req.json()
    const { userId, title, link, category, source, pubDate } = body
    
    if (!userId || !title || !link || !category) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
    }
    
    await DB.prepare(`
      INSERT INTO bookmarks (user_id, news_title, news_link, news_category, news_source, news_pub_date)
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(userId, title, link, category, source, pubDate).run()
    
    return c.json({ success: true, message: 'ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    if (error.message?.includes('UNIQUE constraint failed')) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë¶ë§ˆí¬ì— ì¶”ê°€ëœ ë‰´ìŠ¤ì…ë‹ˆë‹¤' }, 400)
    }
    console.error('ë¶ë§ˆí¬ ì¶”ê°€ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë¶ë§ˆí¬ ì¶”ê°€ ì‹¤íŒ¨' }, 500)
  }
})

// ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ
app.get('/api/bookmarks', async (c) => {
  const { DB } = c.env
  try {
    const userId = c.req.query('userId')
    const category = c.req.query('category')
    const limit = parseInt(c.req.query('limit') || '50')
    const offset = parseInt(c.req.query('offset') || '0')
    
    if (!userId) {
      return c.json({ success: false, error: 'userIdê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    let query = 'SELECT * FROM bookmarks WHERE user_id = ?'
    const params: any[] = [userId]
    
    if (category && category !== 'all') {
      query += ' AND news_category = ?'
      params.push(category)
    }
    
    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?'
    params.push(limit, offset)
    
    const result = await DB.prepare(query).bind(...params).all()
    
    return c.json({ 
      success: true, 
      bookmarks: result.results || [],
      count: result.results?.length || 0
    })
  } catch (error) {
    console.error('ë¶ë§ˆí¬ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë¶ë§ˆí¬ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ë¶ë§ˆí¬ ì‚­ì œ
app.delete('/api/bookmarks/:id', async (c) => {
  const { DB } = c.env
  try {
    const bookmarkId = c.req.param('id')
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'userIdê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    await DB.prepare('DELETE FROM bookmarks WHERE id = ? AND user_id = ?')
      .bind(bookmarkId, userId).run()
    
    return c.json({ success: true, message: 'ë¶ë§ˆí¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    console.error('ë¶ë§ˆí¬ ì‚­ì œ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë¶ë§ˆí¬ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ë¶ë§ˆí¬ í™•ì¸ (íŠ¹ì • ë‰´ìŠ¤ê°€ ë¶ë§ˆí¬ë˜ì–´ ìˆëŠ”ì§€)
app.get('/api/bookmarks/check', async (c) => {
  const { DB } = c.env
  try {
    const userId = c.req.query('userId')
    const link = c.req.query('link')
    
    if (!userId || !link) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
    }
    
    const result = await DB.prepare(
      'SELECT id FROM bookmarks WHERE user_id = ? AND news_link = ?'
    ).bind(userId, link).first()
    
    return c.json({ 
      success: true, 
      bookmarked: !!result,
      bookmarkId: result?.id || null
    })
  } catch (error) {
    console.error('ë¶ë§ˆí¬ í™•ì¸ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë¶ë§ˆí¬ í™•ì¸ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ë‰´ìŠ¤ ê²€ìƒ‰ API ====================
app.get('/api/news/search', async (c) => {
  const { DB } = c.env
  try {
    const query = c.req.query('q') || ''
    const category = c.req.query('category')
    const limit = parseInt(c.req.query('limit') || '50')
    const offset = parseInt(c.req.query('offset') || '0')
    
    if (!query || query.trim().length === 0) {
      return c.json({ success: false, error: 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    let sql = `SELECT * FROM news WHERE (title LIKE ? OR summary LIKE ?)`
    const searchTerm = `%${query.trim()}%`
    const params: any[] = [searchTerm, searchTerm]
    
    if (category && category !== 'all') {
      sql += ' AND category = ?'
      params.push(category)
    }
    
    sql += ' ORDER BY pub_date DESC LIMIT ? OFFSET ?'
    params.push(limit, offset)
    
    const result = await DB.prepare(sql).bind(...params).all()
    
    return c.json({ 
      success: true, 
      news: result.results || [],
      count: result.results?.length || 0,
      query: query.trim()
    })
  } catch (error) {
    console.error('ë‰´ìŠ¤ ê²€ìƒ‰ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë‰´ìŠ¤ ê²€ìƒ‰ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== Figma API ì—°ë™ ====================
// Figma íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
app.get('/api/figma/file/:fileKey', async (c) => {
  const { FIGMA_ACCESS_TOKEN } = c.env
  const fileKey = c.req.param('fileKey')
  
  if (!FIGMA_ACCESS_TOKEN) {
    return c.json({ 
      success: false, 
      error: 'Figma Access Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .dev.vars íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.' 
    }, 500)
  }
  
  try {
    const response = await fetch(`https://api.figma.com/v1/files/${fileKey}`, {
      headers: {
        'X-Figma-Token': FIGMA_ACCESS_TOKEN
      }
    })
    
    if (!response.ok) {
      const errorData = await response.text()
      console.error('Figma API ì˜¤ë¥˜:', response.status, errorData)
      return c.json({ 
        success: false, 
        error: `Figma API ì˜¤ë¥˜: ${response.status}`,
        details: errorData
      }, response.status)
    }
    
    const data = await response.json()
    return c.json({ 
      success: true, 
      data 
    })
  } catch (error) {
    console.error('Figma íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨' 
    }, 500)
  }
})

// Figma ì´ë¯¸ì§€ ë Œë”ë§ (PNG/SVG)
app.get('/api/figma/images/:fileKey', async (c) => {
  const { FIGMA_ACCESS_TOKEN } = c.env
  const fileKey = c.req.param('fileKey')
  const nodeIds = c.req.query('ids') // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë…¸ë“œ IDë“¤
  const format = c.req.query('format') || 'png' // png, jpg, svg, pdf
  const scale = c.req.query('scale') || '1' // 1, 2, 3, 4
  
  if (!FIGMA_ACCESS_TOKEN) {
    return c.json({ 
      success: false, 
      error: 'Figma Access Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' 
    }, 500)
  }
  
  if (!nodeIds) {
    return c.json({ 
      success: false, 
      error: 'Node IDsë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: ?ids=1:2,1:3)' 
    }, 400)
  }
  
  try {
    const url = new URL(`https://api.figma.com/v1/images/${fileKey}`)
    url.searchParams.set('ids', nodeIds)
    url.searchParams.set('format', format)
    url.searchParams.set('scale', scale)
    
    const response = await fetch(url.toString(), {
      headers: {
        'X-Figma-Token': FIGMA_ACCESS_TOKEN
      }
    })
    
    if (!response.ok) {
      const errorData = await response.text()
      return c.json({ 
        success: false, 
        error: `Figma API ì˜¤ë¥˜: ${response.status}`,
        details: errorData
      }, response.status)
    }
    
    const data = await response.json()
    return c.json({ 
      success: true, 
      images: data.images,
      metadata: {
        format,
        scale,
        nodeIds: nodeIds.split(',')
      }
    })
  } catch (error) {
    console.error('Figma ì´ë¯¸ì§€ ë Œë”ë§ ì˜¤ë¥˜:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'ì´ë¯¸ì§€ ë Œë”ë§ ì‹¤íŒ¨' 
    }, 500)
  }
})

// Figma ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸° (ë””ìì¸ í† í°)
app.get('/api/figma/styles/:fileKey', async (c) => {
  const { FIGMA_ACCESS_TOKEN } = c.env
  const fileKey = c.req.param('fileKey')
  
  if (!FIGMA_ACCESS_TOKEN) {
    return c.json({ 
      success: false, 
      error: 'Figma Access Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' 
    }, 500)
  }
  
  try {
    // ë¨¼ì € íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ìŠ¤íƒ€ì¼ ë¶„ì„
    const response = await fetch(`https://api.figma.com/v1/files/${fileKey}`, {
      headers: {
        'X-Figma-Token': FIGMA_ACCESS_TOKEN
      }
    })
    
    if (!response.ok) {
      return c.json({ 
        success: false, 
        error: `Figma API ì˜¤ë¥˜: ${response.status}` 
      }, response.status)
    }
    
    const fileData = await response.json()
    
    // ìŠ¤íƒ€ì¼ ì •ë³´ ì¶”ì¶œ (ìƒ‰ìƒ, í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ë“±)
    const styles = {
      colors: fileData.styles?.fills || {},
      textStyles: fileData.styles?.text || {},
      effectStyles: fileData.styles?.effects || {}
    }
    
    return c.json({ 
      success: true, 
      styles,
      fileName: fileData.name,
      lastModified: fileData.lastModified
    })
  } catch (error) {
    console.error('Figma ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨' 
    }, 500)
  }
})

// Figma ì—°ë™ í…ŒìŠ¤íŠ¸ í˜ì´ì§€
app.get('/figma-test', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Figma API í…ŒìŠ¤íŠ¸ - Faith Portal</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-pencil-ruler text-purple-600 mr-2"></i>
                    Figma API ì—°ë™ í…ŒìŠ¤íŠ¸
                </h1>
                <p class="text-gray-600 mb-4">
                    Figma Personal Access Tokenì„ ì„¤ì •í•˜ê³  ì•„ë˜ì—ì„œ íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-file text-blue-600 mr-2"></i>
                    1. Figma íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                </h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Figma File Key
                    </label>
                    <input 
                        type="text" 
                        id="fileKey"
                        placeholder="ì˜ˆ: ABC123xyz"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        URLì—ì„œ file/ ë‹¤ìŒì˜ ê°’: https://www.figma.com/file/<strong>ABC123xyz</strong>/My-Design
                    </p>
                </div>
                <button 
                    onclick="fetchFileInfo()"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                >
                    <i class="fas fa-download mr-2"></i>
                    íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-image text-green-600 mr-2"></i>
                    2. ì´ë¯¸ì§€ ë Œë”ë§
                </h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Figma File Key
                        </label>
                        <input 
                            type="text" 
                            id="imageFileKey"
                            placeholder="ABC123xyz"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Node IDs (ì‰¼í‘œ êµ¬ë¶„)
                        </label>
                        <input 
                            type="text" 
                            id="nodeIds"
                            placeholder="1:2,1:3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                        />
                    </div>
                </div>
                <button 
                    onclick="renderImages()"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                >
                    <i class="fas fa-paint-brush mr-2"></i>
                    ì´ë¯¸ì§€ ë Œë”ë§
                </button>
            </div>

            <div id="result" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    ê²°ê³¼
                </h3>
                <pre id="resultContent" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto max-h-96 text-xs"></pre>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-6">
                <h3 class="text-lg font-bold text-blue-900 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    ì„¤ì • ê°€ì´ë“œ
                </h3>
                <ol class="list-decimal list-inside text-blue-800 space-y-2">
                    <li>Figma ì„¤ì •ì—ì„œ Personal Access Token ë°œê¸‰</li>
                    <li>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— <code class="bg-blue-100 px-2 py-1 rounded">.dev.vars</code> íŒŒì¼ ìƒì„±</li>
                    <li><code class="bg-blue-100 px-2 py-1 rounded">FIGMA_ACCESS_TOKEN=your_token</code> ì¶”ê°€</li>
                    <li>ê°œë°œ ì„œë²„ ì¬ì‹œì‘</li>
                </ol>
                <p class="text-sm text-blue-700 mt-4">
                    ìì„¸í•œ ë‚´ìš©ì€ <code class="bg-blue-100 px-2 py-1 rounded">FIGMA_INTEGRATION.md</code> ì°¸ê³ 
                </p>
            </div>
        </div>

        <script>
            async function fetchFileInfo() {
                const fileKey = document.getElementById('fileKey').value.trim()
                if (!fileKey) {
                    alert('Figma File Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”')
                    return
                }

                showLoading()
                try {
                    const response = await fetch(\`/api/figma/file/\${fileKey}\`)
                    const data = await response.json()
                    showResult(data)
                } catch (error) {
                    showResult({ success: false, error: error.message })
                }
            }

            async function renderImages() {
                const fileKey = document.getElementById('imageFileKey').value.trim()
                const nodeIds = document.getElementById('nodeIds').value.trim()
                
                if (!fileKey || !nodeIds) {
                    alert('File Keyì™€ Node IDsë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”')
                    return
                }

                showLoading()
                try {
                    const response = await fetch(\`/api/figma/images/\${fileKey}?ids=\${nodeIds}\`)
                    const data = await response.json()
                    showResult(data)
                } catch (error) {
                    showResult({ success: false, error: error.message })
                }
            }

            function showLoading() {
                const result = document.getElementById('result')
                const content = document.getElementById('resultContent')
                result.classList.remove('hidden')
                content.textContent = 'ë¡œë”© ì¤‘...'
            }

            function showResult(data) {
                const result = document.getElementById('result')
                const content = document.getElementById('resultContent')
                result.classList.remove('hidden')
                content.textContent = JSON.stringify(data, null, 2)
            }
        </script>
    </body>
    </html>
  `)
})

// ==================== Puppeteer API ì—°ë™ ====================
// ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜
app.get('/api/puppeteer/screenshot', async (c) => {
  try {
    const url = c.req.query('url')
    const fullPage = c.req.query('fullPage') === 'true'
    const format = c.req.query('format') || 'png'
    const width = parseInt(c.req.query('width') || '1920')
    const height = parseInt(c.req.query('height') || '1080')
    
    if (!url) {
      return c.json({ 
        success: false, 
        error: 'URL parameter is required' 
      }, 400)
    }
    
    // Browserless.io API í† í° ê°€ì ¸ì˜¤ê¸°
    const token = c.env?.BROWSERLESS_API_TOKEN || process.env.BROWSERLESS_API_TOKEN
    
    if (!token || token === 'demo_token_for_testing') {
      return c.json({
        success: false,
        error: 'BROWSERLESS_API_TOKEN not configured',
        message: 'ì‹¤ì œ Browserless.io API í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”',
        guide: {
          step1: 'https://www.browserless.io ì—ì„œ ê°€ì…',
          step2: 'API í‚¤ ë°œê¸‰',
          step3: '.dev.vars íŒŒì¼ì— BROWSERLESS_API_TOKEN ì„¤ì •',
          step4: 'ì„œë²„ ì¬ì‹œì‘'
        }
      }, 401)
    }
    
    try {
      // Browserless.io Screenshot API í˜¸ì¶œ
      const browserlessUrl = `https://chrome.browserless.io/screenshot?token=${token}`
      
      const response = await fetch(browserlessUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({
          url: url,
          options: {
            fullPage: fullPage,
            type: format,
            encoding: 'base64'
          },
          viewport: {
            width: width,
            height: height
          }
        })
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        return c.json({
          success: false,
          error: 'Browserless.io API error',
          status: response.status,
          details: errorText
        }, response.status)
      }
      
      // Base64 ì´ë¯¸ì§€ ë°ì´í„°
      const screenshotBase64 = await response.text()
      
      // Base64ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜
      const screenshotBuffer = Uint8Array.from(atob(screenshotBase64), c => c.charCodeAt(0))
      
      return new Response(screenshotBuffer, {
        headers: {
          'Content-Type': `image/${format}`,
          'Cache-Control': 'public, max-age=3600',
          'X-Screenshot-URL': url
        }
      })
    } catch (apiError: any) {
      return c.json({
        success: false,
        error: 'Failed to capture screenshot',
        message: apiError.message
      }, 500)
    }
  } catch (error: any) {
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// PDF ìƒì„±
app.get('/api/puppeteer/pdf', async (c) => {
  try {
    const url = c.req.query('url')
    const format = c.req.query('format') || 'A4'
    const landscape = c.req.query('landscape') === 'true'
    
    if (!url) {
      return c.json({ 
        success: false, 
        error: 'URL parameter is required' 
      }, 400)
    }
    
    // Browserless.io API í† í° ê°€ì ¸ì˜¤ê¸°
    const token = c.env?.BROWSERLESS_API_TOKEN || process.env.BROWSERLESS_API_TOKEN
    
    if (!token || token === 'demo_token_for_testing') {
      return c.json({
        success: false,
        error: 'BROWSERLESS_API_TOKEN not configured',
        message: 'ì‹¤ì œ Browserless.io API í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”'
      }, 401)
    }
    
    try {
      // Browserless.io PDF API í˜¸ì¶œ
      const browserlessUrl = `https://chrome.browserless.io/pdf?token=${token}`
      
      const response = await fetch(browserlessUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({
          url: url,
          options: {
            format: format,
            landscape: landscape,
            printBackground: true,
            preferCSSPageSize: false
          }
        })
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        return c.json({
          success: false,
          error: 'Browserless.io API error',
          status: response.status,
          details: errorText
        }, response.status)
      }
      
      // PDF ë°”ì´ë„ˆë¦¬ ë°ì´í„°
      const pdfBuffer = await response.arrayBuffer()
      
      return new Response(pdfBuffer, {
        headers: {
          'Content-Type': 'application/pdf',
          'Content-Disposition': `attachment; filename="page-${Date.now()}.pdf"`,
          'Cache-Control': 'public, max-age=3600',
          'X-PDF-URL': url
        }
      })
    } catch (apiError: any) {
      return c.json({
        success: false,
        error: 'Failed to generate PDF',
        message: apiError.message
      }, 500)
    }
  } catch (error: any) {
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// ì›¹ ìŠ¤í¬ë˜í•‘
app.post('/api/puppeteer/scrape', async (c) => {
  try {
    const { url, selector, waitForSelector, waitTime } = await c.req.json()
    
    if (!url) {
      return c.json({ 
        success: false, 
        error: 'URL is required' 
      }, 400)
    }
    
    // Browserless.io API í† í° ê°€ì ¸ì˜¤ê¸°
    const token = c.env?.BROWSERLESS_API_TOKEN || process.env.BROWSERLESS_API_TOKEN
    
    if (!token || token === 'demo_token_for_testing') {
      return c.json({
        success: false,
        error: 'BROWSERLESS_API_TOKEN not configured',
        message: 'ì‹¤ì œ Browserless.io API í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”'
      }, 401)
    }
    
    try {
      // Browserless.io Scrape API í˜¸ì¶œ
      const browserlessUrl = `https://chrome.browserless.io/scrape?token=${token}`
      
      // ìŠ¤í¬ë˜í•‘ í•¨ìˆ˜ (ë¸Œë¼ìš°ì € ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë¨)
      const scrapeFunction = `
        async () => {
          ${waitForSelector ? `await page.waitForSelector('${waitForSelector}', { timeout: 10000 });` : ''}
          ${waitTime ? `await new Promise(r => setTimeout(r, ${waitTime}));` : ''}
          
          const data = {
            title: document.title,
            url: window.location.href,
            timestamp: new Date().toISOString()
          };
          
          ${selector ? `
            const elements = Array.from(document.querySelectorAll('${selector}'));
            data.elements = elements.map(el => ({
              text: el.textContent?.trim(),
              html: el.innerHTML,
              href: el.getAttribute('href'),
              src: el.getAttribute('src')
            }));
          ` : `
            data.content = document.body.textContent?.trim();
          `}
          
          return data;
        }
      `
      
      const response = await fetch(browserlessUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({
          url: url,
          elements: [
            {
              selector: selector || 'body'
            }
          ],
          gotoOptions: {
            waitUntil: 'networkidle2'
          }
        })
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        return c.json({
          success: false,
          error: 'Browserless.io API error',
          status: response.status,
          details: errorText
        }, response.status)
      }
      
      const scrapedData = await response.json()
      
      return c.json({
        success: true,
        data: scrapedData,
        timestamp: new Date().toISOString()
      })
    } catch (apiError: any) {
      return c.json({
        success: false,
        error: 'Failed to scrape webpage',
        message: apiError.message
      }, 500)
    }
  } catch (error: any) {
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// Puppeteer ì—°ë™ í…ŒìŠ¤íŠ¸ í˜ì´ì§€
app.get('/puppeteer-test', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Puppeteer API í…ŒìŠ¤íŠ¸ - Faith Portal</title>
        <script>
          // Tailwind CDN ê²½ê³  í•„í„°
          (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
              const message = args.join(' ');
              if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                return;
              }
              originalWarn.apply(console, args);
            };
          })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-robot text-indigo-600 mr-2"></i>
                    Puppeteer API ì—°ë™ í…ŒìŠ¤íŠ¸
                </h1>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>ì¤‘ìš”:</strong> Cloudflare Workers í™˜ê²½ì—ì„œëŠ” Puppeteerë¥¼ ì§ì ‘ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                                ì™¸ë¶€ ë¸Œë¼ìš°ì € ì„œë¹„ìŠ¤(Browserless.io ë“±)ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ Cloudflare Browser Rendering APIë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-camera text-blue-600 mr-2"></i>
                    1. ì›¹í˜ì´ì§€ ìŠ¤í¬ë¦°ìƒ·
                </h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        URL
                    </label>
                    <input 
                        type="text" 
                        id="screenshotUrl"
                        placeholder="https://example.com"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="fullPage" class="mr-2">
                        <span class="text-sm text-gray-700">ì „ì²´ í˜ì´ì§€ ìº¡ì²˜</span>
                    </label>
                </div>
                <button 
                    onclick="testScreenshot()" 
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors"
                >
                    <i class="fas fa-camera mr-2"></i>ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                    2. PDF ìƒì„±
                </h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        URL
                    </label>
                    <input 
                        type="text" 
                        id="pdfUrl"
                        placeholder="https://example.com"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                    />
                </div>
                <button 
                    onclick="testPdf()" 
                    class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
                >
                    <i class="fas fa-file-pdf mr-2"></i>PDF ìƒì„±
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-spider text-purple-600 mr-2"></i>
                    3. ì›¹ ìŠ¤í¬ë˜í•‘
                </h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        URL
                    </label>
                    <input 
                        type="text" 
                        id="scrapeUrl"
                        placeholder="https://example.com"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        CSS Selector (ì„ íƒì‚¬í•­)
                    </label>
                    <input 
                        type="text" 
                        id="selector"
                        placeholder=".article-title"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                </div>
                <button 
                    onclick="testScrape()" 
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                >
                    <i class="fas fa-spider mr-2"></i>ìŠ¤í¬ë˜í•‘ ì‹œì‘
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-terminal text-green-600 mr-2"></i>
                    ì‘ë‹µ
                </h2>
                <pre id="response" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm">ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>
            </div>

            <div class="mt-6">
                <a href="/" class="text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-arrow-left mr-2"></i>í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>
        </div>

        <script>
            async function testScreenshot() {
                const url = document.getElementById('screenshotUrl').value
                const fullPage = document.getElementById('fullPage').checked
                const response = document.getElementById('response')
                
                if (!url) {
                    response.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
                    return
                }
                
                response.textContent = 'ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)'
                
                try {
                    const res = await fetch(\`/api/puppeteer/screenshot?url=\${encodeURIComponent(url)}&fullPage=\${fullPage}\`)
                    
                    // ì‘ë‹µì´ JSONì¸ ê²½ìš° (ì—ëŸ¬ ë˜ëŠ” ì„¤ì • í•„ìš”)
                    const contentType = res.headers.get('content-type')
                    if (contentType && contentType.includes('application/json')) {
                        const data = await res.json()
                        response.textContent = JSON.stringify(data, null, 2)
                        return
                    }
                    
                    // ì´ë¯¸ì§€ ì‘ë‹µì¸ ê²½ìš°
                    if (res.ok) {
                        const blob = await res.blob()
                        const imageUrl = URL.createObjectURL(blob)
                        response.innerHTML = \`
                            <div class="space-y-4">
                                <p class="text-green-600 font-semibold">âœ… ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ì„±ê³µ!</p>
                                <img src="\${imageUrl}" alt="Screenshot" class="max-w-full border border-gray-300 rounded-lg shadow-lg" />
                                <a href="\${imageUrl}" download="screenshot.png" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                                </a>
                            </div>
                        \`
                    } else {
                        response.textContent = \`Error: \${res.status} - \${await res.text()}\`
                    }
                } catch (error) {
                    response.textContent = 'Error: ' + error.message
                }
            }
            
            async function testPdf() {
                const url = document.getElementById('pdfUrl').value
                const response = document.getElementById('response')
                
                if (!url) {
                    response.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
                    return
                }
                
                response.textContent = 'PDF ìƒì„± ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)'
                
                try {
                    const res = await fetch(\`/api/puppeteer/pdf?url=\${encodeURIComponent(url)}\`)
                    
                    // ì‘ë‹µì´ JSONì¸ ê²½ìš° (ì—ëŸ¬ ë˜ëŠ” ì„¤ì • í•„ìš”)
                    const contentType = res.headers.get('content-type')
                    if (contentType && contentType.includes('application/json')) {
                        const data = await res.json()
                        response.textContent = JSON.stringify(data, null, 2)
                        return
                    }
                    
                    // PDF ì‘ë‹µì¸ ê²½ìš°
                    if (res.ok) {
                        const blob = await res.blob()
                        const pdfUrl = URL.createObjectURL(blob)
                        const filename = \`page-\${Date.now()}.pdf\`
                        
                        // ìë™ ë‹¤ìš´ë¡œë“œ
                        const a = document.createElement('a')
                        a.href = pdfUrl
                        a.download = filename
                        document.body.appendChild(a)
                        a.click()
                        document.body.removeChild(a)
                        
                        response.innerHTML = \`
                            <div class="space-y-4">
                                <p class="text-green-600 font-semibold">âœ… PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</p>
                                <p class="text-sm text-gray-600">íŒŒì¼ëª…: \${filename}</p>
                                <a href="\${pdfUrl}" target="_blank" class="inline-block bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                                    <i class="fas fa-eye mr-2"></i>PDF ë¯¸ë¦¬ë³´ê¸°
                                </a>
                            </div>
                        \`
                    } else {
                        response.textContent = \`Error: \${res.status} - \${await res.text()}\`
                    }
                } catch (error) {
                    response.textContent = 'Error: ' + error.message
                }
            }
            
            async function testScrape() {
                const url = document.getElementById('scrapeUrl').value
                const selector = document.getElementById('selector').value
                const response = document.getElementById('response')
                
                if (!url) {
                    response.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
                    return
                }
                
                response.textContent = 'ì›¹ ìŠ¤í¬ë˜í•‘ ì¤‘... (ìµœëŒ€ 30ì´ˆ ì†Œìš”)'
                
                try {
                    const res = await fetch('/api/puppeteer/scrape', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url, selector })
                    })
                    const data = await res.json()
                    
                    if (data.success) {
                        response.innerHTML = \`
                            <div class="space-y-2">
                                <p class="text-green-600 font-semibold">âœ… ìŠ¤í¬ë˜í•‘ ì„±ê³µ!</p>
                                <pre class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm">\${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        \`
                    } else {
                        response.textContent = JSON.stringify(data, null, 2)
                    }
                } catch (error) {
                    response.textContent = 'Error: ' + error.message
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ==================== ë§ˆì´í˜ì´ì§€ API ====================

// ë¡œê·¸ì¸ ê¸°ë¡ ì¡°íšŒ
app.get('/api/mypage/login-history', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, message: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    const result = await c.env.DB.prepare(`
      SELECT id, login_time, ip_address, user_agent
      FROM login_history
      WHERE user_id = ?
      ORDER BY login_time DESC
      LIMIT 50
    `).bind(userId).all()
    
    return c.json({ success: true, history: result.results || [] })
  } catch (error) {
    console.error('ë¡œê·¸ì¸ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ë§ˆì´í˜ì´ì§€ ====================
app.get('/mypage', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì´í˜ì´ì§€ - Faith Portal</title>
        <script>
            // Tailwind CDN ê²½ê³  í•„í„°ë§ (ê°œë°œ í™˜ê²½ìš©)
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Tailwind CDN ê²½ê³  ë¬´ì‹œ
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .faith-blue-hover:hover { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
            
            /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
            .dark {
                color-scheme: dark;
            }
            .dark body {
                background: linear-gradient(to bottom right, #1e293b, #0f172a, #020617);
            }
            .dark .bg-white {
                background-color: #1e293b !important;
            }
            .dark .text-gray-900 {
                color: #f1f5f9 !important;
            }
            .dark .text-gray-800 {
                color: #e2e8f0 !important;
            }
            .dark .text-gray-700 {
                color: #cbd5e1 !important;
            }
            .dark .text-gray-600 {
                color: #94a3b8 !important;
            }
            .dark .border-gray-200 {
                border-color: #334155 !important;
            }
            .dark .bg-gray-50 {
                background-color: #0f172a !important;
            }
            .dark .bg-gray-100 {
                background-color: #1e293b !important;
            }
        </style>
    </head>
    <body class="bg-gray-50 min-h-screen" id="html-root">
        ${getCommonHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ë§ˆì´í˜ì´ì§€'}
        ])}
        
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6 sm:py-8">
            <div class="mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    <i class="fas fa-user mr-2"></i>ë§ˆì´í˜ì´ì§€
                </h1>
                <p class="text-gray-600 mt-2">ë‚´ ì •ë³´ ë° ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-2 sm:space-x-4 px-4 sm:px-6 overflow-x-auto" aria-label="Tabs">
                        <button id="tab-info" class="tab-button border-b-2 border-sky-500 text-sky-600 py-4 px-1 text-xs sm:text-sm font-medium whitespace-nowrap">
                            <i class="fas fa-user mr-1 sm:mr-2"></i>ë‚´ ì •ë³´
                        </button>
                        <button id="tab-dday" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-xs sm:text-sm font-medium whitespace-nowrap">
                            <i class="fas fa-heart mr-1 sm:mr-2"></i>D-Day
                        </button>
                        <button id="tab-history" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-xs sm:text-sm font-medium whitespace-nowrap">
                            <i class="fas fa-history mr-1 sm:mr-2"></i>ë¡œê·¸ì¸ ê¸°ë¡
                        </button>
                        <button id="tab-settings" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-xs sm:text-sm font-medium whitespace-nowrap">
                            <i class="fas fa-cog mr-1 sm:mr-2"></i>ì„¤ì •
                        </button>
                    </nav>
                </div>
                
                <!-- íƒ­ ì½˜í…ì¸  -->
                <div class="p-4 sm:p-6">
                    <!-- ë‚´ ì •ë³´ íƒ­ -->
                    <div id="content-info" class="tab-content">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm text-gray-600">ì´ë©”ì¼</p>
                                    <p id="user-email" class="text-lg font-medium text-gray-900">-</p>
                                </div>
                                <i class="fas fa-envelope text-2xl text-gray-400"></i>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm text-gray-600">íšŒì› ë ˆë²¨</p>
                                    <p id="user-level" class="text-lg font-medium text-gray-900">-</p>
                                </div>
                                <i class="fas fa-star text-2xl text-gray-400"></i>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm text-gray-600">ê°€ì…ì¼</p>
                                    <p id="user-created" class="text-lg font-medium text-gray-900">-</p>
                                </div>
                                <i class="fas fa-calendar text-2xl text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- D-Day íƒ­ -->
                    <div id="content-dday" class="tab-content hidden">
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">ë‚˜ì˜ D-Day</h3>
                                <p class="text-sm text-gray-600">ë“±ë¡í•œ D-Day ëª©ë¡ì…ë‹ˆë‹¤</p>
                            </div>
                            <a href="/lifestyle/dday-calculator" class="faith-blue text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all text-sm">
                                <i class="fas fa-plus mr-1"></i>ìƒˆë¡œ ë§Œë“¤ê¸°
                            </a>
                        </div>
                        <div id="dday-list-container" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>D-Day ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë¡œê·¸ì¸ ê¸°ë¡ íƒ­ -->
                    <div id="content-history" class="tab-content hidden">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">ìµœê·¼ ë¡œê·¸ì¸ ê¸°ë¡</h3>
                            <p class="text-sm text-gray-600">ìµœê·¼ 50ê°œì˜ ë¡œê·¸ì¸ ê¸°ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤</p>
                        </div>
                        <div id="login-history-list" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>ë¡œê·¸ì¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì„¤ì • íƒ­ -->
                    <div id="content-settings" class="tab-content hidden">
                        <div class="space-y-6">
                            <!-- ë‹¤í¬ëª¨ë“œ ì„¤ì • -->
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">
                                            <i class="fas fa-moon mr-2"></i>ë‹¤í¬ëª¨ë“œ
                                        </h3>
                                        <p class="text-sm text-gray-600 mt-1">ì–´ë‘ìš´ í…Œë§ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ë¶ë§ˆí¬ ë°”ë¡œê°€ê¸° -->
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">
                                            <i class="fas fa-bookmark mr-2"></i>ë¶ë§ˆí¬
                                        </h3>
                                        <p class="text-sm text-gray-600 mt-1">ì €ì¥í•œ ë‰´ìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</p>
                                    </div>
                                    <a href="/bookmarks" class="faith-blue text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all">
                                        ë°”ë¡œê°€ê¸° <i class="fas fa-arrow-right ml-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        ${getCommonFooter()}
        ${getCommonAuthScript()}
        
        <script>
            // ë¡œê·¸ì¸ ì²´í¬
            const token = localStorage.getItem('auth_token');
            const userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            const userLevel = localStorage.getItem('user_level');
            
            if (!token || !userId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
            }
            
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('user-email').textContent = userEmail || '-';
            document.getElementById('user-level').textContent = 'Lv.' + (userLevel || '0');
            
            // íƒ­ ì „í™˜
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                    tabs.forEach(t => {
                        t.classList.remove('border-sky-500', 'text-sky-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // í´ë¦­ëœ íƒ­ í™œì„±í™”
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('border-sky-500', 'text-sky-600');
                    
                    // ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
                    contents.forEach(c => c.classList.add('hidden'));
                    
                    // í•´ë‹¹ ì½˜í…ì¸  í‘œì‹œ
                    const tabId = this.id.replace('tab-', '');
                    document.getElementById('content-' + tabId).classList.remove('hidden');
                    
                    // ë¡œê·¸ì¸ ê¸°ë¡ íƒ­ì´ë©´ ë°ì´í„° ë¡œë“œ
                    if (tabId === 'history') {
                        loadLoginHistory();
                    }
                    // D-Day íƒ­ì´ë©´ ë°ì´í„° ë¡œë“œ
                    if (tabId === 'dday') {
                        loadDdayList();
                    }
                });
            });
            
            // ë¡œê·¸ì¸ ê¸°ë¡ ë¡œë“œ
            async function loadLoginHistory() {
                try {
                    const response = await axios.get('/api/mypage/login-history?userId=' + userId);
                    
                    if (response.data.success) {
                        const history = response.data.history;
                        const listEl = document.getElementById('login-history-list');
                        
                        if (history.length === 0) {
                            listEl.innerHTML = '<div class="text-center py-8 text-gray-500"><p>ë¡œê·¸ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                            return;
                        }
                        
                        listEl.innerHTML = history.map(item => {
                            const date = new Date(item.login_time);
                            const dateStr = date.toLocaleString('ko-KR');
                            const ua = item.user_agent || 'unknown';
                            const browser = getBrowserInfo(ua);
                            
                            return \`
                                <div class="flex items-start p-4 bg-gray-50 rounded-lg">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-\${browser.icon} text-2xl text-gray-400"></i>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-gray-900">\${dateStr}</p>
                                        <p class="text-xs text-gray-600 mt-1">IP: \${item.ip_address}</p>
                                        <p class="text-xs text-gray-600">ê¸°ê¸°: \${browser.name}</p>
                                    </div>
                                </div>
                            \`;
                        }).join('');
                    }
                } catch (error) {
                    console.error('ë¡œê·¸ì¸ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    document.getElementById('login-history-list').innerHTML = 
                        '<div class="text-center py-8 text-red-500"><p>ë¡œê·¸ì¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
                }
            }
            
            // D-Day ëª©ë¡ ë¡œë“œ
            async function loadDdayList() {
                try {
                    const response = await axios.get('/api/dday/list');
                    
                    if (response.data.success) {
                        const ddays = response.data.ddays;
                        const listEl = document.getElementById('dday-list-container');
                        
                        if (ddays.length === 0) {
                            listEl.innerHTML = \`
                                <div class="text-center py-12">
                                    <div class="text-6xl mb-4">ğŸ“…</div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">ë“±ë¡ëœ D-Dayê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                                    <p class="text-gray-600 mb-4">ìƒˆë¡œìš´ D-Dayë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                                    <a href="/lifestyle/dday-calculator" class="inline-block faith-blue text-white px-6 py-3 rounded-lg hover:opacity-90 transition-all">
                                        <i class="fas fa-plus mr-2"></i>D-Day ë§Œë“¤ê¸°
                                    </a>
                                </div>
                            \`;
                            return;
                        }
                        
                        listEl.innerHTML = ddays.map(dday => {
                            const ddayText = calculateDday(dday.target_date, dday.mode, dday.is_anniversary);
                            const colorStyle = getColorGradient(dday.color);
                            
                            return \`
                                <div class="rounded-xl shadow-lg p-5 hover:shadow-xl transition-all" style="\${colorStyle}">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-4xl">\${dday.emoji}</span>
                                            <div class="text-white">
                                                <h3 class="font-bold text-lg">\${dday.title}</h3>
                                                <p class="text-sm opacity-90">\${new Date(dday.target_date).toLocaleDateString('ko-KR')}</p>
                                            </div>
                                        </div>
                                        <button onclick="deleteDdayFromMypage(\${dday.id})" class="text-white opacity-70 hover:opacity-100 transition">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                                        <div class="text-4xl font-bold text-white">\${ddayText}</div>
                                    </div>
                                </div>
                            \`;
                        }).join('');
                    }
                } catch (error) {
                    console.error('D-Day ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    document.getElementById('dday-list-container').innerHTML = 
                        '<div class="text-center py-8 text-red-500"><p>D-Day ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
                }
            }
            
            // D-Day ê³„ì‚°
            function calculateDday(targetDate, mode, isAnniversary) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const target = new Date(targetDate);
                target.setHours(0, 0, 0, 0);
                
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (mode === 'countdown') {
                    if (diffDays === 0) return 'D-Day';
                    if (diffDays > 0) return 'D-' + diffDays;
                    return 'D+' + Math.abs(diffDays);
                } else if (mode === 'countup') {
                    const days = Math.abs(diffDays) + (isAnniversary ? 1 : 0);
                    return days + 'ì¼ì§¸';
                } else {
                    return target.toLocaleDateString('ko-KR');
                }
            }
            
            // ìƒ‰ìƒ ê·¸ë¼ë””ì–¸íŠ¸
            function getColorGradient(color) {
                const gradients = {
                    '#667eea': 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);',
                    '#f093fb': 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);',
                    '#4facfe': 'background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);',
                    '#43e97b': 'background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);',
                    '#fa709a': 'background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);'
                };
                return gradients[color] || gradients['#667eea'];
            }
            
            // D-Day ì‚­ì œ
            async function deleteDdayFromMypage(id) {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    const response = await axios.delete('/api/dday/' + id);
                    if (response.data.success) {
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadDdayList();
                    }
                } catch (error) {
                    console.error('D-Day ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ë¸Œë¼ìš°ì € ì •ë³´ íŒŒì‹±
            function getBrowserInfo(ua) {
                if (ua.includes('Chrome')) return { name: 'Chrome', icon: 'chrome' };
                if (ua.includes('Firefox')) return { name: 'Firefox', icon: 'firefox' };
                if (ua.includes('Safari')) return { name: 'Safari', icon: 'safari' };
                if (ua.includes('Edge')) return { name: 'Edge', icon: 'edge' };
                return { name: 'Unknown', icon: 'globe' };
            }
            
            // ë‹¤í¬ëª¨ë“œ í† ê¸€
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDark = localStorage.getItem('darkMode') === 'true';
            darkModeToggle.checked = isDark;
            
            darkModeToggle.addEventListener('change', function() {
                const htmlRoot = document.getElementById('html-root');
                const isDarkMode = this.checked;
                
                if (isDarkMode) {
                    htmlRoot.classList.add('dark');
                } else {
                    htmlRoot.classList.remove('dark');
                }
                
                localStorage.setItem('darkMode', isDarkMode);
            });
        </script>
    </body>
    </html>
  `)
})

// ==================== ìŠ¤ë§ˆíŠ¸ í•œêµ­ ë‚˜ì´ ê³„ì‚°ê¸° ====================
app.get('/lifestyle/age-calculator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìŠ¤ë§ˆíŠ¸ ë§Œ ë‚˜ì´ & ìƒí™œ ì—°ë ¹ ê³„ì‚°ê¸° - Faith Portal</title>
        <meta name="description" content="ë‚´ ë‚˜ì´, ì´ì œ í—·ê°ˆë¦¬ì§€ ë§ˆì„¸ìš”! ë§Œ ë‚˜ì´, ì—° ë‚˜ì´, ì„¸ëŠ” ë‚˜ì´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ê³  ìˆ Â·ë‹´ë°°Â·íˆ¬í‘œ ë“± ìƒí™œ ê°€ì´ë“œê¹Œì§€">
        <script>
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return;
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .faith-blue { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
            .age-card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .age-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            }
            .check-item {
                transition: all 0.2s ease;
            }
            .check-item:hover {
                background-color: rgba(59, 130, 246, 0.05);
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50" id="html-root">
        ${getCommonAuthScript()}
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'í•œêµ­ ë‚˜ì´ ê³„ì‚°ê¸°'}
        ])}

        <main class="max-w-6xl mx-auto px-3 sm:px-4 lg:px-6 py-6 space-y-6">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl mb-4">
                    <i class="fas fa-birthday-cake text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                    ìŠ¤ë§ˆíŠ¸ ë§Œ ë‚˜ì´ & ìƒí™œ ì—°ë ¹ ê³„ì‚°ê¸°
                </h1>
                <p class="text-gray-600 text-sm md:text-base max-w-2xl mx-auto">
                    ë‚´ ë‚˜ì´, ì´ì œ í—·ê°ˆë¦¬ì§€ ë§ˆì„¸ìš”! ë²•ì  ë‚˜ì´ë¶€í„° ìˆ /ë‹´ë°° ê°€ëŠ¥ ì—¬ë¶€ê¹Œì§€ í•œ ë²ˆì—.
                </p>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-calendar-alt text-xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">ìƒë…„ì›”ì¼ ì…ë ¥</h2>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒë…„ (YYYY)</label>
                        <input 
                            type="number" 
                            id="birthYear" 
                            placeholder="1995"
                            min="1900"
                            max="2025"
                            class="w-full px-4 py-3 text-lg font-semibold border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì›” (MM)</label>
                        <select 
                            id="birthMonth"
                            class="w-full px-4 py-3 text-lg font-semibold border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                        >
                            <option value="">ì„ íƒ</option>
                            ${Array.from({length: 12}, (_, i) => `<option value="${i+1}">${i+1}ì›”</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¼ (DD)</label>
                        <select 
                            id="birthDay"
                            class="w-full px-4 py-3 text-lg font-semibold border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                        >
                            <option value="">ì„ íƒ</option>
                            ${Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}ì¼</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ê³„ì‚° ê¸°ì¤€ì¼ (ì„ íƒì‚¬í•­)
                    </label>
                    <div class="flex items-center gap-3">
                        <input 
                            type="date" 
                            id="referenceDate"
                            class="flex-1 px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none transition"
                        >
                        <button 
                            onclick="setToday()"
                            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-xl transition"
                        >
                            ì˜¤ëŠ˜
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        íŠ¹ì • ë‚ ì§œ(ì˜ˆ: ì…í•™ì¼, ê³„ì•½ì¼)ì— ëª‡ ì‚´ì¸ì§€ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </p>
                </div>

                <button 
                    onclick="calculateAge()"
                    class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold text-lg rounded-xl hover:from-blue-600 hover:to-indigo-700 transition shadow-lg"
                >
                    <i class="fas fa-calculator mr-2"></i>
                    ë‚˜ì´ ê³„ì‚°í•˜ê¸°
                </button>
            </div>

            <!-- ê²°ê³¼ ì˜ì—­ -->
            <div id="results" class="hidden space-y-6">
                <!-- ë©”ì¸ ë‚˜ì´ ì¹´ë“œë“¤ -->
                <div class="grid md:grid-cols-3 gap-4">
                    <!-- ë§Œ ë‚˜ì´ -->
                    <div class="age-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">ğŸ“„ ë§Œ ë‚˜ì´</h3>
                            <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">ë²•ì  í‘œì¤€</span>
                        </div>
                        <div class="text-5xl font-bold mb-2" id="manAge">-</div>
                        <p class="text-sm text-blue-100 mb-4">ê´€ê³µì„œ, ê³„ì•½, ë³‘ì›, ì€í–‰ì—ì„œ ì“°ëŠ” ì§„ì§œ ë‚´ ë‚˜ì´ì…ë‹ˆë‹¤</p>
                        <div class="text-sm bg-white bg-opacity-10 rounded-lg p-3" id="birthdayInfo">
                            ë‹¤ìŒ ìƒì¼ê¹Œì§€ D-?
                        </div>
                    </div>

                    <!-- ì—° ë‚˜ì´ -->
                    <div class="age-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">ğŸº ì—° ë‚˜ì´</h3>
                            <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">ì²­ì†Œë…„ ë³´í˜¸ë²•</span>
                        </div>
                        <div class="text-5xl font-bold mb-2" id="yeonAge">-</div>
                        <p class="text-sm text-purple-100 mb-4">ìˆ Â·ë‹´ë°° êµ¬ë§¤, êµ°ëŒ€ ì…ì˜ ì˜ì¥ì€ ì´ ë‚˜ì´ë¥¼ ë”°ë¦…ë‹ˆë‹¤</p>
                        <div class="text-sm bg-white bg-opacity-10 rounded-lg p-3">
                            = í˜„ì¬ ì—°ë„ - ì¶œìƒ ì—°ë„
                        </div>
                    </div>

                    <!-- ì„¸ëŠ” ë‚˜ì´ -->
                    <div class="age-card bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl shadow-xl p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">ğŸ—£ï¸ ì„¸ëŠ” ë‚˜ì´</h3>
                            <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">ì‚¬íšŒì  ë‚˜ì´</span>
                        </div>
                        <div class="text-5xl font-bold mb-2" id="koreanAge">-</div>
                        <p class="text-sm text-pink-100 mb-4">í•œêµ­ ì‚¬ëŒë“¤ë¼ë¦¬ "ì € 00ë…„ìƒ(00ì‚´)ì…ë‹ˆë‹¤" í•  ë•Œ ì£¼ë¡œ ì”ë‹ˆë‹¤</p>
                        <div class="text-sm bg-white bg-opacity-10 rounded-lg p-3">
                            = ì—° ë‚˜ì´ + 1
                        </div>
                    </div>
                </div>

                <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ìœ„ì ¯ -->
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-check-circle text-xl text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">í•  ìˆ˜ ìˆëŠ” ê²ƒ / ì—†ëŠ” ê²ƒ</h2>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4" id="checklistGrid">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ë ì™€ ë³„ìë¦¬ -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl shadow-lg p-6 border-2 border-orange-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-3xl" id="zodiacEmoji">ğŸ‰</span>
                            <span>ë‚˜ì˜ ë </span>
                        </h3>
                        <div class="text-4xl font-bold text-orange-600 mb-2" id="zodiacName">-</div>
                        <p class="text-sm text-gray-600" id="zodiacDesc">-</p>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-lg p-6 border-2 border-indigo-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-3xl">â­</span>
                            <span>ë‚˜ì˜ ë³„ìë¦¬</span>
                        </h3>
                        <div class="text-4xl font-bold text-indigo-600 mb-2" id="starSign">-</div>
                        <p class="text-sm text-gray-600" id="starSignDate">-</p>
                    </div>
                </div>

                <!-- ìƒì•  ì£¼ê¸° ì•Œë¦¼ -->
                <div id="lifecycleAlerts" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl shadow-lg p-6 md:p-8 border-2 border-yellow-300">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-bell text-yellow-600"></i>
                        <span>ìƒì•  ì£¼ê¸° ì•Œë¦¼</span>
                    </h3>
                    <div id="lifecycleContent" class="space-y-3">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ í™•ì¥ -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl shadow-lg p-6 md:p-8 border-2 border-purple-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    <span>ì´ëŸ° ì •ë³´ë„ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?</span>
                </h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-3xl mb-2">ğŸ“</div>
                        <div class="font-semibold text-gray-800 mb-1">í•™êµ ì…í•™ ê³„ì‚°ê¸°</div>
                        <div class="text-xs text-gray-600">ìë…€ ì´ˆë“±í•™êµ ì…í•™ ì‹œê¸° í™•ì¸</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-3xl mb-2">âš–ï¸</div>
                        <div class="font-semibold text-gray-800 mb-1">ë²•ì  ë‚˜ì´ FAQ</div>
                        <div class="text-xs text-gray-600">2023ë…„ ë§Œ ë‚˜ì´ í†µì¼ë²• ì™„ë²½ ì •ë¦¬</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 hover:shadow-md transition cursor-pointer">
                        <div class="text-3xl mb-2">ğŸ‚</div>
                        <div class="font-semibold text-gray-800 mb-1">ìƒì¼ D-Day</div>
                        <div class="text-xs text-gray-600">ë‚´ ìƒì¼ê¹Œì§€ ë‚¨ì€ ì‹œê°„</div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            window.addEventListener('DOMContentLoaded', function() {
                setToday();
            });

            function setToday() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                document.getElementById('referenceDate').value = year + '-' + month + '-' + day;
            }

            function calculateAge() {
                const year = parseInt(document.getElementById('birthYear').value);
                const month = parseInt(document.getElementById('birthMonth').value);
                const day = parseInt(document.getElementById('birthDay').value);
                const refDate = document.getElementById('referenceDate').value;

                if (!year || !month || !day || !refDate) {
                    alert('ìƒë…„ì›”ì¼ê³¼ ê³„ì‚° ê¸°ì¤€ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const birthDate = new Date(year, month - 1, day);
                const reference = new Date(refDate);
                const currentYear = reference.getFullYear();

                // 1. ì—° ë‚˜ì´
                const yeonAge = currentYear - year;

                // 2. ì„¸ëŠ” ë‚˜ì´
                const koreanAge = yeonAge + 1;

                // 3. ë§Œ ë‚˜ì´
                let manAge = yeonAge;
                const isBirthdayPassed = 
                    reference.getMonth() > birthDate.getMonth() || 
                    (reference.getMonth() === birthDate.getMonth() && reference.getDate() >= birthDate.getDate());
                
                if (!isBirthdayPassed) {
                    manAge -= 1;
                }

                // ë‹¤ìŒ ìƒì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜
                const nextBirthday = new Date(currentYear, birthDate.getMonth(), birthDate.getDate());
                if (isBirthdayPassed) {
                    nextBirthday.setFullYear(currentYear + 1);
                }
                const daysUntilBirthday = Math.ceil((nextBirthday - reference) / (1000 * 60 * 60 * 24));

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('manAge').textContent = manAge + 'ì„¸';
                document.getElementById('yeonAge').textContent = yeonAge + 'ì„¸';
                document.getElementById('koreanAge').textContent = koreanAge + 'ì„¸';
                document.getElementById('birthdayInfo').textContent = 
                    daysUntilBirthday === 0 ? 'ğŸ‰ ì˜¤ëŠ˜ì´ ìƒì¼ì…ë‹ˆë‹¤!' : 'ë‹¤ìŒ ìƒì¼ê¹Œì§€ D-' + daysUntilBirthday;

                // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
                generateChecklist(manAge, yeonAge, birthDate, reference);

                // ë ì™€ ë³„ìë¦¬
                displayZodiacAndStar(year, month, day);

                // ìƒì•  ì£¼ê¸° ì•Œë¦¼
                displayLifecycleAlerts(manAge);

                // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
                document.getElementById('results').classList.remove('hidden');

                // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function generateChecklist(manAge, yeonAge, birthDate, reference) {
                const checks = [
                    { name: 'íˆ¬í‘œ', manReq: 18, yeonReq: null, icon: 'ğŸ—³ï¸', desc: 'êµ­íšŒì˜ì›, ëŒ€í†µë ¹ ì„ ê±°' },
                    { name: 'ìš´ì „ë©´í—ˆ', manReq: 18, yeonReq: null, icon: 'ğŸš—', desc: '2ì¢… ë³´í†µë©´í—ˆ ì·¨ë“ ê°€ëŠ¥' },
                    { name: 'ì•„ë¥´ë°”ì´íŠ¸', manReq: 15, yeonReq: null, icon: 'ğŸ’¼', desc: 'ì·¨ì—… ì¸ì¦ í•„ìš”' },
                    { name: 'ìˆ /ë‹´ë°° êµ¬ë§¤', manReq: null, yeonReq: 19, icon: 'ğŸº', desc: '1ì›” 1ì¼ ê¸°ì¤€ ì—° ë‚˜ì´' },
                    { name: 'ì˜í™” ê´€ëŒ (ì²­ë¶ˆ)', manReq: 18, yeonReq: null, icon: 'ğŸ¬', desc: 'ì²­ì†Œë…„ ê´€ëŒë¶ˆê°€' },
                    { name: 'ì›Œí‚¹í™€ë¦¬ë°ì´', manReq: 18, yeonReq: null, maxAge: 30, icon: 'âœˆï¸', desc: 'êµ­ê°€ë³„ ìƒì´' }
                ];

                const grid = document.getElementById('checklistGrid');
                grid.innerHTML = '';

                checks.forEach(check => {
                    let canDo = false;
                    let statusText = '';

                    if (check.yeonReq !== null) {
                        canDo = yeonAge >= check.yeonReq;
                        statusText = canDo ? 'ê°€ëŠ¥' : ('ì—° ' + check.yeonReq + 'ì„¸ë¶€í„°');
                    } else {
                        if (check.maxAge) {
                            canDo = manAge >= check.manReq && manAge <= check.maxAge;
                            statusText = canDo ? 'ê°€ëŠ¥' : 
                                (manAge < check.manReq ? ('ë§Œ ' + check.manReq + 'ì„¸ë¶€í„°') : 'ì—°ë ¹ ì´ˆê³¼');
                        } else {
                            canDo = manAge >= check.manReq;
                            statusText = canDo ? 'ê°€ëŠ¥' : ('ë§Œ ' + check.manReq + 'ì„¸ë¶€í„°');
                        }
                    }

                    const statusColor = canDo ? 'text-green-600' : 'text-gray-400';
                    const bgColor = canDo ? 'bg-green-50' : 'bg-gray-50';
                    const icon = canDo ? 'âœ…' : 'âŒ';

                    grid.innerHTML += '<div class="check-item p-4 rounded-xl border-2 ' + 
                        (canDo ? 'border-green-200' : 'border-gray-200') + ' ' + bgColor + '">' +
                        '<div class="flex items-start justify-between mb-2">' +
                        '<div class="flex items-center gap-2">' +
                        '<span class="text-2xl">' + check.icon + '</span>' +
                        '<span class="font-bold text-gray-800">' + check.name + '</span>' +
                        '</div>' +
                        '<span class="text-2xl">' + icon + '</span>' +
                        '</div>' +
                        '<div class="text-sm text-gray-600 mb-1">' + check.desc + '</div>' +
                        '<div class="text-xs font-semibold ' + statusColor + '">' + statusText + '</div>' +
                        '</div>';
                });
            }

            function displayZodiacAndStar(year, month, day) {
                // ë  ê³„ì‚°
                const zodiacs = [
                    {name: 'ì¥ë ', emoji: 'ğŸ­', desc: 'ì˜ë¦¬í•˜ê³  ìˆœë°œë ¥ì´ ë›°ì–´ë‚¨'},
                    {name: 'ì†Œë ', emoji: 'ğŸ®', desc: 'ì„±ì‹¤í•˜ê³  ì¸ë‚´ì‹¬ì´ ê°•í•¨'},
                    {name: 'í˜¸ë‘ì´ë ', emoji: 'ğŸ¯', desc: 'ìš©ê°í•˜ê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆìŒ'},
                    {name: 'í† ë¼ë ', emoji: 'ğŸ°', desc: 'ì˜¨í™”í•˜ê³  ì„¬ì„¸í•¨'},
                    {name: 'ìš©ë ', emoji: 'ğŸ‰', desc: 'ì—´ì •ì ì´ê³  ë¦¬ë”ì‹­ì´ ê°•í•¨'},
                    {name: 'ë±€ë ', emoji: 'ğŸ', desc: 'ì§€í˜œë¡­ê³  ì‹ ì¤‘í•¨'},
                    {name: 'ë§ë ', emoji: 'ğŸ´', desc: 'í™œë™ì ì´ê³  ììœ ë¡œì›€'},
                    {name: 'ì–‘ë ', emoji: 'ğŸ‘', desc: 'ì˜¨ìˆœí•˜ê³  ì˜ˆìˆ ì  ê°ê°ì´ ë›°ì–´ë‚¨'},
                    {name: 'ì›ìˆ­ì´ë ', emoji: 'ğŸµ', desc: 'ì¬ì¹˜ìˆê³  ì‚¬êµì '},
                    {name: 'ë‹­ë ', emoji: 'ğŸ“', desc: 'ì •ì§í•˜ê³  ë¶€ì§€ëŸ°í•¨'},
                    {name: 'ê°œë ', emoji: 'ğŸ¶', desc: 'ì¶©ì„±ìŠ¤ëŸ½ê³  ì •ì˜ë¡œì›€'},
                    {name: 'ë¼ì§€ë ', emoji: 'ğŸ·', desc: 'ê´€ëŒ€í•˜ê³  ìˆœìˆ˜í•¨'}
                ];

                const zodiacIndex = (year - 4) % 12;
                const zodiac = zodiacs[zodiacIndex];

                document.getElementById('zodiacEmoji').textContent = zodiac.emoji;
                document.getElementById('zodiacName').textContent = zodiac.name;
                document.getElementById('zodiacDesc').textContent = zodiac.desc;

                // ë³„ìë¦¬ ê³„ì‚°
                const starSigns = [
                    {name: 'ë¬¼ë³‘ìë¦¬', start: [1,20], end: [2,18]},
                    {name: 'ë¬¼ê³ ê¸°ìë¦¬', start: [2,19], end: [3,20]},
                    {name: 'ì–‘ìë¦¬', start: [3,21], end: [4,19]},
                    {name: 'í™©ì†Œìë¦¬', start: [4,20], end: [5,20]},
                    {name: 'ìŒë‘¥ì´ìë¦¬', start: [5,21], end: [6,21]},
                    {name: 'ê²Œìë¦¬', start: [6,22], end: [7,22]},
                    {name: 'ì‚¬ììë¦¬', start: [7,23], end: [8,22]},
                    {name: 'ì²˜ë…€ìë¦¬', start: [8,23], end: [9,23]},
                    {name: 'ì²œì¹­ìë¦¬', start: [9,24], end: [10,22]},
                    {name: 'ì „ê°ˆìë¦¬', start: [10,23], end: [11,22]},
                    {name: 'ì‚¬ìˆ˜ìë¦¬', start: [11,23], end: [12,24]},
                    {name: 'ì—¼ì†Œìë¦¬', start: [12,25], end: [1,19]}
                ];

                let starSign = '';
                for (const sign of starSigns) {
                    const [startMonth, startDay] = sign.start;
                    const [endMonth, endDay] = sign.end;
                    
                    if (startMonth === endMonth) {
                        if (month === startMonth && day >= startDay && day <= endDay) {
                            starSign = sign.name;
                            break;
                        }
                    } else {
                        if ((month === startMonth && day >= startDay) || (month === endMonth && day <= endDay)) {
                            starSign = sign.name;
                            break;
                        }
                    }
                }

                document.getElementById('starSign').textContent = starSign;
                document.getElementById('starSignDate').textContent = month + 'ì›” ' + day + 'ì¼';
            }

            function displayLifecycleAlerts(manAge) {
                const alerts = [];

                if (manAge === 18 || manAge === 19) {
                    alerts.push({
                        icon: 'ğŸ“',
                        title: 'ì„±ë…„ì˜ ì‹œì‘',
                        desc: 'ë²•ì ìœ¼ë¡œ ì„±ì¸ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. íˆ¬í‘œê¶Œ, ìš´ì „ë©´í—ˆ ì·¨ë“ ê°€ëŠ¥'
                    });
                }

                if (manAge >= 18 && manAge < 30) {
                    alerts.push({
                        icon: 'âœˆï¸',
                        title: 'ì›Œí‚¹í™€ë¦¬ë°ì´',
                        desc: 'í•´ì™¸ì—ì„œ ì¼í•˜ë©° ì—¬í–‰í•  ìˆ˜ ìˆëŠ” ì ˆí˜¸ì˜ ê¸°íšŒì…ë‹ˆë‹¤'
                    });
                }

                if (manAge >= 38 && manAge <= 42) {
                    alerts.push({
                        icon: 'ğŸ¥',
                        title: 'ìƒì• ì „í™˜ê¸° ê±´ê°•ê²€ì§„',
                        desc: 'ë§Œ 40ì„¸ë¶€í„° ìƒì• ì „í™˜ê¸° ê±´ê°•ê²€ì§„ ëŒ€ìƒì…ë‹ˆë‹¤'
                    });
                }

                if (manAge >= 63 && manAge <= 67) {
                    alerts.push({
                        icon: 'ğŸ’°',
                        title: 'êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹',
                        desc: 'ë§Œ 65ì„¸ë¶€í„° ê¸°ì´ˆì—°ê¸ˆ ìˆ˜ê¸‰ ëŒ€ìƒì¸ì§€ í™•ì¸í•´ë³´ì„¸ìš”'
                    });
                }

                if (alerts.length > 0) {
                    const content = document.getElementById('lifecycleContent');
                    content.innerHTML = alerts.map(alert => 
                        '<div class="flex items-start gap-3 p-4 bg-white rounded-xl">' +
                        '<div class="text-3xl">' + alert.icon + '</div>' +
                        '<div>' +
                        '<div class="font-bold text-gray-800 mb-1">' + alert.title + '</div>' +
                        '<div class="text-sm text-gray-600">' + alert.desc + '</div>' +
                        '</div>' +
                        '</div>'
                    ).join('');
                    document.getElementById('lifecycleAlerts').classList.remove('hidden');
                } else {
                    document.getElementById('lifecycleAlerts').classList.add('hidden');
                }
            }
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}
    </body>
    </html>
  `)
})

// ==================== ê°ì„± D-Day ë§¤ë‹ˆì € ====================
app.get('/lifestyle/dday-calculator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê°ì„± D-Day ë§¤ë‹ˆì € - Faith Portal</title>
        <meta name="description" content="ë‹¨ìˆœíˆ ë‚ ì§œë§Œ ì„¸ëŠ” ê²Œ ì•„ë‹ˆë¼, ì„¤ë ˆëŠ” ê¸°ë‹¤ë¦¼ì„ ì‹œê°í™”í•´ì£¼ëŠ” D-Day ê´€ë¦¬ ë„êµ¬">
        <script>
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return;
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
        <style>
            .dday-card {
                transition: all 0.3s ease;
            }
            .dday-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            }
            .color-option {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.2s;
            }
            .color-option:hover {
                transform: scale(1.15);
            }
            .color-option.selected {
                border: 3px solid #1f2937;
                transform: scale(1.2);
            }
            .emoji-option {
                font-size: 28px;
                cursor: pointer;
                padding: 8px;
                border-radius: 8px;
                transition: all 0.2s;
            }
            .emoji-option:hover {
                background-color: rgba(0,0,0,0.05);
                transform: scale(1.1);
            }
            .emoji-option.selected {
                background-color: rgba(59, 130, 246, 0.2);
            }
            .progress-bar {
                transition: width 0.5s ease;
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50" id="html-root">
        ${getCommonAuthScript()}
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'D-Day ë§¤ë‹ˆì €'}
        ])}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-600 rounded-2xl mb-4">
                    <i class="fas fa-heart text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                    ê°ì„± D-Day ë§¤ë‹ˆì €
                </h1>
                <p class="text-gray-600 text-sm md:text-base max-w-2xl mx-auto">
                    ë‹¨ìˆœíˆ ë‚ ì§œë§Œ ì„¸ëŠ” ê²Œ ì•„ë‹ˆë¼, ì„¤ë ˆëŠ” ê¸°ë‹¤ë¦¼ì„ ì‹œê°í™”í•´ë“œë¦½ë‹ˆë‹¤
                </p>
            </div>

            <!-- ë©”ì¸ ê·¸ë¦¬ë“œ: ì¢Œì¸¡(ì…ë ¥) - ìš°ì¸¡(ë¦¬ìŠ¤íŠ¸) -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- ì¢Œì¸¡: D-Day ìƒì„±ê¸° -->
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 h-fit">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-purple-600"></i>
                        <span>ìƒˆ D-Day ë§Œë“¤ê¸°</span>
                    </h2>

                    <!-- ì œëª© ì…ë ¥ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì œëª© <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="ddayTitle" 
                            placeholder="ì˜ˆ: ìœ ëŸ½ ì—¬í–‰ âœˆï¸"
                            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none transition"
                        >
                    </div>

                    <!-- ë‚ ì§œ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ëª©í‘œ ë‚ ì§œ <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="ddayDate"
                            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none transition"
                        >
                    </div>

                    <!-- ê³„ì‚° ëª¨ë“œ ì„ íƒ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ê³„ì‚° ëª¨ë“œ
                        </label>
                        <div class="grid grid-cols-3 gap-2">
                            <button 
                                onclick="setMode('countdown')"
                                id="modeCountdown"
                                class="mode-btn px-4 py-3 bg-blue-50 text-blue-700 border-2 border-blue-200 rounded-xl font-semibold hover:bg-blue-100 transition"
                            >
                                <i class="fas fa-hourglass-half"></i>
                                <div class="text-xs mt-1">D-Day</div>
                            </button>
                            <button 
                                onclick="setMode('countup')"
                                id="modeCountup"
                                class="mode-btn px-4 py-3 bg-gray-100 text-gray-600 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-200 transition"
                            >
                                <i class="fas fa-calendar-plus"></i>
                                <div class="text-xs mt-1">ê¸°ë…ì¼</div>
                            </button>
                            <button 
                                onclick="setMode('datefinder')"
                                id="modeDatefinder"
                                class="mode-btn px-4 py-3 bg-gray-100 text-gray-600 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-200 transition"
                            >
                                <i class="fas fa-search"></i>
                                <div class="text-xs mt-1">ë‚ ì§œì°¾ê¸°</div>
                            </button>
                        </div>
                    </div>

                    <!-- ì»¤í”Œ ì˜µì…˜ (countupì¼ ë•Œë§Œ) -->
                    <div id="anniversaryOption" class="hidden mb-6">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="isAnniversary"
                                class="w-5 h-5 text-pink-600 rounded focus:ring-pink-500"
                            >
                            <span class="text-gray-700">
                                <i class="fas fa-heart text-pink-500"></i>
                                ê¸°ì¤€ì¼ì„ 1ì¼ë¡œ í¬í•¨ (ì»¤í”Œ ê¸°ë…ì¼ìš©)
                            </span>
                        </label>
                    </div>

                    <!-- ì¹´ë“œ ê¾¸ë¯¸ê¸° -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ë°°ê²½ìƒ‰ ì„ íƒ
                        </label>
                        <div class="flex gap-3">
                            <div class="color-option selected" data-color="#667eea" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="selectColor(this, '#667eea')"></div>
                            <div class="color-option" data-color="#f093fb" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="selectColor(this, '#f093fb')"></div>
                            <div class="color-option" data-color="#4facfe" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="selectColor(this, '#4facfe')"></div>
                            <div class="color-option" data-color="#43e97b" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="selectColor(this, '#43e97b')"></div>
                            <div class="color-option" data-color="#fa709a" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="selectColor(this, '#fa709a')"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ëŒ€í‘œ ì´ëª¨ì§€
                        </label>
                        <div class="grid grid-cols-6 gap-2">
                            <div class="emoji-option selected text-center" data-emoji="ğŸ“…" onclick="selectEmoji(this, 'ğŸ“…')">ğŸ“…</div>
                            <div class="emoji-option text-center" data-emoji="â¤ï¸" onclick="selectEmoji(this, 'â¤ï¸')">â¤ï¸</div>
                            <div class="emoji-option text-center" data-emoji="âœˆï¸" onclick="selectEmoji(this, 'âœˆï¸')">âœˆï¸</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ“š" onclick="selectEmoji(this, 'ğŸ“š')">ğŸ“š</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ‚" onclick="selectEmoji(this, 'ğŸ‚')">ğŸ‚</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ“" onclick="selectEmoji(this, 'ğŸ“')">ğŸ“</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ’ª" onclick="selectEmoji(this, 'ğŸ’ª')">ğŸ’ª</div>
                            <div class="emoji-option text-center" data-emoji="ğŸƒ" onclick="selectEmoji(this, 'ğŸƒ')">ğŸƒ</div>
                            <div class="emoji-option text-center" data-emoji="ğŸµ" onclick="selectEmoji(this, 'ğŸµ')">ğŸµ</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ®" onclick="selectEmoji(this, 'ğŸ®')">ğŸ®</div>
                            <div class="emoji-option text-center" data-emoji="ğŸ¬" onclick="selectEmoji(this, 'ğŸ¬')">ğŸ¬</div>
                            <div class="emoji-option text-center" data-emoji="âš½" onclick="selectEmoji(this, 'âš½')">âš½</div>
                        </div>
                    </div>

                    <!-- í”„ë¦¬ì…‹ ë²„íŠ¼ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ë¹ ë¥¸ ì„ íƒ
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setPreset('christmas')" class="px-4 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg hover:bg-red-100 transition text-sm">
                                ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤
                            </button>
                            <button onclick="setPreset('newyear')" class="px-4 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 transition text-sm">
                                ğŸ† ìƒˆí•´
                            </button>
                        </div>
                    </div>

                    <!-- ì¶”ê°€ ë²„íŠ¼ -->
                    <button 
                        onclick="addDday()"
                        class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold text-lg rounded-xl hover:from-purple-600 hover:to-pink-600 transition shadow-lg"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ê¸°
                    </button>
                </div>

                <!-- ìš°ì¸¡: D-Day ëŒ€ì‹œë³´ë“œ -->
                <div class="space-y-6">
                    <!-- Hero Section: ê°€ì¥ ê°€ê¹Œìš´ D-Day -->
                    <div id="heroDday" class="hidden bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl shadow-2xl p-8 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">ê°€ì¥ ê°€ê¹Œìš´ ëª©í‘œ</h3>
                            <button onclick="captureHero()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition text-sm">
                                <i class="fas fa-camera mr-1"></i> ì €ì¥
                            </button>
                        </div>
                        <div id="heroContent">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </div>
                    </div>

                    <!-- D-Day ë¦¬ìŠ¤íŠ¸ -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-list text-purple-600"></i>
                                <span>ë‚˜ì˜ D-Day</span>
                                <span id="ddayCount" class="text-lg text-gray-500">(0)</span>
                            </h2>
                            <button onclick="exportAllAsImage()" class="px-4 py-2 bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg transition text-sm font-medium">
                                <i class="fas fa-download mr-1"></i> ì „ì²´ ì €ì¥
                            </button>
                        </div>

                        <!-- ë¹ˆ ìƒíƒœ -->
                        <div id="emptyState" class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ“…</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">ì•„ì§ ë“±ë¡ëœ D-Dayê°€ ì—†ì–´ìš”</h3>
                            <p class="text-gray-600">ì™¼ìª½ì—ì„œ ìƒˆë¡œìš´ D-Dayë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                        </div>

                        <!-- ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
                        <div id="ddayList" class="grid grid-cols-1 gap-4">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            let ddayData = [];
            let currentMode = 'countdown';
            let selectedColor = '#667eea';
            let selectedEmoji = 'ğŸ“…';
            let currentUser = null;

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            window.addEventListener('DOMContentLoaded', async function() {
                // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
                await checkUserSession();
                
                // D-Day ë°ì´í„° ë¡œë“œ
                await loadDdayData();
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
                const today = new Date();
                document.getElementById('ddayDate').valueAsDate = new Date(today.getTime() + 24*60*60*1000);
            });

            // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
            async function checkUserSession() {
                try {
                    const response = await fetch('/api/user/session');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.user) {
                            currentUser = data.user;
                        }
                    }
                } catch (error) {
                    console.log('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }

            // D-Day ë°ì´í„° ë¡œë“œ
            async function loadDdayData() {
                if (currentUser) {
                    // ë¡œê·¸ì¸í•œ ê²½ìš°: DBì—ì„œ ë¡œë“œ
                    try {
                        const response = await fetch('/api/dday/list');
                        if (response.ok) {
                            const data = await response.json();
                            ddayData = data.ddays || [];
                            renderDdayList();
                        }
                    } catch (error) {
                        console.error('D-Day ë¡œë“œ ì‹¤íŒ¨:', error);
                    }
                } else {
                    // ë¹„ë¡œê·¸ì¸: localStorageì—ì„œ ë¡œë“œ
                    const saved = localStorage.getItem('ddayData');
                    if (saved) {
                        ddayData = JSON.parse(saved);
                        renderDdayList();
                    }
                }
            }

            // D-Day ì €ì¥
            async function saveDdayData() {
                if (currentUser) {
                    // ì„œë²„ì— ì €ì¥í•˜ì§€ ì•Šê³  ì¶”ê°€/ì‚­ì œ APIë§Œ ì‚¬ìš©
                } else {
                    // localStorageì— ì €ì¥
                    localStorage.setItem('ddayData', JSON.stringify(ddayData));
                }
            }

            // ëª¨ë“œ ì„¤ì •
            function setMode(mode) {
                currentMode = mode;
                
                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-200');
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
                });
                
                const activeBtn = document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1));
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                activeBtn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
                
                // ê¸°ë…ì¼ ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€
                if (mode === 'countup') {
                    document.getElementById('anniversaryOption').classList.remove('hidden');
                } else {
                    document.getElementById('anniversaryOption').classList.add('hidden');
                }
            }

            // ìƒ‰ìƒ ì„ íƒ
            function selectColor(element, color) {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                element.classList.add('selected');
                selectedColor = color;
            }

            // ì´ëª¨ì§€ ì„ íƒ
            function selectEmoji(element, emoji) {
                document.querySelectorAll('.emoji-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                element.classList.add('selected');
                selectedEmoji = emoji;
            }

            // í”„ë¦¬ì…‹ ì„¤ì •
            function setPreset(type) {
                const now = new Date();
                const year = now.getFullYear();
                
                if (type === 'christmas') {
                    const christmas = new Date(year, 11, 25);
                    if (christmas < now) christmas.setFullYear(year + 1);
                    document.getElementById('ddayTitle').value = 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ğŸ„';
                    document.getElementById('ddayDate').valueAsDate = christmas;
                    selectedEmoji = 'ğŸ„';
                    document.querySelector('[data-emoji="ğŸ„"]')?.classList.add('selected');
                } else if (type === 'newyear') {
                    const newyear = new Date(year + 1, 0, 1);
                    document.getElementById('ddayTitle').value = 'ìƒˆí•´ ì²«ë‚  ğŸ†';
                    document.getElementById('ddayDate').valueAsDate = newyear;
                    selectedEmoji = 'ğŸ†';
                }
                
                setMode('countdown');
            }

            // D-Day ì¶”ê°€
            async function addDday() {
                const title = document.getElementById('ddayTitle').value.trim();
                const date = document.getElementById('ddayDate').value;
                const isAnniversary = document.getElementById('isAnniversary').checked;
                
                if (!title) {
                    alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!date) {
                    alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const newDday = {
                    id: Date.now(),
                    title: title,
                    targetDate: date,
                    mode: currentMode,
                    isAnniversary: isAnniversary,
                    color: selectedColor,
                    emoji: selectedEmoji,
                    createdAt: new Date().toISOString()
                };
                
                if (currentUser) {
                    // ì„œë²„ì— ì €ì¥
                    try {
                        const response = await fetch('/api/dday/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newDday)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            newDday.id = data.id;
                            ddayData.push(newDday);
                            renderDdayList();
                            resetForm();
                        }
                    } catch (error) {
                        console.error('D-Day ì¶”ê°€ ì‹¤íŒ¨:', error);
                        alert('D-Day ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    // localStorageì— ì €ì¥
                    ddayData.push(newDday);
                    saveDdayData();
                    renderDdayList();
                    resetForm();
                }
            }

            // D-Day ì‚­ì œ
            async function deleteDday(id) {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                if (currentUser) {
                    try {
                        const response = await fetch('/api/dday/' + id, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            ddayData = ddayData.filter(d => d.id !== id);
                            renderDdayList();
                        }
                    } catch (error) {
                        console.error('D-Day ì‚­ì œ ì‹¤íŒ¨:', error);
                    }
                } else {
                    ddayData = ddayData.filter(d => d.id !== id);
                    saveDdayData();
                    renderDdayList();
                }
            }

            // ì–‘ì‹ ì´ˆê¸°í™”
            function resetForm() {
                document.getElementById('ddayTitle').value = '';
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('ddayDate').valueAsDate = tomorrow;
                document.getElementById('isAnniversary').checked = false;
            }

            // D-Day ê³„ì‚°
            function calculateDday(targetDate, mode, isAnniversary) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const target = new Date(targetDate);
                target.setHours(0, 0, 0, 0);
                
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (mode === 'countdown') {
                    if (diffDays === 0) return 'D-Day';
                    if (diffDays > 0) return 'D-' + diffDays;
                    return 'D+' + Math.abs(diffDays);
                } else if (mode === 'countup') {
                    const days = Math.abs(diffDays) + (isAnniversary ? 1 : 0);
                    return days + 'ì¼ì§¸';
                } else {
                    return target.toLocaleDateString('ko-KR');
                }
            }

            // D-Day ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            function renderDdayList() {
                const listContainer = document.getElementById('ddayList');
                const emptyState = document.getElementById('emptyState');
                const countSpan = document.getElementById('ddayCount');
                
                countSpan.textContent = '(' + ddayData.length + ')';
                
                if (ddayData.length === 0) {
                    listContainer.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    document.getElementById('heroDday').classList.add('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                // Hero D-Day ì°¾ê¸° (ê°€ì¥ ê°€ê¹Œìš´ countdown)
                const upcomingDdays = ddayData
                    .filter(d => d.mode === 'countdown')
                    .map(d => {
                        const target = new Date(d.targetDate);
                        const today = new Date();
                        const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                        return { ...d, diff };
                    })
                    .filter(d => d.diff >= 0)
                    .sort((a, b) => a.diff - b.diff);
                
                if (upcomingDdays.length > 0) {
                    renderHeroDday(upcomingDdays[0]);
                } else {
                    document.getElementById('heroDday').classList.add('hidden');
                }
                
                // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                listContainer.innerHTML = ddayData.map(dday => {
                    const ddayText = calculateDday(dday.targetDate, dday.mode, dday.isAnniversary);
                    const colorStyle = dday.color.startsWith('#') 
                        ? 'background: linear-gradient(135deg, ' + dday.color + ' 0%, ' + adjustColor(dday.color) + ' 100%);'
                        : 'background: ' + dday.color + ';';
                    
                    return '<div class="dday-card rounded-xl shadow-lg p-5" style="' + colorStyle + '">' +
                        '<div class="flex items-start justify-between mb-3">' +
                        '<div class="flex items-center gap-3">' +
                        '<span class="text-4xl">' + dday.emoji + '</span>' +
                        '<div class="text-white">' +
                        '<h3 class="font-bold text-lg">' + dday.title + '</h3>' +
                        '<p class="text-sm opacity-90">' + new Date(dday.targetDate).toLocaleDateString('ko-KR') + '</p>' +
                        '</div>' +
                        '</div>' +
                        '<button onclick="deleteDday(' + dday.id + ')" class="text-white opacity-70 hover:opacity-100 transition">' +
                        '<i class="fas fa-times"></i>' +
                        '</button>' +
                        '</div>' +
                        '<div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">' +
                        '<div class="text-4xl font-bold text-white">' + ddayText + '</div>' +
                        '</div>' +
                        '</div>';
                }).join('');
            }

            // Hero D-Day ë Œë”ë§
            function renderHeroDday(dday) {
                const heroSection = document.getElementById('heroDday');
                const heroContent = document.getElementById('heroContent');
                
                const ddayText = calculateDday(dday.targetDate, dday.mode, dday.isAnniversary);
                const diff = dday.diff;
                const progress = Math.max(0, Math.min(100, 100 - (diff / 30 * 100)));
                
                heroContent.innerHTML = 
                    '<div class="flex items-center gap-4 mb-4">' +
                    '<span class="text-6xl">' + dday.emoji + '</span>' +
                    '<div>' +
                    '<h2 class="text-3xl font-bold mb-1">' + dday.title + '</h2>' +
                    '<p class="text-lg opacity-90">ê¹Œì§€ ë”± ' + diff + 'ì¼ ë‚¨ì•˜ì–´ìš”!</p>' +
                    '</div>' +
                    '</div>' +
                    '<div class="bg-white bg-opacity-20 rounded-xl p-6 mb-4">' +
                    '<div class="text-6xl font-bold text-center">' + ddayText + '</div>' +
                    '</div>' +
                    '<div class="bg-white bg-opacity-10 rounded-full h-3 overflow-hidden">' +
                    '<div class="progress-bar bg-white h-full" style="width: ' + progress + '%"></div>' +
                    '</div>';
                
                heroSection.classList.remove('hidden');
            }

            // ìƒ‰ìƒ ì¡°ì • (ê·¸ë¼ë””ì–¸íŠ¸ìš©)
            function adjustColor(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                
                const adjusted = '#' + 
                    Math.min(255, r + 30).toString(16).padStart(2, '0') +
                    Math.min(255, g + 30).toString(16).padStart(2, '0') +
                    Math.min(255, b + 30).toString(16).padStart(2, '0');
                
                return adjusted;
            }

            // Hero ìº¡ì²˜
            async function captureHero() {
                const element = document.getElementById('heroDday');
                try {
                    const canvas = await html2canvas(element, { backgroundColor: null });
                    const link = document.createElement('a');
                    link.download = 'my-dday.png';
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ìº¡ì²˜
            async function exportAllAsImage() {
                if (ddayData.length === 0) {
                    alert('ì €ì¥í•  D-Dayê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const element = document.getElementById('ddayList');
                try {
                    const canvas = await html2canvas(element, { backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = 'my-dday-list.png';
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        </script>

        ${getCommonFooter()}
    </body>
    </html>
  `)
})

// ==================== Pro JSON Studio (Developer Tool) ====================
app.get('/lifestyle/json-formatter', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pro JSON Studio - Faith Portal</title>
        <meta name="description" content="ê°œë°œìë¥¼ ìœ„í•œ ì „ë¬¸ JSON ì—ë””í„°. ì‹¤ì‹œê°„ ê²€ì¦, í¬ë§·íŒ…, íŠ¸ë¦¬ë·°, ë³€í™˜ ê¸°ëŠ¥ ì œê³µ. 100% í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ë¡œ ë³´ì•ˆ ê±±ì • NO.">
        <script>
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return;
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        
        <!-- Monaco Editor (VS Code ì—”ì§„) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
        
        <!-- JSON5 for auto-fix -->
        <script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js"></script>
        
        <!-- js-yaml for YAML conversion -->
        <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
        
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            html, body { height: 100%; overflow: hidden; }
            
            /* Dark theme colors */
            :root {
                --bg-primary: #1e1e1e;
                --bg-secondary: #252526;
                --bg-tertiary: #2d2d30;
                --border-color: #3e3e42;
                --text-primary: #d4d4d4;
                --text-secondary: #858585;
                --accent-blue: #007acc;
                --accent-green: #4ec9b0;
                --error-red: #f48771;
                --success-green: #89d185;
            }
            
            body {
                background: var(--bg-primary);
                color: var(--text-primary);
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            }
            
            /* Toolbar styles */
            .toolbar {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 8px 16px;
                border-radius: 4px;
                border: none;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }
            
            .btn-primary {
                background: var(--accent-blue);
                color: white;
            }
            
            .btn-primary:hover {
                background: #005a9e;
            }
            
            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }
            
            .btn-secondary:hover {
                background: #3e3e42;
            }
            
            .btn-danger {
                background: #d32f2f;
                color: white;
            }
            
            .btn-danger:hover {
                background: #b71c1c;
            }
            
            .btn-success {
                background: #388e3c;
                color: white;
            }
            
            .btn-success:hover {
                background: #2e7d32;
            }
            
            /* Status bar */
            .status-bar {
                background: var(--bg-secondary);
                border-top: 1px solid var(--border-color);
                padding: 6px 16px;
                font-size: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .status-error {
                color: var(--error-red);
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .status-success {
                color: var(--success-green);
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            /* Split panel */
            .split-panel {
                display: flex;
                height: calc(100vh - 120px);
            }
            
            .panel {
                flex: 1;
                overflow: hidden;
                position: relative;
            }
            
            .panel-divider {
                width: 4px;
                background: var(--border-color);
                cursor: col-resize;
                position: relative;
            }
            
            .panel-divider:hover {
                background: var(--accent-blue);
            }
            
            /* Monaco editor container */
            #editor-container {
                height: 100%;
                width: 100%;
            }
            
            /* Output panel */
            .output-panel {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .output-tabs {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                padding: 0 16px;
            }
            
            .output-tab {
                padding: 10px 16px;
                cursor: pointer;
                border-bottom: 2px solid transparent;
                font-size: 13px;
                transition: all 0.2s;
            }
            
            .output-tab:hover {
                background: var(--bg-tertiary);
            }
            
            .output-tab.active {
                border-bottom-color: var(--accent-blue);
                color: var(--accent-blue);
            }
            
            .output-content {
                flex: 1;
                overflow: auto;
                padding: 16px;
            }
            
            /* Tree view styles */
            .tree-view {
                font-family: 'Consolas', monospace;
                font-size: 13px;
                line-height: 1.6;
            }
            
            .tree-node {
                margin-left: 20px;
            }
            
            .tree-key {
                color: var(--accent-green);
                cursor: pointer;
            }
            
            .tree-key:hover {
                text-decoration: underline;
            }
            
            .tree-value-string { color: #ce9178; }
            .tree-value-number { color: #b5cea8; }
            .tree-value-boolean { color: #569cd6; }
            .tree-value-null { color: #858585; }
            
            .tree-toggle {
                cursor: pointer;
                color: var(--text-secondary);
                margin-right: 4px;
                user-select: none;
            }
            
            /* Code view */
            .code-view {
                font-family: 'Consolas', monospace;
                font-size: 13px;
                line-height: 1.6;
                white-space: pre;
                color: var(--text-primary);
            }
            
            /* Privacy badge */
            .privacy-badge {
                background: rgba(76, 175, 80, 0.1);
                border: 1px solid rgba(76, 175, 80, 0.3);
                color: var(--success-green);
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 11px;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
            
            /* Dropdown */
            select {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 13px;
                cursor: pointer;
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .split-panel {
                    flex-direction: column;
                    height: calc(100vh - 140px);
                }
                
                .panel-divider {
                    width: 100%;
                    height: 4px;
                    cursor: row-resize;
                }
                
                .toolbar {
                    padding: 8px;
                }
                
                .btn {
                    padding: 6px 12px;
                    font-size: 12px;
                }
            }
        </style>
    </head>
    <body>
        ${getCommonAuthScript()}
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'JSON Studio'}
        ])}

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="formatJson()" title="Beautify JSON (Ctrl+Shift+F)">
                <i class="fas fa-magic"></i> <span class="hidden sm:inline">Format</span>
            </button>
            <button class="btn btn-secondary" onclick="minifyJson()" title="Compress JSON">
                <i class="fas fa-compress"></i> <span class="hidden sm:inline">Minify</span>
            </button>
            <button class="btn btn-success" onclick="autoFixJson()" title="Try to fix broken JSON">
                <i class="fas fa-wrench"></i> <span class="hidden sm:inline">Auto Fix</span>
            </button>
            <button class="btn btn-secondary" onclick="clearEditor()" title="Clear all">
                <i class="fas fa-eraser"></i> <span class="hidden sm:inline">Clear</span>
            </button>
            <button class="btn btn-secondary" onclick="copyToClipboard()" title="Copy to clipboard">
                <i class="fas fa-copy"></i> <span class="hidden sm:inline">Copy</span>
            </button>
            
            <div class="hidden sm:block" style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                <label for="indent-select" style="font-size: 12px;">Indent:</label>
                <select id="indent-select" onchange="updateIndent()">
                    <option value="2" selected>2 spaces</option>
                    <option value="4">4 spaces</option>
                    <option value="tab">Tab</option>
                </select>
            </div>
            
            <div class="privacy-badge">
                <i class="fas fa-shield-alt"></i>
                <span class="hidden sm:inline">100% Client-side Processing</span>
                <span class="sm:hidden">Secure</span>
            </div>
        </div>

        <!-- Main Split Panel -->
        <div class="split-panel">
            <!-- Left: Monaco Editor -->
            <div class="panel">
                <div id="editor-container"></div>
            </div>
            
            <div class="panel-divider"></div>
            
            <!-- Right: Output Viewer -->
            <div class="panel">
                <div class="output-panel">
                    <div class="output-tabs">
                        <div class="output-tab active" onclick="switchTab('code')" data-tab="code">
                            <i class="fas fa-code"></i> Code
                        </div>
                        <div class="output-tab" onclick="switchTab('tree')" data-tab="tree">
                            <i class="fas fa-sitemap"></i> Tree View
                        </div>
                        <div class="output-tab" onclick="switchTab('convert')" data-tab="convert">
                            <i class="fas fa-exchange-alt"></i> Convert
                        </div>
                    </div>
                    <div class="output-content">
                        <div id="code-view" class="code-view"></div>
                        <div id="tree-view" class="tree-view" style="display: none;"></div>
                        <div id="convert-view" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn btn-secondary" onclick="convertTo('yaml')" style="margin-right: 8px;">
                                    <i class="fas fa-file-code"></i> To YAML
                                </button>
                                <button class="btn btn-secondary" onclick="convertTo('xml')" style="margin-right: 8px;">
                                    <i class="fas fa-file-code"></i> To XML
                                </button>
                                <button class="btn btn-secondary" onclick="convertTo('csv')">
                                    <i class="fas fa-file-csv"></i> To CSV
                                </button>
                            </div>
                            <pre id="convert-output" class="code-view"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div id="status-message" style="display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-info-circle"></i>
                <span>Ready</span>
            </div>
            <div id="stats-message" style="font-size: 11px; color: var(--text-secondary);"></div>
        </div>

        <script>
            let editor;
            let currentJson = null;
            let currentIndent = 2;
            let currentTab = 'code';

            // Initialize Monaco Editor
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            
            require(['vs/editor/editor.main'], function() {
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: \`{
  "message": "Welcome to Pro JSON Studio! ğŸ‘‹",
  "features": [
    "Real-time validation",
    "Auto-fix broken JSON",
    "Tree view explorer",
    "Format converter (YAML, XML, CSV)",
    "100% client-side processing"
  ],
  "shortcuts": {
    "format": "Ctrl+Shift+F",
    "find": "Ctrl+F",
    "replace": "Ctrl+H"
  },
  "privacy": "No data sent to server âœ…"
}\`,
                    language: 'json',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    folding: true,
                    bracketPairColorization: {
                        enabled: true
                    },
                    formatOnPaste: true,
                    formatOnType: true
                });

                // Real-time validation
                editor.onDidChangeModelContent(() => {
                    validateAndUpdate();
                });

                // Initial validation
                setTimeout(() => validateAndUpdate(), 500);
            });

            // Validate and update output
            function validateAndUpdate() {
                const value = editor.getValue().trim();
                
                if (!value) {
                    setStatus('info', 'Enter JSON data to begin');
                    currentJson = null;
                    updateOutput();
                    return;
                }

                // Try to detect URL query string
                if (value.startsWith('?') || (value.includes('=') && value.includes('&'))) {
                    try {
                        const params = new URLSearchParams(value.startsWith('?') ? value : '?' + value);
                        const obj = {};
                        params.forEach((val, key) => obj[key] = val);
                        currentJson = obj;
                        const formatted = JSON.stringify(obj, null, currentIndent);
                        editor.setValue(formatted);
                        setStatus('success', 'Auto-converted URL query string to JSON');
                        updateOutput();
                        return;
                    } catch (e) {}
                }

                try {
                    currentJson = JSON.parse(value);
                    setStatus('success', 'Valid JSON âœ“');
                    updateStats(value);
                    updateOutput();
                } catch (e) {
                    currentJson = null;
                    const lineMatch = e.message.match(/position (\\d+)/);
                    if (lineMatch) {
                        const pos = parseInt(lineMatch[1]);
                        const model = editor.getModel();
                        const position = model.getPositionAt(pos);
                        setStatus('error', \`Syntax Error at line \${position.lineNumber}: \${e.message}\`);
                    } else {
                        setStatus('error', \`Syntax Error: \${e.message}\`);
                    }
                    updateStats(value);
                }
            }

            // Format JSON
            function formatJson() {
                if (!currentJson) {
                    alert('Please fix JSON errors first');
                    return;
                }
                const indentStr = currentIndent === 'tab' ? '\\t' : ' '.repeat(currentIndent);
                const formatted = JSON.stringify(currentJson, null, indentStr);
                editor.setValue(formatted);
                setStatus('success', 'JSON formatted successfully');
            }

            // Minify JSON
            function minifyJson() {
                if (!currentJson) {
                    alert('Please fix JSON errors first');
                    return;
                }
                const minified = JSON.stringify(currentJson);
                editor.setValue(minified);
                setStatus('success', 'JSON minified successfully');
            }

            // Auto-fix broken JSON using JSON5
            function autoFixJson() {
                const value = editor.getValue().trim();
                if (!value) return;

                try {
                    // First try standard JSON
                    JSON.parse(value);
                    setStatus('info', 'JSON is already valid');
                    return;
                } catch (e) {
                    // Try JSON5 (tolerant parsing)
                    try {
                        const fixed = JSON5.parse(value);
                        const formatted = JSON.stringify(fixed, null, currentIndent);
                        editor.setValue(formatted);
                        setStatus('success', 'Auto-fixed and formatted! (converted from JSON5)');
                        currentJson = fixed;
                        updateOutput();
                    } catch (e2) {
                        setStatus('error', \`Cannot auto-fix: \${e2.message}\`);
                    }
                }
            }

            // Clear editor
            function clearEditor() {
                if (confirm('Clear all content?')) {
                    editor.setValue('');
                    currentJson = null;
                    updateOutput();
                    setStatus('info', 'Editor cleared');
                }
            }

            // Copy to clipboard
            async function copyToClipboard() {
                const value = editor.getValue();
                if (!value) {
                    alert('Nothing to copy');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(value);
                    setStatus('success', 'Copied to clipboard!');
                } catch (e) {
                    alert('Failed to copy');
                }
            }

            // Update indent setting
            function updateIndent() {
                const select = document.getElementById('indent-select');
                currentIndent = select.value === 'tab' ? 'tab' : parseInt(select.value);
                setStatus('info', \`Indent changed to: \${select.options[select.selectedIndex].text}\`);
            }

            // Switch output tab
            function switchTab(tabName) {
                currentTab = tabName;
                
                // Update tab UI
                document.querySelectorAll('.output-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });

                // Update view
                document.getElementById('code-view').style.display = tabName === 'code' ? 'block' : 'none';
                document.getElementById('tree-view').style.display = tabName === 'tree' ? 'block' : 'none';
                document.getElementById('convert-view').style.display = tabName === 'convert' ? 'block' : 'none';
                
                updateOutput();
            }

            // Update output based on current tab
            function updateOutput() {
                if (currentTab === 'code') {
                    updateCodeView();
                } else if (currentTab === 'tree') {
                    updateTreeView();
                }
            }

            // Update code view
            function updateCodeView() {
                const codeView = document.getElementById('code-view');
                if (!currentJson) {
                    codeView.textContent = '// Waiting for valid JSON...';
                    return;
                }
                const indentStr = currentIndent === 'tab' ? '\\t' : ' '.repeat(currentIndent);
                codeView.textContent = JSON.stringify(currentJson, null, indentStr);
            }

            // Update tree view
            function updateTreeView() {
                const treeView = document.getElementById('tree-view');
                if (!currentJson) {
                    treeView.innerHTML = '<div style="color: var(--text-secondary);">// Waiting for valid JSON...</div>';
                    return;
                }
                treeView.innerHTML = renderTreeNode('root', currentJson);
            }

            // Render tree node
            function renderTreeNode(key, value, level = 0) {
                const indent = '&nbsp;'.repeat(level * 4);
                let html = '';

                if (Array.isArray(value)) {
                    html += \`<div>\${indent}<span class="tree-toggle" onclick="toggleNode(this)">â–¼</span><span class="tree-key">\${key}</span>: [<span style="color: var(--text-secondary);">\${value.length} items</span>]</div>\`;
                    html += '<div class="tree-node">';
                    value.forEach((item, i) => {
                        html += renderTreeNode(i, item, level + 1);
                    });
                    html += '</div>';
                } else if (typeof value === 'object' && value !== null) {
                    const keys = Object.keys(value);
                    html += \`<div>\${indent}<span class="tree-toggle" onclick="toggleNode(this)">â–¼</span><span class="tree-key">\${key}</span>: {<span style="color: var(--text-secondary);">\${keys.length} keys</span>}</div>\`;
                    html += '<div class="tree-node">';
                    keys.forEach(k => {
                        html += renderTreeNode(k, value[k], level + 1);
                    });
                    html += '</div>';
                } else {
                    const className = value === null ? 'tree-value-null' :
                                    typeof value === 'string' ? 'tree-value-string' :
                                    typeof value === 'number' ? 'tree-value-number' :
                                    typeof value === 'boolean' ? 'tree-value-boolean' : '';
                    const displayValue = typeof value === 'string' ? \`"\${value}"\` : String(value);
                    html += \`<div>\${indent}<span class="tree-key">\${key}</span>: <span class="\${className}">\${displayValue}</span></div>\`;
                }

                return html;
            }

            // Toggle tree node
            function toggleNode(toggle) {
                const node = toggle.parentElement.nextElementSibling;
                if (node && node.classList.contains('tree-node')) {
                    const isCollapsed = node.style.display === 'none';
                    node.style.display = isCollapsed ? 'block' : 'none';
                    toggle.textContent = isCollapsed ? 'â–¼' : 'â–¶';
                }
            }

            // Convert to other formats
            function convertTo(format) {
                if (!currentJson) {
                    alert('Please fix JSON errors first');
                    return;
                }

                const output = document.getElementById('convert-output');
                
                try {
                    if (format === 'yaml') {
                        output.textContent = jsyaml.dump(currentJson);
                        setStatus('success', 'Converted to YAML');
                    } else if (format === 'xml') {
                        output.textContent = jsonToXml(currentJson);
                        setStatus('success', 'Converted to XML');
                    } else if (format === 'csv') {
                        output.textContent = jsonToCsv(currentJson);
                        setStatus('success', 'Converted to CSV');
                    }
                } catch (e) {
                    output.textContent = 'Error: ' + e.message;
                    setStatus('error', 'Conversion failed: ' + e.message);
                }
            }

            // JSON to XML converter
            function jsonToXml(obj, rootName = 'root') {
                let xml = \`<?xml version="1.0" encoding="UTF-8"?>\\n<\${rootName}>\\n\`;
                
                function convert(obj, indent = '  ') {
                    let result = '';
                    for (const [key, value] of Object.entries(obj)) {
                        if (Array.isArray(value)) {
                            value.forEach(item => {
                                if (typeof item === 'object') {
                                    result += \`\${indent}<\${key}>\\n\`;
                                    result += convert(item, indent + '  ');
                                    result += \`\${indent}</\${key}>\\n\`;
                                } else {
                                    result += \`\${indent}<\${key}>\${item}</\${key}>\\n\`;
                                }
                            });
                        } else if (typeof value === 'object' && value !== null) {
                            result += \`\${indent}<\${key}>\\n\`;
                            result += convert(value, indent + '  ');
                            result += \`\${indent}</\${key}>\\n\`;
                        } else {
                            result += \`\${indent}<\${key}>\${value}</\${key}>\\n\`;
                        }
                    }
                    return result;
                }
                
                xml += convert(obj);
                xml += \`</\${rootName}>\`;
                return xml;
            }

            // JSON to CSV converter
            function jsonToCsv(obj) {
                if (Array.isArray(obj)) {
                    if (obj.length === 0) return '';
                    
                    const keys = Object.keys(obj[0]);
                    let csv = keys.join(',') + '\\n';
                    
                    obj.forEach(row => {
                        const values = keys.map(key => {
                            const val = row[key];
                            if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                                return \`"\${val.replace(/"/g, '""')}"\`;
                            }
                            return val;
                        });
                        csv += values.join(',') + '\\n';
                    });
                    
                    return csv;
                } else {
                    return 'CSV conversion requires an array of objects';
                }
            }

            // Set status message
            function setStatus(type, message) {
                const statusEl = document.getElementById('status-message');
                const icon = type === 'success' ? 'fa-check-circle' :
                           type === 'error' ? 'fa-exclamation-circle' :
                           'fa-info-circle';
                const color = type === 'success' ? 'var(--success-green)' :
                            type === 'error' ? 'var(--error-red)' :
                            'var(--text-primary)';
                
                statusEl.innerHTML = \`<i class="fas \${icon}" style="color: \${color}"></i><span>\${message}</span>\`;
            }

            // Update stats
            function updateStats(jsonString) {
                const lines = jsonString.split('\\n').length;
                const chars = jsonString.length;
                const size = new Blob([jsonString]).size;
                document.getElementById('stats-message').textContent = 
                    \`Lines: \${lines} | Characters: \${chars} | Size: \${size} bytes\`;
            }
        </script>

        ${getCommonFooter()}
    </body>
    </html>
  `)
})

// ==================== Secret Base64 Converter (Developer Tool) ====================
app.get('/lifestyle/base64-converter', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko" id="html-root">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Secret Base64 Converter - Faith Portal</title>
        <meta name="description" content="100% í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ Base64 ë³€í™˜ê¸°. í•œê¸€ ì™„ë²½ ì§€ì›, JWT ìë™ ê°ì§€, ì´ë¯¸ì§€ ë³€í™˜. ì„œë²„ ì „ì†¡ 0%.">
        <script>
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && typeof args[0] === 'string' && 
                        args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return;
                    }
                    originalWarn.apply(console, args);
                };
            })();
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        
        <!-- js-base64 for UTF-8 support -->
        <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.min.js"></script>
        
        <style>
            * { box-sizing: border-box; }
            
            /* Dark theme */
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #252525;
                --bg-tertiary: #2d2d2d;
                --border-color: #404040;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --accent-blue: #3b82f6;
                --accent-green: #10b981;
                --error-red: #ef4444;
                --success-green: #22c55e;
            }
            
            body {
                background: var(--bg-primary);
                color: var(--text-primary);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            
            /* Tabs */
            .mode-tabs {
                display: flex;
                background: var(--bg-secondary);
                border-bottom: 2px solid var(--border-color);
                padding: 0 20px;
            }
            
            .mode-tab {
                padding: 16px 24px;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                font-size: 15px;
                font-weight: 500;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .mode-tab:hover {
                background: var(--bg-tertiary);
            }
            
            .mode-tab.active {
                border-bottom-color: var(--accent-blue);
                color: var(--accent-blue);
            }
            
            /* Split panel */
            .split-panel {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 0;
                height: calc(100vh - 200px);
                padding: 20px;
            }
            
            .panel {
                display: flex;
                flex-direction: column;
                min-width: 0;
            }
            
            .panel-divider {
                width: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 12px;
            }
            
            /* Textarea */
            textarea {
                flex: 1;
                width: 100%;
                padding: 16px;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                color: var(--text-primary);
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 14px;
                line-height: 1.6;
                resize: none;
                outline: none;
            }
            
            textarea:focus {
                border-color: var(--accent-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            textarea::placeholder {
                color: var(--text-secondary);
            }
            
            /* Buttons */
            .btn {
                padding: 10px 20px;
                border-radius: 6px;
                border: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            
            .btn-primary {
                background: var(--accent-blue);
                color: white;
            }
            
            .btn-primary:hover {
                background: #2563eb;
                transform: translateY(-1px);
            }
            
            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }
            
            .btn-secondary:hover {
                background: var(--bg-secondary);
            }
            
            .btn-success {
                background: var(--success-green);
                color: white;
            }
            
            .btn-success:hover {
                background: #16a34a;
            }
            
            /* Drop zone */
            .drop-zone {
                flex: 1;
                border: 2px dashed var(--border-color);
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px;
                cursor: pointer;
                transition: all 0.3s;
                background: var(--bg-secondary);
            }
            
            .drop-zone:hover, .drop-zone.drag-over {
                border-color: var(--accent-blue);
                background: rgba(59, 130, 246, 0.05);
            }
            
            .drop-zone i {
                font-size: 48px;
                color: var(--accent-blue);
                margin-bottom: 16px;
            }
            
            /* Image preview */
            .image-preview {
                max-width: 100%;
                max-height: 300px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            
            /* JWT chip */
            .jwt-chip {
                background: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.3);
                color: var(--accent-blue);
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 13px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .jwt-chip:hover {
                background: rgba(59, 130, 246, 0.2);
            }
            
            /* Privacy badge */
            .privacy-badge {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(34, 197, 94, 0.1);
                border: 1px solid rgba(34, 197, 94, 0.3);
                color: var(--success-green);
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .split-panel {
                    grid-template-columns: 1fr;
                    height: auto;
                    min-height: calc(100vh - 200px);
                }
                
                .panel-divider {
                    width: 100%;
                    height: 60px;
                    flex-direction: row;
                }
                
                .privacy-badge {
                    bottom: 10px;
                    right: 10px;
                    font-size: 11px;
                    padding: 8px 12px;
                }
            }
        </style>
    </head>
    <body>
        ${getCommonAuthScript()}
        ${getCommonHeader('Lifestyle')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ìœ í‹¸ë¦¬í‹°', href: '/lifestyle'},
          {label: 'Base64 ë³€í™˜'}
        ])}

        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <div class="mode-tab active" onclick="switchMode('text')" data-mode="text">
                <i class="fas fa-font"></i>
                <span>í…ìŠ¤íŠ¸ ë³€í™˜</span>
            </div>
            <div class="mode-tab" onclick="switchMode('image')" data-mode="image">
                <i class="fas fa-image"></i>
                <span>ì´ë¯¸ì§€ ë³€í™˜</span>
            </div>
        </div>

        <!-- Text Mode -->
        <div id="text-mode" class="split-panel">
            <div class="panel">
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 16px; font-weight: 600;">Input</h3>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">
                        <input type="checkbox" id="realtime-toggle" checked onchange="toggleRealtime()">
                        <span>ì‹¤ì‹œê°„ ë³€í™˜</span>
                    </label>
                </div>
                <textarea id="text-input" placeholder="ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (í•œê¸€ ì™„ë²½ ì§€ì›)"></textarea>
            </div>
            
            <div class="panel-divider">
                <button class="btn btn-primary" onclick="encodeText()" title="ì¸ì½”ë”©">
                    <i class="fas fa-arrow-right"></i>
                    <span class="hidden sm:inline">Encode</span>
                </button>
                <button class="btn btn-secondary" onclick="decodeText()" title="ë””ì½”ë”©">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden sm:inline">Decode</span>
                </button>
                <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; margin-top: 8px;">
                    <input type="checkbox" id="url-safe-toggle">
                    <span>URL Safe</span>
                </label>
            </div>
            
            <div class="panel">
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 16px; font-weight: 600;">Output</h3>
                    <div style="display: flex; gap: 8px;">
                        <div id="jwt-indicator"></div>
                        <button class="btn btn-success btn-sm" onclick="copyOutput()" style="padding: 6px 12px; font-size: 13px;">
                            <i class="fas fa-copy"></i>
                            <span class="hidden sm:inline">ë³µì‚¬</span>
                        </button>
                    </div>
                </div>
                <textarea id="text-output" placeholder="ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..." readonly></textarea>
            </div>
        </div>

        <!-- Image Mode -->
        <div id="image-mode" style="display: none; padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 240px);">
                <!-- Left: Drop Zone & Results -->
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                        <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">JPG, PNG, GIF, WebP ì§€ì›</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    </div>
                    
                    <div id="image-results" style="display: none; flex: 1; display: flex; flex-direction: column; gap: 12px; overflow: hidden;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="copyImageResult('raw')" style="flex: 1;">
                                <i class="fas fa-copy"></i> Raw Copy
                            </button>
                            <button class="btn btn-secondary" onclick="copyImageResult('html')" style="flex: 1;">
                                <i class="fas fa-code"></i> &lt;img&gt; Copy
                            </button>
                            <button class="btn btn-secondary" onclick="copyImageResult('css')" style="flex: 1;">
                                <i class="fas fa-palette"></i> CSS Copy
                            </button>
                        </div>
                        <textarea id="image-output" readonly style="flex: 1; font-size: 12px;"></textarea>
                    </div>
                </div>
                
                <!-- Right: Preview -->
                <div style="display: flex; flex-direction: column; background: var(--bg-secondary); border-radius: 12px; padding: 20px; align-items: center; justify-content: center;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; align-self: flex-start;">Preview</h3>
                    <div id="image-preview-container" style="flex: 1; display: flex; align-items: center; justify-content: center; width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 14px;">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Badge -->
        <div class="privacy-badge">
            <i class="fas fa-shield-alt"></i>
            <span>100% í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ - ì„œë²„ ì „ì†¡ 0%</span>
        </div>

        <script>
            let currentMode = 'text';
            let realtimeEnabled = true;
            let currentImageData = null;

            // Initialize
            document.getElementById('text-input').addEventListener('input', () => {
                if (realtimeEnabled) {
                    encodeText();
                }
            });

            // Mode switching
            function switchMode(mode) {
                currentMode = mode;
                
                // Update tabs
                document.querySelectorAll('.mode-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === mode);
                });
                
                // Update views
                document.getElementById('text-mode').style.display = mode === 'text' ? 'grid' : 'none';
                document.getElementById('image-mode').style.display = mode === 'image' ? 'block' : 'none';
            }

            // Toggle realtime conversion
            function toggleRealtime() {
                realtimeEnabled = document.getElementById('realtime-toggle').checked;
            }

            // Encode text
            function encodeText() {
                const input = document.getElementById('text-input').value;
                const output = document.getElementById('text-output');
                const urlSafe = document.getElementById('url-safe-toggle').checked;
                
                if (!input) {
                    output.value = '';
                    return;
                }
                
                try {
                    // UTF-8 safe encoding using js-base64
                    let encoded = Base64.encode(input);
                    
                    // URL Safe conversion
                    if (urlSafe) {
                        encoded = encoded.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');
                    }
                    
                    output.value = encoded;
                    checkJWT(encoded);
                } catch (e) {
                    output.value = 'ì¸ì½”ë”© ì˜¤ë¥˜: ' + e.message;
                }
            }

            // Decode text
            function decodeText() {
                const input = document.getElementById('text-input').value;
                const output = document.getElementById('text-output');
                const urlSafe = document.getElementById('url-safe-toggle').checked;
                
                if (!input) {
                    output.value = '';
                    return;
                }
                
                try {
                    let toDecode = input.trim();
                    
                    // URL Safe conversion back
                    if (urlSafe || toDecode.includes('-') || toDecode.includes('_')) {
                        toDecode = toDecode.replace(/-/g, '+').replace(/_/g, '/');
                        // Add padding if needed
                        while (toDecode.length % 4) {
                            toDecode += '=';
                        }
                    }
                    
                    // UTF-8 safe decoding using js-base64
                    const decoded = Base64.decode(toDecode);
                    output.value = decoded;
                    checkJWT(toDecode);
                } catch (e) {
                    output.value = 'ìœ íš¨í•˜ì§€ ì•Šì€ Base64 í˜•ì‹ì…ë‹ˆë‹¤: ' + e.message;
                }
            }

            // Check if it's a JWT token
            function checkJWT(base64String) {
                const indicator = document.getElementById('jwt-indicator');
                
                // JWT tokens start with "ey"
                if (base64String.startsWith('ey')) {
                    try {
                        // JWT has 3 parts separated by dots
                        const parts = base64String.split('.');
                        if (parts.length === 3) {
                            indicator.innerHTML = \`
                                <div class="jwt-chip" onclick="showJWT('\${base64String}')">
                                    <i class="fas fa-key"></i>
                                    <span>JWT í† í° ê°ì§€ - í´ë¦­í•˜ì—¬ Payload ë³´ê¸°</span>
                                </div>
                            \`;
                            return;
                        }
                    } catch (e) {}
                }
                
                indicator.innerHTML = '';
            }

            // Show JWT payload
            function showJWT(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        alert('ìœ íš¨í•˜ì§€ ì•Šì€ JWT í˜•ì‹ì…ë‹ˆë‹¤.');
                        return;
                    }
                    
                    // Decode header and payload
                    const header = JSON.parse(Base64.decode(parts[0]));
                    const payload = JSON.parse(Base64.decode(parts[1]));
                    
                    // Pretty print
                    const formatted = \`JWT Header:\\n\${JSON.stringify(header, null, 2)}\\n\\nJWT Payload:\\n\${JSON.stringify(payload, null, 2)}\`;
                    
                    // Show in output
                    document.getElementById('text-output').value = formatted;
                    
                    // Show alert with key info
                    let info = 'JWT Token ì •ë³´:\\n\\n';
                    if (payload.exp) {
                        const expDate = new Date(payload.exp * 1000);
                        info += \`ë§Œë£Œ: \${expDate.toLocaleString('ko-KR')}\\n\`;
                    }
                    if (payload.iat) {
                        const iatDate = new Date(payload.iat * 1000);
                        info += \`ë°œí–‰: \${iatDate.toLocaleString('ko-KR')}\\n\`;
                    }
                    if (payload.sub) info += \`Subject: \${payload.sub}\\n\`;
                    if (payload.iss) info += \`Issuer: \${payload.iss}\\n\`;
                    
                    alert(info);
                } catch (e) {
                    alert('JWT íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                }
            }

            // Copy output
            async function copyOutput() {
                const output = document.getElementById('text-output').value;
                if (!output) {
                    alert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    await navigator.clipboard.writeText(output);
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> <span class="hidden sm:inline">ë³µì‚¬ë¨!</span>';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                } catch (e) {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Image upload handling
            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentImageData = reader.result;
                    displayImageResult(currentImageData);
                };
                reader.readAsDataURL(file);
            }

            // Display image result
            function displayImageResult(base64Data) {
                // Show results section
                document.getElementById('image-results').style.display = 'flex';
                
                // Set output
                document.getElementById('image-output').value = base64Data;
                
                // Show preview
                const previewContainer = document.getElementById('image-preview-container');
                previewContainer.innerHTML = \`<img src="\${base64Data}" class="image-preview" alt="Preview">\`;
            }

            // Copy image result in different formats
            async function copyImageResult(format) {
                if (!currentImageData) {
                    alert('ë³€í™˜í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                let textToCopy = '';
                
                switch(format) {
                    case 'raw':
                        textToCopy = currentImageData;
                        break;
                    case 'html':
                        textToCopy = \`<img src="\${currentImageData}" alt="Image">\`;
                        break;
                    case 'css':
                        textToCopy = \`background-image: url('\${currentImageData}');\`;
                        break;
                }
                
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ë¨!';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                } catch (e) {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Drag and drop
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        currentImageData = reader.result;
                        displayImageResult(currentImageData);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            });
        </script>

        ${getCommonFooter()}
    </body>
    </html>
  `)
})

// D-Day API
app.get('/api/dday/list', async (c) => {
  const { DB } = c.env
  const userId = c.get('userId') || null
  
  try {
    const { results } = await DB.prepare(
      'SELECT * FROM dday WHERE user_id = ? ORDER BY target_date ASC'
    ).bind(userId).all()
    
    return c.json({ success: true, ddays: results || [] })
  } catch (error) {
    console.error('D-Day ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'D-Day ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

app.post('/api/dday/add', async (c) => {
  const { DB } = c.env
  const userId = c.get('userId') || null
  
  try {
    const body = await c.req.json()
    const { title, targetDate, mode, isAnniversary, color, emoji } = body
    
    const result = await DB.prepare(
      'INSERT INTO dday (user_id, title, target_date, mode, is_anniversary, color, emoji) VALUES (?, ?, ?, ?, ?, ?, ?)'
    ).bind(userId, title, targetDate, mode, isAnniversary ? 1 : 0, color, emoji).run()
    
    return c.json({ success: true, id: result.meta.last_row_id })
  } catch (error) {
    console.error('D-Day ì¶”ê°€ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'D-Day ì¶”ê°€ ì‹¤íŒ¨' }, 500)
  }
})

app.delete('/api/dday/:id', async (c) => {
  const { DB } = c.env
  const userId = c.get('userId') || null
  const id = c.req.param('id')
  
  try {
    await DB.prepare(
      'DELETE FROM dday WHERE id = ? AND (user_id = ? OR user_id IS NULL)'
    ).bind(id, userId).run()
    
    return c.json({ success: true })
  } catch (error) {
    console.error('D-Day ì‚­ì œ ì˜¤ë¥˜:', error)
    return c.json({ success: false, error: 'D-Day ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ì‡¼í•‘ API ====================
// Mock ì¿ íŒ¡ í•«ë”œ ë°ì´í„° API
app.get('/api/shopping/hotdeals', (c) => {
  // ì‹¤ì œë¡œëŠ” ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ APIë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ì§€ë§Œ, 
  // ì—¬ê¸°ì„œëŠ” Mock ë°ì´í„°ë¡œ ì‹œì—°
  const hotDeals = [
    {
      id: 1,
      title: '[íŠ¹ê°€] ì‚¼ì„± ê°¤ëŸ­ì‹œ ë²„ì¦ˆ2 í”„ë¡œ ë¬´ì„  ì´ì–´í°',
      originalPrice: 289000,
      salePrice: 149000,
      discountRate: 48,
      image: 'https://via.placeholder.com/300x300/667eea/ffffff?text=Galaxy+Buds2+Pro',
      link: 'https://www.coupang.com',
      rating: 4.8,
      reviewCount: 15234,
      category: 'ì „ìì œí’ˆ',
      platform: 'coupang',
      badge: 'ë¡œì¼“ë°°ì†¡'
    },
    {
      id: 2,
      title: '[ì˜¤ëŠ˜ë§Œ] ë‚˜ì´í‚¤ ì—ì–´ë§¥ìŠ¤ ëŸ°ë‹í™” - ì‹ ìƒ ì¶œì‹œ',
      originalPrice: 159000,
      salePrice: 89000,
      discountRate: 44,
      image: 'https://via.placeholder.com/300x300/f093fb/ffffff?text=Nike+Air+Max',
      link: 'https://www.coupang.com',
      rating: 4.7,
      reviewCount: 8921,
      category: 'íŒ¨ì…˜',
      platform: 'coupang',
      badge: 'ë¬´ë£Œë°°ì†¡'
    },
    {
      id: 3,
      title: 'LG ê·¸ë¨ 17ì¸ì¹˜ ë…¸íŠ¸ë¶ ì´ˆê²½ëŸ‰ (1.35kg)',
      originalPrice: 2590000,
      salePrice: 1990000,
      discountRate: 23,
      image: 'https://via.placeholder.com/300x300/4facfe/ffffff?text=LG+Gram+17',
      link: 'https://www.coupang.com',
      rating: 4.9,
      reviewCount: 3456,
      category: 'ì „ìì œí’ˆ',
      platform: 'coupang',
      badge: 'ë¡œì¼“ë°°ì†¡'
    },
    {
      id: 4,
      title: '[1+1] í”„ë¦¬ë¯¸ì—„ ì™€ì´ë“œ ëª¨ë‹ˆí„° 27ì¸ì¹˜ QHD',
      originalPrice: 349000,
      salePrice: 249000,
      discountRate: 29,
      image: 'https://via.placeholder.com/300x300/00d2ff/ffffff?text=Monitor+27',
      link: 'https://www.coupang.com',
      rating: 4.6,
      reviewCount: 12890,
      category: 'ì „ìì œí’ˆ',
      platform: 'coupang',
      badge: 'ì˜¤ëŠ˜ì¶œë°œ'
    },
    {
      id: 5,
      title: 'ì½”ìŠ¤íŠ¸ì½” ì¸ê¸° 1ìœ„ í”„ë¡œí‹´ ë³´ì¶©ì œ 5kg ëŒ€ìš©ëŸ‰',
      originalPrice: 129000,
      salePrice: 69000,
      discountRate: 47,
      image: 'https://via.placeholder.com/300x300/feca57/ffffff?text=Protein+5kg',
      link: 'https://www.coupang.com',
      rating: 4.8,
      reviewCount: 28934,
      category: 'ì‹í’ˆ',
      platform: 'coupang',
      badge: 'ë² ìŠ¤íŠ¸'
    },
    {
      id: 6,
      title: 'ë‹¤ì´ìŠ¨ V15 ë¬´ì„ ì²­ì†Œê¸° ìµœì‹ í˜• + ì‚¬ì€í’ˆ ì¦ì •',
      originalPrice: 1390000,
      salePrice: 999000,
      discountRate: 28,
      image: 'https://via.placeholder.com/300x300/ee5a6f/ffffff?text=Dyson+V15',
      link: 'https://www.coupang.com',
      rating: 4.9,
      reviewCount: 5632,
      category: 'ìƒí™œê°€ì „',
      platform: 'coupang',
      badge: 'ë¡œì¼“ì§êµ¬'
    },
    {
      id: 7,
      title: 'Apple ì—ì–´íŒŸ í”„ë¡œ 2ì„¸ëŒ€ USB-C ì •í’ˆ',
      originalPrice: 359000,
      salePrice: 289000,
      discountRate: 19,
      image: 'https://via.placeholder.com/300x300/764ba2/ffffff?text=AirPods+Pro+2',
      link: 'https://www.coupang.com',
      rating: 5.0,
      reviewCount: 9821,
      category: 'ì „ìì œí’ˆ',
      platform: 'coupang',
      badge: 'ë¡œì¼“ë°°ì†¡'
    },
    {
      id: 8,
      title: '[íƒ€ì„íŠ¹ê°€] ìƒ¤ì˜¤ë¯¸ ê³µê¸°ì²­ì •ê¸° 4 í”„ë¡œ ë¯¸ì„¸ë¨¼ì§€',
      originalPrice: 529000,
      salePrice: 329000,
      discountRate: 38,
      image: 'https://via.placeholder.com/300x300/48dbfb/ffffff?text=Xiaomi+Air+4',
      link: 'https://www.coupang.com',
      rating: 4.7,
      reviewCount: 7234,
      category: 'ìƒí™œê°€ì „',
      platform: 'coupang',
      badge: 'íƒ€ì„íŠ¹ê°€'
    },
  ]

  return c.json(hotDeals)
})

// ==================== ì‡¼í•‘ ë©”ì¸ í˜ì´ì§€ ====================
app.get('/shopping', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìµœì €ê°€ í•«ë”œ ë­í‚¹ - Faith Portal</title>
        <meta name="description" content="ì‹¤ì‹œê°„ ê¸‰ìƒìŠ¹ í•«ë”œ! ì¿ íŒ¡, ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤ ìµœì €ê°€ ìƒí’ˆì„ í•œëˆˆì— ë¹„êµí•˜ì„¸ìš”.">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .deal-card {
                transition: all 0.3s ease;
                cursor: pointer;
            }
            .deal-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            }
            .badge {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.8; }
            }
            .discount-badge {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }
            .loading-skeleton {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: loading 1.5s infinite;
            }
            @keyframes loading {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-orange-50 via-red-50 to-pink-50">
        ${getCommonHeader('Shopping')}
        ${getStickyHeader()}
        
        ${getBreadcrumb([
          {label: 'í™ˆ', href: '/'},
          {label: 'ì‡¼í•‘', href: '/shopping'}
        ])}

        <!-- ì„œë¸Œ ë©”ë‰´ -->
        ${getShoppingMenu('/shopping')}

        <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6 sm:py-8">
            <!-- í—¤ë” -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 flex items-center gap-3">
                            <i class="fas fa-fire text-orange-600 animate-pulse"></i>
                            ì‹¤ì‹œê°„ í•«ë”œ ë­í‚¹
                        </h1>
                        <p class="text-gray-600 mt-2">
                            <i class="fas fa-bolt text-yellow-500"></i>
                            ì§€ê¸ˆ ê°€ì¥ í•«í•œ ì´ˆíŠ¹ê°€ ìƒí’ˆì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”!
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterCategory('all')" id="filter-all" class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium shadow-md hover:bg-orange-700 transition">
                            <i class="fas fa-th"></i> ì „ì²´
                        </button>
                        <button onclick="filterCategory('ì „ìì œí’ˆ')" id="filter-ì „ìì œí’ˆ" class="px-4 py-2 bg-white text-gray-700 rounded-lg font-medium shadow-md hover:bg-gray-100 transition">
                            <i class="fas fa-laptop"></i> ì „ìì œí’ˆ
                        </button>
                        <button onclick="filterCategory('íŒ¨ì…˜')" id="filter-íŒ¨ì…˜" class="px-4 py-2 bg-white text-gray-700 rounded-lg font-medium shadow-md hover:bg-gray-100 transition hidden sm:inline-block">
                            <i class="fas fa-tshirt"></i> íŒ¨ì…˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-xl p-4 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">ì´ ìƒí’ˆìˆ˜</p>
                            <p class="text-2xl font-bold" id="totalProducts">0</p>
                        </div>
                        <i class="fas fa-box text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl p-4 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">í‰ê·  í• ì¸ìœ¨</p>
                            <p class="text-2xl font-bold" id="avgDiscount">0%</p>
                        </div>
                        <i class="fas fa-percent text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-4 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">ìµœëŒ€ í• ì¸ìœ¨</p>
                            <p class="text-2xl font-bold" id="maxDiscount">0%</p>
                        </div>
                        <i class="fas fa-fire text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl p-4 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">ë¦¬ë·° í‰ì </p>
                            <p class="text-2xl font-bold" id="avgRating">0</p>
                        </div>
                        <i class="fas fa-star text-3xl opacity-80"></i>
                    </div>
                </div>
            </div>

            <!-- ìƒí’ˆ ê·¸ë¦¬ë“œ -->
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ -->
                <div class="loading-skeleton h-96 rounded-xl"></div>
                <div class="loading-skeleton h-96 rounded-xl"></div>
                <div class="loading-skeleton h-96 rounded-xl"></div>
                <div class="loading-skeleton h-96 rounded-xl"></div>
            </div>
        </main>

        <script>
            let allProducts = [];
            let currentFilter = 'all';

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            async function loadProducts() {
                try {
                    const response = await fetch('/api/shopping/hotdeals');
                    allProducts = await response.json();
                    
                    // í†µê³„ ê³„ì‚°
                    updateStatistics();
                    
                    // ìƒí’ˆ í‘œì‹œ
                    displayProducts(allProducts);
                } catch (error) {
                    console.error('Failed to load products:', error);
                    document.getElementById('productsGrid').innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
                }
            }

            // í†µê³„ ì—…ë°ì´íŠ¸
            function updateStatistics() {
                const totalProducts = allProducts.length;
                const avgDiscount = Math.round(allProducts.reduce((sum, p) => sum + p.discountRate, 0) / totalProducts);
                const maxDiscount = Math.max(...allProducts.map(p => p.discountRate));
                const avgRating = (allProducts.reduce((sum, p) => sum + p.rating, 0) / totalProducts).toFixed(1);

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('avgDiscount').textContent = avgDiscount + '%';
                document.getElementById('maxDiscount').textContent = maxDiscount + '%';
                document.getElementById('avgRating').textContent = avgRating;
            }

            // ìƒí’ˆ í‘œì‹œ
            function displayProducts(products) {
                const grid = document.getElementById('productsGrid');
                
                if (products.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-shopping-bag text-4xl mb-3"></i><p>ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                grid.innerHTML = products.map(product => \`
                    <div class="deal-card bg-white rounded-xl overflow-hidden shadow-lg border border-gray-200" onclick="window.open('\${product.link}', '_blank')">
                        <!-- ì´ë¯¸ì§€ -->
                        <div class="relative">
                            <img src="\${product.image}" alt="\${product.title}" class="w-full h-48 object-cover">
                            
                            <!-- í• ì¸ìœ¨ ë°°ì§€ -->
                            <div class="absolute top-3 left-3 discount-badge text-white px-3 py-1.5 rounded-lg font-bold shadow-lg">
                                <i class="fas fa-tag"></i> \${product.discountRate}%
                            </div>
                            
                            <!-- í”Œë«í¼ ë°°ì§€ -->
                            <div class="absolute top-3 right-3 bg-white px-3 py-1 rounded-lg text-xs font-semibold text-orange-600 shadow-md">
                                \${product.badge}
                            </div>
                        </div>

                        <!-- ë‚´ìš© -->
                        <div class="p-4">
                            <!-- ì¹´í…Œê³ ë¦¬ -->
                            <span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mb-2">
                                \${product.category}
                            </span>

                            <!-- ì œëª© -->
                            <h3 class="font-bold text-gray-800 mb-2 line-clamp-2 min-h-[3rem]">
                                \${product.title}
                            </h3>

                            <!-- í‰ì  -->
                            <div class="flex items-center gap-2 mb-3">
                                <div class="flex items-center">
                                    \${'<i class="fas fa-star text-yellow-400"></i>'.repeat(Math.floor(product.rating))}
                                    \${product.rating % 1 !== 0 ? '<i class="fas fa-star-half-alt text-yellow-400"></i>' : ''}
                                </div>
                                <span class="text-sm text-gray-600">\${product.rating}</span>
                                <span class="text-xs text-gray-400">(\${product.reviewCount.toLocaleString()})</span>
                            </div>

                            <!-- ê°€ê²© -->
                            <div class="border-t pt-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-400 line-through">\${product.originalPrice.toLocaleString()}ì›</p>
                                        <p class="text-xl font-bold text-orange-600">\${product.salePrice.toLocaleString()}ì›</p>
                                    </div>
                                    <button class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                \`).join('');
            }

            // ì¹´í…Œê³ ë¦¬ í•„í„°
            function filterCategory(category) {
                currentFilter = category;
                
                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                    const btnCategory = btn.id.replace('filter-', '');
                    if (btnCategory === category) {
                        btn.className = 'px-4 py-2 bg-orange-600 text-white rounded-lg font-medium shadow-md hover:bg-orange-700 transition';
                    } else {
                        btn.className = btn.classList.contains('hidden') 
                            ? 'px-4 py-2 bg-white text-gray-700 rounded-lg font-medium shadow-md hover:bg-gray-100 transition hidden sm:inline-block'
                            : 'px-4 py-2 bg-white text-gray-700 rounded-lg font-medium shadow-md hover:bg-gray-100 transition';
                    }
                });

                // í•„í„°ë§
                const filtered = category === 'all' 
                    ? allProducts 
                    : allProducts.filter(p => p.category === category);
                
                displayProducts(filtered);
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
            document.addEventListener('DOMContentLoaded', loadProducts);
        </script>

        ${getCommonFooter()}
        ${getCommonAuthScript()}
    </body>
    </html>
  `)
})

export default app
